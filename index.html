<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高鐵訂位確認單生成器</title>
    
    <!-- 引入字體 Noto Sans TC -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Vue.js 2 (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>

    <!-- html2canvas (用於生成圖片) -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <!-- jsPDF (用於生成 PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
            height: 100vh;
            overflow: hidden;
        }
        
        .input-minimal {
            background-color: transparent;
            border-bottom: 1px solid #d6d3d1;
            padding: 4px 0;
            width: 100%;
            transition: all 0.3s ease;
            color: #44403c;
            outline: none;
        }
        .input-minimal:focus {
            border-color: #0d9488;
            border-bottom-width: 2px;
        }
        .input-label {
            font-size: 0.75rem;
            color: #78716c;
            margin-bottom: 0.25rem;
            display: block;
        }
        .btn-add {
            background-color: #57534e;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s;
            width: 100%;
        }
        .btn-add:hover { background-color: #44403c; }
        
        /* 隱藏但維持佈局的生成區塊 (解決 PDF 文字位移關鍵) */
        .off-screen-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 148mm;
            height: 210mm;
            overflow: hidden;
            z-index: -100;
            visibility: hidden;
            pointer-events: none;
        }

        /* 預覽確認單 A5 尺寸 */
        .a5-container {
            width: 148mm;
            height: 210mm;
            background: white;
            padding: 12mm 10mm; 
            box-sizing: border-box;
            position: relative;
            font-family: 'Noto Sans TC', sans-serif;
            color: #334155;
            font-size: 10px;
            margin: 0 auto;
            border: 1px solid #f1f5f9;
        }

        .scale-wrapper {
            width: 100%;
            transform-origin: top center;
        }

        /* 表頭 */
        .doc-header-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
            border-bottom: 2px solid #0f172a; 
        }
        .doc-header-table td {
            padding: 2px 4px;
            vertical-align: bottom;
        }
        .doc-label {
            color: #64748b;
            font-size: 0.55rem; 
            display: block;
            line-height: 1;
            margin-bottom: 2px;
        }
        .doc-val {
            font-weight: 700;
            color: #1e293b;
            font-size: 0.75rem; 
            border-bottom: 1px solid #e2e8f0;
            display: block;
            width: 100%;
        }

        /* 行程表格樣式 */
        .trip-section-table {
            margin-bottom: 10px;
            border: 1px solid #94a3b8; 
            border-radius: 4px;
            overflow: hidden;
        }
        
        .trip-meta-header {
            background-color: #f1f5f9;
            padding: 4px 8px;
            border-bottom: 1px solid #94a3b8;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.65rem;
            color: #334155;
        }
        
        .direction-label {
            font-weight: bold;
            background-color: #334155;
            color: white;
            padding: 2px 6px;
            border-radius: 2px;
            text-transform: uppercase;
        }
        .trip-ids-right {
            font-size: 0.65rem;
            font-family: monospace;
            font-weight: 600;
            display: flex;
            gap: 10px;
        }

        .confirm-table {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
            font-size: 0.75rem;
        }
        .confirm-table th {
            background-color: #e2e8f0;
            font-weight: 600;
            color: #475569;
            padding: 3px;
            border: 1px solid #cbd5e1;
            font-size: 0.65rem;
        }
        .confirm-table td {
            padding: 4px;
            border: 1px solid #cbd5e1;
            color: #1e293b;
            font-weight: 500;
        }

        .ticket-info-bar {
            background-color: #f8fafc;
            border-top: 1px solid #cbd5e1;
            border-bottom: 1px solid #cbd5e1;
            padding: 3px 8px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .car-type-badge {
            font-weight: 800;
            color: #0f766e;
            margin-right: 8px;
        }
        .ticket-breakdown {
            color: #475569;
            font-size: 0.7rem;
        }
        
        .p-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem;
        }
        .p-table th {
            text-align: left;
            padding: 3px 6px;
            background-color: #f1f5f9;
            color: #64748b;
            font-weight: 600;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.6rem;
        }
        .p-table td {
            padding: 3px 6px;
            border-bottom: 1px dashed #e2e8f0;
            color: #334155;
        }
        .p-table tr:last-child td { border-bottom: none; }

        .total-row {
            text-align: right;
            padding: 6px 0;
            font-weight: 800;
            font-size: 1rem;
            color: #0f172a;
            border-top: 2px solid #0f172a;
            margin-top: 10px;
        }
        
        .footer-note {
            margin-top: 10px;
            font-size: 0.55rem;
            color: #64748b;
            line-height: 1.4;
            padding-top: 5px;
            border-top: 1px solid #e2e8f0;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* 右側介面佈局 */
        .preview-section {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .summary-list {
            flex: 1;
            overflow-y: auto;
        }
    </style>
</head>
<body class="text-stone-700 h-screen overflow-hidden">

    <div id="app" class="h-full flex flex-col">
        
        <header class="py-4 text-center no-print bg-[#f5f5f4] shrink-0 border-b border-stone-200 shadow-sm z-20">
            <h1 class="text-2xl font-light tracking-widest text-stone-800">高鐵訂位確認單生成器</h1>
        </header>

        <main class="flex-1 overflow-hidden grid grid-cols-1 lg:grid-cols-12 gap-4 p-4 lg:p-6 bg-[#f5f5f4]">
            
            <!-- 左側：輸入表單 -->
            <section class="lg:col-span-7 bg-white rounded-2xl border border-stone-200 overflow-y-auto no-scrollbar input-section p-6 md:p-8 shadow-sm">
                
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b border-stone-100 pb-4 gap-3">
                    <div class="flex items-center gap-4 flex-wrap">
                        <h2 class="text-lg font-medium text-stone-600 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-teal-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                            資料輸入
                        </h2>
                        <div class="flex items-center gap-3 bg-stone-50 px-4 py-2 rounded-lg border border-stone-100">
                            <div class="flex items-center gap-1 border-r border-stone-200 pr-3">
                                <span class="text-xs text-stone-400">訂票人員</span>
                                <select v-model="booker" class="bg-transparent text-sm font-bold text-stone-700 outline-none">
                                    <option>卓芷伶</option>
                                    <option>陳侑君</option>
                                </select>
                            </div>
                            <div class="flex items-center gap-1 border-r border-stone-200 pr-3">
                                <span class="text-xs text-stone-400">訂票日期</span>
                                <span class="text-sm font-bold">{{ formatDate(bookingDate) }}</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <span class="text-xs text-teal-600 font-bold">D/L</span>
                                <input type="date" v-model="deadlineDate" class="bg-transparent text-sm font-bold text-teal-700 outline-none w-28">
                            </div>
                        </div>
                    </div>
                    <button @click="resetForm" class="text-stone-400 hover:text-red-500 p-1 rounded hover:bg-stone-100" title="清空所有資料">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6 pb-6 border-b border-stone-100 text-sm">
                    <div>
                        <label class="input-label">業務員</label>
                        <input type="text" v-model="salesperson" class="input-minimal" placeholder="例如：王大明">
                    </div>
                    <div>
                        <label class="input-label">訂單編號</label>
                        <input type="text" v-model="cowayOrderId" maxlength="8" class="input-minimal" placeholder="12345678">
                    </div>
                    <div>
                        <label class="input-label">團號</label>
                        <input type="text" v-model="groupNumber" class="input-minimal" placeholder="TPE20230512A001">
                    </div>
                </div>

                <!-- 新增行程 -->
                <div class="mb-10 p-5 bg-stone-50 rounded-xl border border-stone-100">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="w-1.5 h-5 bg-stone-700 rounded-sm"></span>
                        <h3 class="font-bold text-stone-700 text-sm">行程設定</h3>
                    </div>

                    <div class="mb-4 flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded border border-stone-200">
                            <input type="radio" value="去程" v-model="currentTripInput.direction">
                            <span :class="currentTripInput.direction === '去程' ? 'font-bold text-teal-700' : ''">去程</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded border border-stone-200">
                            <input type="radio" value="回程" v-model="currentTripInput.direction">
                            <span :class="currentTripInput.direction === '回程' ? 'font-bold text-teal-700' : ''">回程</span>
                        </label>
                    </div>

                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                         <div>
                            <label class="input-label">高鐵訂單編號</label>
                            <input type="text" v-model="currentTripInput.hsrOrderId" maxlength="12" class="input-minimal font-mono">
                        </div>
                        <div>
                            <label class="input-label">訂位代號 (PNR)</label>
                            <input type="text" v-model="currentTripInput.pnr" maxlength="8" class="input-minimal font-bold uppercase text-teal-700" placeholder="預設空白">
                        </div>
                        <div>
                            <label class="input-label">日期</label>
                            <input type="date" v-model="currentTripInput.date" class="input-minimal">
                        </div>
                        <div>
                            <label class="input-label">車次</label>
                            <input type="text" v-model="currentTripInput.trainNumber" class="input-minimal" placeholder="0809">
                        </div>
                        <div class="lg:col-span-2">
                            <label class="input-label">車廂種類</label>
                            <select v-model="currentTripInput.carType" @change="updateInputPrices" class="input-minimal">
                                <option>標準車廂</option><option>商務車廂</option>
                            </select>
                        </div>
                        <div><label class="input-label">起程時間</label><input type="text" v-model="currentTripInput.depTime" class="input-minimal" placeholder="09:00"></div>
                        <div><label class="input-label">抵達時間</label><input type="text" v-model="currentTripInput.arrTime" class="input-minimal" placeholder="10:45"></div>
                        <div class="col-span-2 lg:col-span-2 flex items-end gap-2">
                            <div class="flex-1">
                                <label class="input-label">出發站</label>
                                <select v-model="currentTripInput.origin" @change="updateInputPrices" class="input-minimal text-sm">
                                    <option v-for="st in stations" :value="st">{{ st }}</option>
                                </select>
                            </div>
                            <button @click="swapStations" class="mb-1 p-2 text-stone-400 hover:text-teal-600 transition-colors rounded-full hover:bg-stone-100" title="交換起訖站">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                            </button>
                            <div class="flex-1">
                                <label class="input-label">抵達站</label>
                                <select v-model="currentTripInput.destination" @change="updateInputPrices" class="input-minimal text-sm">
                                    <option v-for="st in stations" :value="st">{{ st }}</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-3 rounded-lg border border-stone-200 mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-bold text-stone-500">票種與張數 (上限 10 位)</label>
                            <button @click="addTicketInput" class="text-xs text-teal-600 hover:text-teal-800 font-medium">+ 增加票種</button>
                        </div>
                        <div v-for="(ticket, idx) in currentTripInput.tickets" :key="'t-'+idx" class="flex gap-2 mb-2 items-end border-b border-stone-100 pb-2 last:border-0 last:pb-0 last:mb-0">
                            <div class="flex-1">
                                <select v-model="ticket.type" @change="updateInputPrices" class="input-minimal text-sm">
                                    <option>全票</option><option>孩童</option><option>敬老</option><option>愛心</option>
                                </select>
                            </div>
                            <div class="w-16"><input type="number" v-model.number="ticket.count" min="1" max="10" @input="updatePassengerCount" class="input-minimal text-center text-sm" placeholder="張"></div>
                            <div class="w-20"><input type="number" v-model.number="ticket.price" class="input-minimal text-right text-sm" placeholder="$"></div>
                            <button v-if="currentTripInput.tickets.length > 1" @click="removeTicketInput(idx)" class="text-stone-300 hover:text-red-400 px-1">&times;</button>
                        </div>
                    </div>

                    <div v-if="passengers.length > 0" class="mb-6">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-sm font-bold text-stone-700">旅客資料 (共 {{ passengers.length }} 位)</span>
                        </div>
                        <div v-for="(p, index) in passengers" :key="'p-'+index" class="mb-3 bg-white p-4 rounded-xl border border-stone-200 shadow-sm">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div><label class="input-label">姓名 <span class="required-mark">*</span></label><input type="text" v-model="p.name" class="input-minimal"></div>
                                <div><label class="input-label">身分證字號 <span class="required-mark">*</span></label><input type="text" v-model="p.id" @input="p.id = p.id.toUpperCase()" class="input-minimal uppercase"></div>
                                <div><label class="input-label">出生年月日</label><input type="date" v-model="p.birthDate" class="input-minimal text-stone-500"></div>
                                <div><label class="input-label">護照號碼</label><input type="text" v-model="p.passport" class="input-minimal uppercase"></div>
                            </div>
                        </div>
                    </div>

                    <button @click="addTripToList" class="btn-add flex items-center justify-center gap-2 w-full py-3 shadow-md transform transition-all hover:-translate-y-0.5">
                        <span>加入行程清單</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
                    </button>
                </div>
            </section>

            <!-- 右側：清單摘要 -->
            <section class="lg:col-span-5 bg-[#fdfcfc] rounded-2xl border border-stone-200 p-6 flex flex-col shadow-sm preview-section overflow-hidden">
                <h2 class="text-xl font-bold text-stone-700 mb-6 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-stone-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                    行程摘要
                </h2>

                <div class="summary-list no-scrollbar mb-4">
                    <div v-if="trips.length === 0" class="h-full flex flex-col justify-center items-center text-stone-300 border-2 border-dashed border-stone-200 rounded-xl min-h-[300px]">
                        <p class="text-lg">尚未加入任何行程</p>
                    </div>

                    <div v-else class="space-y-3">
                        <div v-for="(trip, idx) in trips" :key="idx" class="bg-white border border-stone-200 rounded-lg p-4 shadow-sm relative group">
                            <button @click="removeTripFromList(idx)" class="absolute top-3 right-3 text-stone-300 hover:text-red-500 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>
                            <div class="flex items-center gap-3 mb-2">
                                <span class="px-2 py-0.5 rounded text-xs font-bold tracking-wider" :class="trip.direction === '去程' ? 'bg-teal-100 text-teal-800' : 'bg-stone-200 text-stone-600'">{{ trip.direction }}</span>
                                <span class="text-sm font-bold">{{ formatDate(trip.date) }}</span>
                                <span class="text-xs font-mono text-stone-400 bg-stone-100 px-2 py-0.5 rounded">班次{{ trip.trainNumber }}</span>
                            </div>
                            <div class="flex items-baseline gap-2 mb-1 text-stone-800 font-bold">
                                <span>{{ trip.origin }} ➜ {{ trip.destination }}</span>
                                <span class="ml-auto font-mono text-teal-700">$ {{ formatPrice(getTripSubtotal(trip)) }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="shrink-0 flex gap-4 justify-center pt-4 border-t border-stone-200 bg-[#fdfcfc]">
                    <button @click="generateText" class="bg-white hover:bg-stone-50 text-stone-700 px-6 py-2.5 rounded-lg shadow-sm border border-stone-200 font-bold text-sm transition-all flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                        下載 TXT
                    </button>
                    <button @click="generatePDF" class="bg-teal-700 hover:bg-teal-800 text-white px-6 py-2.5 rounded-lg shadow-md font-bold text-sm transition-all flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        下載 PDF
                    </button>
                </div>

                <!-- 隱藏生成容器 -->
                <div class="off-screen-container">
                    <div ref="captureArea" class="a5-container">
                        <div ref="contentWrapper" class="scale-wrapper" :style="{ transform: `scale(${contentScale})` }">
                            <div class="mb-4">
                                <h2 class="text-xl font-bold tracking-widest text-stone-800 text-center border-b-2 border-stone-800 pb-2 mb-3">訂位確認單</h2>
                                <table class="doc-header-table">
                                    <tr>
                                        <td><span class="doc-label">訂票人員</span><span class="doc-val">{{ booker }}</span></td>
                                        <td><span class="doc-label">訂票日期</span><span class="doc-val">{{ formatDate(bookingDate) }}</span></td>
                                        <td><span class="doc-label">D/L開票期限</span><span class="doc-val text-red-600">{{ formatDate(deadlineDate) }} 18:00前</span></td>
                                    </tr>
                                    <tr>
                                        <td><span class="doc-label">業務員</span><span class="doc-val">{{ salesperson || '-' }}</span></td>
                                        <td><span class="doc-label">訂單編號</span><span class="doc-val">{{ cowayOrderId || '-' }}</span></td>
                                        <td><span class="doc-label">團號</span><span class="doc-val font-mono">{{ groupNumber || '-' }}</span></td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div v-for="(trip, idx) in trips" :key="'preview-'+idx" class="trip-section-table">
                                <div class="trip-meta-header">
                                    <span class="direction-label">{{ trip.direction }}</span>
                                    <div class="trip-ids-right">
                                        <span>訂單: {{ trip.hsrOrderId || '-' }}</span>
                                        <span>PNR: {{ trip.pnr || '-' }}</span>
                                    </div>
                                </div>
                                <table class="confirm-table">
                                    <thead><tr><th>日期</th><th>班次</th><th>起程車站</th><th>到達車站</th><th>起程時間</th><th>到達時間</th></tr></thead>
                                    <tbody>
                                        <tr><td>{{ formatDate(trip.date) }}</td><td>{{ trip.trainNumber }}</td><td>{{ trip.origin }}</td><td>{{ trip.destination }}</td><td class="font-mono">{{ trip.depTime }}</td><td class="font-mono">{{ trip.arrTime }}</td></tr>
                                    </tbody>
                                </table>
                                <div class="ticket-info-bar">
                                    <div>
                                        <span class="car-type-badge">{{ trip.carType.replace('車廂','') }}</span>
                                        <span class="ticket-breakdown">
                                            <span v-for="t in trip.tickets" v-if="t.count > 0" class="mr-2">{{ t.type }} {{ t.count }}張</span>
                                        </span>
                                    </div>
                                    <div class="font-mono font-bold text-stone-800">${{ formatPrice(getTripSubtotal(trip)) }}</div>
                                </div>
                                <div class="passenger-table-container">
                                    <table class="p-table">
                                        <thead><tr><th>票種</th><th>姓名</th><th>身分證字號</th><th>出生年月日</th><th class="text-right">護照號碼</th></tr></thead>
                                        <tbody>
                                            <tr v-for="(p, pIdx) in trip.passengers" :key="pIdx">
                                                <td>{{ getPassengerTicketType(trip.tickets, pIdx) }}</td>
                                                <td>{{ p.name }}</td>
                                                <td class="font-mono">{{ maskID(p.id) }}</td>
                                                <td class="font-mono">{{ p.birthDate ? formatDate(p.birthDate).replace(/\//g,'.') : '' }}</td>
                                                <td class="font-mono text-right">{{ p.passport || '' }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="total-row">總金額 Total: TWD ${{ formatPrice(totalPrice) }}</div>

                            <div class="footer-note">
                                <div class="bg-red-50 border border-red-200 rounded p-1.5 text-center mb-2">
                                    <p class="text-red-700 font-bold text-[0.6rem] leading-tight">請業務們務必再次核對資訊，如有錯誤請於出票前告知，出票後自行負責。</p>
                                </div>
                                <p class="text-center font-bold mb-1 text-[0.7rem]">【 請務必於D/L前告知可開票 與 取票方式  紙本 / 電子票 】</p>
                                <ol class="list-decimal list-inside pl-1 text-[0.55rem] text-stone-500">
                                    <li>座位皆由電腦自動劃位，恕無法指定。</li>
                                    <li>高鐵退票手續費每張 50 元，請於 4 個工作日前提出。</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>

            </section>
        </main>
    </div>

    <script>
        new Vue({
            el: '#app',
            data: {
                contentScale: 1, 
                stations: ['南港', '台北', '板橋', '桃園', '新竹', '苗栗', '台中', '彰化', '雲林', '嘉義', '台南', '左營'],
                standardFares: { '南港': { '台北': 40, '板橋': 70, '桃園': 200, '新竹': 330, '苗栗': 480, '台中': 750, '彰化': 870, '雲林': 930, '嘉義': 1120, '台南': 1390, '左營': 1530 }, '台北': { '板橋': 40, '桃園': 160, '新竹': 290, '苗栗': 430, '台中': 700, '彰化': 820, '雲林': 930, '嘉義': 1080, '台南': 1350, '左營': 1490 }, '板橋': { '桃園': 130, '新竹': 260, '苗栗': 400, '台中': 670, '彰化': 790, '雲林': 900, '嘉義': 1050, '台南': 1320, '左營': 1460 }, '桃園': { '新竹': 130, '苗栗': 280, '台中': 540, '彰化': 670, '雲林': 780, '嘉義': 920, '台南': 1190, '左營': 1330 }, '新竹': { '苗栗': 270, '台中': 390, '彰化': 500, '雲林': 640, '嘉義': 920, '台南': 1060, '左營': 1200 }, '苗栗': { '台中': 270, '彰化': 390, '雲林': 500, '嘉義': 640, '台南': 920, '左營': 1060 }, '台中': { '彰化': 130, '雲林': 230, '嘉義': 380, '台南': 650, '左營': 790 }, '彰化': { '雲林': 110, '嘉義': 250, '台南': 530, '左營': 680 }, '雲林': { '嘉義': 150, '台南': 420, '左營': 560 }, '嘉義': { '台南': 280, '左營': 410 }, '台南': { '左營': 140 } },
                businessFares: { '南港': { '台北': 260, '板橋': 310, '桃園': 500, '新竹': 700, '苗栗': 920, '台中': 1330, '彰化': 1510, '雲林': 1660, '嘉義': 1880, '台南': 2290, '左營': 2500 }, '台北': { '板橋': 260, '桃園': 440, '新竹': 640, '苗栗': 850, '台中': 1250, '彰化': 1430, '雲林': 1600, '嘉義': 1820, '台南': 2230, '左營': 2440 }, '板橋': { '桃園': 400, '新竹': 590, '苗栗': 800, '台中': 1210, '彰化': 1390, '雲林': 1550, '嘉義': 1780, '台南': 2180, '左營': 2390 }, '桃園': { '新竹': 400, '苗栗': 620, '台中': 1010, '彰化': 1210, '雲林': 1370, '嘉義': 1580, '台南': 1990, '左營': 2200 }, '新竹': { '苗栗': 410, '台中': 820, '彰化': 1010, '雲林': 1160, '嘉義': 1390, '台南': 1790, '左營': 2000 }, '苗栗': { '台中': 610, '彰化': 790, '雲林': 950, '嘉義': 1160, '台南': 1580, '左營': 1790 }, '台中': { '彰化': 400, '雲林': 550, '嘉義': 770, '台南': 1180, '左營': 1390 }, '彰化': { '雲林': 370, '嘉義': 580, '台南': 1000, '左營': 1210 }, '雲林': { '嘉義': 430, '台南': 830, '左營': 1040 }, '嘉義': { '台南': 620, '左營': 820 }, '台南': { '左營': 410 } },
                groupNumber: '', cowayOrderId: '', salesperson: '', booker: '卓芷伶', bookingDate: '', deadlineDate: '', passengers: [], trips: [],
                currentTripInput: { direction: '去程', date: '', trainNumber: '', carType: '標準車廂', origin: '南港', destination: '左營', depTime: '', arrTime: '', pnr: '', hsrOrderId: '', tickets: [ { type: '全票', count: 1, price: 0 } ] }
            },
            computed: {
                totalPrice() { return this.trips.reduce((sum, trip) => sum + trip.tickets.reduce((s, t) => s + (t.count * t.price), 0), 0); }
            },
            watch: {
                trips: { handler() { this.adjustScale(); }, deep: true }
            },
            methods: {
                adjustScale() {
                    this.$nextTick(() => {
                        const content = this.$refs.contentWrapper;
                        if (content) {
                            this.contentScale = 1;
                            this.$nextTick(() => {
                                const h = content.scrollHeight;
                                const maxH = 680; // A5 內容區域極限 px
                                if (h > maxH) this.contentScale = Math.max(0.6, maxH / h);
                            });
                        }
                    });
                },
                getDownloadFilename() {
                    let d = this.bookingDate ? this.bookingDate.split('-').map(s => s.slice(-2)).join('') : '000000';
                    let p = (this.trips.length > 0 && this.trips[0].pnr) ? this.trips[0].pnr : '';
                    let s = this.salesperson || '';
                    return `${d}${p}${s}`;
                },
                swapStations() {
                    const temp = this.currentTripInput.origin;
                    this.currentTripInput.origin = this.currentTripInput.destination;
                    this.currentTripInput.destination = temp;
                    this.updateInputPrices();
                },
                updatePassengerCount() {
                    const count = this.currentTripInput.tickets.reduce((sum, t) => sum + (t.count || 0), 0);
                    if (count > 10) return;
                    while(this.passengers.length < count) this.passengers.push({ name: '', id: '', passport: '', birthDate: '' });
                    while(this.passengers.length > count) this.passengers.pop();
                },
                addTicketInput() {
                    if (this.currentTripInput.tickets.reduce((sum, t) => sum + (t.count || 0), 0) >= 10) return;
                    this.currentTripInput.tickets.push({ type: '全票', count: 1, price: 0 });
                    this.updateInputPrices();
                },
                removeTicketInput(index) {
                    this.currentTripInput.tickets.splice(index, 1);
                    this.updateInputPrices();
                },
                updateInputPrices() {
                    const { carType, origin, destination, tickets } = this.currentTripInput;
                    const fares = carType === '商務車廂' ? this.businessFares : this.standardFares;
                    const getFare = (o, d) => (fares[o] && fares[o][d]) || (fares[d] && fares[d][o]) || 0;
                    const base = getFare(origin, destination);
                    tickets.forEach(t => { t.price = Math.round(t.type === '全票' ? base * (carType === '商務車廂' ? 0.9 : 0.85) : base * 0.5); });
                    this.updatePassengerCount();
                },
                addTripToList() {
                    if (this.passengers.some(p => !p.name || !p.id)) { alert("請填寫所有旅客姓名與身分證"); return; }
                    const trip = JSON.parse(JSON.stringify(this.currentTripInput));
                    trip.passengers = JSON.parse(JSON.stringify(this.passengers));
                    this.trips.push(trip);
                    if (this.currentTripInput.direction === '去程') {
                         this.currentTripInput.direction = '回程';
                         [this.currentTripInput.origin, this.currentTripInput.destination] = [this.currentTripInput.destination, this.currentTripInput.origin];
                         this.currentTripInput.depTime = ''; this.currentTripInput.arrTime = ''; this.currentTripInput.pnr = '';
                    } else {
                        this.currentTripInput.trainNumber = ''; this.currentTripInput.pnr = ''; this.currentTripInput.hsrOrderId = '';
                    }
                    this.updateInputPrices();
                },
                removeTripFromList(index) { if(confirm('確定刪除？')) this.trips.splice(index, 1); },
                getTripSubtotal(trip) { return trip.tickets.reduce((sum, t) => sum + (t.count * t.price), 0); },
                getPassengerTicketType(tickets, index) {
                    let total = 0;
                    for(let t of tickets) { total += t.count; if(index < total) return t.type; }
                    return '票種';
                },
                formatDate(dateStr) {
                    if (!dateStr) return '-';
                    const d = new Date(dateStr);
                    return `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2, '0')}/${d.getDate().toString().padStart(2, '0')}`;
                },
                formatDateShort(dateStr) { return this.formatDate(dateStr); },
                maskID(id) {
                    if (!id) return '';
                    const u = id.toUpperCase();
                    return u.length < 4 ? u : u.substring(0, 3) + '*****' + u.substring(u.length - 2);
                },
                formatPrice(v) { return (v || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); },
                generateText() {
                    let t = `【訂位確認單】\n\n訂票人員: ${this.booker}\n訂票日期: ${this.formatDate(this.bookingDate)}\nD/L: ${this.formatDate(this.deadlineDate)} 18:00前\n業務: ${this.salesperson || '-'}\n\n`;
                    this.trips.forEach(trip => {
                        t += `--- ${trip.direction} ---\n高鐵訂單: ${trip.hsrOrderId || '-'}\nPNR: ${trip.pnr || '-'}\n${this.formatDate(trip.date)}  ${trip.origin}${trip.destination}  班次${trip.trainNumber}  ${trip.depTime}-${trip.arrTime}\n\n旅客:\n`;
                        trip.passengers.forEach((p, i) => { t += `${i+1}. ${this.getPassengerTicketType(trip.tickets, i)} ${p.name} / ${this.maskID(p.id)} / ${p.birthDate || ''} / ${p.passport || ''}\n`; });
                        t += `\n`;
                    });
                    t += `--------------------------------------------------\n總計: TWD $${this.formatPrice(this.totalPrice)}`;
                    const blob = new Blob([t], { type: 'text/plain' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `${this.getDownloadFilename()}.txt`;
                    link.click();
                },
                async generatePDF() {
                    const element = this.$refs.captureArea;
                    if (!element || this.trips.length === 0) return;
                    
                    // 確保字體載入完成
                    await document.fonts.ready;
                    
                    html2canvas(element, { 
                        scale: 2, 
                        useCORS: true, 
                        backgroundColor: '#ffffff',
                        logging: false,
                        windowWidth: 1000 // 鎖定視窗寬度以穩定佈局
                    }).then(canvas => {
                        const imgData = canvas.toDataURL('image/jpeg', 0.95);
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF('p', 'mm', 'a5');
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                        pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                        pdf.save(`${this.getDownloadFilename()}.pdf`);
                    });
                },
                resetForm() {
                    if(confirm('清空？')) {
                        this.groupNumber = ''; this.cowayOrderId = ''; this.salesperson = ''; 
                        this.trips = []; this.passengers = [];
                        const d = new Date();
                        const s = d.toISOString().split('T')[0];
                        this.bookingDate = s;
                        this.currentTripInput = { direction: '去程', date: s, trainNumber: '', carType: '標準車廂', origin: '南港', destination: '左營', depTime: '', arrTime: '', pnr: '', hsrOrderId: '', tickets: [{ type: '全票', count: 1, price: 0 }] };
                        this.updateInputPrices();
                    }
                }
            },
            mounted() {
                const d = new Date();
                const s = d.toISOString().split('T')[0];
                this.bookingDate = s;
                this.currentTripInput.date = s;
                const dl = new Date(d); dl.setDate(d.getDate() + 2);
                this.deadlineDate = dl.toISOString().split('T')[0];
                this.updateInputPrices();
            }
        });
    </script>
</body>
</html>
