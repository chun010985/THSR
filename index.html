<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜éµè¨‚ä½ç¢ºèªå–®ç”Ÿæˆå™¨ - ç²¾ç·»ç‰ˆ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* =========================================
           ã€æ—¥ç³»é¢¨æ ¼æ ¸å¿ƒè¨­å®š - å…¨ç«™å…±ç”¨ã€‘
           ========================================= */
        :root {
            /* ä¸»è‰²èª¿ï¼šå‹è‰² (Kachi-iro) - æ·±æ²ˆæœ‰åŠ›çš„è—é’ */
            --j-theme-main: #2b4b6f; 
            /* å‰¯è‰²èª¿ï¼šè—é¼  (Ai-nezu) - å¸¶ç°çš„è— */
            --j-theme-sub: #6c848d; 
            /* èƒŒæ™¯è‰²ï¼šèƒ¡ç²‰ (Gofun) - æº«æ½¤çš„ç™½ */
            --j-bg-body: #f4f6f8; 
            /* å¼·èª¿è‰²ï¼šèŒœè‰² (Akane) - æ·±ç´… */
            --j-accent-red: #b94047;
            /* é‚Šæ¡†ï¼šéŠ€é¼  */
            --j-border: #d0d7de;
            
            /* åœ–æª”å°ˆç”¨èƒŒæ™¯ï¼šç´”ç™½ */
            --doc-bg: #ffffff;
        }

        /* ====================
           UI ä»‹é¢æ¨£å¼ (æ“ä½œå€)
           ==================== */
        body {
            font-family: 'Noto Sans TC', "Yu Gothic", "æ¸¸ã‚´ã‚·ãƒƒã‚¯", "Hiragino Kaku Gothic Pro", sans-serif;
            background-color: var(--j-bg-body); 
            background-image: linear-gradient(0deg, #f4f6f8 0%, #fff 100%);
            color: #2d3748;
            letter-spacing: 0.04em;
            min-height: 100vh;
        }

        /* æ—¥ç³»å¡ç‰‡é¢¨æ ¼ */
        .japanese-card {
            background: #ffffff;
            border: 1px solid #e0e6ed;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(43, 75, 111, 0.06);
            transition: all 0.3s ease;
        }
        .japanese-card:hover {
            box-shadow: 0 5px 15px rgba(43, 75, 111, 0.1);
        }

        /* æ¨™é¡Œè£é£¾ */
        .section-title {
            color: var(--j-theme-main);
            font-weight: 700;
            border-left: 4px solid var(--j-theme-main);
            padding-left: 12px;
            font-size: 1.125rem;
            letter-spacing: 0.1em;
        }

        .form-label { font-size: 0.75rem; color: #5a6a7e; margin-bottom: 0.4rem; font-weight: 700; }
        
        /* è¼¸å…¥æ¡†å„ªåŒ– */
        input, select {
            background-color: #fdfdfd; 
            border: 1px solid #cbd5e1; 
            border-radius: 4px;
            padding: 0.5rem 0.75rem; 
            font-size: 0.9rem; 
            width: 100%; 
            height: 40px; 
            color: #334155;
            transition: all 0.2s;
        }
        input:focus, select:focus { 
            border-color: var(--j-theme-main); 
            box-shadow: 0 0 0 1px var(--j-theme-main); 
            outline: none; 
            background-color: #fff;
        }
        
        /* æŒ‰éˆ•é¢¨æ ¼é‡å¡‘ */
        .btn-primary { 
            background-color: var(--j-theme-main); 
            color: #fff; 
            font-weight: 600; 
            border-radius: 4px;
            letter-spacing: 0.05em;
        }
        .btn-primary:hover:not(:disabled) { 
            background-color: #1e3652; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn-outline { 
            border: 1px solid var(--j-theme-sub); 
            color: var(--j-theme-sub); 
            background-color: white; 
            font-weight: 600; 
            border-radius: 4px; 
        }
        .btn-outline:hover { 
            background-color: #f0f4f6; 
            color: var(--j-theme-main);
            border-color: var(--j-theme-main);
        }
        
        .time-input { letter-spacing: 0.1em; text-align: center; }
        [v-cloak] { display: none; }
        
        /* é è¦½å€å®¹å™¨èƒŒæ™¯ - ä½¿ç”¨æ·±è‰²è¥¯æ‰˜ç™½ç´™ */
        .preview-wrapper {
            width: 100%;
            background-color: #6c757d; 
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.1' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
            padding: 40px 20px;
            overflow: auto;
            border-top: 1px solid #9ca3af;
            display: flex;
            justify-content: center;
            margin-top: 40px;
        }

        /* =========================================
           ã€åœ–æª”æ–‡ä»¶æœ¬é«”æ¨£å¼ - å·²ç¸®å°æ–‡å­—ã€‘
           ========================================= */
        .doc-container {
            width: 850px;
            min-width: 850px;
            background-color: var(--doc-bg); /* ç´”ç™½èƒŒæ™¯ */
            color: #2d3748;
            line-height: 1.35;
            font-family: 'Yu Gothic', 'Microsoft JhengHei', 'Hiragino Sans', sans-serif; 
            position: relative;
            box-sizing: border-box;
            padding: 40px 45px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        /* æ¨™é¡Œå€ */
        .doc-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 20px;
            border-bottom: 3px double var(--j-theme-main);
            padding-bottom: 10px;
        }
        .doc-title {
            font-size: 27px; /* åŸ 28px -1 */
            font-weight: 900;
            color: var(--j-theme-main); 
            letter-spacing: 0.2em;
            margin: 0;
            line-height: 1;
            font-family: "MS Mincho", "Hiragino Mincho Pro", serif; 
        }
        .doc-subtitle {
            font-size: 10px; /* åŸ 11px -1 */
            color: #718096;
            font-weight: 600;
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-top: 6px;
        }
        .doc-meta { text-align: right; }
        .doc-timestamp { font-size: 9px; color: #a0aec0; font-family: Consolas, monospace; } /* åŸ 10px -1 */

        /* è³‡è¨Šè¡¨é ­ */
        .info-header-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            border: 1px solid var(--j-border);
            table-layout: fixed;
            background: #fff;
        }
        .info-header-table td {
            border-right: 1px solid var(--j-border);
            padding: 8px 6px;
            vertical-align: middle;
            text-align: center;
        }
        .info-header-table td:last-child { border-right: none; }
        
        .info-header-label {
            display: block;
            font-size: 9px; /* åŸ 10px -1 */
            color: #718096;
            font-weight: 600;
            margin-bottom: 3px;
            letter-spacing: 0.05em;
        }
        .info-header-value {
            display: block;
            font-size: 11px; /* åŸ 12px -1 */
            font-weight: 800;
            color: #2d3748;
            word-break: break-all;
        }
        .text-deadline { color: var(--j-accent-red) !important; }

        /* é–‹ç¥¨èªªæ˜ */
        .notice-box {
            border: 1px dashed var(--j-theme-main); 
            background-color: #fafbfd; 
            padding: 12px 18px;
            margin-bottom: 25px;
            font-size: 10px; /* åŸ 11px -1 */
            color: #4a5568;
            border-radius: 4px;
            line-height: 1.7;
        }
        .notice-title { 
            font-weight: 900; 
            margin-bottom: 6px; 
            display: block; 
            font-size: 11px; /* åŸ 12px -1 */
            color: var(--j-theme-main);
        }
        .checkbox-symbol { 
            font-family: sans-serif; 
            margin-right: 4px; 
            font-size: 13px; /* åŸ 14px -1 */
            vertical-align: middle; 
            position: relative;
            top: -1px; 
            color: var(--j-theme-main);
        }

        /* å€å¡Šæ¨™é¡Œ */
        .doc-section-header {
            font-size: 11px; /* åŸ 12px -1 */
            font-weight: 900;
            color: #fff;
            background-color: var(--j-theme-main); 
            padding: 5px 20px;
            display: inline-block;
            margin-bottom: 0;
            border-radius: 4px 4px 0 0;
            letter-spacing: 2px;
        }

        /* è¡Œç¨‹å®¹å™¨ */
        .trip-container {
            margin-bottom: 25px;
            border: 2px solid var(--j-theme-main); 
            border-radius: 0 4px 4px 4px;
            overflow: hidden;
            background: #fff;
        }
        
        .trip-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px; /* åŸ 11px -1 */
            text-align: center;
            line-height: 1.5;
            table-layout: fixed;
        }
        /* è¡¨é ­ */
        .trip-table th {
            background-color: var(--j-theme-main); 
            color: #fff;
            font-weight: 600;
            padding: 8px 4px;
            border-right: 1px solid rgba(255,255,255,0.3);
            border-bottom: 1px solid var(--j-theme-main);
            vertical-align: middle !important;
            letter-spacing: 0.05em;
        }
        .trip-table th:last-child { border-right: none; }
        
        .trip-table td {
            background-color: #fff;
            color: #2d3748;
            padding: 8px 4px;
            border-right: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            vertical-align: middle !important;
        }
        
        /* è¨‚ä½ä»£è™Ÿç‰¹æ®Šæ¨£å¼ */
        .hsr-code {
            font-family: "Courier New", Consolas, monospace; 
            font-weight: 900; 
            color: var(--j-theme-main); 
            font-size: 12px; /* åŸ 13px -1 */
            letter-spacing: 0.05em;
        }

        /* ç¥¨åƒ¹è¨ˆç®—å€ */
        .fare-row-header th {
            background-color: #f7f9fa !important; 
            color: #64748b !important;
            font-weight: 700;
            font-size: 9px; /* åŸ 10px -1 */
            border-bottom: 1px dashed #cbd5e0 !important;
            padding: 4px;
        }
        .fare-row-data td {
            background-color: #f7f9fa !important; 
            color: #475569;
            font-family: Consolas, monospace;
            font-size: 9px; /* åŸ 10px -1 */
            padding: 4px;
            border-top: none !important;
        }
        .fare-total-price {
            font-weight: 900;
            color: var(--j-theme-main);
            font-size: 10px; /* åŸ 11px -1 */
        }

        /* æ‘˜è¦æ¢ */
        .summary-bar {
            background-color: #f1f5f9;
            padding: 6px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 10px; /* åŸ 11px -1 */
            font-weight: 700;
            color: var(--j-theme-main);
            border-top: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
        }

        /* æ—…å®¢åå–® */
        .pax-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            text-align: center;
        }
        .pax-table th {
            background-color: #e2e8f0;
            color: #475569;
            padding: 5px;
            font-weight: 800;
            border-bottom: 1px solid #cbd5e0;
            border-right: 1px solid #cbd5e0;
            font-size: 9px; /* åŸ 10px -1 */
            text-align: center;
            vertical-align: middle;
        }
        .pax-table td {
            padding: 5px;
            color: #2d3748;
            border-bottom: 1px solid #e2e8f0;
            border-right: 1px solid #e2e8f0;
            font-size: 9px; /* åŸ 10px -1 */
            text-align: center;
            vertical-align: middle;
        }

        /* åˆ†éš”ç·š - ä¿®æ”¹ç‚º 0px */
        .trip-divider {
            border-bottom: 0px dashed #cbd5e0; /* ä¿®æ”¹ç‚º 0px */
            margin: 0;
            height: 1px;
            background: none;
        }

        /* ç¸½é‡‘é¡ */
        .grand-total {
            text-align: right;
            margin-top: 30px;
            padding-top: 15px;
            border-top: 2px solid var(--j-theme-main);
        }
        .total-label { font-size: 11px; color: #64748b; font-weight: 700; margin-right: 12px; letter-spacing: 0.1em; } /* åŸ 12px -1 */
        .total-value { font-size: 31px; font-weight: 900; color: var(--j-theme-main); font-family: 'Arial', sans-serif; letter-spacing: -0.02em; } /* åŸ 32px -1 */

        /* è­¦èª */
        .warning-text {
            color: #9b2c2c;
            background-color: #fff5f5;
            border: 1px solid #fc8181;
            font-weight: 800;
            margin-top: 20px;
            margin-bottom: 15px;
            padding: 12px 18px;
            display: block;
            font-size: 11px; /* åŸ 12px -1 */
            line-height: 1.6;
            text-align: center;
            border-radius: 4px;
        }

        /* é å°¾ */
        .footer-terms {
            margin-top: 30px;
            font-size: 9px; /* åŸ 10px -1 */
            color: #64748b;
            border-top: 1px dashed #cbd5e0;
            padding-top: 20px;
            line-height: 1.8;
        }
        .footer-title { font-weight: 800; color: var(--j-theme-main); display: block; margin-bottom: 8px; font-size: 10px; letter-spacing: 0.1em; } /* åŸ 11px -1 */
        .note-item { display: flex; align-items: flex-start; margin-bottom: 3px; }
        .note-num { width: 18px; flex-shrink: 0; font-weight: 700; color: var(--j-theme-main); }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app" v-cloak class="max-w-6xl mx-auto">
        <header class="mb-10 text-center">
            <h1 class="text-3xl font-bold text-slate-700 tracking-wider font-serif">é«˜éµè¨‚ä½ç¢ºèªå–®ç”Ÿæˆå™¨</h1>
            <div class="flex items-center justify-center gap-2 mt-2">
                <span class="h-[1px] w-8 bg-slate-300"></span>
                <p class="text-slate-400 text-xs tracking-[0.2em] uppercase">Professional Slip Generator</p>
                <span class="h-[1px] w-8 bg-slate-300"></span>
            </div>
        </header>

        <div v-if="toastMsg" class="fixed top-6 left-1/2 -translate-x-1/2 z-[100] bg-slate-800 text-white px-6 py-3 rounded shadow-lg text-sm flex items-center gap-2 transition-all">
            <span class="w-2 h-2 bg-emerald-400 rounded-full"></span>{{ toastMsg }}
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
              
            <div class="lg:col-span-8 space-y-6">
                <!-- åŸºæœ¬è³‡æ–™å¡ç‰‡ -->
                <div class="japanese-card p-6 md:p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="section-title">åŸºæœ¬è³‡æ–™ç®¡ç†</h2>
                        <div class="flex gap-3">
                            <button @click="focusInput('staff')" class="text-xs text-slate-500 hover:text-blue-700 hover:underline font-bold transition">âœ ç·¨è¼¯</button>
                            <button @click="clearBasicInfo" class="text-xs text-slate-500 hover:text-red-700 hover:underline font-bold transition">ğŸ—‘ æ¸…é™¤</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                        <div class="flex flex-col"><label class="form-label">è¨‚ç¥¨äººå“¡</label><input ref="staffInput" type="text" v-model="baseInfo.staff"></div>
                        <div class="flex flex-col"><label class="form-label">è¨‚ç¥¨æ—¥æœŸ</label><input type="date" v-model="baseInfo.bookingDate"></div>
                        <div class="flex flex-col">
                            <label class="form-label text-[#b94047] font-bold">é–‹ç¥¨æœŸé™ (DL)</label>
                            <div class="flex gap-2"><input type="date" v-model="baseInfo.deadlineDate"><input type="text" v-model="baseInfo.deadlineTime" class="time-input w-24"></div>
                        </div>
                        <div class="flex flex-col"><label class="form-label">æ¥­å‹™å§“å</label><input type="text" v-model="baseInfo.sales"></div>
                        <div class="flex flex-col"><label class="form-label">è¨‚å–®ç·¨è™Ÿ</label><input type="text" v-model="baseInfo.orderId"></div>
                        <div class="flex flex-col"><label class="form-label">åœ˜é«”ä»£è™Ÿ</label><input type="text" v-model="baseInfo.groupId"></div>
                    </div>
                </div>

                <!-- è¡Œç¨‹è¨­å®šå¡ç‰‡ -->
                <div class="japanese-card p-6 md:p-8 relative">
                    <div v-if="editingIndex !== null" class="absolute top-6 right-8 bg-[#2b4b6f] text-white px-4 py-1 text-xs font-bold rounded-full shadow-md animate-pulse">ç·¨è¼¯æ¨¡å¼ä¸­</div>
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="section-title">è¡Œç¨‹è©³ç´°è¨­å®š</h2>
                        <div class="flex items-center gap-4">
                            <button @click="focusInput('hsrId')" class="btn-outline px-3 py-1 text-xs border-none font-bold">âœ ç·¨è¼¯ ID</button>
                            <button @click="clearTripForm" class="btn-outline px-3 py-1 text-xs border-none text-[#b94047] font-bold">ğŸ—‘ é‡ç½®è¡¨å–®</button>
                            
                            <!-- å–®ç¨‹/ä¾†å›åˆ‡æ›æŒ‰éˆ• -->
                            <div class="flex bg-slate-100 p-1 rounded-md ml-2 border border-slate-200">
                                <button @click="tripMode = 'one-way'" :class="tripMode === 'one-way' ? 'bg-white text-[#2b4b6f] shadow-sm' : 'text-slate-400 hover:text-slate-600'" class="px-4 py-1 text-sm font-bold transition-all rounded">å–®ç¨‹</button>
                                <button @click="tripMode = 'round-trip'" :class="tripMode === 'round-trip' ? 'bg-white text-[#2b4b6f] shadow-sm' : 'text-slate-400 hover:text-slate-600'" class="px-4 py-1 text-sm font-bold transition-all rounded">ä¾†å›</button>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-8">
                        <!-- å»ç¨‹å€å¡Š -->
                        <div class="p-5 bg-[#f8fafc] border border-slate-200 rounded-lg">
                            <span class="text-[11px] bg-[#2b4b6f] text-white px-3 py-1 rounded-sm font-bold uppercase mb-4 inline-block tracking-widest">Outbound å»ç¨‹</span>
                            <div class="grid grid-cols-1 md:grid-cols-12 gap-5">
                                <div class="md:col-span-6"><label class="form-label">é«˜éµè¨‚ä½ç·¨è™Ÿ</label><input ref="hsrIdInput" type="text" v-model="outbound.hsrOrderId" @input="syncHsrOrderId" class="font-bold tracking-widest text-[#2b4b6f]" placeholder="8ç¢¼ç·¨è™Ÿ"></div>
                                <div class="md:col-span-6"><label class="form-label">PNR ä»£ç¢¼</label><input type="text" v-model="outbound.pnr" class="uppercase font-bold tracking-widest"></div>
                                <div class="md:col-span-4"><label class="form-label">æ—¥æœŸ</label><input type="date" v-model="outbound.date"></div>
                                <div class="md:col-span-4"><label class="form-label">è‰™ç­‰</label><select v-model="outbound.carClass"><option>æ¨™æº–è»Šå»‚</option><option>å•†å‹™è»Šå»‚</option></select></div>
                                <div class="md:col-span-4"><label class="form-label">è»Šæ¬¡</label><input type="text" v-model="outbound.trainNo"></div>
                                <div class="md:col-span-6"><label class="form-label">èµ·è¨–ç«™é»</label><div class="flex gap-2 items-center"><select v-model="outbound.from"><option v-for="s in stations">{{s}}</option></select><button @click="swapStations(outbound)" class="text-slate-400 hover:text-[#2b4b6f] text-lg transition">â‡„</button><select v-model="outbound.to"><option v-for="s in stations">{{s}}</option></select></div></div>
                                <div class="md:col-span-6"><label class="form-label">æ™‚é–“ (24H)</label><div class="flex gap-2 items-center"><input type="text" v-model="outbound.depTime" class="time-input" placeholder="09:00"><span class="text-slate-400">-</span><input type="text" v-model="outbound.arrTime" class="time-input" placeholder="10:30"></div></div>
                            </div>
                        </div>

                        <!-- å›ç¨‹å€å¡Š -->
                        <div v-if="tripMode === 'round-trip'" class="p-5 bg-[#f8fafc] border border-slate-200 rounded-lg">
                            <span class="text-[11px] bg-[#6c848d] text-white px-3 py-1 rounded-sm font-bold uppercase mb-4 inline-block tracking-widest">Return å›ç¨‹</span>
                            <div class="grid grid-cols-1 md:grid-cols-12 gap-5">
                                <div class="md:col-span-6"><label class="form-label">é«˜éµè¨‚ä½ç·¨è™Ÿ</label><input type="text" v-model="returnTrip.hsrOrderId" class="text-[#2b4b6f] font-bold"></div>
                                <div class="md:col-span-6"><label class="form-label">PNR ä»£ç¢¼</label><input type="text" v-model="returnTrip.pnr" class="uppercase font-bold tracking-widest"></div>
                                <div class="md:col-span-4"><label class="form-label">æ—¥æœŸ</label><input type="date" v-model="returnTrip.date"></div>
                                <div class="md:col-span-4"><label class="form-label">è‰™ç­‰</label><select v-model="returnTrip.carClass"><option>æ¨™æº–è»Šå»‚</option><option>å•†å‹™è»Šå»‚</option></select></div>
                                <div class="md:col-span-4"><label class="form-label">è»Šæ¬¡</label><input type="text" v-model="returnTrip.trainNo"></div>
                                <div class="md:col-span-6"><label class="form-label">èµ·è¨–ç«™é»</label><div class="flex gap-2 items-center"><select v-model="returnTrip.from"><option v-for="s in stations">{{s}}</option></select><button @click="swapStations(returnTrip)" class="text-slate-400 hover:text-[#2b4b6f] text-lg transition">â‡„</button><select v-model="returnTrip.to"><option v-for="s in stations">{{s}}</option></select></div></div>
                                <div class="md:col-span-6"><label class="form-label">æ™‚é–“ (24H)</label><div class="flex gap-2 items-center"><input type="text" v-model="returnTrip.depTime" class="time-input" placeholder="18:00"><span class="text-slate-400">-</span><input type="text" v-model="returnTrip.arrTime" class="time-input" placeholder="19:30"></div></div>
                            </div>
                        </div>

                        <!-- ç¥¨æ•¸è¨­å®šå€ -->
                        <div class="bg-white p-6 border border-slate-200 rounded-lg">
                            <div class="mb-5">
                                <p class="text-xs font-bold mb-3 text-slate-600 border-b border-slate-100 pb-2">å»ç¨‹ç¥¨æ•¸è¨­å®š</p>
                                <div class="grid grid-cols-4 gap-3">
                                    <div><label class="form-label">å…¨ç¥¨</label><input type="number" v-model.number="ticketsOut.adult" min="0"></div>
                                    <div><label class="form-label">å­©ç«¥</label><input type="number" v-model.number="ticketsOut.child" min="0"></div>
                                    <div><label class="form-label">æ•¬è€</label><input type="number" v-model.number="ticketsOut.senior" min="0"></div>
                                    <div><label class="form-label">æ„›å¿ƒ</label><input type="number" v-model.number="ticketsOut.disability" min="0"></div>
                                </div>
                            </div>
                            <div v-if="tripMode === 'round-trip'" class="mb-5 border-t border-slate-100 pt-4">
                                <div class="flex justify-between items-center mb-3 border-b border-slate-100 pb-2"><p class="text-xs font-bold text-slate-600">å›ç¨‹ç¥¨æ•¸è¨­å®š</p><button @click="copyOutboundTickets" class="text-[11px] text-[#2b4b6f] hover:underline font-bold">åŒå»ç¨‹ç¥¨æ•¸</button></div>
                                <div class="grid grid-cols-4 gap-3">
                                    <div><label class="form-label">å…¨ç¥¨</label><input type="number" v-model.number="ticketsRet.adult" min="0"></div>
                                    <div><label class="form-label">å­©ç«¥</label><input type="number" v-model.number="ticketsRet.child" min="0"></div>
                                    <div><label class="form-label">æ•¬è€</label><input type="number" v-model.number="ticketsRet.senior" min="0"></div>
                                    <div><label class="form-label">æ„›å¿ƒ</label><input type="number" v-model.number="ticketsRet.disability" min="0"></div>
                                </div>
                            </div>
                            <div class="flex justify-end gap-3 mt-4 pt-4 border-t border-slate-100">
                                <button @click="openPassengerModal" :disabled="countOut === 0" class="btn-outline px-5 py-2 text-sm">ç·¨è¼¯åå–®</button>
                                <button v-if="editingIndex === null" @click="addTripToList" :disabled="isOverLimit || countOut === 0" class="btn-primary px-8 py-2 text-sm shadow-md hover:shadow-lg transition">æ–°å¢è¡Œç¨‹</button>
                                <button v-else @click="updateTripInList" class="bg-[#2b4b6f] text-white px-8 py-2 text-sm rounded shadow-md">æ›´æ–°è¡Œç¨‹</button>
                                <button v-if="editingIndex !== null" @click="cancelEdit" class="text-slate-400 text-sm px-2 hover:text-slate-600">å–æ¶ˆ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4 space-y-6">
                <div class="japanese-card p-6 sticky top-8 flex flex-col h-[85vh]">
                    <h2 class="section-title mb-4 border-b border-slate-100 pb-3">å·²ç™»éŒ„è¡Œç¨‹æ‘˜è¦</h2>
                    <div class="flex-1 overflow-y-auto space-y-3 pr-1">
                        <div v-if="addedTrips.length===0" class="flex flex-col items-center justify-center h-40 text-slate-300">
                            <span class="text-4xl mb-2">ğŸ“­</span>
                            <span class="text-sm">å°šæœªæ–°å¢ä»»ä½•è¡Œç¨‹</span>
                        </div>
                        <div v-for="(t, i) in addedTrips" :key="i" class="p-4 bg-white border border-slate-200 rounded-lg relative hover:border-[#2b4b6f] transition group shadow-sm">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-[10px] bg-[#2b4b6f] text-white px-2 py-0.5 rounded font-mono font-bold">#{{ i + 1 }}</span>
                                <div class="flex gap-3 opacity-60 group-hover:opacity-100 transition">
                                    <button @click="startEdit(i)" class="text-[#2b4b6f] text-xs font-bold hover:underline">ç·¨è¼¯</button>
                                    <button @click="removeTrip(i)" class="text-[#b94047] text-xs font-bold hover:underline">åˆªé™¤</button>
                                </div>
                            </div>
                            <p class="font-bold text-slate-700 mb-1 font-mono">ID: {{t.outbound.hsrOrderId}}</p>
                            <div class="flex justify-between text-xs text-slate-500 font-mono">
                                <span>{{t.outbound.date}}</span>
                                <span class="font-bold text-[#2b4b6f]">NT$ {{t.totalAmount.toLocaleString()}}</span>
                            </div>
                        </div>
                    </div>
                    <div class="pt-5 border-t border-slate-200 mt-auto bg-white">
                        <div class="flex justify-between items-baseline mb-4">
                            <span class="text-slate-500 font-bold text-sm">ç¸½é‡‘é¡</span>
                            <span class="text-2xl font-bold text-[#2b4b6f] font-sans">${{ totalOrderAmount.toLocaleString() }}</span>
                        </div>
                        <button @click="downloadImage" :disabled="addedTrips.length===0" class="w-full btn-primary py-3 mb-3 shadow-md font-bold text-sm flex items-center justify-center gap-2">
                             ä¸‹è¼‰åœ–ç‰‡
                        </button>
                        <div class="grid grid-cols-2 gap-3">
                            <button @click="downloadTxt" :disabled="addedTrips.length===0" class="btn-outline py-2 text-xs">ä¸‹è¼‰æ–‡å­—</button>
                            <button @click="copyText" :disabled="addedTrips.length===0" class="btn-outline py-2 text-xs">è¤‡è£½æ–‡å­—</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ—…å®¢åå–® Modal -->
        <div v-if="showPassengerModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg w-full max-w-4xl max-h-[80vh] flex flex-col shadow-2xl border border-slate-200">
                <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-[#f8fafc] rounded-t-lg">
                    <h3 class="font-bold text-slate-700 flex items-center gap-2">
                        <span class="w-1 h-4 bg-[#2b4b6f] rounded-full"></span>
                        ç·¨è¼¯æ—…å®¢è³‡æ–™
                    </h3>
                    <div class="flex bg-white border border-slate-200 rounded-md p-1">
                        <button @click="paxTab='out'" :class="{'bg-[#2b4b6f] text-white shadow-sm':paxTab==='out', 'text-slate-500 hover:bg-slate-50':paxTab!=='out'}" class="px-4 py-1 text-xs rounded transition-all font-bold">å»ç¨‹åå–®</button>
                        <button v-if="tripMode==='round-trip'" @click="paxTab='ret'" :class="{'bg-[#2b4b6f] text-white shadow-sm':paxTab==='ret', 'text-slate-500 hover:bg-slate-50':paxTab!=='ret'}" class="px-4 py-1 text-xs rounded transition-all font-bold">å›ç¨‹åå–®</button>
                    </div>
                    <button @click="showPassengerModal=false" class="text-slate-400 hover:text-slate-600 px-2 text-lg">âœ•</button>
                </div>
                <div class="p-6 overflow-y-auto flex-1 space-y-3 bg-white">
                    <div v-for="(p, i) in (paxTab==='out'?passengersOut:passengersRet)" :key="i" class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end border-b border-slate-100 pb-3 text-sm">
                        <div class="md:col-span-1 text-slate-400 font-mono text-xs font-bold pt-2">#{{i+1}}</div>
                        <div class="md:col-span-2 text-[#2b4b6f] font-bold text-xs bg-slate-50 p-1 rounded text-center">{{p.type}}</div>
                        <div class="md:col-span-2"><input v-model="p.name" placeholder="å§“å" class="text-sm h-8" @input="syncPassengerData(i, 'name')"></div>
                        <div class="md:col-span-3"><input v-model="p.idNumber" placeholder="èº«åˆ†è­‰å­—è™Ÿ" class="text-sm h-8 uppercase font-mono" @input="syncPassengerData(i, 'idNumber')"></div>
                        <div class="md:col-span-2"><input v-model="p.passportNo" placeholder="è­·ç…§è™Ÿç¢¼" class="text-sm h-8 uppercase font-mono" @input="syncPassengerData(i, 'passportNo')"></div>
                        <div class="md:col-span-2"><input type="date" v-model="p.birthday" class="text-sm h-8" @input="syncPassengerData(i, 'birthday')"></div>
                    </div>
                </div>
                <div class="p-4 border-t border-slate-100 text-right bg-[#f8fafc] rounded-b-lg">
                    <button @click="showPassengerModal=false" class="btn-primary px-8 py-2 rounded shadow-md">å®Œæˆç·¨è¼¯</button>
                </div>
            </div>
        </div>

        <!-- é è¦½å€ -->
        <div class="preview-wrapper">
            <div id="image-node" class="doc-container">
                <div class="doc-header">
                    <div>
                        <h1 class="doc-title">é«˜éµè¨‚ä½ç¢ºèªå–®</h1>
                        <div class="doc-subtitle">BOOKING CONFIRMATION</div>
                    </div>
                    <div class="doc-meta">
                        <div class="doc-timestamp">{{ nowTimestamp }}</div>
                    </div>
                </div>

                <table class="info-header-table">
                    <tr>
                        <td><span class="info-header-label">è¨‚å–®ç·¨è™Ÿ</span><span class="info-header-value">{{ baseInfo.orderId || '-' }}</span></td>
                        <td><span class="info-header-label">åœ˜è™Ÿ</span><span class="info-header-value">{{ baseInfo.groupId || 'N/A' }}</span></td>
                        <td><span class="info-header-label">æ¥­å‹™äººå“¡</span><span class="info-header-value">{{ baseInfo.sales || '-' }}</span></td>
                        <td><span class="info-header-label">è¨‚ç¥¨æ—¥æœŸ</span><span class="info-header-value">{{ baseInfo.bookingDate.replace(/-/g, '/') }}</span></td>
                        <td><span class="info-header-label">è¨‚ç¥¨äººå“¡</span><span class="info-header-value">{{ baseInfo.staff }}</span></td>
                        <td><span class="info-header-label text-deadline">é–‹ç¥¨æœŸé™(D/L)</span><span class="info-header-value text-deadline">{{ formattedDeadline }}</span></td>
                    </tr>
                </table>

                <div class="notice-box">
                    <strong class="notice-title">ã€ é–‹ç¥¨èªªæ˜ ã€‘</strong>
                    <div>è«‹æ–¼ D/L å‰é€šçŸ¥ <strong>å¯é–‹ç¥¨</strong> ä»¥åŠ <strong>å–ç¥¨æ–¹å¼</strong>ï¼›é€¾æœŸç³»çµ±å°‡è‡ªå‹•å–æ¶ˆï¼Œéœ€é‡æ–°è¨‚ç¥¨ï¼Œç„¡æ³•ä¿è­‰æ˜¯å¦æœ‰ä½ã€‚</div>
                    <div style="margin-top:4px;">
                        å–ç¥¨æ–¹å¼ï¼š<span class="checkbox-symbol">â–¢</span>ç´™æœ¬ç¥¨ã€€
                        <span class="checkbox-symbol">â–¢</span>é›»å­ç¥¨(è«‹ä½¿ç”¨å°ç£é«˜éµAPPå–ç¥¨åŠåˆ†ç¥¨)ã€€
                        <span class="checkbox-symbol">â–¢</span>è¶…å•†å–ç¥¨(æ‰‹çºŒè²»è‡ªè² )ã€€ã€€â€» æ¯ä¸€ç­†è¨‚ä½ä»£ç¢¼ç‚ºçµ±ä¸€å–ç¥¨æ–¹å¼ã€‚
                    </div>

                    <!-- æ–°å¢ï¼šæ›å¸³èªªæ˜ç§»è‡³æ­¤è™• -->
                    <div style="margin-top: 12px; padding-top: 8px; border-top: 1px dashed #cbd5e0; color: #2b6cb0;">
                        <strong>ã€ æ›å¸³èªªæ˜ ã€‘</strong>
                        <span>æ›å¸³ å…¨ç¥¨æœƒå…ˆæ› 85æŠ˜çš„åƒ¹æ ¼ï¼Œå„ªå¾…ç¥¨ï¼ˆå­©ç«¥ã€æ•¬è€ã€æ„›å¿ƒï¼‰éƒ½æ˜¯åŠåƒ¹ã€‚å¦‚æœå”®åƒ¹æœ‰èª¿æ•´éœ€è¦æ›´æ”¹è«‹å‹™å¿…é€šçŸ¥ï¼Œè¬è¬æ‚¨ã€‚</span>
                    </div>
                </div>

                <div class="doc-section-header">è¨‚ä½æ˜ç´°</div>

                <div v-for="(trip, idx) in addedTrips" :key="idx" class="trip-container">
                    <table class="trip-table">
                        <thead>
                            <tr>
                                <th style="width:8%;">è¡Œç¨‹</th>
                                <th colspan="2" style="width:20%;">é«˜éµè¨‚ä½ç·¨è™Ÿ</th>
                                <th style="width:10%;">PNR</th>
                                <th style="width:12%;">æ­ä¹˜æ—¥æœŸ</th>
                                <th style="width:10%;">è»Šæ¬¡</th>
                                <th style="width:10%;">èµ·ç¨‹è»Šç«™</th>
                                <th style="width:10%;">åˆ°é”è»Šç«™</th>
                                <th style="width:10%;">å‡ºç™¼æ™‚é–“</th>
                                <th style="width:10%;">æŠµé”æ™‚é–“</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="font-bold">å»ç¨‹</td>
                                <td colspan="2" class="hsr-code">{{ trip.outbound.hsrOrderId || '-' }}</td>
                                <td style="font-family:Consolas, monospace; font-weight:700;">{{ trip.outbound.pnr }}</td>
                                <td>{{ trip.outbound.date.replace(/-/g, '/') }}</td>
                                <td>{{ trip.outbound.trainNo }}</td>
                                <td>{{ trip.outbound.from }}</td>
                                <td>{{ trip.outbound.to }}</td>
                                <td>{{ trip.outbound.depTime }}</td>
                                <td>{{ trip.outbound.arrTime }}</td>
                            </tr>
                        </tbody>
                        
                        <tbody class="fare-row-header">
                            <tr>
                                <th colspan="2">å…¨ç¥¨</th>
                                <th colspan="2">å­©ç«¥ç¥¨</th>
                                <th colspan="2">æ„›å¿ƒç¥¨</th>
                                <th colspan="2">æ•¬è€ç¥¨</th>
                                <th colspan="2">å°è¨ˆ</th>
                            </tr>
                        </tbody>
                        <tbody class="fare-row-data">
                            <tr>
                                <td colspan="2">{{ trip.calcDetailsOut.adultStr }}</td>
                                <td colspan="2">{{ trip.calcDetailsOut.childStr }}</td>
                                <td colspan="2">{{ trip.calcDetailsOut.disabilityStr }}</td>
                                <td colspan="2">{{ trip.calcDetailsOut.seniorStr }}</td>
                                <td colspan="2" class="fare-total-price">NT${{ trip.outAmount.toLocaleString() }}</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="summary-bar">
                        <span>è»Šå»‚ï¼š{{ trip.outbound.carClass }}</span>
                        <span>ç¥¨ç¨®ï¼š{{ trip.outBreakdownText }}</span>
                    </div>

                    <table class="pax-table">
                        <thead><tr><th style="width:15%">ç¥¨ç¨®</th><th style="width:25%">å§“å</th><th style="width:35%">èº«åˆ†è­‰å­—è™Ÿ</th><th style="width:25%">è­·ç…§è™Ÿç¢¼</th></tr></thead>
                        <tbody>
                            <tr v-for="p in trip.passengersOut">
                                <td>{{ p.type }}</td><td>{{ p.name }}</td><td>{{ maskId(p.idNumber) }}</td><td>{{ p.passportNo || '' }}</td>
                            </tr>
                        </tbody>
                    </table>

                    <div v-if="trip.mode === 'round-trip'" class="trip-divider"></div>

                    <div v-if="trip.mode === 'round-trip'">
                        <table class="trip-table">
                            <thead>
                                <tr>
                                    <th style="width:8%;">è¡Œç¨‹</th><th colspan="2" style="width:20%;">é«˜éµè¨‚ä½ç·¨è™Ÿ</th><th style="width:10%;">PNR</th><th style="width:12%;">æ­ä¹˜æ—¥æœŸ</th><th style="width:10%;">è»Šæ¬¡</th><th style="width:10%;">èµ·ç¨‹è»Šç«™</th><th style="width:10%;">åˆ°é”è»Šç«™</th><th style="width:10%;">å‡ºç™¼æ™‚é–“</th><th style="width:10%;">æŠµé”æ™‚é–“</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="font-bold">å›ç¨‹</td>
                                    <td colspan="2" class="hsr-code">{{ trip.returnTrip.hsrOrderId || '-' }}</td>
                                    <td style="font-family:Consolas, monospace; font-weight:700;">{{ trip.returnTrip.pnr }}</td>
                                    <td>{{ trip.returnTrip.date.replace(/-/g, '/') }}</td><td>{{ trip.returnTrip.trainNo }}</td>
                                    <td>{{ trip.returnTrip.from }}</td><td>{{ trip.returnTrip.to }}</td>
                                    <td>{{ trip.returnTrip.depTime }}</td><td>{{ trip.returnTrip.arrTime }}</td>
                                </tr>
                            </tbody>
                            
                            <tbody class="fare-row-header">
                                <tr>
                                    <th colspan="2">å…¨ç¥¨</th>
                                    <th colspan="2">å­©ç«¥ç¥¨</th>
                                    <th colspan="2">æ„›å¿ƒç¥¨</th>
                                    <th colspan="2">æ•¬è€ç¥¨</th>
                                    <th colspan="2">å°è¨ˆ</th>
                                </tr>
                            </tbody>
                            <tbody class="fare-row-data">
                                <tr>
                                    <td colspan="2">{{ trip.calcDetailsRet.adultStr }}</td>
                                    <td colspan="2">{{ trip.calcDetailsRet.childStr }}</td>
                                    <td colspan="2">{{ trip.calcDetailsRet.disabilityStr }}</td>
                                    <td colspan="2">{{ trip.calcDetailsRet.seniorStr }}</td>
                                    <td colspan="2" class="fare-total-price">NT${{ trip.retAmount.toLocaleString() }}</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div class="summary-bar">
                            <span>è»Šå»‚ï¼š{{ trip.returnTrip.carClass }}</span>
                            <span>ç¥¨ç¨®ï¼š{{ trip.retBreakdownText }}</span>
                        </div>

                        <table class="pax-table">
                            <thead><tr><th style="width:15%">ç¥¨ç¨®</th><th style="width:25%">å§“å</th><th style="width:35%">èº«åˆ†è­‰å­—è™Ÿ</th><th style="width:25%">è­·ç…§è™Ÿç¢¼</th></tr></thead>
                            <tbody>
                                <tr v-for="p in trip.passengersRet">
                                    <td>{{ p.type }}</td><td>{{ p.name }}</td><td>{{ maskId(p.idNumber) }}</td><td>{{ p.passportNo || '' }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="grand-total">
                    <span class="total-label">ç¸½è¨ˆæ‡‰æ”¶é‡‘é¡</span>
                    <span class="total-value">NT$ {{ totalOrderAmount.toLocaleString() }}</span>
                </div>
                
                <strong class="warning-text">
                    è«‹æ¥­å‹™å€‘å‹™å¿…å†æ¬¡æ ¸å° ç¥¨ç¨®/å¼µæ•¸/é‡‘é¡ æ˜¯å¦æ­£ç¢ºï¼Œå¦‚æœ‰éŒ¯èª¤ è«‹æ–¼ã€Œå‡ºç¥¨å‰ã€å‘ŠçŸ¥ï¼Œå‡ºç¥¨å¾Œå‘ŠçŸ¥è«‹è‡ªè¡Œè² è²¬ã€‚<br>
                    é«˜éµè¨‚ç¥¨æœå‹™çª—å£æ„Ÿè¬æ‚¨çš„é…åˆã€‚
                </strong>

                <div class="footer-terms">
                    <strong class="footer-title">--- æ³¨æ„äº‹é … èˆ‡ æ”¹/é€€ç¥¨èªªæ˜ ---</strong>
                    <div class="note-item"><div class="note-num">1.</div><div class="note-text">åº§ä½çš†ç”±é›»è…¦è‡ªå‹•åŠƒä½ï¼Œæ•ç„¡æ³•æŒ‡å®šåº§ä½ï¼Œäº¦ç„¡æ³•ä¿è­‰åŒè¡Œè€…ç‚ºç›¸é„°åº§ä½ã€‚</div></div>
                    <div class="note-item"><div class="note-num">2.</div><div class="note-text">è‹¥å› é€¾æ™‚æœªèƒ½æ­ä¹˜ï¼Œè«‹è‡ªè¡Œæ´½è©¢ç«™å‹™äººå“¡æ˜¯å¦å¯æ”¹æ­ç•¶æ—¥å…¶ä»–è»Šæ¬¡ä¹‹è‡ªç”±åº§ï¼Œæ•ç„¡æ³•è¾¦ç†é€€ç¥¨ã€‚</div></div>
                    <div class="note-item"><div class="note-num">3.</div><div class="note-text">é«˜éµè»Šç¥¨é ˆæ–¼æ­ä¹˜ç•¶æ—¥ä½¿ç”¨ï¼Œé€¾æœŸè¦–åŒå»¢ç¥¨ï¼Œæ•ä¸å—ç†é€€ç¥¨ã€‚</div></div>
                    <div class="note-item"><div class="note-num">4.</div><div class="note-text">å¦‚éœ€è¾¦ç†æ”¹ç¥¨/é€€ç¥¨ï¼Œè«‹æ–¼ <strong>4å€‹å·¥ä½œæ—¥å‰</strong> ç”³è«‹ï¼Œä¸¦æä¾›ç´™æœ¬ç¥¨æ ¹æˆ– APP é›»å­ç¥¨æˆªåœ–(å¤©ç½å°è‡´é«˜éµåœé§›è€…ä¸åœ¨æ­¤é™)ã€‚</div></div>
                    <div class="note-item"><div class="note-num">5.</div><div class="note-text">é€€ç¥¨å°‡é…Œæ”¶æ‰‹çºŒè²» æ¯å¼µæ–°å°å¹£ 50 å…ƒã€‚</div></div>
                    <div class="note-item"><div class="note-num">6.</div><div class="note-text">è¾¦ç†æ”¹ç¥¨/é€€ç¥¨æ™‚ï¼Œè«‹å‹™å¿…æä¾› ç´™æœ¬ç¥¨æ ¹æˆ–é›»å­ç¥¨(APP æˆªåœ–)ï¼Œæœªæä¾›è€…å°‡è¦–åŒæ­£å¸¸æ­ä¹˜ï¼Œç›¸é—œè²»ç”¨é ˆè‡ªè¡Œè² æ“”ã€‚</div></div>
                    <div class="note-item"><div class="note-num">7.</div><div class="note-text">å› èˆªç­å»¶èª¤æˆ–å–æ¶ˆç­‰éé«˜éµå› ç´ è‡´ç„¡æ³•æ­ä¹˜è€…ï¼Œè»Šç¥¨ æ•ç„¡æ³•æ”¹æœŸæˆ–é€€ç¥¨ï¼Œæ•¬è«‹è¦‹è«’ã€‚</div></div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, reactive, computed, watch, onMounted } = Vue;

        createApp({
            setup() {
                const stations = ['å—æ¸¯', 'å°åŒ—', 'æ¿æ©‹', 'æ¡ƒåœ’', 'æ–°ç«¹', 'è‹—æ —', 'å°ä¸­', 'å½°åŒ–', 'é›²æ—', 'å˜‰ç¾©', 'å°å—', 'å·¦ç‡Ÿ'];
                const tripMode = ref('one-way');
                const paxTab = ref('out');
                const showPassengerModal = ref(false);
                const toastMsg = ref('');
                const addedTrips = ref([]);
                const editingIndex = ref(null);
                
                const staffInput = ref(null);
                const hsrIdInput = ref(null);

                // 2026 å®Œæ•´å®˜æ–¹ç¥¨åƒ¹ (å«å•†å‹™)
                const fareRules = {
                    standard: {
                        'å—æ¸¯': { 'å°åŒ—': 40, 'æ¿æ©‹': 70, 'æ¡ƒåœ’': 200, 'æ–°ç«¹': 330, 'è‹—æ —': 470, 'å°ä¸­': 740, 'å½°åŒ–': 860, 'é›²æ—': 970, 'å˜‰ç¾©': 1120, 'å°å—': 1390, 'å·¦ç‡Ÿ': 1530 },
                        'å°åŒ—': { 'æ¿æ©‹': 40, 'æ¡ƒåœ’': 160, 'æ–°ç«¹': 290, 'è‹—æ —': 430, 'å°ä¸­': 700, 'å½°åŒ–': 820, 'é›²æ—': 930, 'å˜‰ç¾©': 1080, 'å°å—': 1350, 'å·¦ç‡Ÿ': 1490 },
                        'æ¿æ©‹': { 'æ¡ƒåœ’': 130, 'æ–°ç«¹': 260, 'è‹—æ —': 400, 'å°ä¸­': 670, 'å½°åŒ–': 790, 'é›²æ—': 900, 'å˜‰ç¾©': 1050, 'å°å—': 1320, 'å·¦ç‡Ÿ': 1460 },
                        'æ¡ƒåœ’': { 'æ–°ç«¹': 130, 'è‹—æ —': 280, 'å°ä¸­': 540, 'å½°åŒ–': 670, 'é›²æ—': 780, 'å˜‰ç¾©': 920, 'å°å—': 1190, 'å·¦ç‡Ÿ': 1330 },
                        'æ–°ç«¹': { 'è‹—æ —': 140, 'å°ä¸­': 410, 'å½°åŒ–': 540, 'é›²æ—': 640, 'å˜‰ç¾©': 790, 'å°å—': 1060, 'å·¦ç‡Ÿ': 1200 },
                        'è‹—æ —': { 'å°ä¸­': 270, 'å½°åŒ–': 390, 'é›²æ—': 500, 'å˜‰ç¾©': 640, 'å°å—': 920, 'å·¦ç‡Ÿ': 1060 },
                        'å°ä¸­': { 'å½°åŒ–': 130, 'é›²æ—': 230, 'å˜‰ç¾©': 380, 'å°å—': 650, 'å·¦ç‡Ÿ': 790 },
                        'å½°åŒ–': { 'é›²æ—': 110, 'å˜‰ç¾©': 250, 'å°å—': 530, 'å·¦ç‡Ÿ': 670 },
                        'é›²æ—': { 'å˜‰ç¾©': 150, 'å°å—': 420, 'å·¦ç‡Ÿ': 560 },
                        'å˜‰ç¾©': { 'å°å—': 280, 'å·¦ç‡Ÿ': 410 },
                        'å°å—': { 'å·¦ç‡Ÿ': 140 }
                    },
                    business: {
                        'å—æ¸¯': { 'å°åŒ—': 260, 'æ¿æ©‹': 310, 'æ¡ƒåœ’': 500, 'æ–°ç«¹': 700, 'è‹—æ —': 920, 'å°ä¸­': 1330, 'å½°åŒ–': 1510, 'é›²æ—': 1660, 'å˜‰ç¾©': 1880, 'å°å—': 2290, 'å·¦ç‡Ÿ': 2500 },
                        'å°åŒ—': { 'æ¿æ©‹': 260, 'æ¡ƒåœ’': 440, 'æ–°ç«¹': 640, 'è‹—æ —': 850, 'å°ä¸­': 1250, 'å½°åŒ–': 1430, 'é›²æ—': 1600, 'å˜‰ç¾©': 1820, 'å°å—': 2230, 'å·¦ç‡Ÿ': 2440 },
                        'æ¿æ©‹': { 'æ¡ƒåœ’': 400, 'æ–°ç«¹': 590, 'è‹—æ —': 800, 'å°ä¸­': 1210, 'å½°åŒ–': 1390, 'é›²æ—': 1550, 'å˜‰ç¾©': 1780, 'å°å—': 2180, 'å·¦ç‡Ÿ': 2390 },
                        'æ¡ƒåœ’': { 'æ–°ç«¹': 400, 'è‹—æ —': 620, 'å°ä¸­': 1010, 'å½°åŒ–': 1210, 'é›²æ—': 1370, 'å˜‰ç¾©': 1580, 'å°å—': 1990, 'å·¦ç‡Ÿ': 2200 },
                        'æ–°ç«¹': { 'è‹—æ —': 410, 'å°ä¸­': 820, 'å½°åŒ–': 1010, 'é›²æ—': 1160, 'å˜‰ç¾©': 1390, 'å°å—': 1790, 'å·¦ç‡Ÿ': 2000 },
                        'è‹—æ —': { 'å°ä¸­': 610, 'å½°åŒ–': 790, 'é›²æ—': 950, 'å˜‰ç¾©': 1160, 'å°å—': 1580, 'å·¦ç‡Ÿ': 1790 },
                        'å°ä¸­': { 'å½°åŒ–': 400, 'é›²æ—': 550, 'å˜‰ç¾©': 770, 'å°å—': 1180, 'å·¦ç‡Ÿ': 1390 },
                        'å½°åŒ–': { 'é›²æ—': 370, 'å˜‰ç¾©': 580, 'å°å—': 1000, 'å·¦ç‡Ÿ': 1210 },
                        'é›²æ—': { 'å˜‰ç¾©': 430, 'å°å—': 830, 'å·¦ç‡Ÿ': 1040 },
                        'å˜‰ç¾©': { 'å°å—': 620, 'å·¦ç‡Ÿ': 820 },
                        'å°å—': { 'å·¦ç‡Ÿ': 410 }
                    }
                };

                const baseInfo = reactive({ staff: 'é™³ä¾‘å›', bookingDate: new Date().toISOString().split('T')[0], deadlineDate: '', deadlineTime: '18:00', sales: '', orderId: '', groupId: '' });
                const outbound = reactive({ hsrOrderId: '', pnr: '', date: '', carClass: 'æ¨™æº–è»Šå»‚', from: 'å°åŒ—', to: 'å·¦ç‡Ÿ', trainNo: '', depTime: '09:00', arrTime: '10:34' });
                const returnTrip = reactive({ hsrOrderId: '', pnr: '', date: '', carClass: 'æ¨™æº–è»Šå»‚', from: 'å·¦ç‡Ÿ', to: 'å°åŒ—', trainNo: '', depTime: '18:00', arrTime: '19:34' });
                const ticketsOut = reactive({ adult: 0, child: 0, senior: 0, disability: 0 });
                const ticketsRet = reactive({ adult: 0, child: 0, senior: 0, disability: 0 });
                const passengersOut = ref([]);
                const passengersRet = ref([]);

                const showToast = (msg) => { toastMsg.value = msg; setTimeout(() => { toastMsg.value = ''; }, 3000); };
                const focusInput = (name) => {
                      if(name==='staff' && staffInput.value) staffInput.value.focus();
                      if(name==='hsrId' && hsrIdInput.value) hsrIdInput.value.focus();
                };

                const calculateDeadline = () => {
                    if (!baseInfo.bookingDate) return;
                    const bDate = new Date(baseInfo.bookingDate);
                    let dDate = new Date(bDate); dDate.setDate(bDate.getDate() + 2);
                    const day = bDate.getDay(); 
                    const diff = day <= 5 ? 5-day : 5+(7-day);
                    const friday = new Date(bDate); friday.setDate(bDate.getDate() + diff);
                    const final = dDate > friday ? friday : dDate;
                    baseInfo.deadlineDate = final.toISOString().split('T')[0];
                };

                const syncHsrOrderId = () => { if (tripMode.value === 'round-trip') returnTrip.hsrOrderId = outbound.hsrOrderId; };
                const swapStations = (t) => { const tmp = t.from; t.from = t.to; t.to = tmp; };
                const clearBasicInfo = () => { if(confirm('æ¸…é™¤åŸºæœ¬è³‡æ–™?')) { baseInfo.sales=''; baseInfo.orderId=''; baseInfo.groupId=''; } };
                const clearTripForm = () => { if(confirm('é‡ç½®è¡Œç¨‹è¡¨å–®?')) { outbound.pnr=''; ticketsOut.adult=0; passengersOut.value=[]; } };
                const copyOutboundTickets = () => { Object.assign(ticketsRet, JSON.parse(JSON.stringify(ticketsOut))); };

                // ç¥¨åƒ¹è¨ˆç®— (é¡¯ç¤ºç®—å¼)
                const getCalcDetails = (trip, tks) => {
                    const matrix = trip.carClass === 'å•†å‹™è»Šå»‚' ? fareRules.business : fareRules.standard;
                    const base = matrix[trip.from]?.[trip.to] || matrix[trip.to]?.[trip.from] || 0;
                    const disc = trip.carClass === 'å•†å‹™è»Šå»‚' ? 0.9 : 0.85;
                    const full = Math.round(base * disc);
                    const half = Math.round(base * 0.5);
                    return {
                        adultStr: tks.adult > 0 ? `${full}*${tks.adult}` : '',
                        childStr: tks.child > 0 ? `${half}*${tks.child}` : '',
                        seniorStr: tks.senior > 0 ? `${half}*${tks.senior}` : '',
                        disabilityStr: tks.disability > 0 ? `${half}*${tks.disability}` : ''
                    };
                };

                const getFare = (trip) => {
                    const matrix = trip.carClass === 'å•†å‹™è»Šå»‚' ? fareRules.business : fareRules.standard;
                    return matrix[trip.from]?.[trip.to] || matrix[trip.to]?.[trip.from] || 0;
                };

                const calcTotal = (trip, tks) => {
                    const base = getFare(trip);
                    const disc = trip.carClass === 'å•†å‹™è»Šå»‚' ? 0.9 : 0.85;
                    return (tks.adult * Math.round(base*disc)) + ((tks.child + tks.senior + tks.disability) * Math.round(base*0.5));
                };

                const getBreakdownText = (tks) => {
                    let p = [];
                    if(tks.adult) p.push(`å…¨ç¥¨ ${tks.adult} å¼µ`);
                    if(tks.child) p.push(`å­©ç«¥ç¥¨ ${tks.child} å¼µ`);
                    if(tks.senior) p.push(`æ•¬è€ç¥¨ ${tks.senior} å¼µ`);
                    if(tks.disability) p.push(`æ„›å¿ƒç¥¨ ${tks.disability} å¼µ`);
                    return p.join('ï½œ');
                };

                const addTripToList = () => {
                    addedTrips.value.push({
                        mode: tripMode.value,
                        outbound: { ...outbound }, returnTrip: { ...returnTrip },
                        ticketsOut: { ...ticketsOut }, ticketsRet: { ...ticketsRet },
                        passengersOut: JSON.parse(JSON.stringify(passengersOut.value)),
                        passengersRet: JSON.parse(JSON.stringify(passengersRet.value)),
                        outAmount: calcTotal(outbound, ticketsOut),
                        retAmount: tripMode.value === 'round-trip' ? calcTotal(returnTrip, ticketsRet) : 0,
                        totalAmount: calcTotal(outbound, ticketsOut) + (tripMode.value==='round-trip' ? calcTotal(returnTrip, ticketsRet) : 0),
                        calcDetailsOut: getCalcDetails(outbound, ticketsOut),
                        calcDetailsRet: getCalcDetails(returnTrip, ticketsRet),
                        outBreakdownText: getBreakdownText(ticketsOut),
                        retBreakdownText: getBreakdownText(ticketsRet)
                    });
                    showToast("å·²æ–°å¢");
                };

                const updateTripInList = () => {
                    const idx = editingIndex.value;
                    const oAmt = calcTotal(outbound, ticketsOut);
                    const rAmt = tripMode.value === 'round-trip' ? calcTotal(returnTrip, ticketsRet) : 0;
                    addedTrips.value[idx] = {
                        mode: tripMode.value, outbound: {...outbound}, returnTrip: {...returnTrip},
                        ticketsOut: {...ticketsOut}, ticketsRet: {...ticketsRet},
                        passengersOut: JSON.parse(JSON.stringify(passengersOut.value)),
                        passengersRet: JSON.parse(JSON.stringify(passengersRet.value)),
                        outAmount: oAmt, retAmount: rAmt, totalAmount: oAmt + rAmt,
                        calcDetailsOut: getCalcDetails(outbound, ticketsOut),
                        calcDetailsRet: getCalcDetails(returnTrip, ticketsRet),
                        outBreakdownText: getBreakdownText(ticketsOut),
                        retBreakdownText: getBreakdownText(ticketsRet)
                    };
                    editingIndex.value = null; showToast("å·²æ›´æ–°");
                };

                const startEdit = (idx) => {
                    editingIndex.value = idx; const t = addedTrips.value[idx];
                    tripMode.value = t.mode; Object.assign(outbound, t.outbound); Object.assign(returnTrip, t.returnTrip);
                    Object.assign(ticketsOut, t.ticketsOut); Object.assign(ticketsRet, t.ticketsRet);
                    passengersOut.value = JSON.parse(JSON.stringify(t.passengersOut)); passengersRet.value = JSON.parse(JSON.stringify(t.passengersRet));
                };

                const cancelEdit = () => { editingIndex.value = null; };
                const removeTrip = (i) => addedTrips.value.splice(i, 1);
                const openPassengerModal = () => showPassengerModal.value = true;
                const syncPassengerData = (i, f) => { if(paxTab.value==='out' && tripMode.value==='round-trip' && passengersRet.value[i]) passengersRet.value[i][f] = passengersOut.value[i][f]; };

                const countOut = computed(() => ticketsOut.adult + ticketsOut.child + ticketsOut.senior + ticketsOut.disability);
                const countRet = computed(() => ticketsRet.adult + ticketsRet.child + ticketsRet.senior + ticketsRet.disability);
                const isOverLimit = computed(() => countOut.value > 10 || countRet.value > 10);
                const totalOrderAmount = computed(() => addedTrips.value.reduce((s,t) => s + t.totalAmount, 0));
                const formattedDeadline = computed(() => `${baseInfo.deadlineDate.replace(/-/g,'/')} ${baseInfo.deadlineTime}`);
                const nowTimestamp = computed(() => new Date().toLocaleString('zh-TW', { hour12: false }));

                watch(ticketsOut, (v) => syncPaxList(passengersOut, v.adult+v.child+v.senior+v.disability, v), { deep: true });
                watch(ticketsRet, (v) => syncPaxList(passengersRet, v.adult+v.child+v.senior+v.disability, v), { deep: true });
                watch(() => baseInfo.bookingDate, calculateDeadline);
                watch(passengersOut, (val) => {
                    if (tripMode.value === 'round-trip') {
                        val.forEach((p, i) => {
                            if (passengersRet.value[i] && !passengersRet.value[i].isDirty) {
                                Object.assign(passengersRet.value[i], { name: p.name, idNumber: p.idNumber, passportNo: p.passportNo, birthday: p.birthday });
                            }
                        });
                    }
                }, { deep: true });

                const syncPaxList = (list, count, tks) => {
                    if (count > list.value.length) for(let i=list.value.length; i<count; i++) list.value.push({type:'', name:'', idNumber:'', passportNo:'', isDirty: false});
                    else if (count < list.value.length) list.value.splice(count);
                    let idx = 0;
                    [{n: tks.adult, t:'å…¨ç¥¨'}, {n: tks.child, t:'å­©ç«¥ç¥¨'}, {n: tks.senior, t:'æ•¬è€ç¥¨'}, {n: tks.disability, t:'æ„›å¿ƒç¥¨'}].forEach(grp => {
                        for(let k=0; k<grp.n; k++) { if(list.value[idx]) list.value[idx].type = grp.t; idx++; }
                    });
                };

                const maskId = (id) => id ? (id.length > 6 ? id.slice(0,3) + '*****' + id.slice(-4) : id) : '';

                const downloadImage = () => {
                    const node = document.getElementById('image-node');
                    // ç¢ºä¿åœ–æª”èƒŒæ™¯ç‚ºç´”ç™½
                    html2canvas(node, { scale: 3, backgroundColor: '#ffffff' }).then(canvas => {
                        const a = document.createElement('a'); a.href = canvas.toDataURL("image/png");
                        a.download = `${baseInfo.orderId}_${baseInfo.sales}_é«˜éµç¢ºèªå–®.png`; a.click();
                        showToast("åœ–æª”ä¸‹è¼‰æˆåŠŸ");
                    });
                };

                const copyText = () => {
                    let txt = `ã€é«˜éµè¨‚ä½ç¢ºèªå–®ã€‘\n\næ¥­å‹™å§“åï¼š${baseInfo.sales}\nè¨‚å–®ç·¨è™Ÿï¼š${baseInfo.orderId}ã€€\nåœ˜é«”ä»£è™Ÿï¼š${baseInfo.groupId}\t\né–‹ç¥¨äººå“¡ï¼š${baseInfo.staff}\n\né–‹ç¥¨æœŸé™ï¼š${formattedDeadline.value}\n\né–‹ç¥¨èªªæ˜ï¼š\nè«‹æ–¼D/Lå‰é€šçŸ¥ å¯é–‹ç¥¨ èˆ‡ å–ç¥¨æ–¹å¼\né€¾æœŸå°‡è‡ªå‹•å–æ¶ˆéœ€é‡æ–°è¨‚ç¥¨\næ¯ç­†è¨‚ä½ä»£ç¢¼,çµ±ä¸€å–ç¥¨æ–¹å¼\n\næ›å¸³èªªæ˜ï¼š\næ›å¸³å…¨ç¥¨æœƒå…ˆæ›85æŠ˜çš„åƒ¹æ ¼,å„ªå¾…ç¥¨(å­©ç«¥ã€æ•¬è€ã€æ„›å¿ƒ)éƒ½æ˜¯åŠåƒ¹ã€‚å¦‚æœå”®åƒ¹æœ‰èª¿æ•´éœ€è¦æ›´æ”¹å†è«‹é€šçŸ¥å”· è¬è¬\n\nè«‹æ¥­å‹™å€‘å‹™å¿…å†æ¬¡æ ¸å° ç¥¨ç¨®/å¼µæ•¸/é‡‘é¡ æ˜¯å¦æ­£ç¢ºï¼Œå¦‚æœ‰éŒ¯èª¤ è«‹æ–¼ã€Œå‡ºç¥¨å‰ã€å‘ŠçŸ¥ï¼Œå‡ºç¥¨å¾Œå‘ŠçŸ¥è«‹è‡ªè¡Œè² è²¬ã€‚\né«˜éµè¨‚ç¥¨æœå‹™çª—å£æ„Ÿè¬æ‚¨çš„é…åˆã€‚\n\n`;
                    addedTrips.value.forEach((t, i) => {
                        txt += `[è¡Œç¨‹ç´€éŒ„ #${i+1}]\n\n`;
                        txt += `å»ç¨‹ï½œPNR ${t.outbound.pnr}\n${t.outbound.date}ã€€${t.outbound.from}/${t.outbound.to}  ç­æ¬¡${t.outbound.trainNo}ã€€${t.outbound.depTime}-${t.outbound.arrTime}\nç¥¨æ•¸ï¼š${t.outBreakdownText} ($${t.outAmount.toLocaleString()})\n\n`;
                        if (t.mode === 'round-trip') {
                            txt += `å›ç¨‹ï½œPNR ${t.returnTrip.pnr}\n${t.returnTrip.date}ã€€${t.returnTrip.from}/${t.returnTrip.to}  ç­æ¬¡${t.returnTrip.trainNo}ã€€${t.returnTrip.depTime}-${t.returnTrip.arrTime}\nç¥¨æ•¸ï¼š${t.retBreakdownText} ($${t.retAmount.toLocaleString()})\n\n`;
                        }
                    });
                    txt += `ç¸½è¨ˆæ‡‰æ”¶é‡‘é¡ï¼šNT$ ${totalOrderAmount.value.toLocaleString()}\n\n---æ³¨æ„äº‹é …èˆ‡æ”¹/é€€ç¥¨èªªæ˜---\n1. åº§ä½çš†ç”±é›»è…¦è‡ªå‹•åŠƒä½,æ•ç„¡æ³•æŒ‡å®šåº§ä½,äº¦ç„¡æ³•ä¿è­‰åŒè¡Œè€…ç‚ºç›¸é„°åº§ä½ã€‚\n2. è‹¥å› é€¾æ™‚æœªèƒ½æ­ä¹˜,è«‹è‡ªè¡Œæ´½è©¢ç«™å‹™äººå“¡æ˜¯å¦å¯æ”¹æ­ç•¶æ—¥å…¶ä»–è»Šæ¬¡ä¹‹è‡ªç”±åº§,æ•ç„¡æ³•è¾¦ç†é€€ç¥¨ã€‚\n3. é«˜éµè»Šç¥¨é ˆæ–¼æ­ä¹˜ç•¶æ—¥ä½¿ç”¨,é€¾æœŸè¦–åŒå»¢ç¥¨,æ•ä¸å—ç†é€€ç¥¨ã€‚\n4. å¦‚éœ€è¾¦ç†æ”¹ç¥¨/é€€ç¥¨,è«‹æ–¼ 4å€‹å·¥ä½œæ—¥å‰ ç”³è«‹,ä¸¦æä¾›ç´™æœ¬ç¥¨æ ¹æˆ– APP é›»å­ç¥¨æˆªåœ–(å¤©ç½å°è‡´é«˜éµåœé§›è€…ä¸åœ¨æ­¤é™)ã€‚\n5. é€€ç¥¨å°‡é…Œæ”¶æ‰‹çºŒè²» æ¯å¼µæ–°å°å¹£ 50 å…ƒã€‚\n6. è¾¦ç†æ”¹ç¥¨/é€€ç¥¨æ™‚,è«‹å‹™å¿…æä¾› ç´™æœ¬ç¥¨æ ¹æˆ–é›»å­ç¥¨(APP æˆªåœ–),æœªæä¾›è€…å°‡è¦–åŒæ­£å¸¸æ­ä¹˜,ç›¸é—œè²»ç”¨é ˆè‡ªè¡Œè² æ“”ã€‚\n7. å› èˆªç­å»¶èª¤æˆ–å–æ¶ˆç­‰éé«˜éµå› ç´ è‡´ç„¡æ³•æ­ä¹˜è€…,è»Šç¥¨ æ•ç„¡æ³•æ”¹æœŸæˆ–é€€ç¥¨,æ•¬è«‹è¦‹è«’ã€‚`;
                    const el = document.createElement('textarea'); el.value = txt; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
                    showToast("æ–‡å­—ç¯„æœ¬å·²è¤‡è£½");
                };
                
                const downloadTxt = () => {
                    const blob = new Blob([document.querySelector('textarea')?.value || 'è«‹å…ˆé»é¸è¤‡è£½æ–‡å­—'], { type: 'text/plain' });
                    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                    a.download = `${baseInfo.orderId}_ç¢ºèªç¯„æœ¬.txt`; a.click();
                };
                
                const resetCurrentTripForm = () => {
                    if(confirm('é‡ç½®è¡Œç¨‹è¡¨å–®?')) { outbound.pnr=''; ticketsOut.adult=0; passengersOut.value=[]; }
                };

                const handleHsrIdInput = () => {
                      if (tripMode.value === 'round-trip') returnTrip.hsrOrderId = outbound.hsrOrderId;
                };

                onMounted(calculateDeadline);

                return {
                    baseInfo, outbound, returnTrip, ticketsOut, ticketsRet, addedTrips, tripMode, stations, maskId,
                    countOut, countRet, isOverLimit, showPassengerModal, paxTab, passengersOut, passengersRet,
                    totalOrderAmount, formattedDeadline, editingIndex, toastMsg, nowTimestamp: new Date().toLocaleString(),
                    addTripToList, updateTripInList, startEdit, cancelEdit, removeTrip,
                    openPassengerModal, copyOutboundTickets, downloadImage, copyText, downloadTxt, clearBasicInfo, 
                    clearTripForm: resetCurrentTripForm, syncHsrOrderId, swapStations, focusInput, staffInput, hsrIdInput, syncPassengerData,
                    resetCurrentTripForm, handleHsrIdInput
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
