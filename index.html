<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高鐵訂位確認單生成器 - 專業版</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Google Fonts: Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f7f7f5; 
            color: #374151;
            letter-spacing: 0.02em;
        }
        .japanese-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }
        .form-label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 0.35rem;
            font-weight: 600;
        }
        input, select {
            background-color: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 0.6rem;
            font-size: 0.875rem;
            outline: none;
            transition: all 0.2s;
            width: 100%;
        }
        input:focus, select:focus {
            background-color: #ffffff;
            border-color: #4b5563;
            box-shadow: 0 0 0 2px rgba(156, 163, 175, 0.2);
        }
        .btn-primary {
            background-color: #1f2937;
            color: #ffffff;
            font-weight: 500;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #111827;
        }
        .btn-update {
            background-color: #78350f;
            color: #ffffff;
        }
        .btn-outline {
            border: 1px solid #374151;
            color: #374151;
            background-color: transparent;
        }
        .btn-outline:hover:not(:disabled) {
            background-color: #f3f4f6;
        }
        .time-input {
            letter-spacing: 0.1em;
            text-align: center;
        }
        .tab-active {
            border-bottom: 3px solid #1f2937;
            color: #111827;
        }
        .tab-inactive {
            color: #9ca3af;
        }
        [v-cloak] { display: none; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        
        #capture-area-container {
            position: absolute;
            left: -9999px;
            top: 0;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app" v-cloak class="max-w-7xl mx-auto">
        
        <header class="mb-10 text-center">
            <h1 class="text-2xl font-light tracking-[0.3em] text-gray-800 uppercase border-b border-gray-200 inline-block pb-2">高鐵訂位確認單生成系統</h1>
            <p class="text-[10px] text-gray-400 mt-2 tracking-widest">HSR BOOKING CONFIRMATION GENERATOR v2.1</p>
        </header>

        <div v-if="toastMsg" class="fixed top-6 left-1/2 -translate-x-1/2 z-[100] bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl text-xs flex items-center gap-3">
            <span class="font-medium">{{ toastMsg }}</span>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            
            <div class="lg:col-span-8 space-y-8">
                <div class="japanese-card p-6 md:p-8">
                    <div class="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
                        <div class="flex items-center gap-3 font-bold text-gray-700">
                            <span class="w-1.5 h-6 bg-gray-800 rounded-full"></span>
                            <h2 class="text-lg tracking-tight">基本資料管理</h2>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="flex flex-col">
                            <label class="form-label">訂票專員</label>
                            <input type="text" v-model="baseInfo.staff" placeholder="請輸入姓名">
                        </div>
                        <div class="flex flex-col">
                            <label class="form-label">訂票日期</label>
                            <input type="date" v-model="baseInfo.bookingDate">
                        </div>
                        <div class="flex flex-col">
                            <label class="form-label text-red-600 font-bold">開票期限 (DeadLine)</label>
                            <div class="flex gap-2">
                                <input type="date" v-model="baseInfo.deadlineDate" class="flex-[2] border-red-200 bg-red-50/30">
                                <input type="text" v-model="baseInfo.deadlineTime" class="flex-1 time-input border-red-200 bg-red-50/30" maxlength="5">
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <label class="form-label">業務姓名</label>
                            <input type="text" v-model="baseInfo.sales" placeholder="請輸入業務姓名">
                        </div>
                        <div class="flex flex-col">
                            <label class="form-label">訂單編號 (Order ID)</label>
                            <input type="text" v-model="baseInfo.orderId" placeholder="例如: 04030655">
                        </div>
                        <div class="flex flex-col">
                            <label class="form-label">團體代號 (Group ID)</label>
                            <input type="text" v-model="baseInfo.groupId">
                        </div>
                    </div>
                </div>

                <div class="japanese-card p-6 md:p-8 relative">
                    <div v-if="editingIndex !== null" class="absolute -top-3 left-8 bg-amber-500 text-white px-4 py-1 text-[10px] font-bold rounded shadow-lg">編輯模式中</div>
                    
                    <div class="flex justify-between items-center mb-8 border-b border-gray-100 pb-4">
                        <div class="flex items-center gap-3 font-bold text-gray-700">
                            <span class="w-1.5 h-6 bg-gray-800 rounded-full"></span>
                            <h2 class="text-lg tracking-tight">行程詳細設定</h2>
                        </div>
                        <div class="flex bg-gray-100 p-1 rounded-lg">
                            <button @click="tripMode = 'one-way'" :class="tripMode === 'one-way' ? 'bg-white shadow text-gray-800' : 'text-gray-400'" class="px-4 py-1.5 text-xs font-bold transition-all rounded-md">單程</button>
                            <button @click="tripMode = 'round-trip'" :class="tripMode === 'round-trip' ? 'bg-white shadow text-gray-800' : 'text-gray-400'" class="px-4 py-1.5 text-xs font-bold transition-all rounded-md">來回</button>
                        </div>
                    </div>

                    <div class="space-y-8">
                        <div>
                            <div class="flex items-center gap-2 mb-4"><span class="bg-gray-800 text-white text-[10px] px-2 py-0.5 rounded font-mono">STEP 01</span><span class="text-sm font-bold text-gray-600">去程段設定</span></div>
                            <div class="grid grid-cols-1 md:grid-cols-12 gap-5">
                                <div class="md:col-span-4"><label class="form-label">高鐵訂單號</label><input type="text" v-model="outbound.hsrOrderId" @input="syncOrderId"></div>
                                <div class="md:col-span-4"><label class="form-label font-bold text-gray-800">PNR 代碼</label><input type="text" v-model="outbound.pnr" class="font-bold tracking-widest uppercase text-gray-800"></div>
                                <div class="md:col-span-4"><label class="form-label">乘車日期</label><input type="date" v-model="outbound.date"></div>
                                <div class="md:col-span-3">
                                    <label class="form-label">車廂艙等</label>
                                    <select v-model="outbound.carClass">
                                        <option value="標準車廂">標準車廂</option>
                                        <option value="商務車廂">商務車廂</option>
                                    </select>
                                </div>
                                <div class="md:col-span-3"><label class="form-label">車次</label><input type="text" v-model="outbound.trainNo"></div>
                                <div class="md:col-span-3">
                                    <label class="form-label">區間</label>
                                    <div class="flex items-center gap-1">
                                        <select v-model="outbound.from" class="text-xs"><option v-for="s in stations" :value="s">{{s}}</option></select>
                                        <select v-model="outbound.to" class="text-xs"><option v-for="s in stations" :value="s">{{s}}</option></select>
                                    </div>
                                </div>
                                <div class="md:col-span-3"><label class="form-label">時間</label><div class="flex items-center gap-1"><input type="text" v-model="outbound.depTime" class="time-input text-xs"><input type="text" v-model="outbound.arrTime" class="time-input text-xs"></div></div>
                            </div>
                        </div>

                        <div v-if="tripMode === 'round-trip'" class="pt-6 border-t border-dashed border-gray-200">
                            <div class="flex items-center gap-2 mb-4"><span class="bg-gray-400 text-white text-[10px] px-2 py-0.5 rounded font-mono">STEP 02</span><span class="text-sm font-bold text-gray-600">回程段設定</span></div>
                            <div class="grid grid-cols-1 md:grid-cols-12 gap-5">
                                <div class="md:col-span-4"><label class="form-label">高鐵訂單號</label><input type="text" v-model="returnTrip.hsrOrderId"></div>
                                <div class="md:col-span-4"><label class="form-label font-bold text-gray-800">PNR 代碼</label><input type="text" v-model="returnTrip.pnr" class="font-bold tracking-widest uppercase text-gray-800"></div>
                                <div class="md:col-span-4"><label class="form-label">乘車日期</label><input type="date" v-model="returnTrip.date"></div>
                                <div class="md:col-span-3">
                                    <label class="form-label">車廂艙等</label>
                                    <select v-model="returnTrip.carClass">
                                        <option value="標準車廂">標準車廂</option>
                                        <option value="商務車廂">商務車廂</option>
                                    </select>
                                </div>
                                <div class="md:col-span-3"><label class="form-label">車次</label><input type="text" v-model="returnTrip.trainNo"></div>
                                <div class="md:col-span-3">
                                    <label class="form-label">區間</label>
                                    <div class="flex items-center gap-1">
                                        <select v-model="returnTrip.from" class="text-xs"><option v-for="s in stations" :value="s">{{s}}</option></select>
                                        <select v-model="returnTrip.to" class="text-xs"><option v-for="s in stations" :value="s">{{s}}</option></select>
                                    </div>
                                </div>
                                <div class="md:col-span-3"><label class="form-label">時間</label><div class="flex items-center gap-1"><input type="text" v-model="returnTrip.depTime" class="time-input text-xs"><input type="text" v-model="returnTrip.arrTime" class="time-input text-xs"></div></div>
                            </div>
                        </div>

                        <div class="bg-gray-50 rounded-xl p-6 border border-gray-100">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                <div><label class="form-label">全票</label><input type="number" v-model.number="tickets.adult"></div>
                                <div><label class="form-label">孩童</label><input type="number" v-model.number="tickets.child"></div>
                                <div><label class="form-label">敬老</label><input type="number" v-model.number="tickets.senior"></div>
                                <div><label class="form-label">愛心</label><input type="number" v-model.number="tickets.disability"></div>
                            </div>
                            <div class="flex justify-end gap-2">
                                <button @click="openPassengerModal" :disabled="totalPersonCount === 0" class="btn-outline px-6 py-3 rounded-lg text-xs font-bold">編輯名單</button>
                                <button v-if="editingIndex === null" @click="addTripToList" :disabled="isOverLimit || totalPersonCount === 0" class="btn-primary px-8 py-3 rounded-lg text-xs font-bold">新增至摘要</button>
                                <button v-else @click="updateTripInList" :disabled="isOverLimit || totalPersonCount === 0" class="btn-update px-8 py-3 rounded-lg text-xs font-bold">儲存更新</button>
                                <button v-if="editingIndex !== null" @click="cancelEdit" class="px-4 py-3 text-gray-400 font-bold text-xs">取消</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4 space-y-6">
                <div class="japanese-card p-6 sticky top-8 flex flex-col h-[calc(100vh-100px)]">
                    <div class="flex justify-between items-center mb-6 border-b pb-4"><h2 class="text-sm font-bold text-gray-800">已登錄行程摘要</h2></div>
                    <div class="flex-1 overflow-y-auto space-y-4 pr-1">
                        <div v-for="(trip, idx) in addedTrips" :key="idx" class="p-4 bg-gray-50 border rounded-lg relative">
                            <div class="flex justify-between mb-2">
                                <span class="text-[10px] bg-gray-800 text-white px-2 py-0.5 rounded font-mono">#{{ idx + 1 }}</span>
                                <div class="flex gap-2">
                                    <button @click="startEdit(idx)" class="text-[10px] underline">編輯</button>
                                    <button @click="removeTrip(idx)" class="text-[10px] text-red-500">✕</button>
                                </div>
                            </div>
                            <div class="text-xs font-bold text-gray-700 font-mono">PNR: {{ trip.outbound.pnr }} / NT$ {{ trip.totalAmount.toLocaleString() }}</div>
                        </div>
                    </div>
                    <div class="mt-6 pt-6 border-t border-gray-100">
                        <div class="flex justify-between items-end mb-6">
                            <span class="text-xs text-gray-400 font-bold uppercase">總計金額</span>
                            <span class="text-2xl font-bold text-gray-900 font-mono">NT$ {{ totalOrderAmount.toLocaleString() }}</span>
                        </div>
                        <div class="space-y-2">
                            <button @click="copyToClipboard" :disabled="addedTrips.length === 0" class="w-full btn-outline py-3 rounded-lg text-xs font-bold">複製確認文字</button>
                            <div class="grid grid-cols-2 gap-2">
                                <button @click="downloadTxt" :disabled="addedTrips.length === 0" class="btn-outline py-3 rounded-lg text-xs font-bold">下載文字檔</button>
                                <button @click="downloadImage" :disabled="addedTrips.length === 0" class="btn-primary py-3 rounded-lg text-xs font-bold">導出圖片</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <transition name="fade">
            <div v-if="showPassengerModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900/60 backdrop-blur-sm">
                <div class="bg-white w-full max-w-5xl max-h-[90vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
                    <div class="px-8 py-6 border-b bg-gray-50 flex justify-between items-center">
                        <div class="flex gap-8">
                            <button @click="passengerTab = 'out'" :class="passengerTab === 'out' ? 'tab-active' : 'tab-inactive'" class="text-sm font-bold tracking-widest pb-1">去程旅客清單</button>
                            <button v-if="tripMode === 'round-trip'" @click="passengerTab = 'ret'" :class="passengerTab === 'ret' ? 'tab-active' : 'tab-inactive'" class="text-sm font-bold tracking-widest pb-1">回程旅客清單</button>
                        </div>
                        <button @click="showPassengerModal = false">✕</button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-8 space-y-4">
                        <div v-for="(p, index) in (passengerTab === 'out' ? passengersOut : passengersRet)" :key="index" class="p-5 border rounded-xl bg-white grid grid-cols-1 md:grid-cols-5 gap-4 items-end relative">
                            <div class="absolute -top-2 left-4 px-2 py-0.5 bg-gray-100 text-gray-500 text-[9px] rounded font-mono font-bold uppercase">序號 #{{index + 1}}</div>
                            <div class="flex flex-col"><label class="form-label">票種</label><div class="bg-gray-50 border p-2 text-xs rounded-md">{{ p.type }}</div></div>
                            <div class="flex flex-col"><label class="form-label">姓名</label><input type="text" v-model="p.name" @input="p.isDirty = (passengerTab === 'ret')"></div>
                            <div class="flex flex-col"><label class="form-label">身分證號</label><input type="text" v-model="p.idNumber" @input="p.isDirty = (passengerTab === 'ret')" class="uppercase"></div>
                            <div class="flex flex-col"><label class="form-label">護照號碼</label><input type="text" v-model="p.passportNo" @input="p.isDirty = (passengerTab === 'ret')" class="uppercase"></div>
                            <div class="flex flex-col"><label class="form-label">生日</label><input type="date" v-model="p.birthday" @input="p.isDirty = (passengerTab === 'ret')"></div>
                        </div>
                    </div>
                    <div class="px-8 py-6 border-t bg-gray-50 text-right">
                        <button @click="showPassengerModal = false" class="px-10 py-3 btn-primary rounded-xl text-xs font-bold">保存並返回</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Image Export Template -->
        <div id="capture-area-container">
            <div id="image-node" class="w-[850px] bg-white p-16 text-gray-800">
                <div class="flex justify-between items-start mb-8 border-b-4 border-gray-800 pb-6">
                    <div>
                        <h1 class="text-3xl font-bold tracking-[0.4em] mb-2 uppercase">高鐵訂位確認單</h1>
                        <p class="text-[11px] text-gray-400 font-medium tracking-[0.5em]">BOOKING CONFIRMATION SLIP</p>
                    </div>
                    <div class="text-right">
                        <div class="inline-block bg-gray-800 text-white px-5 py-1.5 text-xs font-mono mb-2">TRAVEL AGENCY COPY</div>
                        <p class="text-[10px] text-gray-400 font-mono">{{ manualTimestamp }}</p>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-6 text-[11px] mb-8 bg-gray-50 p-6 rounded-lg border border-gray-100">
                    <div><span class="text-gray-400 font-bold mr-2">訂單：</span><span class="font-bold font-mono">{{baseInfo.orderId || 'N/A'}}</span></div>
                    <div><span class="text-gray-400 font-bold mr-2">團號：</span><span class="font-bold font-mono">{{baseInfo.groupId || 'N/A'}}</span></div>
                    <div><span class="text-gray-400 font-bold mr-2">日期：</span><span class="font-bold font-mono">{{baseInfo.bookingDate.replace(/-/g, '/')}}</span></div>
                    <div><span class="text-gray-400 font-bold mr-2">業務：</span><span class="font-bold">{{baseInfo.sales || 'N/A'}}</span></div>
                    <div><span class="text-gray-400 font-bold mr-2">人員：</span><span class="font-bold">{{baseInfo.staff}}</span></div>
                </div>

                <div class="mb-6 py-4 px-6 border-l-8 border-red-500 bg-red-50 flex items-center justify-between rounded-r-lg">
                    <span class="text-sm font-bold text-red-700">★ 開票期限 (DEADLINE)</span>
                    <span class="text-red-600 font-bold text-2xl font-mono underline underline-offset-8">{{ formattedDeadline }}</span>
                </div>

                <div v-for="(trip, tIdx) in addedTrips" :key="tIdx" class="mb-10">
                    <div class="flex items-center gap-4 mb-6">
                        <span class="text-sm font-bold text-gray-800 font-mono">[訂票紀錄 #{{ tIdx + 1 }}]</span>
                        <div class="h-px flex-1 bg-gray-100"></div>
                    </div>
                    
                    <div class="mb-6 overflow-hidden rounded-lg border">
                        <div class="bg-gray-800 text-white px-5 py-2 flex justify-between text-[10px] font-bold">
                            <span>去程｜PNR: {{ trip.outbound.pnr }}</span>
                            <span>訂單號: {{ trip.outbound.hsrOrderId || 'N/A' }}</span>
                        </div>
                        <div class="p-4 bg-gray-50 font-bold text-sm">
                            {{ trip.outbound.date.replace(/-/g, '/') }}&nbsp;&nbsp;{{ trip.outbound.from }}{{ trip.outbound.to }}&nbsp;&nbsp;班次{{ trip.outbound.trainNo }}&nbsp;&nbsp;{{ trip.outbound.depTime }} - {{ trip.outbound.arrTime }}
                        </div>
                        <div class="px-5 py-2 bg-white text-[10px] flex justify-between border-t">
                            <span>{{ trip.outbound.carClass }}｜{{ trip.outBreakdown }}</span>
                            <span class="font-bold text-gray-700">NT$ {{ trip.outAmount.toLocaleString() }}</span>
                        </div>
                    </div>

                    <div v-if="trip.mode === 'round-trip'" class="overflow-hidden rounded-lg border">
                        <div class="bg-amber-600 text-white px-5 py-2 flex justify-between text-[10px] font-bold">
                            <span>回程｜PNR: {{ trip.returnTrip.pnr }}</span>
                            <span>訂單號: {{ trip.returnTrip.hsrOrderId || trip.outbound.hsrOrderId || 'N/A' }}</span>
                        </div>
                        <div class="p-4 bg-amber-50 font-bold text-sm">
                            {{ trip.returnTrip.date.replace(/-/g, '/') }}&nbsp;&nbsp;{{ trip.returnTrip.from }}{{ trip.returnTrip.to }}&nbsp;&nbsp;班次{{ trip.returnTrip.trainNo }}&nbsp;&nbsp;{{ trip.returnTrip.depTime }} - {{ trip.returnTrip.arrTime }}
                        </div>
                        <div class="px-5 py-2 bg-white text-[10px] flex justify-between border-t">
                            <span>{{ trip.returnTrip.carClass }}｜{{ trip.retBreakdown }}</span>
                            <span class="font-bold text-amber-700">NT$ {{ trip.retAmount.toLocaleString() }}</span>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-end border-t pt-10 mt-10">
                    <div class="text-[10px] text-gray-400 leading-relaxed max-w-[500px]">
                        <p class="font-bold text-gray-800 mb-1">【 注意事項與退票說明 】</p>
                        <p>1. 座位皆由電腦自動劃位,恕無法指定座位,亦無法保證同行者為相鄰座位。</p>
                        <p>2. 若因逾時未能搭乘,請自行洽詢站務人員是否可改搭當日其他車次之自由座,恕無法辦理退票。</p>
                        <p>3. 高鐵車票須於搭乘當日使用,逾期視同廢票,恕不受理退票。</p>
                        <p>4. 如需辦理退票,請於 4個工作日前 申請,並提供紙本票根或 APP 電子票截圖(天災導致高鐵停駛者不在此限)。</p>
                        <p>5. 退票將酌收手續費 每張新台幣 50 元。</p>
                        <p>6. 辦理退票時,請務必提供 紙本票根或電子票(APP 截圖),未提供者將視同正常搭乘,相關費用須自行負擔。</p>
                        <p>7. 因航班延誤或取消等非高鐵因素致無法搭乘者,車票 恕無法改期或退票,敬請見諒。</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-400 font-bold uppercase">Grand Total</p>
                        <p class="text-4xl font-bold text-gray-900 font-mono">TWD {{totalOrderAmount.toLocaleString()}}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, computed, watch, onMounted } = Vue;

        createApp({
            setup() {
                const today = new Date().toISOString().split('T')[0];
                const stations = ['南港', '台北', '板橋', '桃園', '新竹', '苗栗', '台中', '彰化', '雲林', '嘉義', '台南', '左營'];
                const tripMode = ref('one-way');
                const showPassengerModal = ref(false);
                const passengerTab = ref('out');
                const toastMsg = ref('');
                const editingIndex = ref(null);

                const fareRules = {
                    standard: {
                        '台北': { '左營': 1490, '台南': 1350, '嘉義': 1080, '台中': 700, '桃園': 160, '新竹': 290, '南港': 40, '板橋': 40, '苗栗': 430, '彰化': 820, '雲林': 930 },
                        '左營': { '台北': 1490, '桃園': 1330, '台中': 790, '新竹': 1200, '南港': 1530, '板橋': 1460, '苗栗': 1060, '彰化': 680, '雲林': 560, '嘉義': 410, '台南': 140 },
                        '新竹': { '左營': 1200, '台北': 290, '南港': 330, '板橋': 260, '桃園': 130, '苗栗': 270, '台中': 390, '彰化': 500, '雲林': 640, '嘉義': 920, '台南': 1060 }
                    },
                    business: {
                        '台北': { '左營': 2440, '台南': 2230, '嘉義': 1820, '台中': 1250, '桃園': 440, '新竹': 640 },
                        '左營': { '台北': 2440, '桃園': 2200, '台中': 1390, '新竹': 2000 }
                    }
                };

                const baseInfo = reactive({ staff: '陳侑君', bookingDate: today, deadlineDate: '', deadlineTime: '18:00', sales: '', orderId: '', groupId: '' });
                const outbound = reactive({ hsrOrderId: '', pnr: '', date: today, trainNo: '', from: '左營', to: '新竹', depTime: '07:00', arrTime: '08:23', carClass: '標準車廂' });
                const returnTrip = reactive({ hsrOrderId: '', pnr: '', date: today, trainNo: '', from: '新竹', to: '左營', depTime: '21:22', arrTime: '22:45', carClass: '標準車廂' });
                const tickets = reactive({ adult: 0, child: 0, senior: 0, disability: 0 });
                const passengersOut = ref([]);
                const passengersRet = ref([]);
                const addedTrips = ref([]);

                const showToast = (msg) => {
                    toastMsg.value = msg;
                    setTimeout(() => { toastMsg.value = ''; }, 3000);
                };

                const getSingleFare = (f, t, carClass) => {
                    const matrix = carClass === '商務車廂' ? fareRules.business : fareRules.standard;
                    return matrix[f]?.[t] || matrix[t]?.[f] || 1000;
                };

                const calcAmount = (tripObj) => {
                    const unit = getSingleFare(tripObj.from, tripObj.to, tripObj.carClass);
                    const discount = tripObj.carClass === '標準車廂' ? 0.85 : 0.9;
                    const adultPrice = Math.round(unit * discount);
                    const concessionPrice = Math.round(unit * 0.5);
                    return (tickets.adult * adultPrice) + ((tickets.child + tickets.senior + tickets.disability) * concessionPrice);
                };

                const getBreakdown = (tripObj, tks) => {
                    const unit = getSingleFare(tripObj.from, tripObj.to, tripObj.carClass);
                    const discount = tripObj.carClass === '標準車廂' ? 0.85 : 0.9;
                    const adultPrice = Math.round(unit * discount);
                    const concessionPrice = Math.round(unit * 0.5);
                    let res = [];
                    if (tks.adult > 0) res.push(`全票*${tks.adult}張 ($${adultPrice})`);
                    if (tks.child > 0) res.push(`孩童*${tks.child}張 ($${concessionPrice})`);
                    if (tks.senior > 0) res.push(`敬老*${tks.senior}張 ($${concessionPrice})`);
                    if (tks.disability > 0) res.push(`愛心*${tks.disability}張 ($${concessionPrice})`);
                    return res.join(' ');
                };

                const maskId = (id) => {
                    if (!id) return '';
                    const s = id.toString();
                    if (s.length < 7) return s;
                    return `${s.slice(0, 3)}****${s.slice(-3)}`;
                };

                const addTripToList = () => {
                    if (!outbound.pnr) { showToast("請輸入 PNR 代碼"); return; }
                    const outAmount = calcAmount(outbound);
                    const retAmount = tripMode.value === 'round-trip' ? calcAmount(returnTrip) : 0;
                    addedTrips.value.push({
                        mode: tripMode.value,
                        outbound: { ...outbound },
                        returnTrip: { ...returnTrip },
                        tickets: { ...tickets },
                        passengersOut: JSON.parse(JSON.stringify(passengersOut.value)),
                        passengersRet: tripMode.value === 'round-trip' ? JSON.parse(JSON.stringify(passengersRet.value)) : [],
                        totalAmount: outAmount + retAmount,
                        outAmount, retAmount,
                        outBreakdown: getBreakdown(outbound, tickets),
                        retBreakdown: tripMode.value === 'round-trip' ? getBreakdown(returnTrip, tickets) : ''
                    });
                    resetForm();
                    showToast("行程已新增至摘要");
                };

                const startEdit = (idx) => {
                    const t = addedTrips.value[idx];
                    editingIndex.value = idx;
                    tripMode.value = t.mode;
                    Object.assign(outbound, t.outbound);
                    Object.assign(returnTrip, t.returnTrip);
                    Object.assign(tickets, t.tickets);
                    passengersOut.value = JSON.parse(JSON.stringify(t.passengersOut));
                    passengersRet.value = JSON.parse(JSON.stringify(t.passengersRet));
                    showToast("載入行程資料");
                };

                const updateTripInList = () => {
                    const idx = editingIndex.value;
                    const outAmount = calcAmount(outbound);
                    const retAmount = tripMode.value === 'round-trip' ? calcAmount(returnTrip) : 0;
                    addedTrips.value[idx] = {
                        mode: tripMode.value,
                        outbound: { ...outbound },
                        returnTrip: { ...returnTrip },
                        tickets: { ...tickets },
                        passengersOut: JSON.parse(JSON.stringify(passengersOut.value)),
                        passengersRet: tripMode.value === 'round-trip' ? JSON.parse(JSON.stringify(passengersRet.value)) : [],
                        totalAmount: outAmount + retAmount,
                        outAmount, retAmount,
                        outBreakdown: getBreakdown(outbound, tickets),
                        retBreakdown: tripMode.value === 'round-trip' ? getBreakdown(returnTrip, tickets) : ''
                    };
                    resetForm();
                    editingIndex.value = null;
                    showToast("行程已更新");
                };

                const resetForm = () => {
                    outbound.pnr = ''; returnTrip.pnr = '';
                    tickets.adult = 0; tickets.child = 0; tickets.senior = 0; tickets.disability = 0;
                };

                const cancelEdit = () => { resetForm(); editingIndex.value = null; };
                const removeTrip = (i) => addedTrips.value.splice(i, 1);
                const openPassengerModal = () => showPassengerModal.value = true;
                const syncOrderId = () => { if(tripMode.value === 'round-trip') returnTrip.hsrOrderId = outbound.hsrOrderId; };

                const totalPersonCount = computed(() => tickets.adult + tickets.child + tickets.senior + tickets.disability);
                const totalTicketCountInCurrent = computed(() => tripMode.value === 'one-way' ? totalPersonCount.value : totalPersonCount.value * 2);
                const isOverLimit = computed(() => totalPersonCount.value > 10);
                const totalOrderAmount = computed(() => addedTrips.value.reduce((s, t) => s + t.totalAmount, 0));
                const formattedDeadline = computed(() => baseInfo.deadlineDate ? `${baseInfo.deadlineDate.replace(/-/g,'/')} ${baseInfo.deadlineTime}` : '');
                const manualTimestamp = computed(() => new Date().toLocaleString());

                watch(tickets, (val) => {
                    const sync = (list) => {
                        const types = [{c: val.adult, t:'全票'}, {c: val.child, t:'孩童'}, {c: val.senior, t:'敬老'}, {c: val.disability, t:'愛心'}];
                        let newList = [];
                        types.forEach(item => { for(let i=0; i<item.c; i++) newList.push({type: item.t, name:'', idNumber:'', passportNo:'', birthday:'', isDirty: false}) });
                        newList.forEach((p, i) => { if(list.value[i]) Object.assign(p, list.value[i]) });
                        list.value = newList.slice(0, 10);
                    };
                    sync(passengersOut); sync(passengersRet);
                }, { deep: true });

                watch(passengersOut, (val) => {
                    if (tripMode.value === 'round-trip') {
                        val.forEach((p, i) => {
                            if (passengersRet.value[i] && !passengersRet.value[i].isDirty) {
                                Object.assign(passengersRet.value[i], { name: p.name, idNumber: p.idNumber, passportNo: p.passportNo, birthday: p.birthday });
                            }
                        });
                    }
                }, { deep: true });

                const getFullSummaryText = () => {
                    let text = `【高鐵訂票確認單】\n\n`;
                    text += `訂單：${baseInfo.orderId || '未提供'}\n`;
                    text += `訂票日期：${baseInfo.bookingDate}\n`;
                    text += `業務：${baseInfo.sales || '未提供'}\n\n`;
                    text += `★開票期限：${formattedDeadline.value}\n`;
                    text += `請務必於D/L到期前通知可開票\n\n`;
                    text += `【提醒事項】\n`;
                    text += `1. 請務必於D/L前告知可開票與取票方式(紙本/電子)。\n`;
                    text += `2. 掛帳全票會先掛85折的價格，優待票(孩童、敬老、愛心)都是半價。\n`;
                    text += `   ※如果售價有調整需要更改再請通知唷 謝謝\n\n`;

                    addedTrips.value.forEach((t, i) => {
                        text += `[訂票紀錄 #${i + 1}]\n`;
                        text += `去程｜PNR ${t.outbound.pnr}\n`;
                        text += `${t.outbound.date.replace(/-/g, '/')}  ${t.outbound.from}${t.outbound.to}  班次${t.outbound.trainNo}  ${t.outbound.depTime} - ${t.outbound.arrTime}\n`;
                        text += `${t.outbound.carClass}｜${t.outBreakdown} = NT$ ${t.outAmount.toLocaleString()}\n\n`;
                        
                        if (t.mode === 'round-trip') {
                            text += `回程｜PNR ${t.returnTrip.pnr}\n`;
                            text += `${t.returnTrip.date.replace(/-/g, '/')}  ${t.returnTrip.from}${t.returnTrip.to}  班次${t.returnTrip.trainNo}  ${t.returnTrip.depTime} - ${t.returnTrip.arrTime}\n`;
                            text += `${t.returnTrip.carClass}｜${t.retBreakdown} = NT$ ${t.retAmount.toLocaleString()}\n`;
                        }
                        text += `--------------------------------\n\n`;
                    });

                    text += `應收總計金額：TWD ${totalOrderAmount.value.toLocaleString()}\n\n`;
                    text += `【注意事項與退票說明】\n`;
                    text += `1. 座位皆由電腦自動劃位,恕無法指定座位,亦無法保證同行者為相鄰座位。\n`;
                    text += `2. 若因逾時未能搭乘,請自行洽詢站務人員是否可改搭當日其他車次之自由座,恕無法辦理退票。\n`;
                    text += `3. 高鐵車票須於搭乘當日使用,逾期視同廢票,恕不受理退票。\n`;
                    text += `4. 如需辦理退票,請於 4個工作日前 申請,並提供紙本票根或 APP 電子票截圖(天災導致高鐵停駛者不在此限)。\n`;
                    text += `5. 退票將酌收手續費 每張新台幣 50 元。\n`;
                    text += `6. 辦理退票時,請務必提供 紙本票根或電子票(APP 截圖),未提供者將視同正常搭乘,相關費用須自行負擔。\n`;
                    text += `7. 因航班延誤或取消等非高鐵因素致無法搭乘者,車票 恕無法改期或退票,敬請見諒。\n`;
                    
                    return text;
                };

                const copyToClipboard = () => {
                    const text = getFullSummaryText();
                    const el = document.createElement('textarea');
                    el.value = text; document.body.appendChild(el); el.select();
                    document.execCommand('copy'); document.body.removeChild(el);
                    showToast("已成功複製範本文字");
                };

                const downloadTxt = () => {
                    const text = getFullSummaryText();
                    const blob = new Blob([text], { type: 'text/plain' });
                    const a = document.createElement('a');
                    const fileName = `${baseInfo.bookingDate}_HSR_Confirmation.txt`;
                    a.href = URL.createObjectURL(blob); a.download = fileName; a.click();
                };

                const downloadImage = () => {
                    html2canvas(document.getElementById('image-node'), { scale: 2 }).then(canvas => {
                        const a = document.createElement('a'); a.href = canvas.toDataURL("image/png");
                        a.download = `HSR_Confirm_${new Date().getTime()}.png`; a.click();
                        showToast("圖片導出成功");
                    });
                };

                return { baseInfo, outbound, returnTrip, tickets, passengersOut, passengersRet, passengerTab, stations, tripMode, showPassengerModal, openPassengerModal, formattedDeadline, totalPersonCount, totalTicketCountInCurrent, isOverLimit, addedTrips, addTripToList, startEdit, updateTripInList, cancelEdit, editingIndex, removeTrip, totalOrderAmount, syncOrderId, downloadTxt, downloadImage, copyToClipboard, manualTimestamp, toastMsg, maskId };
            }
        }).mount('#app');
    </script>
</body>
</html>
