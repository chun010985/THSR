<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高鐵訂位確認單生成器 - 日系極簡版</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Google Fonts: Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f4f4f2; 
            color: #333333;
            letter-spacing: 0.02em;
        }
        .japanese-card {
            background: #ffffff;
            border: 1px solid #e5e5e0;
            border-radius: 4px;
        }
        .form-label {
            font-size: 0.75rem;
            color: #8c8c88;
            margin-bottom: 0.3rem;
            font-weight: 500;
        }
        input, select {
            background-color: #fafaf9;
            border: 1px solid #e5e5e0;
            border-radius: 3px;
            padding: 0.5rem;
            font-size: 0.875rem;
            outline: none;
            transition: all 0.2s;
            width: 100%;
        }
        input:focus, select:focus {
            background-color: #ffffff;
            border-color: #a8a8a2;
        }
        .btn-primary {
            background-color: #4a4a46;
            color: #ffffff;
            transition: all 0.3s;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #2a2a26;
        }
        .btn-update {
            background-color: #8c7e6c;
            color: #ffffff;
        }
        .btn-primary:disabled {
            background-color: #d1d1cc;
            cursor: not-allowed;
        }
        .btn-outline {
            border: 1px solid #4a4a46;
            color: #4a4a46;
            background-color: transparent;
            transition: all 0.3s;
        }
        .btn-outline:hover:not(:disabled) {
            background-color: #4a4a46;
            color: #ffffff;
        }
        .time-input {
            letter-spacing: 0.1em;
            text-align: center;
        }
        .tab-active {
            border-bottom: 2px solid #4a4a46;
            color: #333333;
            font-weight: bold;
        }
        .tab-inactive {
            color: #a8a8a2;
        }
        .notes-text {
            font-size: 10px;
            line-height: 1.5;
            color: #718096;
        }
        [v-cloak] { display: none; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d1d1cc; border-radius: 10px; }
        .sync-badge {
            font-size: 9px;
            background: #f0fdf4;
            color: #16a34a;
            padding: 1px 4px;
            border-radius: 2px;
            border: 1px solid #dcfce7;
        }
    </style>
</head>
<body class="p-4 md:p-8 text-sm font-sans">
    <div id="app" v-cloak class="max-w-7xl mx-auto">
        
        <!-- 標頭 -->
        <header class="mb-10 text-center font-sans">
            <div class="inline-block px-8 py-1 border-y border-gray-400 mb-2">
                <span class="text-xl font-light tracking-[0.4em]">高鐵訂位確認單生成器</span>
            </div>
        </header>

        <!-- 訊息通知 -->
        <div v-if="toastMsg" class="fixed top-6 left-1/2 -translate-x-1/2 z-[100] bg-gray-800/90 backdrop-blur text-white px-6 py-2.5 rounded shadow-xl text-xs flex items-center gap-3 animate-bounce">
            <span>{{ toastMsg }}</span>
            <button @click="toastMsg = ''">✕</button>
        </div>

        <!-- 主要佈局 -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start font-sans">
            
            <!-- 左側區域 -->
            <div class="lg:col-span-8 space-y-8">
                
                <!-- 基本資料 -->
                <div class="japanese-card p-6 md:p-8 shadow-sm">
                    <div class="flex items-center gap-3 mb-6 font-bold text-stone-600">
                        <span class="w-1 h-5 bg-stone-400"></span>
                        <h2 class="text-md tracking-wider">基本資料登錄</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="flex flex-col">
                            <label class="form-label">訂位人員</label>
                            <div class="bg-stone-50 p-2 border border-stone-100 text-stone-400 font-medium rounded">{{ baseInfo.staff }}</div>
                        </div>
                        <div class="flex flex-col">
                            <label class="form-label">訂票日期</label>
                            <div class="bg-stone-50 p-2 border border-stone-100 text-stone-400 font-medium rounded font-mono">{{ baseInfo.bookingDate }}</div>
                        </div>
                        <div class="flex flex-col text-red-500">
                            <label class="form-label text-red-500 font-bold underline tracking-tighter">開票期限 (24H)</label>
                            <div class="flex gap-1 text-black font-mono">
                                <input type="date" v-model="baseInfo.deadlineDate" class="w-2/3">
                                <input type="text" v-model="baseInfo.deadlineTime" class="w-1/3 time-input" maxlength="5">
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <label class="form-label">業務人員</label>
                            <input type="text" v-model="baseInfo.sales" placeholder="輸入業務姓名">
                        </div>
                        <div class="flex flex-col font-mono">
                            <label class="form-label font-sans">訂單編號</label>
                            <input type="text" v-model="baseInfo.orderId">
                        </div>
                        <div class="flex flex-col font-mono">
                            <label class="form-label font-sans">團號</label>
                            <input type="text" v-model="baseInfo.groupId">
                        </div>
                    </div>
                </div>

                <!-- 行程資訊 -->
                <div class="japanese-card p-6 md:p-8 relative shadow-sm text-sm">
                    <div v-if="editingIndex !== null" class="absolute top-0 right-0 bg-stone-700 text-white px-4 py-1 text-[10px] font-bold rounded-bl tracking-widest">
                        正在編輯行程紀錄
                    </div>

                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-3 font-bold text-stone-600">
                            <span class="w-1 h-5 bg-stone-400"></span>
                            <h2 class="text-md tracking-wider">行程資訊</h2>
                        </div>
                        <div class="flex bg-stone-100 p-1 rounded font-medium">
                            <button @click="tripMode = 'one-way'" :class="tripMode === 'one-way' ? 'bg-white shadow-sm text-stone-800' : 'text-stone-400'" class="px-5 py-1.5 text-[11px] transition-all rounded">單程</button>
                            <button @click="tripMode = 'round-trip'" :class="tripMode === 'round-trip' ? 'bg-white shadow-sm text-stone-800' : 'text-stone-400'" class="px-5 py-1.5 text-[11px] transition-all rounded">來回</button>
                        </div>
                    </div>

                    <!-- 去程段 -->
                    <div class="mb-8 font-sans">
                        <p class="text-[9px] font-bold text-stone-400 uppercase tracking-[0.2em] mb-4 border-b border-stone-100 pb-1 flex justify-between items-end">
                            <span>第一段：去程段</span>
                            <span v-if="outbound.hsrOrderId" class="font-mono text-stone-300 tracking-tighter">#{{ outbound.hsrOrderId }}</span>
                        </p>
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                            <div class="flex flex-col md:col-span-4 font-mono">
                                <label class="form-label font-sans">高鐵訂單編號</label>
                                <input type="text" v-model="outbound.hsrOrderId" @input="syncOrderId">
                            </div>
                            <div class="flex flex-col md:col-span-4 font-mono">
                                <label class="form-label font-bold text-stone-600 font-sans">訂位 PNR</label>
                                <input type="text" v-model="outbound.pnr" class="font-bold tracking-[0.2em] text-stone-700 uppercase">
                            </div>
                            <div class="flex flex-col md:col-span-4 font-mono">
                                <label class="form-label font-sans">乘車日期</label>
                                <input type="date" v-model="outbound.date" class="text-xs">
                            </div>
                            <div class="flex flex-col md:col-span-2">
                                <label class="form-label font-medium text-stone-500">車廂艙等</label>
                                <select v-model="outbound.carClass">
                                    <option value="標準車廂">標準車廂</option>
                                    <option value="商務車廂">商務車廂</option>
                                </select>
                            </div>
                            <div class="flex flex-col md:col-span-2 font-mono">
                                <label class="form-label font-sans">車次</label>
                                <input type="text" v-model="outbound.trainNo" placeholder="如 612">
                            </div>
                            <div class="flex flex-col md:col-span-4">
                                <label class="form-label font-sans">起迄站點</label>
                                <div class="flex items-center gap-1">
                                    <select v-model="outbound.from" class="w-full">
                                        <option v-for="s in stations" :key="s" :value="s">{{s}}</option>
                                    </select>
                                    <button @click="swapStations(outbound)" class="p-1 hover:text-stone-400 text-lg">⇆</button>
                                    <select v-model="outbound.to" class="w-full">
                                        <option v-for="s in stations" :key="s" :value="s">{{s}}</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex flex-col md:col-span-4 font-mono">
                                <label class="form-label font-sans">乘車時間 (24H)</label>
                                <div class="flex items-center gap-1">
                                    <input type="text" v-model="outbound.depTime" class="w-1/2 time-input" placeholder="08:00">
                                    <span class="text-stone-300">~</span>
                                    <input type="text" v-model="outbound.arrTime" class="w-1/2 time-input" placeholder="09:30">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 回程段 -->
                    <div v-if="tripMode === 'round-trip'" class="mb-8 pt-4 border-t border-dashed border-stone-100 font-sans">
                        <p class="text-[9px] font-bold text-stone-400 uppercase tracking-[0.2em] mb-4 border-b border-stone-100 pb-1 font-bold">第二段：回程段</p>
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                            <div class="flex flex-col md:col-span-4 font-mono">
                                <label class="form-label font-sans">高鐵訂單編號</label>
                                <input type="text" v-model="returnTrip.hsrOrderId">
                            </div>
                            <div class="flex flex-col md:col-span-4 font-mono">
                                <label class="form-label font-bold text-stone-600 font-sans">訂位 PNR</label>
                                <input type="text" v-model="returnTrip.pnr" class="font-bold tracking-[0.2em] text-stone-700 uppercase">
                            </div>
                            <div class="flex flex-col md:col-span-4 font-mono">
                                <label class="form-label font-sans">乘車日期</label>
                                <input type="date" v-model="returnTrip.date" class="text-xs">
                            </div>
                            <div class="flex flex-col md:col-span-2">
                                <label class="form-label font-medium text-stone-500">車廂艙等</label>
                                <select v-model="returnTrip.carClass">
                                    <option value="標準車廂">標準車廂</option>
                                    <option value="商務車廂">商務車廂</option>
                                </select>
                            </div>
                            <div class="flex flex-col md:col-span-2 font-mono">
                                <label class="form-label font-sans">車次</label>
                                <input type="text" v-model="returnTrip.trainNo">
                            </div>
                            <div class="flex flex-col md:col-span-4">
                                <label class="form-label font-sans">起迄站點</label>
                                <div class="flex items-center gap-1">
                                    <select v-model="returnTrip.from" class="w-full">
                                        <option v-for="s in stations" :key="s" :value="s">{{s}}</option>
                                    </select>
                                    <button @click="swapStations(returnTrip)" class="p-1 hover:text-stone-400 text-lg">⇆</button>
                                    <select v-model="returnTrip.to" class="w-full">
                                        <option v-for="s in stations" :key="s" :value="s">{{s}}</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex flex-col md:col-span-4 font-mono">
                                <label class="form-label font-sans">乘車時間 (24H)</label>
                                <div class="flex items-center gap-1">
                                    <input type="text" v-model="returnTrip.depTime" class="w-1/2 time-input" placeholder="17:00">
                                    <span class="text-stone-300">~</span>
                                    <input type="text" v-model="returnTrip.arrTime" class="w-1/2 time-input" placeholder="18:30">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 票數設定與旅客按鈕 -->
                    <div class="p-6 bg-stone-50 rounded border border-stone-100 shadow-sm font-medium">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8 text-stone-600 font-sans">
                            <div class="flex flex-col text-xs font-bold">
                                <label class="form-label font-bold text-stone-600">全票</label>
                                <input type="number" v-model.number="tickets.adult" min="0">
                            </div>
                            <div class="flex flex-col text-xs font-bold">
                                <label class="form-label font-bold text-stone-600">孩童(優待票)</label>
                                <input type="number" v-model.number="tickets.child" min="0" class="border-stone-200">
                            </div>
                            <div class="flex flex-col text-xs font-bold">
                                <label class="form-label font-bold text-stone-600">敬老(優待票)</label>
                                <input type="number" v-model.number="tickets.senior" min="0" class="border-stone-200">
                            </div>
                            <div class="flex flex-col text-xs font-bold">
                                <label class="form-label font-bold text-stone-600">愛心(優待票)</label>
                                <input type="number" v-model.number="tickets.disability" min="0" class="border-stone-200">
                            </div>
                        </div>
                        
                        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                            <div class="text-[11px] font-medium" :class="isOverLimit ? 'text-red-500 font-bold underline' : 'text-stone-400'">
                                <span v-if="isOverLimit">⚠ 人數上限 10 位 / </span>
                                合計：{{ totalPersonCount }} 位旅客 (共計 {{ totalTicketCountInCurrent }} 張)
                            </div>
                            <div class="flex gap-2 w-full md:w-auto font-bold font-sans">
                                <button @click="openPassengerModal" :disabled="isOverLimit || totalPersonCount === 0" class="flex-1 md:flex-none btn-outline px-6 py-2.5 rounded text-[11px] shadow-sm uppercase tracking-widest">
                                    編輯名單
                                </button>
                                <button v-if="editingIndex === null" @click="addTripToList" :disabled="isOverLimit || totalPersonCount === 0" class="flex-1 md:flex-none btn-primary px-8 py-2.5 rounded text-[11px] shadow-sm uppercase tracking-widest">
                                    新增行程
                                </button>
                                <button v-else @click="updateTripInList" :disabled="isOverLimit || totalPersonCount === 0" class="flex-1 md:flex-none btn-update px-8 py-2.5 rounded text-[11px] font-bold shadow-sm uppercase tracking-widest">
                                    更新紀錄
                                </button>
                                <button v-if="editingIndex !== null" @click="cancelEdit" class="p-2 text-stone-400 hover:text-stone-600 font-bold">取消</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右側摘要 -->
            <div class="lg:col-span-4 h-full font-medium font-sans">
                <div class="japanese-card p-6 flex flex-col h-[calc(100vh-160px)] sticky top-8 shadow-sm text-sm">
                    <div class="flex justify-between items-end mb-6 pb-2 border-b border-stone-100 font-bold">
                        <h2 class="text-xs font-bold text-stone-500 tracking-[0.2em]">行程摘要紀錄</h2>
                        <span v-if="addedTrips.length > 0" @click="clearAllTrips" class="text-[10px] text-stone-300 hover:text-red-400 cursor-pointer transition-colors">全部清空</span>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto space-y-4 pr-1 font-light text-stone-400">
                        <div v-if="addedTrips.length === 0" class="h-full flex flex-col items-center justify-center italic py-20 text-center text-xs opacity-50">
                            尚未登錄行程記錄<br>完成輸入後點擊「新增行程」
                        </div>
                        
                        <div v-for="(trip, idx) in addedTrips" :key="idx" 
                             :class="editingIndex === idx ? 'border-stone-400 bg-stone-100' : 'border-stone-100 bg-stone-50'"
                             class="p-4 border rounded-sm relative group transition-all hover:border-stone-300 shadow-sm text-xs font-medium">
                            
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-[9px] bg-stone-600 text-white px-2 py-0.5 rounded-full font-bold font-mono">#{{ idx + 1 }}</span>
                                <div class="flex gap-3 font-bold text-stone-600">
                                    <button @click="startEdit(idx)" class="text-[10px] hover:text-stone-700 underline underline-offset-2 font-bold">編輯</button>
                                    <button @click="removeTrip(idx)" class="text-[10px] hover:text-red-400 font-bold">✕</button>
                                </div>
                            </div>

                            <div class="flex flex-col gap-1 text-[11px] text-stone-500">
                                <div class="flex justify-between font-bold text-stone-700 uppercase font-mono tracking-tight font-bold">
                                    <span>PNR: {{ trip.outbound.pnr }}</span>
                                    <span>NT$ {{ trip.totalAmount.toLocaleString() }}</span>
                                </div>
                                <div class="flex justify-between mt-1 pt-1 border-t border-stone-200/50 font-mono text-[10px]">
                                    <span class="opacity-70 font-mono">{{ trip.outbound.date }}</span>
                                    <span class="font-sans font-medium text-stone-600">{{ trip.outbound.from }} → {{ trip.outbound.to }}</span>
                                </div>
                                <div v-if="trip.mode === 'round-trip'" class="flex justify-between text-orange-400/80 font-mono text-[10px]">
                                    <span class="opacity-70 font-mono">{{ trip.returnTrip.date }}</span>
                                    <span class="font-sans font-medium">{{ trip.returnTrip.from }} → {{ trip.returnTrip.to }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 pt-6 border-t border-stone-100 font-sans">
                        <div class="flex justify-between items-baseline mb-6 font-bold text-stone-700 font-sans">
                            <span class="text-[10px] text-stone-400 tracking-widest uppercase">總計金額小計</span>
                            <div class="text-right">
                                <span class="text-xs text-stone-400 mr-1 font-mono uppercase font-light">TWD</span>
                                <span class="text-3xl font-bold tracking-tighter">{{ totalOrderAmount.toLocaleString() }}</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 font-bold">
                            <button @click="downloadTxt" :disabled="addedTrips.length === 0" class="btn-outline py-3 rounded text-[11px] shadow-sm uppercase tracking-widest font-bold">下載文字檔</button>
                            <button @click="downloadImage" :disabled="addedTrips.length === 0" class="btn-primary py-3 rounded text-[11px] shadow-sm uppercase tracking-widest font-bold font-sans">下載確認圖片</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 旅客彈窗 -->
        <transition name="modal">
            <div v-if="showPassengerModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-stone-900/60 backdrop-blur-sm text-sm font-sans">
                <div class="bg-white w-full max-w-5xl max-h-[90vh] rounded shadow-2xl flex flex-col overflow-hidden border border-stone-200 font-medium">
                    <div class="px-8 py-4 border-b bg-stone-50 flex justify-between items-center text-xs font-bold font-sans">
                        <div class="flex gap-6 items-center">
                            <button @click="passengerTab = 'out'" :class="passengerTab === 'out' ? 'tab-active text-stone-800' : 'tab-inactive text-stone-400'" class="text-[11px] tracking-widest pb-1 transition-all uppercase font-bold font-sans">去程名單</button>
                            <button v-if="tripMode === 'round-trip'" @click="passengerTab = 'ret'" :class="passengerTab === 'ret' ? 'tab-active text-stone-800' : 'tab-inactive text-stone-400'" class="text-[11px] tracking-widest pb-1 transition-all uppercase font-bold font-sans">回程名單</button>
                        </div>
                        <button @click="showPassengerModal = false" class="text-stone-300 hover:text-stone-600 text-xl font-light font-mono font-bold">✕</button>
                    </div>

                    <div class="flex-1 overflow-y-auto p-8 space-y-4">
                        <div v-for="(p, index) in (passengerTab === 'out' ? passengersOut : passengersRet)" :key="index" class="p-4 border border-stone-100 rounded bg-stone-50 grid grid-cols-1 md:grid-cols-5 gap-4 items-end relative shadow-sm text-xs font-medium">
                            <div class="absolute -top-2 left-2 px-1.5 py-0.5 bg-stone-200 text-stone-600 text-[8px] rounded font-bold uppercase font-mono font-bold">
                                序號 P{{index + 1}}
                                <span v-if="passengerTab === 'ret' && !p.isDirty" class="sync-badge">同步中</span>
                            </div>
                            <div class="flex flex-col">
                                <label class="form-label font-sans font-bold">票種</label>
                                <div class="bg-white border p-2 text-xs text-stone-400 rounded font-sans font-bold">{{ p.type }}</div>
                            </div>
                            <div class="flex flex-col">
                                <label class="form-label font-bold text-stone-600 font-sans font-bold">姓名</label>
                                <input type="text" v-model="p.name" @input="p.isDirty = (passengerTab === 'ret')" class="text-sm font-bold font-sans">
                            </div>
                            <div class="flex flex-col font-mono">
                                <label class="form-label font-bold text-stone-600 font-sans font-bold">身分證號</label>
                                <input type="text" v-model="p.idNumber" @input="p.isDirty = (passengerTab === 'ret')" class="text-sm uppercase tracking-tighter">
                            </div>
                            <div class="flex flex-col font-mono">
                                <label class="form-label font-bold text-stone-600 font-sans font-bold">護照號碼</label>
                                <input type="text" v-model="p.passportNo" @input="p.isDirty = (passengerTab === 'ret')" class="text-sm uppercase tracking-tighter">
                            </div>
                            <div class="flex flex-col font-mono">
                                <label class="form-label font-bold text-stone-600 font-sans font-bold">生日</label>
                                <input type="date" v-model="p.birthday" @input="p.isDirty = (passengerTab === 'ret')" class="text-xs">
                            </div>
                        </div>
                    </div>

                    <div class="px-8 py-5 border-t bg-stone-50 flex justify-between items-center text-xs font-medium font-sans">
                        <p class="text-[10px] text-stone-400 italic font-light font-sans font-sans">提醒：去程資料會自動帶入回程，您可單獨編輯回程細節。</p>
                        <button @click="showPassengerModal = false" class="px-12 py-2.5 bg-stone-700 text-white rounded text-[11px] font-bold uppercase shadow-md tracking-widest font-bold font-sans">完成並返回</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- 導出圖片預覽區 -->
        <div id="capture-area" class="fixed -left-[4000px] top-0 font-sans font-medium">
            <div class="w-[900px] bg-white p-12 text-[#2d2d2a]" id="image-node">
                <div class="flex justify-between items-start mb-6 border-b-2 border-[#2d2d2a] pb-4 font-bold">
                    <div>
                        <h1 class="text-2xl tracking-[0.3em] mb-1 uppercase font-bold text-stone-800 font-sans font-bold">高鐵訂位確認單</h1>
                        <p class="text-[9px] text-gray-400 font-light tracking-[0.4em] uppercase font-sans font-bold">旅行社行政管理作業紀錄單</p>
                    </div>
                    <div class="text-right">
                        <div class="inline-block bg-[#2d2d2a] text-white px-4 py-1 text-[10px] tracking-widest mb-1 font-mono uppercase font-bold font-mono">OFFICIAL COPY</div>
                        <p class="text-[9px] text-gray-400 font-mono tracking-tighter uppercase font-sans">系統時間: {{ manualTimestamp }}</p>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-x-4 gap-y-1 text-[10px] mb-4 bg-stone-50 p-3 rounded border border-stone-100 shadow-sm font-medium font-sans">
                    <div class="flex gap-2"><span class="text-gray-400 font-bold">訂單編號：</span><span class="text-gray-700 font-bold font-mono">{{baseInfo.orderId}}</span></div>
                    <div class="flex gap-2"><span class="text-gray-400 font-bold">團號：</span><span class="text-gray-700 font-bold font-mono">{{baseInfo.groupId}}</span></div>
                    <div class="flex gap-2"><span class="text-gray-400 font-bold">訂票日期：</span><span class="text-gray-700 font-medium font-mono text-[11px] font-bold">{{baseInfo.bookingDate}}</span></div>
                    <div class="flex gap-2"><span class="text-gray-400 font-bold">業務人員：</span><span class="text-gray-700 font-bold font-sans">{{baseInfo.sales}}</span></div>
                    <div class="flex gap-2"><span class="text-gray-400 font-bold">訂位人員：</span><span class="text-gray-700 font-sans font-bold">{{baseInfo.staff}}</span></div>
                </div>

                <div class="mb-4 py-3 px-4 border-l-4 border-red-500 bg-red-50 flex items-center justify-between shadow-sm rounded-r">
                    <div class="flex items-center gap-3 font-bold text-red-700">
                        <span class="text-[12px] tracking-widest uppercase font-bold font-sans">開票期限</span>
                    </div>
                    <span class="text-red-600 font-bold text-xl underline underline-offset-4 decoration-red-300 font-mono tracking-tighter uppercase font-sans">{{ formattedDeadline }}</span>
                </div>

                <div class="mb-8 px-4 py-2 text-stone-600 border-stone-100 border-l-2 font-medium font-sans font-bold">
                    <ul class="text-[10px] space-y-1 leading-relaxed">
                        <li class="font-bold tracking-tight font-bold">【 請務必於期限前告知可開票 與 取票方式  紙本 / 電子票(搭配APP使用) 】</li>
                        <li class="tracking-tight font-sans font-bold">掛帳全票會先掛85折的價格，優待票(孩童、敬老、愛心)都是半價。 <span class="opacity-80 italic text-[9px] font-normal font-sans">※如果售價有調整需要更改再請通知唷 謝謝</span></li>
                    </ul>
                </div>

                <div v-for="(trip, tIdx) in addedTrips" :key="tIdx" class="mb-10 font-medium text-stone-700 font-sans">
                    <div class="flex items-center gap-4 mb-3 text-xs font-bold font-sans">
                        <span class="text-md text-stone-800 tracking-tighter uppercase font-mono uppercase font-bold font-sans">訂票紀錄 #{{ tIdx + 1 }}</span>
                        <div class="h-[1px] flex-1 bg-stone-100 font-sans"></div>
                    </div>

                    <!-- 去程容器 -->
                    <div class="mb-5 overflow-hidden rounded-sm border border-stone-100 shadow-sm bg-[#fafafa] font-sans">
                        <div class="bg-stone-800 text-white px-3 py-1.5 flex justify-between items-center text-[10px] font-bold tracking-widest uppercase font-sans">
                            <span>去程</span>
                            <div class="flex gap-6 opacity-80 font-mono tracking-tighter uppercase font-bold font-mono">
                                <span>高鐵訂單：{{ trip.outbound.hsrOrderId }}</span>
                                <span>PNR: {{ trip.outbound.pnr }}</span>
                            </div>
                        </div>
                        <table class="w-full text-[10px] text-left text-stone-700 border-b border-stone-50 font-sans">
                            <tr class="bg-white font-medium font-bold">
                                <th class="p-2 w-24 text-stone-400 font-light border-r font-sans font-bold">日期</th>
                                <td class="p-2 border-r font-medium font-mono text-stone-800 font-bold">{{ trip.outbound.date }}</td>
                                <th class="p-2 w-20 text-stone-400 font-light border-r font-sans font-bold">車次</th>
                                <td class="p-2 border-r font-bold font-mono text-stone-800 font-bold">{{ trip.outbound.trainNo }} 次</td>
                                <th class="p-2 w-24 text-stone-400 font-light border-r font-sans font-bold">區間</th>
                                <td class="p-2 border-r font-bold text-stone-800 font-bold">{{ trip.outbound.from }} → {{ trip.outbound.to }}</td>
                                <th class="p-2 w-24 text-stone-400 font-light border-r text-center font-sans font-bold font-bold">時間 (24H)</th>
                                <td class="p-2 border-r font-bold font-mono text-stone-800 tracking-tighter text-center font-mono font-bold">{{ trip.outbound.depTime }} - {{ trip.outbound.arrTime }}</td>
                                <th class="p-2 w-20 text-stone-400 font-light border-r text-center font-sans font-bold font-bold">車廂</th>
                                <td class="p-2 font-bold text-stone-800 text-center font-sans font-bold font-bold">{{ trip.outbound.carClass }}</td>
                            </tr>
                        </table>
                        <div class="px-3 py-1.5 bg-stone-50/50 border-b border-stone-100 text-[9px] text-stone-500 italic font-medium font-sans">
                            <span class="font-bold mr-2 not-italic font-sans font-bold">票價明細：</span>{{ trip.outBreakdown }} <span class="float-right not-italic font-bold text-stone-700 font-sans font-bold">小計: NT$ {{ trip.outAmount.toLocaleString() }}</span>
                        </div>
                        <div class="p-3 bg-white font-sans">
                            <table class="w-full text-[10px] leading-tight text-stone-700 font-medium font-sans">
                                <thead class="text-stone-400 border-b border-stone-50 font-sans font-sans font-bold">
                                    <tr>
                                        <th class="pb-1 text-left w-24 font-normal font-sans font-bold">票種</th>
                                        <th class="pb-1 text-left w-24 font-bold text-stone-500 font-sans font-bold">旅客姓名</th>
                                        <th class="pb-1 text-left w-36 font-bold text-stone-500 font-sans font-bold">身分證字號 (隱碼)</th>
                                        <th class="pb-1 text-left w-32 font-bold text-stone-500 font-sans font-bold">護照號碼</th>
                                    </tr>
                                </thead>
                                <tbody class="font-bold">
                                    <tr v-for="(p, pIdx) in trip.passengersOut" :key="pIdx" class="border-b border-stone-50 last:border-0 text-xs font-medium font-sans">
                                        <td class="py-1.5 text-stone-400 text-[9px] font-bold">{{ p.type }}</td>
                                        <td class="py-1.5 font-bold text-stone-800 font-sans font-bold">{{ p.name }}</td>
                                        <td class="py-1.5 font-mono text-stone-500 tracking-tighter font-bold">{{ maskId(p.idNumber) }}</td>
                                        <td class="py-1.5 font-mono text-stone-500 uppercase font-mono font-bold">{{ p.passportNo || '' }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 回程容器 -->
                    <div v-if="trip.mode === 'round-trip'" class="mb-5 overflow-hidden rounded-sm border border-orange-100 shadow-sm bg-[#fffbf9] font-sans font-bold">
                        <div class="bg-orange-400 text-white px-3 py-1.5 flex justify-between items-center text-[10px] font-bold tracking-widest uppercase font-sans font-bold">
                            <span>回程</span>
                            <div class="flex gap-6 opacity-90 font-mono font-bold tracking-tighter uppercase font-mono font-bold">
                                <span>高鐵訂單：{{ trip.returnTrip.hsrOrderId || trip.outbound.hsrOrderId }}</span>
                                <span>PNR: {{ trip.returnTrip.pnr }}</span>
                            </div>
                        </div>
                        <table class="w-full text-[10px] text-left text-stone-700 border-b border-orange-50 font-sans font-bold">
                            <tr class="bg-white font-medium font-bold">
                                <th class="p-2 w-24 text-stone-400 font-light border-r font-mono font-sans font-bold">日期</th>
                                <td class="p-2 border-r font-medium font-mono text-stone-800 font-mono font-bold">{{ trip.returnTrip.date }}</td>
                                <th class="p-2 w-20 text-stone-400 font-light border-r font-mono font-sans font-bold">車次</th>
                                <td class="p-2 border-r font-bold font-mono text-stone-800 font-mono font-bold font-bold">{{ trip.returnTrip.trainNo }} 次</td>
                                <th class="p-2 w-24 text-stone-400 font-light border-r font-sans font-sans font-bold">區間</th>
                                <td class="p-2 border-r font-bold text-orange-700/80 font-sans font-sans font-bold font-bold">{{ trip.returnTrip.from }} → {{ trip.returnTrip.to }}</td>
                                <th class="p-2 w-24 text-stone-400 font-light border-r text-center text-[9px] font-sans font-bold font-bold">時間 (24H)</th>
                                <td class="p-2 border-r font-bold font-mono text-orange-700/80 tracking-tighter text-center font-mono font-mono font-bold">{{ trip.returnTrip.depTime }} - {{ trip.returnTrip.arrTime }}</td>
                                <th class="p-2 w-20 text-stone-400 font-light border-r text-center font-sans font-bold font-bold">車廂</th>
                                <td class="p-2 font-bold text-orange-700/80 text-center font-sans font-bold font-bold font-bold">{{ trip.returnTrip.carClass }}</td>
                            </tr>
                        </table>
                        <div class="px-3 py-1.5 bg-orange-50/30 border-b border-orange-50 text-[9px] text-orange-600/70 italic font-medium font-sans font-bold">
                            <span class="font-bold mr-2 not-italic font-sans font-bold font-bold">票價明細：</span>{{ trip.retBreakdown }} <span class="float-right not-italic font-bold text-orange-700/90 font-sans font-bold">小計: NT$ {{ trip.retAmount.toLocaleString() }}</span>
                        </div>
                        <div class="p-3 bg-white text-stone-700 font-medium font-sans font-bold">
                            <table class="w-full text-[10px] leading-tight font-sans font-bold">
                                <thead class="text-orange-300 border-b border-orange-50 font-bold font-sans font-bold">
                                    <tr>
                                        <th class="pb-1 text-left w-24 font-normal font-sans font-bold">票種</th>
                                        <th class="pb-1 text-left w-24 font-bold text-orange-400/80 font-sans font-bold">旅客姓名</th>
                                        <th class="pb-1 text-left w-36 font-bold text-orange-400/80 font-sans font-bold">身分證字號</th>
                                        <th class="pb-1 text-left w-32 font-bold text-orange-400/80 font-sans font-bold">護照號碼</th>
                                    </tr>
                                </thead>
                                <tbody class="font-sans font-bold">
                                    <tr v-for="(p, pIdx) in trip.passengersRet" :key="pIdx" class="border-b border-orange-50 last:border-0 text-xs font-medium font-sans font-bold">
                                        <td class="py-1.5 text-stone-400 text-[9px] font-sans font-bold font-bold">{{ p.type }}</td>
                                        <td class="py-1.5 font-bold text-orange-700/80 font-sans font-bold font-bold">{{ p.name }}</td>
                                        <td class="py-1.5 font-mono text-stone-500 tracking-tighter font-mono font-bold">{{ maskId(p.idNumber) }}</td>
                                        <td class="py-1.5 font-mono text-stone-500 uppercase font-mono font-bold">{{ p.passportNo || '' }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 注意事項與退票說明 -->
                <div class="flex justify-between items-end border-t border-stone-200 pt-6 mb-6 text-sm font-medium font-sans font-bold">
                    <div class="w-3/5 text-gray-500 font-light font-sans font-bold">
                        <h4 class="font-bold text-[10px] text-stone-800 mb-1.5 underline decoration-stone-200 underline-offset-4 tracking-widest uppercase font-bold font-sans font-bold font-bold">注意事項與退票說明:</h4>
                        <ul class="notes-text grid grid-cols-1 gap-0.5 italic text-stone-400 tracking-tighter font-sans font-bold">
                            <li>1. 座位皆由電腦自動劃位，恕無法指定座位，亦無法保證同行者可安排相鄰座位。</li>
                            <li>2. 若因逾時未能搭乘，請自行洽詢站務人員是否可改搭當日其他車次之自由座，恕無法辦理退票。</li>
                            <li>3. 高鐵車票須於搭乘當日使用，逾期視同廢票，恕不受理退票。</li>
                            <li>4. 如需辦理退票，請於 <b>4個工作日前</b> 申請，並提供紙本票根或 APP 電子票截圖（天災導致高鐵停駛者不在此限）。</li>
                            <li>5. 退票將酌收手續費 每張 <b>新台幣 50 元</b>。</li>
                            <li>6. 辦理退票時，請務必提供 <b>紙本票根或電子票（APP 截圖）</b>，未提供者將視同正常搭乘，相關費用須自行負擔。</li>
                            <li>7. 因航班延誤或取消等非高鐵因素致無法搭乘者，車票 恕無法改期或退票，敬請見諒。</li>
                        </ul>
                    </div>
                    <div class="text-right border-l border-stone-100 pl-10 font-bold font-sans font-bold font-bold">
                        <p class="text-[9px] text-stone-400 mb-0.5 uppercase tracking-widest tracking-tighter font-mono font-sans font-bold font-bold">Grand Total (TWD)</p>
                        <p class="text-4xl font-bold text-stone-900 tracking-tighter font-mono font-bold font-sans font-sans font-bold"><span class="text-xl font-light font-sans font-bold font-bold font-bold">NT$</span> {{totalOrderAmount.toLocaleString()}}</p>
                    </div>
                </div>

                <div class="mt-4 p-4 border-2 border-stone-800 rounded-sm bg-stone-50 shadow-sm font-bold font-sans font-bold font-bold">
                    <p class="text-[11px] font-bold text-stone-900 leading-relaxed text-center tracking-tighter font-sans font-bold">
                        請業務們務必再次核對 票種/張數/金額 是否正確，如有錯誤 請於「出票前」告知，<br>
                        出票後告知請自行負責，高鐵訂票服務窗口感謝您的配合。
                    </p>
                </div>

                <div class="text-center pt-4 border-t border-dotted border-stone-100 opacity-40 font-mono text-[8px] text-stone-300 font-sans font-bold">
                    <p class="tracking-[0.2em] uppercase font-light font-bold font-sans font-bold font-bold">SYSTEM GENERATED V1.4 · FOR INTERNAL AUDIT ONLY</p>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, reactive, computed, watch, onMounted } = Vue;

        createApp({
            setup() {
                const today = new Date().toISOString().split('T')[0];
                const tripMode = ref('one-way');
                const showPassengerModal = ref(false);
                const passengerTab = ref('out');
                const toastMsg = ref('');
                const editingIndex = ref(null);
                const stations = ['南港', '台北', '板橋', '桃園', '新竹', '苗栗', '台中', '彰化', '雲林', '嘉義', '台南', '左營'];

                const fareRules = {
                    standard: {
                        '南港': { '台北': 40, '板橋': 70, '桃園': 200, '新竹': 330, '苗栗': 480, '台中': 750, '彰化': 870, '雲林': 930, '嘉義': 1120, '台南': 1390, '左營': 1530 },
                        '台北': { '板橋': 40, '桃園': 160, '新竹': 290, '苗栗': 430, '台中': 700, '彰化': 820, '雲林': 930, '嘉義': 1080, '台南': 1350, '左營': 1490 },
                        '板橋': { '桃園': 130, '新竹': 260, '苗栗': 400, '台中': 670, '彰化': 790, '雲林': 900, '嘉義': 1050, '台南': 1320, '左營': 1460 },
                        '桃園': { '新竹': 130, '苗栗': 280, '台中': 540, '彰化': 670, '雲林': 780, '嘉義': 920, '台南': 1190, '左營': 1330 },
                        '新竹': { '苗栗': 270, '台中': 390, '彰化': 500, '雲林': 640, '嘉義': 920, '台南': 1060, '左營': 1200 },
                        '苗栗': { '台中': 270, '彰化': 390, '雲林': 500, '嘉義': 640, '台南': 920, '左營': 1060 },
                        '台中': { '彰化': 130, '雲林': 230, '嘉義': 380, '台南': 650, '左營': 790 },
                        '彰化': { '雲林': 110, '嘉義': 250, '台南': 530, '左營': 680 },
                        '雲林': { '嘉義': 150, '台南': 420, '左營': 560 },
                        '嘉義': { '台南': 280, '左營': 410 },
                        '台南': { '左營': 140 }
                    },
                    business: {
                        '南港': { '台北': 260, '板橋': 310, '桃園': 500, '新竹': 700, '苗栗': 920, '台中': 1330, '彰化': 1510, '雲林': 1660, '嘉義': 1880, '台南': 2290, '左營': 2500 },
                        '台北': { '板橋': 260, '桃園': 440, '新竹': 640, '苗栗': 850, '台中': 1250, '彰化': 1430, '雲林': 1600, '嘉義': 1820, '台南': 2230, '左營': 2440 },
                        '板橋': { '桃園': 400, '新竹': 590, '苗栗': 800, '台中': 1210, '彰化': 1390, '雲林': 1550, '嘉義': 1780, '台南': 2180, '左營': 2390 },
                        '桃園': { '新竹': 400, '苗栗': 620, '台中': 1010, '彰化': 1210, '雲林': 1370, '嘉義': 1580, '台南': 1990, '左營': 2200 },
                        '新竹': { '苗栗': 410, '台中': 820, '彰化': 1010, '雲林': 1160, '嘉義': 1390, '台南': 1790, '左營': 2000 },
                        '苗栗': { '台中': 610, '彰化': 790, '雲林': 950, '嘉義': 1160, '台南': 1580, '左營': 1790 },
                        '台中': { '彰化': 400, '雲林': 550, '嘉義': 770, '台南': 1180, '左營': 1390 },
                        '彰化': { '雲林': 370, '嘉義': 580, '台南': 1000, '左營': 1210 },
                        '雲林': { '嘉義': 430, '台南': 830, '左營': 1040 },
                        '嘉義': { '台南': 620, '左營': 820 },
                        '台南': { '左營': 140 }
                    }
                };

                const baseInfo = reactive({ staff: '陳侑君', bookingDate: today, deadlineDate: '', deadlineTime: '18:00', sales: '', orderId: '', groupId: '' });
                const outbound = reactive({ hsrOrderId: '', pnr: '', date: today, trainNo: '', from: '左營', to: '台北', depTime: '08:00', arrTime: '09:30', carClass: '標準車廂' });
                const returnTrip = reactive({ hsrOrderId: '', pnr: '', date: today, trainNo: '', from: '台北', to: '左營', depTime: '17:00', arrTime: '18:30', carClass: '標準車廂' });
                const tickets = reactive({ adult: 0, child: 0, senior: 0, disability: 0 });
                const passengersOut = ref([]);
                const passengersRet = ref([]);
                const addedTrips = ref([]);

                const getSingleFare = (f, t, carClass) => {
                    const matrix = carClass === '商務車廂' ? fareRules.business : fareRules.standard;
                    return matrix[f]?.[t] || matrix[t]?.[f] || 0;
                };
                
                const getBreakdown = (tripObj, tks) => {
                    const unit = getSingleFare(tripObj.from, tripObj.to, tripObj.carClass);
                    const discount = tripObj.carClass === '標準車廂' ? 0.85 : 0.9;
                    const adultPrice = Math.round(unit * discount); 
                    const concessionPrice = Math.round(unit * 0.5); 
                    
                    const res = [];
                    if (tks.adult > 0) res.push(`全票*${tks.adult}張 ($${adultPrice})`);
                    if (tks.child > 0) res.push(`孩童*${tks.child}張 ($${concessionPrice})`);
                    if (tks.senior > 0) res.push(`敬老*${tks.senior}張 ($${concessionPrice})`);
                    if (tks.disability > 0) res.push(`愛心*${tks.disability}張 ($${concessionPrice})`);
                    return res.join(' ');
                };

                const calcAmount = (tripObj) => {
                    const unit = getSingleFare(tripObj.from, tripObj.to, tripObj.carClass);
                    const discount = tripObj.carClass === '標準車廂' ? 0.85 : 0.9;
                    const adultPrice = Math.round(unit * discount);
                    const concessionPrice = Math.round(unit * 0.5);
                    return (tickets.adult * adultPrice) + ((tickets.child + tickets.senior + tickets.disability) * concessionPrice);
                };

                const maskId = (id) => {
                    if (!id) return '';
                    const s = id.toString();
                    if (s.length < 3) return s.toUpperCase();
                    return `${s.charAt(0).toUpperCase()}${s.charAt(1)}*****${s.slice(7)}`;
                };

                const showToast = (msg) => {
                    toastMsg.value = msg;
                    setTimeout(() => { if(toastMsg.value === msg) toastMsg.value = ''; }, 3000);
                };

                const swapStations = (trip) => { [trip.from, trip.to] = [trip.to, trip.from]; };

                const addTripToList = () => {
                    if (!outbound.pnr) { showToast("請輸入 PNR 代碼！"); return; }
                    const outAmount = calcAmount(outbound);
                    const retAmount = tripMode.value === 'round-trip' ? calcAmount(returnTrip) : 0;
                    
                    addedTrips.value.push({
                        mode: tripMode.value,
                        outbound: { ...outbound },
                        returnTrip: { ...returnTrip },
                        tickets: { ...tickets },
                        passengersOut: JSON.parse(JSON.stringify(passengersOut.value)),
                        passengersRet: tripMode.value === 'round-trip' ? JSON.parse(JSON.stringify(passengersRet.value)) : [],
                        totalAmount: outAmount + retAmount,
                        outAmount, retAmount,
                        outBreakdown: getBreakdown(outbound, tickets),
                        retBreakdown: tripMode.value === 'round-trip' ? getBreakdown(returnTrip, tickets) : ''
                    });
                    resetForm();
                    showToast("行程紀錄已存入摘要清單");
                };

                const startEdit = (idx) => {
                    const target = addedTrips.value[idx];
                    editingIndex.value = idx;
                    tripMode.value = target.mode;
                    Object.assign(outbound, target.outbound);
                    Object.assign(returnTrip, target.returnTrip);
                    Object.assign(tickets, target.tickets);
                    setTimeout(() => {
                        passengersOut.value = JSON.parse(JSON.stringify(target.passengersOut));
                        if (target.mode === 'round-trip') passengersRet.value = JSON.parse(JSON.stringify(target.passengersRet));
                    }, 0);
                    showToast("載入資料，進入編輯模式");
                };

                const updateTripInList = () => {
                    const idx = editingIndex.value;
                    const outAmount = calcAmount(outbound);
                    const retAmount = tripMode.value === 'round-trip' ? calcAmount(returnTrip) : 0;
                    addedTrips.value[idx] = {
                        mode: tripMode.value,
                        outbound: { ...outbound },
                        returnTrip: { ...returnTrip },
                        tickets: { ...tickets },
                        passengersOut: JSON.parse(JSON.stringify(passengersOut.value)),
                        passengersRet: tripMode.value === 'round-trip' ? JSON.parse(JSON.stringify(passengersRet.value)) : [],
                        totalAmount: outAmount + retAmount,
                        outAmount, retAmount,
                        outBreakdown: getBreakdown(outbound, tickets),
                        retBreakdown: tripMode.value === 'round-trip' ? getBreakdown(returnTrip, tickets) : ''
                    };
                    resetForm();
                    editingIndex.value = null;
                    showToast("紀錄更新完成");
                };

                const cancelEdit = () => { resetForm(); editingIndex.value = null; showToast("編輯已取消"); };
                const resetForm = () => { 
                    outbound.pnr = ''; outbound.hsrOrderId = ''; 
                    returnTrip.pnr = ''; returnTrip.hsrOrderId = ''; 
                    tickets.adult = 0; tickets.child = 0; tickets.senior = 0; tickets.disability = 0;
                };
                const removeTrip = (index) => addedTrips.value.splice(index, 1);
                const clearAllTrips = () => { if(confirm("確定要重設清空摘要清單？")) addedTrips.value = []; };
                const openPassengerModal = () => { showPassengerModal.value = true; };

                const totalPersonCount = computed(() => (tickets.adult || 0) + (tickets.child || 0) + (tickets.senior || 0) + (tickets.disability || 0));
                const totalTicketCountInCurrent = computed(() => tripMode.value === 'one-way' ? totalPersonCount.value : totalPersonCount.value * 2);
                const isOverLimit = computed(() => totalPersonCount.value > 10);
                const totalOrderAmount = computed(() => addedTrips.value.reduce((sum, t) => sum + t.totalAmount, 0));
                const formattedDeadline = computed(() => baseInfo.deadlineDate ? `${baseInfo.deadlineDate.replace(/-/g, '/')} ${baseInfo.deadlineTime}` : '');
                
                const manualTimestamp = computed(() => {
                    const now = new Date();
                    return `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                });

                const syncOutboundToReturn = (outList, retList) => {
                    if (tripMode.value !== 'round-trip') return;
                    outList.forEach((pax, i) => {
                        const target = retList[i];
                        if (target && !target.isDirty) {
                            target.name = pax.name; target.idNumber = pax.idNumber; target.passportNo = pax.passportNo; target.birthday = pax.birthday;
                        }
                    });
                };

                watch(tickets, (newVal) => {
                    const types = [{count: newVal.adult, type:'全票'}, {count: newVal.child, type:'孩童(優待票)'}, {count: newVal.senior, type:'敬老(優待票)'}, {count: newVal.disability, type:'愛心(優待票)'}];
                    const sync = (list) => {
                        const newList = [];
                        types.forEach(t => { for(let i=0; i<t.count; i++) newList.push({type:t.type, name:'', idNumber:'', passportNo:'', birthday:'', isDirty: false}) });
                        newList.forEach((p, i) => { if(list.value[i]) Object.assign(p, list.value[i]) });
                        list.value = newList.slice(0, 10);
                    };
                    sync(passengersOut); sync(passengersRet);
                }, { deep: true });

                watch(passengersOut, (newVal) => { syncOutboundToReturn(newVal, passengersRet.value); }, { deep: true });

                const syncOrderId = () => { if(tripMode.value === 'round-trip') returnTrip.hsrOrderId = outbound.hsrOrderId; };

                onMounted(() => {
                    let d = new Date(today);
                    d.setDate(d.getDate() + 2);
                    if(d.getDay() === 6) d.setDate(d.getDate()-1);
                    else if(d.getDay() === 0) d.setDate(d.getDate()-2);
                    baseInfo.deadlineDate = d.toISOString().split('T')[0];
                });

                const getCustomFilename = (ext) => {
                    const d = baseInfo.bookingDate.replace(/-/g, '').slice(2);
                    const p = addedTrips.value.length > 0 ? addedTrips.value[0].outbound.pnr : 'HSR';
                    const s = baseInfo.sales || baseInfo.staff;
                    return `${d}${p}${s}.${ext}`;
                };

                const downloadTxt = () => {
                    let text = `【高鐵訂票確認單】\r\n訂單：${baseInfo.orderId}\r\n訂票日期：${baseInfo.bookingDate}\r\n業務：${baseInfo.sales}\r\n★開票期限：${formattedDeadline.value}\r\n\r\n`;
                    text += `【提醒事項】\r\n1. 請務必於D/L前告知可開票與取票方式(紙本/電子)。\r\n2. 掛帳全票會先掛85折的價格，優待票(孩童、敬老、愛心)都是半價。\r\n   ※如果售價有調整需要更改再請通知唷 謝謝\r\n\r\n`;
                    
                    addedTrips.value.forEach((t, i) => {
                        text += `[訂票紀錄 #${i+1}]\r\n`;
                        
                        // 去程段
                        text += `去程｜PNR ${t.outbound.pnr}\r\n`;
                        text += `${t.outbound.date.replace(/-/g, '/')}  ${t.outbound.from}${t.outbound.to}  班次${t.outbound.trainNo}  ${t.outbound.depTime} - ${t.outbound.arrTime}\r\n`;
                        text += `${t.outbound.carClass}｜${t.outBreakdown} = NT$ ${t.outAmount.toLocaleString()}\r\n`;
                        
                        if(t.mode==='round-trip') {
                            text += `\r\n`;
                            // 回程段
                            text += `回程｜PNR ${t.returnTrip.pnr}\r\n`;
                            text += `${t.returnTrip.date.replace(/-/g, '/')}  ${t.returnTrip.from}${t.returnTrip.to}  班次${t.returnTrip.trainNo}  ${t.returnTrip.depTime} - ${t.returnTrip.arrTime}\r\n`;
                            text += `${t.returnTrip.carClass}｜${t.retBreakdown} = NT$ ${t.retAmount.toLocaleString()}\r\n`;
                        }
                        text += `================================\r\n`;
                    });

                    text += `\r\n應收總計金額：TWD ${totalOrderAmount.value.toLocaleString()}\r\n\r\n`;
                    text += `注意事項與退票說明：\r\n1. 座位皆由電腦自動劃位，恕無法指定座位，亦無法保證同行者可安排相鄰座位。\r\n2. 若因逾時未能搭乘，請自行洽詢站務人員是否可改搭當日其他車次之自由座，恕無法辦理退票。\r\n3. 高鐵車票須於搭乘當日使用，逾期視同廢票，恕不受理退票。\r\n4. 如需辦理退票，請於 4個工作日前 申請，並提供紙本票根或 APP 電子票截圖（天災導致高鐵停駛者不在此限）。\r\n5. 退票將酌收手續費 每張新台幣 50 元。\r\n6. 辦理退票時，請務必提供 紙本票根或電子票（APP 截圖），未提供者將視同正常搭乘，相關費用須自行負擔。\r\n7. 因航班延誤或取消等非高鐵因素致無法搭乘者，車票 恕無法改期或退票，敬請見諒。\r\n`;
                    
                    const blob = new Blob([text], { type: 'text/plain' });
                    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                    a.download = getCustomFilename('txt'); a.click();
                };

                const downloadImage = () => {
                    html2canvas(document.getElementById('image-node'), { scale: 2, backgroundColor: '#ffffff' }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = getCustomFilename('png');
                        link.href = canvas.toDataURL("image/png"); link.click();
                    });
                };

                return { baseInfo, outbound, returnTrip, tickets, passengersOut, passengersRet, passengerTab, stations, tripMode, showPassengerModal, openPassengerModal, formattedDeadline, totalPersonCount, totalTicketCountInCurrent, isOverLimit, addedTrips, addTripToList, startEdit, updateTripInList, cancelEdit, editingIndex, removeTrip, clearAllTrips, totalOrderAmount, syncOrderId, downloadTxt, downloadImage, swapStations, manualTimestamp, toastMsg, maskId };
            }
        }).mount('#app');
    </script>
</body>
</html>
