<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜éµè¨‚ä½ç¢ºèªå–®ç”Ÿæˆå™¨ - å¤§åœ°çŸ³ç°ç‰ˆ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* =========================================
           ã€å¤§åœ°çŸ³ç°é¢¨æ ¼ (Stone Theme) è¨­å®šã€‘
           ========================================= */
        :root {
            --j-theme-main: #4a4a46; 
            --j-theme-sub: #8c8c88; 
            --j-bg-body: #f4f4f2; 
            --j-bg-card: #ffffff;
            --j-bg-input: #fafaf9;
            --j-bg-th: #f7fafc;
            --j-bg-tag: #f1f5f9;
            --j-border: #e5e5e0;
            --j-border-table: #e2e8f0;
            --j-text-body: #333333;
            --j-text-doc: #1a202c;
            --j-text-table: #2d3748;
            --j-text-th: #4a5568;
            --j-text-light: #a0aec0;
            --j-accent-red: #b94047;
        }

        /* ====================
           UI ä»‹é¢æ¨£å¼
           ==================== */
        body {
            font-family: 'Noto Sans TC', "Yu Gothic", "æ¸¸ã‚´ã‚·ãƒƒã‚¯", "Hiragino Kaku Gothic Pro", sans-serif;
            background-color: var(--j-bg-body); 
            color: var(--j-text-body);
            letter-spacing: 0.04em;
            min-height: 100vh;
        }

        .japanese-card {
            background: var(--j-bg-card);
            border: 1px solid var(--j-border);
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: all 0.3s ease;
        }
        .japanese-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-color: #d6d3d1;
        }

        .section-title {
            color: var(--j-theme-main);
            font-weight: 700;
            border-left: 4px solid var(--j-theme-main);
            padding-left: 12px;
            font-size: 1.125rem;
            letter-spacing: 0.1em;
        }

        .form-label { 
            font-size: 0.75rem; 
            color: var(--j-theme-sub);
            margin-bottom: 0.4rem; 
            font-weight: 700; 
        }
        
        input, select {
            background-color: var(--j-bg-input);
            border: 1px solid var(--j-border);
            border-radius: 4px;
            padding: 0.5rem 0.75rem; 
            font-size: 0.9rem; 
            width: 100%; 
            height: 40px; 
            color: var(--j-text-body);
            transition: all 0.2s;
        }
        input:focus, select:focus { 
            border-color: var(--j-theme-main); 
            box-shadow: 0 0 0 1px var(--j-theme-main); 
            outline: none; 
            background-color: #fff;
        }
        
        .btn-primary { 
            background-color: var(--j-theme-main);
            color: #fff; 
            font-weight: 600; 
            border-radius: 4px;
            letter-spacing: 0.05em;
        }
        .btn-primary:hover:not(:disabled) { 
            background-color: #292925;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }
        .btn-outline { 
            border: 1px solid var(--j-theme-sub); 
            color: var(--j-theme-sub); 
            background-color: white; 
            font-weight: 600; 
            border-radius: 4px; 
        }
        .btn-outline:hover { 
            background-color: var(--j-bg-input); 
            color: var(--j-theme-main);
            border-color: var(--j-theme-main);
        }
        
        .time-input { letter-spacing: 0.1em; text-align: center; }
        [v-cloak] { display: none; }
        
        .preview-wrapper {
            width: 100%;
            background-color: #57534e;
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23a8a29e' fill-opacity='0.15' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
            padding: 40px 20px;
            overflow: auto;
            border-top: 1px solid #a8a29e;
            display: flex;
            justify-content: center;
            margin-top: 40px;
        }

        /* =========================================
           ã€åœ–æª”æ–‡ä»¶æœ¬é«”æ¨£å¼ã€‘
           ========================================= */
        .doc-container {
            width: 850px;
            min-width: 850px;
            background-color: var(--j-bg-card);
            color: var(--j-text-doc);
            line-height: 1.35;
            font-family: 'Yu Gothic', 'Microsoft JhengHei', 'Hiragino Sans', sans-serif; 
            position: relative;
            box-sizing: border-box;
            padding: 40px 45px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .doc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 3px double var(--j-theme-main);
            padding-bottom: 10px;
        }
        .doc-title {
            font-size: 27px;
            font-weight: 900;
            color: var(--j-theme-main); 
            letter-spacing: 0.2em;
            margin: 0;
            line-height: 1;
            font-family: "MS Mincho", "Hiragino Mincho Pro", serif; 
        }
        .doc-subtitle {
            font-size: 10px;
            color: var(--j-theme-sub);
            font-weight: 600;
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-top: 6px;
        }
        .doc-meta { text-align: right; }
        .doc-timestamp { font-size: 9px; color: var(--j-text-light); font-family: Consolas, monospace; }

        .info-header-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            border: 1px solid var(--j-border-table);
            table-layout: fixed;
            background: #fff;
        }
        .info-header-table td {
            border-right: 1px solid var(--j-border-table);
            padding: 8px 6px;
            vertical-align: middle;
            text-align: center;
        }
        .info-header-table td:last-child { border-right: none; }
        
        .info-header-label {
            display: block;
            font-size: 9px;
            color: var(--j-theme-sub);
            font-weight: 600;
            margin-bottom: 3px;
            letter-spacing: 0.05em;
        }
        .info-header-value {
            display: block;
            font-size: 11px;
            font-weight: 800;
            color: var(--j-text-body);
            word-break: break-all;
        }
        .text-deadline { color: var(--j-accent-red) !important; }

        .notice-box {
            border: 1px dashed var(--j-theme-main); 
            background-color: var(--j-bg-body);
            padding: 12px 18px;
            margin-bottom: 25px;
            font-size: 10px;
            color: var(--j-text-table);
            border-radius: 4px;
            line-height: 1.7;
        }
        .notice-title { 
            font-weight: 900; 
            margin-bottom: 6px; 
            display: block; 
            font-size: 11px;
            color: var(--j-theme-main);
        }
        .checkbox-symbol { 
            font-family: sans-serif; 
            margin-right: 4px; 
            font-size: 13px;
            vertical-align: middle; 
            position: relative;
            top: -1px; 
            color: var(--j-theme-main);
        }

        .doc-section-header {
            font-size: 11px;
            font-weight: 900;
            color: #fff;
            background-color: var(--j-theme-main); 
            padding: 5px 20px;
            display: inline-block;
            margin-bottom: 0;
            border-radius: 4px 4px 0 0;
            letter-spacing: 2px;
        }

        .trip-container {
            margin-bottom: 5px; /* ä¿®æ”¹ï¼šé–“è·èª¿æ•´ç‚º 5px */
            border: 2px solid var(--j-theme-main); 
            border-radius: 0 4px 4px 4px;
            overflow: hidden;
            background: #fff;
        }
        
        .trip-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
            text-align: center;
            line-height: 1.5; /* ä¿®æ”¹ï¼šè¡Œé«˜æ”¹ç‚º 1.5 */
            table-layout: fixed;
        }
        .trip-table th {
            background-color: var(--j-bg-th);
            color: var(--j-text-th);
            font-weight: 700;
            padding: 8px 4px; /* ä¿®æ”¹ï¼šæ¢å¾©ä¸Šä¸‹å°ç¨± padding */
            border-right: 1px solid var(--j-border-table);
            border-bottom: 1px solid var(--j-border-table);
            vertical-align: middle !important;
            letter-spacing: 0.05em;
        }
        .trip-table th:last-child { border-right: none; }
        
        .trip-table td {
            background-color: #fff;
            color: var(--j-text-table);
            padding: 8px 4px; /* ä¿®æ”¹ï¼šæ¢å¾©ä¸Šä¸‹å°ç¨± padding */
            border-right: 1px solid var(--j-border-table);
            border-bottom: 1px solid var(--j-border-table);
            font-weight: 600;
            vertical-align: middle !important;
        }
        
        .hsr-code {
            font-family: "Courier New", Consolas, monospace; 
            font-weight: 900; 
            color: var(--j-theme-main); 
            font-size: 12px;
            letter-spacing: 0.05em;
        }

        .fare-row-header th {
            background-color: #fafaf9 !important;
            color: var(--j-theme-sub) !important;
            font-weight: 700;
            font-size: 9px;
            border-bottom: 1px dashed var(--j-border) !important;
            padding: 4px;
        }
        .fare-row-data td {
            background-color: #fafaf9 !important; 
            color: var(--j-text-table);
            font-family: Consolas, monospace;
            font-size: 9px;
            padding: 4px;
            border-top: none !important;
        }
        .fare-total-price {
            font-weight: 900;
            color: var(--j-theme-main);
            font-size: 10px;
        }

        .summary-bar {
            background-color: var(--j-bg-tag);
            padding: 6px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 10px;
            font-weight: 700;
            color: var(--j-text-th);
            border-top: 1px solid var(--j-border-table);
            border-bottom: 1px solid var(--j-border-table);
        }

        .pax-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            text-align: center;
            line-height: 1.5; /* ä¿®æ”¹ï¼šè¡Œé«˜æ”¹ç‚º 1.5 */
        }
        .pax-table th {
            background-color: var(--j-bg-th);
            color: var(--j-text-th);
            padding: 6px 5px; /* ä¿®æ”¹ï¼šæ¢å¾©ä¸Šä¸‹å°ç¨± padding */
            font-weight: 800;
            border-bottom: 1px solid var(--j-border-table);
            border-right: 1px solid var(--j-border-table);
            font-size: 9px;
            text-align: center;
            vertical-align: middle !important;
        }
        .pax-table td {
            padding: 6px 5px; /* ä¿®æ”¹ï¼šæ¢å¾©ä¸Šä¸‹å°ç¨± padding */
            color: var(--j-text-table);
            border-bottom: 1px solid var(--j-border-table);
            border-right: 1px solid var(--j-border-table);
            font-size: 9px;
            text-align: center;
            vertical-align: middle !important;
        }

        .grand-total {
            text-align: right;
            margin-top: 30px;
            padding-top: 15px;
            border-top: 2px solid var(--j-theme-main);
        }
        .total-label { font-size: 11px; color: var(--j-theme-sub); font-weight: 700; margin-right: 12px; letter-spacing: 0.1em; }
        .total-value { font-size: 31px; font-weight: 900; color: var(--j-theme-main); font-family: 'Arial', sans-serif; letter-spacing: -0.02em; }

        .warning-text {
            color: #9b2c2c;
            background-color: #fff5f5;
            border: 1px solid #fc8181;
            font-weight: 800;
            margin-top: 20px;
            margin-bottom: 15px;
            padding: 12px 18px;
            display: block;
            font-size: 11px;
            line-height: 1.6;
            text-align: center;
            border-radius: 4px;
        }

        .footer-terms {
            margin-top: 30px;
            font-size: 9px;
            color: var(--j-text-table);
            border-top: 1px dashed var(--j-border);
            padding-top: 20px;
            line-height: 1.8;
        }
        .footer-title { font-weight: 800; color: var(--j-theme-main); display: block; margin-bottom: 8px; font-size: 10px; letter-spacing: 0.1em; }
        .note-item { display: flex; align-items: flex-start; margin-bottom: 3px; }
        .note-num { width: 18px; flex-shrink: 0; font-weight: 700; color: var(--j-theme-main); }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app" v-cloak class="max-w-6xl mx-auto">
        <header class="mb-10 text-center">
            <h1 class="text-3xl font-bold text-stone-700 tracking-wider font-serif">é«˜éµè¨‚ä½ç¢ºèªå–®ç”Ÿæˆå™¨</h1>
            <div class="flex items-center justify-center gap-2 mt-2">
                <span class="h-[1px] w-8 bg-stone-300"></span>
                <p class="text-stone-400 text-xs tracking-[0.2em] uppercase">Professional Slip Generator</p>
                <span class="h-[1px] w-8 bg-stone-300"></span>
            </div>
        </header>

        <div v-if="toastMsg" class="fixed top-6 left-1/2 -translate-x-1/2 z-[100] bg-stone-800 text-white px-6 py-3 rounded shadow-lg text-sm flex items-center gap-2 transition-all">
            <span class="w-2 h-2 bg-emerald-400 rounded-full"></span>{{ toastMsg }}
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
              
            <div class="lg:col-span-8 space-y-6">
                <!-- åŸºæœ¬è³‡æ–™å¡ç‰‡ -->
                <div class="japanese-card p-6 md:p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="section-title">åŸºæœ¬è³‡æ–™ç®¡ç†</h2>
                        <div class="flex gap-3">
                            <button @click="focusInput('staff')" class="text-xs text-stone-500 hover:text-stone-700 hover:underline font-bold transition">âœ ç·¨è¼¯</button>
                            <button @click="clearBasicInfo" class="text-xs text-stone-500 hover:text-red-700 hover:underline font-bold transition">ğŸ—‘ æ¸…é™¤</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                        <div class="flex flex-col"><label class="form-label">è¨‚ç¥¨äººå“¡</label><input ref="staffInput" type="text" v-model="baseInfo.staff"></div>
                        <div class="flex flex-col"><label class="form-label">è¨‚ç¥¨æ—¥æœŸ</label><input type="date" v-model="baseInfo.bookingDate"></div>
                        <div class="flex flex-col">
                            <label class="form-label text-[#b94047] font-bold">é–‹ç¥¨æœŸé™ (DL)</label>
                            <div class="flex gap-2"><input type="date" v-model="baseInfo.deadlineDate"><input type="text" v-model="baseInfo.deadlineTime" class="time-input w-24"></div>
                        </div>
                        <div class="flex flex-col"><label class="form-label">æ¥­å‹™å§“å</label><input type="text" v-model="baseInfo.sales"></div>
                        <div class="flex flex-col"><label class="form-label">è¨‚å–®ç·¨è™Ÿ</label><input type="text" v-model="baseInfo.orderId"></div>
                        <div class="flex flex-col"><label class="form-label">åœ˜é«”ä»£è™Ÿ</label><input type="text" v-model="baseInfo.groupId"></div>
                    </div>
                </div>

                <!-- è¡Œç¨‹è¨­å®šå¡ç‰‡ -->
                <div class="japanese-card p-6 md:p-8 relative">
                    <div v-if="editingIndex !== null" class="absolute top-6 right-8 bg-[#4a4a46] text-white px-4 py-1 text-xs font-bold rounded-full shadow-md animate-pulse">ç·¨è¼¯æ¨¡å¼ä¸­</div>
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="section-title">è¡Œç¨‹è©³ç´°è¨­å®š</h2>
                        <div class="flex items-center gap-4">
                            <button @click="focusInput('hsrId')" class="btn-outline px-3 py-1 text-xs border-none font-bold">âœ ç·¨è¼¯ ID</button>
                            <button @click="clearTripForm" class="btn-outline px-3 py-1 text-xs border-none text-[#b94047] font-bold">ğŸ—‘ é‡ç½®è¡¨å–®</button>
                        </div>
                    </div>

                    <div class="space-y-8">
                        <!-- è¡Œç¨‹è³‡è¨Š (é€šç”¨è¡¨å–®) -->
                        <div class="p-5 bg-[#fafaf9] border border-[#e5e5e0] rounded-lg">
                            <span class="text-[11px] bg-[#4a4a46] text-white px-3 py-1 rounded-sm font-bold uppercase mb-4 inline-block tracking-widest">Trip Details</span>
                            <div class="grid grid-cols-1 md:grid-cols-12 gap-5">
                                <div class="md:col-span-6"><label class="form-label">é«˜éµè¨‚ä½ç·¨è™Ÿ</label><input ref="hsrIdInput" type="text" v-model="tripForm.hsrOrderId" class="font-bold tracking-widest text-[#4a4a46]" placeholder="8ç¢¼ç·¨è™Ÿ"></div>
                                <div class="md:col-span-6"><label class="form-label">PNR ä»£ç¢¼</label><input type="text" v-model="tripForm.pnr" class="uppercase font-bold tracking-widest"></div>
                                <div class="md:col-span-4"><label class="form-label">æ—¥æœŸ</label><input type="date" v-model="tripForm.date"></div>
                                <div class="md:col-span-4"><label class="form-label">è‰™ç­‰</label><select v-model="tripForm.carClass"><option>æ¨™æº–è»Šå»‚</option><option>å•†å‹™è»Šå»‚</option></select></div>
                                <div class="md:col-span-4"><label class="form-label">è»Šæ¬¡</label><input type="text" v-model="tripForm.trainNo"></div>
                                <div class="md:col-span-6"><label class="form-label">èµ·è¨–ç«™é»</label><div class="flex gap-2 items-center"><select v-model="tripForm.from"><option v-for="s in stations">{{s}}</option></select><button @click="swapStations" class="text-stone-400 hover:text-[#4a4a46] text-lg transition">â‡„</button><select v-model="tripForm.to"><option v-for="s in stations">{{s}}</option></select></div></div>
                                <div class="md:col-span-6"><label class="form-label">æ™‚é–“ (24H)</label><div class="flex gap-2 items-center"><input type="text" v-model="tripForm.depTime" class="time-input" placeholder="09:00"><span class="text-stone-400">-</span><input type="text" v-model="tripForm.arrTime" class="time-input" placeholder="10:30"></div></div>
                            </div>
                        </div>

                        <!-- ç¥¨æ•¸è¨­å®šå€ -->
                        <div class="bg-white p-6 border border-[#e5e5e0] rounded-lg">
                            <div class="mb-5">
                                <p class="text-xs font-bold mb-3 text-stone-600 border-b border-[#e5e5e0] pb-2">ç¥¨æ•¸è¨­å®š</p>
                                <div class="grid grid-cols-4 gap-3">
                                    <div><label class="form-label">å…¨ç¥¨</label><input type="number" v-model.number="ticketForm.adult" min="0"></div>
                                    <div><label class="form-label">å­©ç«¥</label><input type="number" v-model.number="ticketForm.child" min="0"></div>
                                    <div><label class="form-label">æ•¬è€</label><input type="number" v-model.number="ticketForm.senior" min="0"></div>
                                    <div><label class="form-label">æ„›å¿ƒ</label><input type="number" v-model.number="ticketForm.disability" min="0"></div>
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-center gap-3 mt-4 pt-4 border-t border-[#e5e5e0]">
                                <button @click="openPassengerModal" :disabled="totalTickets === 0" class="btn-outline px-5 py-2 text-sm">ç·¨è¼¯åå–®</button>
                                
                                <div v-if="editingIndex === null" class="flex gap-2">
                                    <button @click="addTripToList('å»ç¨‹')" :disabled="totalTickets === 0" class="btn-primary px-5 py-2 text-sm shadow-md hover:shadow-lg transition flex items-center gap-1">
                                        <span class="text-lg leading-none">+</span> æ–°å¢å»ç¨‹
                                    </button>
                                    <button @click="addTripToList('å›ç¨‹')" :disabled="totalTickets === 0" class="bg-white text-[#4a4a46] border border-[#4a4a46] px-5 py-2 text-sm rounded font-bold hover:bg-[#fafaf9] transition flex items-center gap-1">
                                        <span class="text-lg leading-none">+</span> æ–°å¢å›ç¨‹
                                    </button>
                                </div>
                                
                                <div v-else class="flex gap-2">
                                    <button @click="updateTripInList" class="bg-[#4a4a46] text-white px-8 py-2 text-sm rounded shadow-md">æ›´æ–°è¡Œç¨‹</button>
                                    <button @click="cancelEdit" class="text-stone-400 text-sm px-2 hover:text-stone-600">å–æ¶ˆ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4 space-y-6">
                <div class="japanese-card p-6 sticky top-8 flex flex-col h-[85vh]">
                    <h2 class="section-title mb-4 border-b border-[#e5e5e0] pb-3">å·²ç™»éŒ„è¡Œç¨‹æ‘˜è¦</h2>
                    <div class="flex-1 overflow-y-auto space-y-3 pr-1">
                        <div v-if="addedTrips.length===0" class="flex flex-col items-center justify-center h-40 text-stone-300">
                            <span class="text-4xl mb-2">ğŸ“­</span>
                            <span class="text-sm">å°šæœªæ–°å¢ä»»ä½•è¡Œç¨‹</span>
                        </div>
                        <div v-for="(t, i) in addedTrips" :key="i" class="p-4 bg-white border border-[#e5e5e0] rounded-lg relative hover:border-[#4a4a46] transition group shadow-sm">
                            <div class="flex justify-between items-start mb-2">
                                <span :class="t.type === 'å»ç¨‹' ? 'bg-[#4a4a46]' : 'bg-[#8c8c88]'" class="text-[10px] text-white px-2 py-0.5 rounded font-mono font-bold">{{ t.type }} #{{ i + 1 }}</span>
                                <div class="flex gap-3 opacity-60 group-hover:opacity-100 transition">
                                    <button @click="startEdit(i)" class="text-[#4a4a46] text-xs font-bold hover:underline">ç·¨è¼¯</button>
                                    <button @click="removeTrip(i)" class="text-[#b94047] text-xs font-bold hover:underline">åˆªé™¤</button>
                                </div>
                            </div>
                            <p class="font-bold text-stone-700 mb-1 font-mono">ID: {{t.hsrOrderId}}</p>
                            <div class="flex justify-between text-xs text-stone-500 font-mono">
                                <span>{{t.date}} ({{t.from}}-{{t.to}})</span>
                                <span class="font-bold text-[#4a4a46]">NT$ {{t.totalAmount.toLocaleString()}}</span>
                            </div>
                        </div>
                    </div>
                    <div class="pt-5 border-t border-[#e5e5e0] mt-auto bg-white">
                        <div class="flex justify-between items-baseline mb-4">
                            <span class="text-stone-500 font-bold text-sm">ç¸½é‡‘é¡</span>
                            <span class="text-2xl font-bold text-[#4a4a46] font-sans">${{ totalOrderAmount.toLocaleString() }}</span>
                        </div>
                        <button @click="downloadImage" :disabled="addedTrips.length===0" class="w-full btn-primary py-3 mb-3 shadow-md font-bold text-sm flex items-center justify-center gap-2">
                             ä¸‹è¼‰åœ–ç‰‡
                        </button>
                        <div class="grid grid-cols-2 gap-3">
                            <button @click="downloadTxt" :disabled="addedTrips.length===0" class="btn-outline py-2 text-xs">ä¸‹è¼‰æ–‡å­—</button>
                            <button @click="copyText" :disabled="addedTrips.length===0" class="btn-outline py-2 text-xs">è¤‡è£½æ–‡å­—</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ—…å®¢åå–® Modal -->
        <div v-if="showPassengerModal" class="fixed inset-0 bg-stone-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg w-full max-w-4xl max-h-[80vh] flex flex-col shadow-2xl border border-[#e5e5e0]">
                <div class="p-5 border-b border-[#e5e5e0] flex justify-between items-center bg-[#f7fafc] rounded-t-lg">
                    <h3 class="font-bold text-stone-700 flex items-center gap-2">
                        <span class="w-1 h-4 bg-[#4a4a46] rounded-full"></span>
                        ç·¨è¼¯æ—…å®¢è³‡æ–™
                    </h3>
                    <button @click="showPassengerModal=false" class="text-stone-400 hover:text-stone-600 px-2 text-lg">âœ•</button>
                </div>
                <div class="p-6 overflow-y-auto flex-1 space-y-3 bg-white">
                    <div v-for="(p, i) in passengerList" :key="i" class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end border-b border-[#e5e5e0] pb-3 text-sm">
                        <div class="md:col-span-1 text-stone-400 font-mono text-xs font-bold pt-2">#{{i+1}}</div>
                        <div class="md:col-span-2 text-[#4a4a46] font-bold text-xs bg-[#f1f5f9] p-1 rounded text-center">{{p.type}}</div>
                        <div class="md:col-span-2"><input v-model="p.name" placeholder="å§“å" class="text-sm h-8" @input="p.name = $event.target.value"></div>
                        <div class="md:col-span-3"><input v-model="p.idNumber" placeholder="èº«åˆ†è­‰å­—è™Ÿ" class="text-sm h-8 uppercase font-mono" @input="p.idNumber = $event.target.value"></div>
                        <div class="md:col-span-2"><input v-model="p.passportNo" placeholder="è­·ç…§è™Ÿç¢¼" class="text-sm h-8 uppercase font-mono" @input="p.passportNo = $event.target.value"></div>
                        <div class="md:col-span-2"><input type="date" v-model="p.birthday" class="text-sm h-8" @input="p.birthday = $event.target.value"></div>
                    </div>
                </div>
                <div class="p-4 border-t border-[#e5e5e0] text-right bg-[#f7fafc] rounded-b-lg">
                    <button @click="showPassengerModal=false" class="btn-primary px-8 py-2 rounded shadow-md">å®Œæˆç·¨è¼¯</button>
                </div>
            </div>
        </div>

        <!-- é è¦½å€ -->
        <div class="preview-wrapper">
            <div id="image-node" class="doc-container">
                <div class="doc-header">
                    <div>
                        <h1 class="doc-title">é«˜éµè¨‚ä½ç¢ºèªå–®</h1>
                        <div class="doc-subtitle">BOOKING CONFIRMATION</div>
                    </div>
                    <div class="doc-meta">
                        <div class="doc-timestamp">{{ nowTimestamp }}</div>
                    </div>
                </div>

                <table class="info-header-table">
                    <tr>
                        <td><span class="info-header-label">è¨‚å–®ç·¨è™Ÿ</span><span class="info-header-value">{{ baseInfo.orderId || '-' }}</span></td>
                        <td><span class="info-header-label">åœ˜è™Ÿ</span><span class="info-header-value">{{ baseInfo.groupId || 'N/A' }}</span></td>
                        <td><span class="info-header-label">æ¥­å‹™äººå“¡</span><span class="info-header-value">{{ baseInfo.sales || '-' }}</span></td>
                        <td><span class="info-header-label">è¨‚ç¥¨æ—¥æœŸ</span><span class="info-header-value">{{ baseInfo.bookingDate.replace(/-/g, '/') }}</span></td>
                        <td><span class="info-header-label">è¨‚ç¥¨äººå“¡</span><span class="info-header-value">{{ baseInfo.staff }}</span></td>
                        <td><span class="info-header-label text-deadline">é–‹ç¥¨æœŸé™(D/L)</span><span class="info-header-value text-deadline">{{ formattedDeadline }}</span></td>
                    </tr>
                </table>

                <div class="notice-box">
                    <strong class="notice-title">ã€ é–‹ç¥¨èªªæ˜ ã€‘</strong>
                    <div>è«‹æ–¼ D/L å‰é€šçŸ¥ <strong>å¯é–‹ç¥¨</strong> ä»¥åŠ <strong>å–ç¥¨æ–¹å¼</strong>ï¼›é€¾æœŸç³»çµ±å°‡è‡ªå‹•å–æ¶ˆï¼Œéœ€é‡æ–°è¨‚ç¥¨ï¼Œç„¡æ³•ä¿è­‰æ˜¯å¦æœ‰ä½ã€‚</div>
                    <div style="margin-top:4px;">
                        å–ç¥¨æ–¹å¼ï¼š<span class="checkbox-symbol">â–¢</span>ç´™æœ¬ç¥¨ã€€
                        <span class="checkbox-symbol">â–¢</span>é›»å­ç¥¨(è«‹ä½¿ç”¨å°ç£é«˜éµAPPå–ç¥¨åŠåˆ†ç¥¨)ã€€
                        <span class="checkbox-symbol">â–¢</span>è¶…å•†å–ç¥¨(æ‰‹çºŒè²»è‡ªè² )ã€€ã€€â€» æ¯ä¸€ç­†è¨‚ä½ä»£ç¢¼ç‚ºçµ±ä¸€å–ç¥¨æ–¹å¼ã€‚
                    </div>

                    <div style="margin-top: 12px; padding-top: 8px; border-top: 1px dashed #cbd5e0; color: #4a5568;">
                        <strong>ã€ æ›å¸³èªªæ˜ ã€‘</strong>
                        <span>æ›å¸³ å…¨ç¥¨æœƒå…ˆæ› 85æŠ˜çš„åƒ¹æ ¼ï¼Œå„ªå¾…ç¥¨ï¼ˆå­©ç«¥ã€æ•¬è€ã€æ„›å¿ƒï¼‰éƒ½æ˜¯åŠåƒ¹ã€‚å¦‚æœå”®åƒ¹æœ‰èª¿æ•´éœ€è¦æ›´æ”¹è«‹å‹™å¿…é€šçŸ¥ï¼Œè¬è¬æ‚¨ã€‚</span>
                    </div>
                </div>

                <div class="doc-section-header">è¨‚ä½æ˜ç´°</div>

                <!-- é€™è£¡é–‹å§‹æ˜¯è¿´åœˆï¼Œæ¯å€‹è¡Œç¨‹éƒ½æ˜¯ç¨ç«‹çš„è¡¨æ ¼ -->
                <div v-for="(trip, idx) in addedTrips" :key="idx" class="trip-container">
                    <table class="trip-table">
                        <thead>
                            <tr>
                                <th style="width:8%;">è¡Œç¨‹</th>
                                <th colspan="2" style="width:20%;">é«˜éµè¨‚ä½ç·¨è™Ÿ</th>
                                <th style="width:10%;">PNR</th>
                                <th style="width:12%;">æ­ä¹˜æ—¥æœŸ</th>
                                <th style="width:10%;">è»Šæ¬¡</th>
                                <th style="width:10%;">èµ·ç¨‹è»Šç«™</th>
                                <th style="width:10%;">åˆ°é”è»Šç«™</th>
                                <th style="width:10%;">å‡ºç™¼æ™‚é–“</th>
                                <th style="width:10%;">æŠµé”æ™‚é–“</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="font-bold">{{ trip.type }}</td>
                                <td colspan="2" class="hsr-code">{{ trip.hsrOrderId || '-' }}</td>
                                <td style="font-family:Consolas, monospace; font-weight:700;">{{ trip.pnr }}</td>
                                <td>{{ trip.date.replace(/-/g, '/') }}</td>
                                <td>{{ trip.trainNo }}</td>
                                <td>{{ trip.from }}</td>
                                <td>{{ trip.to }}</td>
                                <td>{{ trip.depTime }}</td>
                                <td>{{ trip.arrTime }}</td>
                            </tr>
                        </tbody>
                        
                        <tbody class="fare-row-header">
                            <tr>
                                <th colspan="2">å…¨ç¥¨</th>
                                <th colspan="2">å­©ç«¥ç¥¨</th>
                                <th colspan="2">æ„›å¿ƒç¥¨</th>
                                <th colspan="2">æ•¬è€ç¥¨</th>
                                <th colspan="2">å°è¨ˆ</th>
                            </tr>
                        </tbody>
                        <tbody class="fare-row-data">
                            <tr>
                                <td colspan="2">{{ trip.calcDetails.adultStr }}</td>
                                <td colspan="2">{{ trip.calcDetails.childStr }}</td>
                                <td colspan="2">{{ trip.calcDetails.disabilityStr }}</td>
                                <td colspan="2">{{ trip.calcDetails.seniorStr }}</td>
                                <td colspan="2" class="fare-total-price">NT${{ trip.totalAmount.toLocaleString() }}</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="summary-bar">
                        <span>è»Šå»‚ï¼š{{ trip.carClass }}</span>
                        <span>ç¥¨ç¨®ï¼š{{ trip.breakdownText }}</span>
                    </div>

                    <table class="pax-table">
                        <thead><tr><th style="width:15%">ç¥¨ç¨®</th><th style="width:25%">å§“å</th><th style="width:35%">èº«åˆ†è­‰å­—è™Ÿ</th><th style="width:25%">è­·ç…§è™Ÿç¢¼</th></tr></thead>
                        <tbody>
                            <tr v-for="p in trip.passengers">
                                <td>{{ p.type }}</td><td>{{ p.name }}</td><td>{{ maskId(p.idNumber) }}</td><td>{{ p.passportNo || '' }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- è¿´åœˆçµæŸ -->

                <div class="grand-total">
                    <span class="total-label">ç¸½è¨ˆæ‡‰æ”¶é‡‘é¡</span>
                    <span class="total-value">NT$ {{ totalOrderAmount.toLocaleString() }}</span>
                </div>
                
                <strong class="warning-text">
                    è«‹æ¥­å‹™å€‘å‹™å¿…å†æ¬¡æ ¸å° ç¥¨ç¨®/å¼µæ•¸/é‡‘é¡ æ˜¯å¦æ­£ç¢ºï¼Œå¦‚æœ‰éŒ¯èª¤ è«‹æ–¼ã€Œå‡ºç¥¨å‰ã€å‘ŠçŸ¥ï¼Œå‡ºç¥¨å¾Œå‘ŠçŸ¥è«‹è‡ªè¡Œè² è²¬ã€‚<br>
                    é«˜éµè¨‚ç¥¨æœå‹™çª—å£æ„Ÿè¬æ‚¨çš„é…åˆã€‚
                </strong>

                <div class="footer-terms">
                    <strong class="footer-title">--- æ³¨æ„äº‹é … èˆ‡ æ”¹/é€€ç¥¨èªªæ˜ ---</strong>
                    <div class="note-item"><div class="note-num">1.</div><div class="note-text">åº§ä½çš†ç”±é›»è…¦è‡ªå‹•åŠƒä½ï¼Œæ•ç„¡æ³•æŒ‡å®šåº§ä½ï¼Œäº¦ç„¡æ³•ä¿è­‰åŒè¡Œè€…ç‚ºç›¸é„°åº§ä½ã€‚</div></div>
                    <div class="note-item"><div class="note-num">2.</div><div class="note-text">è‹¥å› é€¾æ™‚æœªèƒ½æ­ä¹˜ï¼Œè«‹è‡ªè¡Œæ´½è©¢ç«™å‹™äººå“¡æ˜¯å¦å¯æ”¹æ­ç•¶æ—¥å…¶ä»–è»Šæ¬¡ä¹‹è‡ªç”±åº§ï¼Œæ•ç„¡æ³•è¾¦ç†é€€ç¥¨ã€‚</div></div>
                    <div class="note-item"><div class="note-num">3.</div><div class="note-text">é«˜éµè»Šç¥¨é ˆæ–¼æ­ä¹˜ç•¶æ—¥ä½¿ç”¨ï¼Œé€¾æœŸè¦–åŒå»¢ç¥¨ï¼Œæ•ä¸å—ç†é€€ç¥¨ã€‚</div></div>
                    <div class="note-item"><div class="note-num">4.</div><div class="note-text">å¦‚éœ€è¾¦ç†æ”¹ç¥¨/é€€ç¥¨ï¼Œè«‹æ–¼ <strong>4å€‹å·¥ä½œæ—¥å‰</strong> ç”³è«‹ï¼Œä¸¦æä¾›ç´™æœ¬ç¥¨æ ¹æˆ– APP é›»å­ç¥¨æˆªåœ–(å¤©ç½å°è‡´é«˜éµåœé§›è€…ä¸åœ¨æ­¤é™)ã€‚</div></div>
                    <div class="note-item"><div class="note-num">5.</div><div class="note-text">é€€ç¥¨å°‡é…Œæ”¶æ‰‹çºŒè²» æ¯å¼µæ–°å°å¹£ 50 å…ƒã€‚</div></div>
                    <div class="note-item"><div class="note-num">6.</div><div class="note-text">è¾¦ç†æ”¹ç¥¨/é€€ç¥¨æ™‚ï¼Œè«‹å‹™å¿…æä¾› ç´™æœ¬ç¥¨æ ¹æˆ–é›»å­ç¥¨(APP æˆªåœ–)ï¼Œæœªæä¾›è€…å°‡è¦–åŒæ­£å¸¸æ­ä¹˜ï¼Œç›¸é—œè²»ç”¨é ˆè‡ªè¡Œè² æ“”ã€‚</div></div>
                    <div class="note-item"><div class="note-num">7.</div><div class="note-text">å› èˆªç­å»¶èª¤æˆ–å–æ¶ˆç­‰éé«˜éµå› ç´ è‡´ç„¡æ³•æ­ä¹˜è€…ï¼Œè»Šç¥¨ æ•ç„¡æ³•æ”¹æœŸæˆ–é€€ç¥¨ï¼Œæ•¬è«‹è¦‹è«’ã€‚</div></div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, reactive, computed, watch, onMounted } = Vue;

        createApp({
            setup() {
                const stations = ['å—æ¸¯', 'å°åŒ—', 'æ¿æ©‹', 'æ¡ƒåœ’', 'æ–°ç«¹', 'è‹—æ —', 'å°ä¸­', 'å½°åŒ–', 'é›²æ—', 'å˜‰ç¾©', 'å°å—', 'å·¦ç‡Ÿ'];
                const showPassengerModal = ref(false);
                const toastMsg = ref('');
                const addedTrips = ref([]);
                const editingIndex = ref(null);
                
                const staffInput = ref(null);
                const hsrIdInput = ref(null);

                // 2026 å®Œæ•´å®˜æ–¹ç¥¨åƒ¹ (å«å•†å‹™)
                const fareRules = {
                    standard: {
                        'å—æ¸¯': { 'å°åŒ—': 40, 'æ¿æ©‹': 70, 'æ¡ƒåœ’': 200, 'æ–°ç«¹': 330, 'è‹—æ —': 470, 'å°ä¸­': 740, 'å½°åŒ–': 860, 'é›²æ—': 970, 'å˜‰ç¾©': 1120, 'å°å—': 1390, 'å·¦ç‡Ÿ': 1530 },
                        'å°åŒ—': { 'æ¿æ©‹': 40, 'æ¡ƒåœ’': 160, 'æ–°ç«¹': 290, 'è‹—æ —': 430, 'å°ä¸­': 700, 'å½°åŒ–': 820, 'é›²æ—': 930, 'å˜‰ç¾©': 1080, 'å°å—': 1350, 'å·¦ç‡Ÿ': 1490 },
                        'æ¿æ©‹': { 'æ¡ƒåœ’': 130, 'æ–°ç«¹': 260, 'è‹—æ —': 400, 'å°ä¸­': 670, 'å½°åŒ–': 790, 'é›²æ—': 900, 'å˜‰ç¾©': 1050, 'å°å—': 1320, 'å·¦ç‡Ÿ': 1460 },
                        'æ¡ƒåœ’': { 'æ–°ç«¹': 130, 'è‹—æ —': 280, 'å°ä¸­': 540, 'å½°åŒ–': 670, 'é›²æ—': 780, 'å˜‰ç¾©': 920, 'å°å—': 1190, 'å·¦ç‡Ÿ': 1330 },
                        'æ–°ç«¹': { 'è‹—æ —': 140, 'å°ä¸­': 410, 'å½°åŒ–': 540, 'é›²æ—': 640, 'å˜‰ç¾©': 790, 'å°å—': 1060, 'å·¦ç‡Ÿ': 1200 },
                        'è‹—æ —': { 'å°ä¸­': 270, 'å½°åŒ–': 390, 'é›²æ—': 500, 'å˜‰ç¾©': 640, 'å°å—': 920, 'å·¦ç‡Ÿ': 1060 },
                        'å°ä¸­': { 'å½°åŒ–': 130, 'é›²æ—': 230, 'å˜‰ç¾©': 380, 'å°å—': 650, 'å·¦ç‡Ÿ': 790 },
                        'å½°åŒ–': { 'é›²æ—': 110, 'å˜‰ç¾©': 250, 'å°å—': 530, 'å·¦ç‡Ÿ': 670 },
                        'é›²æ—': { 'å˜‰ç¾©': 150, 'å°å—': 420, 'å·¦ç‡Ÿ': 560 },
                        'å˜‰ç¾©': { 'å°å—': 280, 'å·¦ç‡Ÿ': 410 },
                        'å°å—': { 'å·¦ç‡Ÿ': 140 }
                    },
                    business: {
                        'å—æ¸¯': { 'å°åŒ—': 260, 'æ¿æ©‹': 310, 'æ¡ƒåœ’': 500, 'æ–°ç«¹': 700, 'è‹—æ —': 920, 'å°ä¸­': 1330, 'å½°åŒ–': 1510, 'é›²æ—': 1660, 'å˜‰ç¾©': 1880, 'å°å—': 2290, 'å·¦ç‡Ÿ': 2500 },
                        'å°åŒ—': { 'æ¿æ©‹': 260, 'æ¡ƒåœ’': 440, 'æ–°ç«¹': 640, 'è‹—æ —': 850, 'å°ä¸­': 1250, 'å½°åŒ–': 1430, 'é›²æ—': 1600, 'å˜‰ç¾©': 1820, 'å°å—': 2230, 'å·¦ç‡Ÿ': 2440 },
                        'æ¿æ©‹': { 'æ¡ƒåœ’': 400, 'æ–°ç«¹': 590, 'è‹—æ —': 800, 'å°ä¸­': 1210, 'å½°åŒ–': 1390, 'é›²æ—': 1550, 'å˜‰ç¾©': 1780, 'å°å—': 2180, 'å·¦ç‡Ÿ': 2390 },
                        'æ¡ƒåœ’': { 'æ–°ç«¹': 400, 'è‹—æ —': 620, 'å°ä¸­': 1010, 'å½°åŒ–': 1210, 'é›²æ—': 1370, 'å˜‰ç¾©': 1580, 'å°å—': 1990, 'å·¦ç‡Ÿ': 2200 },
                        'æ–°ç«¹': { 'è‹—æ —': 410, 'å°ä¸­': 820, 'å½°åŒ–': 1010, 'é›²æ—': 1160, 'å˜‰ç¾©': 1390, 'å°å—': 1790, 'å·¦ç‡Ÿ': 2000 },
                        'è‹—æ —': { 'å°ä¸­': 610, 'å½°åŒ–': 790, 'é›²æ—': 950, 'å˜‰ç¾©': 1160, 'å°å—': 1580, 'å·¦ç‡Ÿ': 1790 },
                        'å°ä¸­': { 'å½°åŒ–': 400, 'é›²æ—': 550, 'å˜‰ç¾©': 770, 'å°å—': 1180, 'å·¦ç‡Ÿ': 1390 },
                        'å½°åŒ–': { 'é›²æ—': 370, 'å˜‰ç¾©': 580, 'å°å—': 1000, 'å·¦ç‡Ÿ': 1210 },
                        'é›²æ—': { 'å˜‰ç¾©': 430, 'å°å—': 830, 'å·¦ç‡Ÿ': 1040 },
                        'å˜‰ç¾©': { 'å°å—': 620, 'å·¦ç‡Ÿ': 820 },
                        'å°å—': { 'å·¦ç‡Ÿ': 410 }
                    }
                };

                const baseInfo = reactive({ staff: 'é™³ä¾‘å›', bookingDate: new Date().toISOString().split('T')[0], deadlineDate: '', deadlineTime: '18:00', sales: '', orderId: '', groupId: '' });
                const tripForm = reactive({ hsrOrderId: '', pnr: '', date: '', carClass: 'æ¨™æº–è»Šå»‚', from: 'å°åŒ—', to: 'å·¦ç‡Ÿ', trainNo: '', depTime: '09:00', arrTime: '10:34' });
                const ticketForm = reactive({ adult: 0, child: 0, senior: 0, disability: 0 });
                const passengerList = ref([]);

                const showToast = (msg) => { toastMsg.value = msg; setTimeout(() => { toastMsg.value = ''; }, 3000); };
                const focusInput = (name) => {
                      if(name==='staff' && staffInput.value) staffInput.value.focus();
                      if(name==='hsrId' && hsrIdInput.value) hsrIdInput.value.focus();
                };

                const calculateDeadline = () => {
                    if (!baseInfo.bookingDate) return;
                    const bDate = new Date(baseInfo.bookingDate);
                    let dDate = new Date(bDate); dDate.setDate(bDate.getDate() + 2);
                    const day = bDate.getDay(); 
                    const diff = day <= 5 ? 5-day : 5+(7-day);
                    const friday = new Date(bDate); friday.setDate(bDate.getDate() + diff);
                    const final = dDate > friday ? friday : dDate;
                    baseInfo.deadlineDate = final.toISOString().split('T')[0];
                };

                const swapStations = () => { const tmp = tripForm.from; tripForm.from = tripForm.to; tripForm.to = tmp; };
                
                // Canvas ç’°å¢ƒèª¿æ•´ï¼šç§»é™¤ confirm å½ˆçª—ï¼Œæ”¹ç‚ºç›´æ¥åŸ·è¡Œä¸¦æç¤º
                const clearBasicInfo = () => { 
                    baseInfo.sales=''; baseInfo.orderId=''; baseInfo.groupId=''; 
                    showToast('åŸºæœ¬è³‡æ–™å·²æ¸…é™¤');
                };
                
                const clearTripForm = () => { 
                    tripForm.pnr=''; ticketForm.adult=0; passengerList.value=[]; 
                    showToast('è¡Œç¨‹è¡¨å–®å·²é‡ç½®');
                };

                // ç¥¨åƒ¹è¨ˆç®— (é¡¯ç¤ºç®—å¼)
                const getCalcDetails = (trip, tks) => {
                    const matrix = trip.carClass === 'å•†å‹™è»Šå»‚' ? fareRules.business : fareRules.standard;
                    const base = matrix[trip.from]?.[trip.to] || matrix[trip.to]?.[trip.from] || 0;
                    const disc = trip.carClass === 'å•†å‹™è»Šå»‚' ? 0.9 : 0.85;
                    const full = Math.round(base * disc);
                    const half = Math.round(base * 0.5);
                    return {
                        adultStr: tks.adult > 0 ? `${full}*${tks.adult}` : '',
                        childStr: tks.child > 0 ? `${half}*${tks.child}` : '',
                        seniorStr: tks.senior > 0 ? `${half}*${tks.senior}` : '',
                        disabilityStr: tks.disability > 0 ? `${half}*${tks.disability}` : ''
                    };
                };

                const getFare = (trip) => {
                    const matrix = trip.carClass === 'å•†å‹™è»Šå»‚' ? fareRules.business : fareRules.standard;
                    return matrix[trip.from]?.[trip.to] || matrix[trip.to]?.[trip.from] || 0;
                };

                const calcTotal = (trip, tks) => {
                    const base = getFare(trip);
                    const disc = trip.carClass === 'å•†å‹™è»Šå»‚' ? 0.9 : 0.85;
                    return (tks.adult * Math.round(base*disc)) + ((tks.child + tks.senior + tks.disability) * Math.round(base*0.5));
                };

                const getBreakdownText = (tks) => {
                    let p = [];
                    if(tks.adult) p.push(`å…¨ç¥¨ ${tks.adult} å¼µ`);
                    if(tks.child) p.push(`å­©ç«¥ç¥¨ ${tks.child} å¼µ`);
                    if(tks.senior) p.push(`æ•¬è€ç¥¨ ${tks.senior} å¼µ`);
                    if(tks.disability) p.push(`æ„›å¿ƒç¥¨ ${tks.disability} å¼µ`);
                    return p.join('ï½œ');
                };

                const addTripToList = (type) => {
                    addedTrips.value.push({
                        type: type, // 'å»ç¨‹' or 'å›ç¨‹'
                        ...JSON.parse(JSON.stringify(tripForm)), // Clone form data
                        tickets: { ...ticketForm },
                        passengers: JSON.parse(JSON.stringify(passengerList.value)),
                        totalAmount: calcTotal(tripForm, ticketForm),
                        calcDetails: getCalcDetails(tripForm, ticketForm),
                        breakdownText: getBreakdownText(ticketForm)
                    });
                    showToast(`å·²æ–°å¢${type}`);

                    // è‡ªå‹•æ¸…ç©ºç¥¨æ•¸èˆ‡åå–®
                    Object.assign(ticketForm, { adult: 0, child: 0, senior: 0, disability: 0 });
                    passengerList.value = [];
                };

                const updateTripInList = () => {
                    const idx = editingIndex.value;
                    const type = addedTrips.value[idx].type; // Keep original type
                    addedTrips.value[idx] = {
                        type: type,
                        ...JSON.parse(JSON.stringify(tripForm)),
                        tickets: { ...ticketForm },
                        passengers: JSON.parse(JSON.stringify(passengerList.value)),
                        totalAmount: calcTotal(tripForm, ticketForm),
                        calcDetails: getCalcDetails(tripForm, ticketForm),
                        breakdownText: getBreakdownText(ticketForm)
                    };
                    editingIndex.value = null; showToast("å·²æ›´æ–°");
                };

                const startEdit = (idx) => {
                    editingIndex.value = idx; const t = addedTrips.value[idx];
                    Object.assign(tripForm, {
                        hsrOrderId: t.hsrOrderId, pnr: t.pnr, date: t.date, carClass: t.carClass,
                        from: t.from, to: t.to, trainNo: t.trainNo, depTime: t.depTime, arrTime: t.arrTime
                    });
                    Object.assign(ticketForm, t.tickets);
                    passengerList.value = JSON.parse(JSON.stringify(t.passengers));
                };

                const cancelEdit = () => { editingIndex.value = null; };
                const removeTrip = (i) => addedTrips.value.splice(i, 1);
                const openPassengerModal = () => showPassengerModal.value = true;

                const totalTickets = computed(() => ticketForm.adult + ticketForm.child + ticketForm.senior + ticketForm.disability);
                const totalOrderAmount = computed(() => addedTrips.value.reduce((s,t) => s + t.totalAmount, 0));
                const formattedDeadline = computed(() => `${baseInfo.deadlineDate.replace(/-/g,'/')} ${baseInfo.deadlineTime}`);
                const nowTimestamp = computed(() => new Date().toLocaleString('zh-TW', { hour12: false }));

                watch(ticketForm, (v) => syncPaxList(passengerList, v.adult+v.child+v.senior+v.disability, v), { deep: true });
                watch(() => baseInfo.bookingDate, calculateDeadline);

                const syncPaxList = (list, count, tks) => {
                    if (count > list.value.length) for(let i=list.value.length; i<count; i++) list.value.push({type:'', name:'', idNumber:'', passportNo:'', isDirty: false});
                    else if (count < list.value.length) list.value.splice(count);
                    let idx = 0;
                    [{n: tks.adult, t:'å…¨ç¥¨'}, {n: tks.child, t:'å­©ç«¥ç¥¨'}, {n: tks.senior, t:'æ•¬è€ç¥¨'}, {n: tks.disability, t:'æ„›å¿ƒç¥¨'}].forEach(grp => {
                        for(let k=0; k<grp.n; k++) { if(list.value[idx]) list.value[idx].type = grp.t; idx++; }
                    });
                };

                const maskId = (id) => id ? (id.length > 6 ? id.slice(0,3) + '*****' + id.slice(-4) : id) : '';

                // ä¿®æ”¹å¾Œçš„ä¸‹è¼‰åœ–ç‰‡å‡½å¼ (ä¿®å¾©æ–‡å­—ä¸‹æ²‰å•é¡Œ)
                const downloadImage = () => {
                    const node = document.getElementById('image-node');
                    
                    // ä½¿ç”¨ html2canvas
                    html2canvas(node, { 
                        scale: 3, // ä¿æŒé«˜è§£æåº¦
                        backgroundColor: '#ffffff',
                        
                        // ã€é—œéµä¿®å¾©ã€‘ï¼šonclone å…è¨±æˆ‘å€‘åœ¨æˆªåœ–"å‰"ä¿®æ”¹è¤‡è£½å‡ºä¾†çš„ DOM
                        onclone: (clonedDoc) => {
                            const style = clonedDoc.createElement('style');
                            // åœ¨é€™è£¡å¯«å…¥ CSSï¼Œå¼·åˆ¶æŠŠæ–‡å­—å¾€ä¸Šæï¼ŒæŠµéŠ· html2canvas çš„ä¸‹æ²‰èª¤å·®
                            style.innerHTML = `
                                /* é‡å°è¡¨æ ¼å…§çš„æ–‡å­—é€²è¡Œå‚ç›´æ ¡æ­£ */
                                .trip-table td, .trip-table th, .pax-table td, .pax-table th {
                                    padding-top: 5px !important;    /* åŸæœ¬æ˜¯ 8pxï¼Œæ¸›å°‘ 3px */
                                    padding-bottom: 11px !important; /* åŸæœ¬æ˜¯ 8pxï¼Œå¢åŠ  3px (ä¿æŒç¸½é«˜åº¦ä¸è®Šï¼Œä½†å…§å®¹ä¸Šç§») */
                                }
                                
                                /* é‡å°ä¸Šæ–¹è³‡è¨Šæ¬„ä½çš„æ ¡æ­£ */
                                .info-header-value {
                                    transform: translateY(-3px); /* ç›´æ¥ä½¿ç”¨ transform ä¸Šç§» */
                                }
                                
                                /* é‡å°ç¸½é‡‘é¡èˆ‡æ¨™é¡Œ */
                                .total-value, .doc-title, .doc-subtitle {
                                    transform: translateY(-4px);
                                }
                                
                                /* é‡å° checkbox ç¬¦è™Ÿç‰¹åˆ¥ä¿®æ­£ */
                                .checkbox-symbol {
                                    top: -4px !important;
                                }
                            `;
                            clonedDoc.body.appendChild(style);
                        }
                    }).then(canvas => {
                        const a = document.createElement('a'); a.href = canvas.toDataURL("image/png");
                        a.download = `${baseInfo.orderId}_${baseInfo.sales}_é«˜éµç¢ºèªå–®.png`; a.click();
                        showToast("åœ–æª”ä¸‹è¼‰æˆåŠŸ");
                    });
                };

                const copyText = () => {
                    let txt = `ã€é«˜éµè¨‚ä½ç¢ºèªå–®ã€‘\n\né–‹ç¥¨æœŸé™ï¼š${formattedDeadline.value}\n\né–‹ç¥¨èªªæ˜ï¼š\nè«‹æ–¼D/Lå‰é€šçŸ¥ å¯é–‹ç¥¨ èˆ‡ å–ç¥¨æ–¹å¼\né€¾æœŸå°‡è‡ªå‹•å–æ¶ˆéœ€é‡æ–°è¨‚ç¥¨\næ¯ç­†è¨‚ä½ä»£ç¢¼,çµ±ä¸€å–ç¥¨æ–¹å¼\n\nè«‹æ¥­å‹™å€‘å‹™å¿…å†æ¬¡æ ¸å° ç¥¨ç¨®/å¼µæ•¸/é‡‘é¡ æ˜¯å¦æ­£ç¢º\nå¦‚æœ‰éŒ¯èª¤ è«‹æ–¼ã€Œå‡ºç¥¨å‰ã€å‘ŠçŸ¥ï¼Œå‡ºç¥¨å¾Œå‘ŠçŸ¥è«‹è‡ªè¡Œè² è²¬ã€‚\né«˜éµè¨‚ç¥¨æœå‹™çª—å£æ„Ÿè¬æ‚¨çš„é…åˆã€‚\n\n------------------\n\n`;
                    
                    addedTrips.value.forEach((t, i) => {
                        txt += `[è¡Œç¨‹ç´€éŒ„ #${i+1}]\n\n`;
                        txt += `${t.type}ï½œPNR ${t.pnr}\n${t.date}ã€€${t.from}/${t.to}  ç­æ¬¡ ${t.trainNo}ã€€${t.depTime}-${t.arrTime}\nç¥¨æ•¸ï¼š${t.breakdownText} ($${t.totalAmount.toLocaleString()})\n\n`;
                    });
                    
                    txt += `ç¸½è¨ˆæ‡‰æ”¶é‡‘é¡ï¼šNT$ ${totalOrderAmount.value.toLocaleString()}\n\n---æ³¨æ„äº‹é …èˆ‡æ”¹/é€€ç¥¨èªªæ˜---\n1. åº§ä½çš†ç”±é›»è…¦è‡ªå‹•åŠƒä½,æ•ç„¡æ³•æŒ‡å®šåº§ä½,äº¦ç„¡æ³•ä¿è­‰åŒè¡Œè€…ç‚ºç›¸é„°åº§ä½ã€‚\n2. è‹¥å› é€¾æ™‚æœªèƒ½æ­ä¹˜,è«‹è‡ªè¡Œæ´½è©¢ç«™å‹™äººå“¡æ˜¯å¦å¯æ”¹æ­ç•¶æ—¥å…¶ä»–è»Šæ¬¡ä¹‹è‡ªç”±åº§,æ•ç„¡æ³•è¾¦ç†é€€ç¥¨ã€‚\n3. é«˜éµè»Šç¥¨é ˆæ–¼æ­ä¹˜ç•¶æ—¥ä½¿ç”¨,é€¾æœŸè¦–åŒå»¢ç¥¨,æ•ä¸å—ç†é€€ç¥¨ã€‚\n4. å¦‚éœ€è¾¦ç†æ”¹ç¥¨/é€€ç¥¨,è«‹æ–¼ 4å€‹å·¥ä½œæ—¥å‰ ç”³è«‹,ä¸¦æä¾›ç´™æœ¬ç¥¨æ ¹æˆ– APP é›»å­ç¥¨æˆªåœ–(å¤©ç½å°è‡´é«˜éµåœé§›è€…ä¸åœ¨æ­¤é™)ã€‚\n5. é€€ç¥¨å°‡é…Œæ”¶æ‰‹çºŒè²» æ¯å¼µæ–°å°å¹£ 50 å…ƒã€‚\n6. è¾¦ç†æ”¹ç¥¨/é€€ç¥¨æ™‚,è«‹å‹™å¿…æä¾› ç´™æœ¬ç¥¨æ ¹æˆ–é›»å­ç¥¨(APP æˆªåœ–),æœªæä¾›è€…å°‡è¦–åŒæ­£å¸¸æ­ä¹˜,ç›¸é—œè²»ç”¨é ˆè‡ªè¡Œè² æ“”ã€‚\n7. å› èˆªç­å»¶èª¤æˆ–å–æ¶ˆç­‰éé«˜éµå› ç´ è‡´ç„¡æ³•æ­ä¹˜è€…,è»Šç¥¨ æ•ç„¡æ³•æ”¹æœŸæˆ–é€€ç¥¨,æ•¬è«‹è¦‹è«’ã€‚`;
                    
                    const el = document.createElement('textarea'); el.value = txt; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
                    showToast("æ–‡å­—ç¯„æœ¬å·²è¤‡è£½");
                };
                
                const downloadTxt = () => {
                    const blob = new Blob([document.querySelector('textarea')?.value || 'è«‹å…ˆé»é¸è¤‡è£½æ–‡å­—'], { type: 'text/plain' });
                    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                    a.download = `${baseInfo.orderId}_ç¢ºèªç¯„æœ¬.txt`; a.click();
                };
                
                // Canvas ç’°å¢ƒèª¿æ•´ï¼šç§»é™¤ confirm å½ˆçª—ï¼Œæ”¹ç‚ºç›´æ¥åŸ·è¡Œä¸¦æç¤º
                const resetCurrentTripForm = () => {
                    tripForm.pnr=''; ticketForm.adult=0; passengerList.value=[];
                    showToast('è¡Œç¨‹è¡¨å–®å·²é‡ç½®');
                };

                onMounted(calculateDeadline);

                return {
                    baseInfo, tripForm, ticketForm, passengerList, addedTrips, stations, maskId,
                    totalTickets, showPassengerModal,
                    totalOrderAmount, formattedDeadline, editingIndex, toastMsg, nowTimestamp: new Date().toLocaleString(),
                    addTripToList, updateTripInList, startEdit, cancelEdit, removeTrip,
                    openPassengerModal, downloadImage, copyText, downloadTxt, clearBasicInfo, 
                    clearTripForm: resetCurrentTripForm, swapStations, focusInput, staffInput, hsrIdInput
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
