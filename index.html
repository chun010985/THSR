<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高鐵訂位確認單生成器</title>
    
    <!-- 引入字體 Noto Sans TC -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Vue.js 2 (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>

    <!-- html2canvas (用於生成圖片) -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <!-- Tesseract.js (用於圖片文字辨識) -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f5f5f4; /* Stone 100 */
        }
        /* 自定義日系輸入框樣式 */
        .input-minimal {
            background-color: transparent;
            border-bottom: 1px solid #d6d3d1; /* Stone 300 */
            padding: 0.5rem 0;
            width: 100%;
            transition: all 0.3s ease;
            color: #44403c; /* Stone 700 */
            outline: none;
        }
        .input-minimal:focus {
            border-color: #0d9488; /* Teal 600 */
            border-bottom-width: 2px;
        }
        .input-label {
            font-size: 0.75rem;
            color: #78716c; /* Stone 500 */
            margin-bottom: 0.25rem;
            display: block;
        }
        /* 按鈕樣式 */
        .btn-add {
            background-color: #57534e; /* Stone 600 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s;
            width: 100%;
        }
        .btn-add:hover {
            background-color: #44403c;
        }
        .btn-primary {
            background-color: #0d9488; /* Teal 600 */
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 0.5rem;
            font-weight: 500;
            letter-spacing: 0.05em;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            background-color: #0f766e; /* Teal 700 */
            transform: translateY(-1px);
            box-shadow: 0 6px 8px -1px rgba(0, 0, 0, 0.15);
        }
        
        /* 彈窗樣式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            padding: 20px;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: #e5e5e5;
            border-radius: 1rem;
            max-height: 95vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* 讀取中遮罩 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 60;
            backdrop-filter: blur(2px);
        }
        .spinner {
            border: 4px solid #e5e7eb;
            border-top: 4px solid #0d9488;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 預覽確認單專用樣式 (A4 Optimized) */
        .a4-container {
            width: 210mm;
            min-height: 297mm; /* A4 height */
            background: white;
            padding: 15mm;
            box-sizing: border-box;
            position: relative;
            font-family: 'Noto Sans TC', sans-serif;
            color: #1f2937;
        }

        .header-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 15px;
        }
        
        .header-item {
            display: flex;
            flex-direction: column;
        }
        .header-label {
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 500;
        }
        .header-value {
            font-size: 1rem;
            font-weight: 600;
            border-bottom: 1px solid #d1d5db;
            padding-bottom: 2px;
        }

        .trip-block {
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }

        .trip-title-bar {
            background-color: #f3f4f6;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.9rem;
            font-weight: bold;
            color: #374151;
        }

        .trip-info-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1px;
            background-color: #e5e7eb; /* Grid border color */
            border-bottom: 1px solid #e5e7eb;
        }
        .trip-cell {
            background-color: white;
            padding: 8px 4px;
            text-align: center;
        }
        .trip-cell-label {
            font-size: 0.7rem;
            color: #9ca3af;
            margin-bottom: 2px;
        }
        .trip-cell-val {
            font-size: 0.95rem;
            font-weight: 600;
        }
        
        .passenger-list {
            padding: 10px 12px;
            background-color: white;
        }
        .passenger-row {
            display: flex;
            font-size: 0.85rem;
            padding: 4px 0;
            border-bottom: 1px dashed #f3f4f6;
        }
        .passenger-row:last-child {
            border-bottom: none;
        }

        .price-summary {
            text-align: right;
            padding: 8px 12px;
            background-color: #f9fafb;
            font-weight: bold;
            font-size: 1rem;
            border-top: 1px solid #e5e7eb;
        }

        .footer-note {
            margin-top: 20px;
            font-size: 0.75rem;
            color: #6b7280;
            line-height: 1.5;
            padding-top: 10px;
            border-top: 2px solid #e5e7eb;
        }
        
        /* 必填星號 */
        .required-mark {
            color: #ef4444;
            margin-left: 2px;
        }

        /* 隱藏滾動條但保留功能 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="text-stone-700 h-screen overflow-hidden" @paste="handlePaste">

    <div id="app" class="h-full flex flex-col">
        
        <!-- Loading Overlay -->
        <div v-if="isRecognizing" class="loading-overlay">
            <div class="spinner"></div>
            <div class="text-stone-700 font-bold text-lg">正在分析圖片中的資訊...</div>
            <div class="text-sm text-stone-500 mt-2">辨識項目：訂單編號 / PNR / 車次 / 時間 / 旅客(隱碼)</div>
            <div class="text-xs text-stone-400 mt-1">系統將自動優化圖片對比度以提高準確率</div>
        </div>

        <!-- 標題 (固定頂部) -->
        <header class="py-4 text-center no-print bg-[#f5f5f4] shrink-0 border-b border-stone-200 shadow-sm z-20">
            <h1 class="text-2xl font-light tracking-widest text-stone-800">高鐵訂位確認單生成器</h1>
        </header>

        <!-- 主內容區 -->
        <main class="flex-1 overflow-hidden grid grid-cols-1 lg:grid-cols-12 gap-4 p-4 lg:p-6 bg-[#f5f5f4]">
            
            <!-- 左側：輸入表單區 -->
            <section class="lg:col-span-7 bg-white rounded-2xl border border-stone-200 overflow-y-auto custom-scrollbar input-section p-6 md:p-8 shadow-sm z-10">
                
                <!-- 標題列 -->
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b border-stone-100 pb-4 gap-3">
                    <div class="flex items-center gap-4 flex-wrap">
                        <h2 class="text-lg font-medium text-stone-600 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-teal-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                            資料輸入
                        </h2>
                        
                        <div class="flex items-center gap-3 bg-stone-50 px-4 py-2 rounded-lg border border-stone-100 shadow-sm">
                            <div class="flex items-center gap-1 border-r border-stone-200 pr-3">
                                <span class="text-xs text-stone-400">訂票人員</span>
                                <select v-model="booker" class="bg-transparent text-sm font-bold text-stone-700 focus:outline-none cursor-pointer p-0 border-none appearance-none hover:text-teal-600">
                                    <option>卓芷伶</option>
                                    <option>陳侑君</option>
                                </select>
                            </div>
                            
                            <div class="flex items-center gap-1 border-r border-stone-200 pr-3">
                                <span class="text-xs text-stone-400">訂票日期</span>
                                <span class="text-sm font-bold text-stone-700">{{ formatDate(bookingDate) }}</span>
                            </div>

                            <div class="flex items-center gap-1">
                                <span class="text-xs text-teal-600 font-bold">D/L</span>
                                <input type="date" v-model="deadlineDate" class="bg-transparent text-sm font-bold text-teal-700 focus:outline-none p-0 border-none w-28 cursor-pointer hover:bg-stone-100 rounded px-1">
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 ml-auto sm:ml-0">
                        <button @click="resetForm" class="text-stone-400 hover:text-red-500 transition-colors p-1 rounded hover:bg-stone-100" title="清空所有資料">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- 1. 全域設定 -->
                <div class="grid grid-cols-2 gap-4 mb-6 pb-6 border-b border-stone-100 text-sm">
                    <div>
                        <label class="input-label">訂單編號</label>
                        <input type="text" v-model="cowayOrderId" maxlength="8" class="input-minimal tracking-wider" placeholder="12345678">
                    </div>
                    <div>
                        <label class="input-label">團號</label>
                        <input type="text" v-model="groupNumber" class="input-minimal" placeholder="TPE20230512A001">
                    </div>
                </div>

                <!-- 2. 新增行程 & 旅客 -->
                <div class="mb-10 p-5 bg-stone-50 rounded-xl border border-stone-100">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="w-1.5 h-5 bg-stone-700 rounded-sm"></span>
                        <h3 class="font-bold text-stone-700 text-sm">新增行程設定</h3>
                    </div>

                    <!-- OCR 圖片上傳/貼上區塊 -->
                    <div 
                        class="mb-6 border-2 border-dashed border-stone-300 rounded-lg p-6 text-center cursor-pointer hover:border-teal-500 hover:bg-teal-50 transition-colors group flex flex-col items-center justify-center min-h-[120px]"
                        @click="$refs.fileInput.click()"
                        @dragover.prevent
                        @drop.prevent="handleDrop"
                    >
                        <input type="file" ref="fileInput" @change="handleFileUpload" accept="image/*" class="hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mb-2 text-stone-400 group-hover:text-teal-600 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <div class="text-sm font-medium text-stone-600 group-hover:text-teal-700">
                            點擊上傳 或 直接貼上(Ctrl+V) 高鐵訂單截圖
                        </div>
                        <div class="text-xs text-stone-400 mt-1">
                            支援辨識：訂單編號 / PNR / 車次 / 時間 / 票種 / 旅客資料(含隱碼)
                        </div>
                    </div>

                    <!-- 行程方向 -->
                    <div class="mb-4 flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded border border-stone-200 hover:border-teal-400 transition-colors">
                            <input type="radio" value="去程" v-model="currentTripInput.direction" class="text-teal-600 focus:ring-teal-500">
                            <span :class="currentTripInput.direction === '去程' ? 'font-bold text-teal-700' : 'text-stone-600'">去程</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded border border-stone-200 hover:border-teal-400 transition-colors">
                            <input type="radio" value="回程" v-model="currentTripInput.direction" class="text-teal-600 focus:ring-teal-500">
                            <span :class="currentTripInput.direction === '回程' ? 'font-bold text-teal-700' : 'text-stone-600'">回程</span>
                        </label>
                    </div>

                    <!-- 行程詳細資料 (包含 PNR 和 HSR Order ID) -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                         <div class="lg:col-span-1">
                            <label class="input-label">高鐵訂單編號</label>
                            <input type="text" v-model="currentTripInput.hsrOrderId" class="input-minimal font-mono tracking-wider" placeholder="20230512">
                        </div>
                        <div class="lg:col-span-1">
                            <label class="input-label">訂位代號 (PNR)</label>
                            <input type="text" v-model="currentTripInput.pnr" maxlength="8" class="input-minimal font-bold uppercase tracking-wider text-teal-700" placeholder="06082412">
                        </div>
                        <div class="lg:col-span-1">
                            <label class="input-label">日期</label>
                            <input type="date" v-model="currentTripInput.date" class="input-minimal">
                        </div>
                        <div class="lg:col-span-1">
                            <label class="input-label">車次</label>
                            <input type="text" v-model="currentTripInput.trainNumber" class="input-minimal" placeholder="ex: 1205">
                        </div>
                        <div class="lg:col-span-2">
                            <label class="input-label">車廂種類</label>
                            <select v-model="currentTripInput.carType" @change="updateInputPrices" class="input-minimal">
                                <option>標準車廂</option>
                                <option>商務車廂</option>
                            </select>
                        </div>
                        
                        <div class="lg:col-span-1">
                            <label class="input-label">起程時間</label>
                            <input type="text" v-model="currentTripInput.depTime" class="input-minimal" placeholder="ex: 09:30">
                        </div>
                        <div class="lg:col-span-1">
                            <label class="input-label">到達時間</label>
                            <input type="text" v-model="currentTripInput.arrTime" class="input-minimal" placeholder="ex: 11:15">
                        </div>
                        
                        <!-- 起訖站 (含交換按鈕) -->
                        <div class="col-span-2 lg:col-span-2 flex items-end gap-2">
                            <div class="flex-1">
                                <label class="input-label">出發站</label>
                                <select v-model="currentTripInput.origin" @change="updateInputPrices" class="input-minimal">
                                    <option v-for="st in stations" :value="st">{{ st }}</option>
                                </select>
                            </div>
                            
                            <button @click="swapStations" class="mb-1 p-2 text-stone-400 hover:text-teal-600 transition-colors rounded-full hover:bg-stone-100" title="交換起訖站">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                                </svg>
                            </button>
                            
                            <div class="flex-1">
                                <label class="input-label">抵達站</label>
                                <select v-model="currentTripInput.destination" @change="updateInputPrices" class="input-minimal">
                                    <option v-for="st in stations" :value="st">{{ st }}</option>
                                </select>
                            </div>
                        </div>

                    </div>

                    <!-- 票種輸入 -->
                    <div class="bg-white p-3 rounded-lg border border-stone-200 mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-bold text-stone-500">票種與張數 (上限 10 位)</label>
                            <button @click="addTicketInput" class="text-xs text-teal-600 hover:text-teal-800 font-medium">+ 增加票種</button>
                        </div>
                        <div v-for="(ticket, idx) in currentTripInput.tickets" :key="'t-'+idx" class="flex gap-2 mb-2 items-end border-b border-stone-100 pb-2 last:border-0 last:pb-0 last:mb-0">
                            <div class="flex-1">
                                <select v-model="ticket.type" @change="updateInputPrices" class="input-minimal text-sm">
                                    <option>全票</option>
                                    <option>孩童</option>
                                    <option>敬老</option>
                                    <option>愛心</option>
                                </select>
                            </div>
                            <div class="w-16">
                                <input type="number" v-model.number="ticket.count" min="1" max="10" @input="updatePassengerCount" class="input-minimal text-center text-sm" placeholder="張數">
                            </div>
                            <div class="w-20">
                                <input type="number" v-model.number="ticket.price" class="input-minimal text-right text-sm" placeholder="價格">
                            </div>
                            <button v-if="currentTripInput.tickets.length > 1" @click="removeTicketInput(idx)" class="text-stone-300 hover:text-red-400 px-1">
                                &times;
                            </button>
                        </div>
                    </div>

                    <!-- 動態旅客資料輸入 -->
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-3 px-1">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-bold text-stone-700">旅客資料輸入</span>
                                <span class="text-xs text-teal-600 bg-teal-50 px-2 py-0.5 rounded-full">共 {{ passengers.length }} 位</span>
                            </div>
                        </div>
                        
                        <div v-if="passengers.length === 0" class="text-center py-4 text-stone-400 text-xs bg-stone-100 rounded-lg">
                            請先在上方選擇票種與張數
                        </div>

                        <div v-for="(p, index) in passengers" :key="'p-'+index" class="mb-3 bg-white p-4 rounded-xl border border-stone-200 shadow-sm">
                            <div class="text-xs text-stone-400 mb-2 font-bold">旅客 {{ index + 1 }}</div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <label class="input-label">姓名 <span class="required-mark">*</span></label>
                                    <input type="text" v-model="p.name" class="input-minimal" placeholder="必填">
                                </div>
                                <div>
                                    <label class="input-label">身分證字號 <span class="required-mark">*</span></label>
                                    <input type="text" v-model="p.id" class="input-minimal uppercase" placeholder="必填 (可為隱碼)">
                                </div>
                                <div>
                                    <label class="input-label">出生年月日 (選填)</label>
                                    <input type="date" v-model="p.birthDate" class="input-minimal text-stone-500">
                                </div>
                                <div>
                                    <label class="input-label">護照號碼 (選填)</label>
                                    <input type="text" v-model="p.passport" class="input-minimal uppercase" placeholder="選填">
                                </div>
                            </div>
                        </div>
                    </div>

                    <button @click="addTripToList" class="btn-add flex items-center justify-center gap-2 w-full py-3 shadow-md hover:shadow-lg transform transition-all hover:-translate-y-0.5">
                        <span>加入行程清單</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                        </svg>
                    </button>
                </div>

            </section>

            <!-- 右側：摘要清單區 -->
            <section class="lg:col-span-5 bg-[#fdfcfc] rounded-2xl border border-stone-200 overflow-y-auto custom-scrollbar p-6 relative flex flex-col shadow-sm">
                
                <h2 class="text-xl font-bold text-stone-700 mb-6 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-stone-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                    </svg>
                    預覽摘要 (Trip Summary)
                </h2>

                <!-- 空狀態 -->
                <div v-if="trips.length === 0" class="flex-1 flex flex-col justify-center items-center text-stone-300 border-2 border-dashed border-stone-200 rounded-xl mb-8 min-h-[200px]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4v16m8-8H4" />
                    </svg>
                    <p class="text-lg">尚未加入任何行程</p>
                    <p class="text-sm mt-1">請在左側填寫並加入</p>
                </div>

                <!-- 行程卡片清單 -->
                <div v-else class="space-y-3 mb-8">
                    <div v-for="(trip, idx) in trips" :key="idx" class="bg-white border border-stone-200 rounded-lg p-4 shadow-sm relative group hover:shadow-md transition-shadow">
                        <button @click="removeTripFromList(idx)" class="absolute top-3 right-3 text-stone-300 hover:text-red-500 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>

                        <div class="flex items-center gap-3 mb-2">
                            <span class="px-2 py-0.5 rounded text-xs font-bold tracking-wider" 
                                  :class="trip.direction === '去程' ? 'bg-teal-100 text-teal-800' : 'bg-stone-200 text-stone-600'">
                                {{ trip.direction }}
                            </span>
                            <span class="text-sm text-stone-500 font-medium">{{ formatDateShort(trip.date) }}</span>
                            <span class="text-xs font-mono text-stone-400 bg-stone-100 px-2 py-0.5 rounded">{{ trip.trainNumber }}車次</span>
                        </div>

                        <div class="flex items-baseline gap-2 mb-1">
                            <span class="text-lg font-bold text-stone-800">{{ trip.origin }}</span>
                            <span class="text-stone-300 text-sm">➜</span>
                            <span class="text-lg font-bold text-stone-800">{{ trip.destination }}</span>
                            <span class="ml-auto font-mono text-base font-bold text-stone-700">TWD ${{ formatPrice(getTripSubtotal(trip)) }}</span>
                        </div>

                        <div class="text-xs text-stone-500 flex flex-wrap gap-2">
                            <span class="font-mono">{{ trip.depTime }} - {{ trip.arrTime }}</span>
                            <span class="text-stone-300">|</span>
                            <span>{{ trip.pnr }}</span>
                            <span class="text-stone-300">|</span>
                             <span v-if="trip.hsrOrderId">訂單:{{ trip.hsrOrderId }}</span>
                             <span v-else class="text-red-300">無訂單號</span>
                        </div>
                    </div>

                    <!-- 總計摘要 -->
                    <div class="flex justify-end items-center gap-4 pt-4 border-t border-stone-200 mt-6">
                        <span class="text-stone-500 text-sm">總金額合計</span>
                        <span class="text-2xl font-bold text-teal-700">TWD ${{ formatPrice(totalPrice) }}</span>
                    </div>
                </div>

                <!-- 生成按鈕 -->
                <div class="mt-auto pt-4 text-center">
                    <button 
                        @click="generateTicket" 
                        :disabled="trips.length === 0"
                        :class="trips.length === 0 ? 'bg-stone-300 cursor-not-allowed' : 'bg-stone-800 hover:bg-stone-900 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5'"
                        class="text-white px-8 py-3 rounded-full text-lg font-medium tracking-wide transition-all flex items-center justify-center gap-3 mx-auto w-full max-w-sm">
                        <span>生成確認單</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>

            </section>
        </main>

        <!-- 彈出式確認單 Modal -->
        <transition name="fade">
            <div v-if="showModal" class="modal-overlay" @click.self="showModal = false">
                <div class="modal-content relative p-4 md:p-8">
                    
                    <button @click="showModal = false" class="absolute top-4 right-4 z-50 bg-stone-200 hover:bg-stone-300 rounded-full p-2 text-stone-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>

                    <!-- A4 紙張模擬容器 (A4 Optimized) -->
                    <div ref="captureArea" class="a4-container mx-auto mb-20 shadow-2xl">
                        
                        <!-- 1. 表頭 (Row 1) -->
                        <div class="text-center mb-6">
                            <h2 class="text-3xl font-extrabold tracking-widest text-stone-800 mb-1">訂位確認單</h2>
                            <p class="text-xs text-stone-500 uppercase tracking-[0.2em] mb-4">Booking Confirmation</p>
                            
                            <div class="header-grid">
                                <div class="header-item">
                                    <div class="header-label">訂票人員</div>
                                    <div class="header-value">{{ booker }}</div>
                                </div>
                                <div class="header-item">
                                    <div class="header-label">訂票日期</div>
                                    <div class="header-value">{{ formatDate(bookingDate) }}</div>
                                </div>
                                <div class="header-item">
                                    <div class="header-label">D/L開票期限</div>
                                    <div class="header-value text-red-600">{{ formatDate(deadlineDate) }} 18:00前</div>
                                </div>
                                <div class="header-item">
                                    <div class="header-label">訂單編號</div>
                                    <div class="header-value">{{ cowayOrderId || '-' }}</div>
                                </div>
                                <div class="header-item">
                                    <div class="header-label">團號</div>
                                    <div class="header-value font-mono">{{ groupNumber || '-' }}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 2. 行程與旅客 (Row 2, 3 / 4, 5) -->
                        <div v-for="(trip, idx) in trips" :key="'preview-'+idx" class="trip-block">
                            
                            <!-- Trip Header Info -->
                            <div class="trip-title-bar">
                                <span>{{ trip.direction }}</span>
                                <div class="flex gap-4 font-mono text-xs">
                                     <span>高鐵訂單: {{ trip.hsrOrderId }}</span>
                                     <span>PNR: {{ trip.pnr }}</span>
                                </div>
                            </div>

                            <div class="trip-info-grid">
                                <div class="trip-cell"><div class="trip-cell-label">日期</div><div class="trip-cell-val">{{ formatDate(trip.date) }}</div></div>
                                <div class="trip-cell"><div class="trip-cell-label">班次</div><div class="trip-cell-val">{{ trip.trainNumber }}</div></div>
                                <div class="trip-cell"><div class="trip-cell-label">起程站</div><div class="trip-cell-val">{{ trip.origin }}</div></div>
                                <div class="trip-cell"><div class="trip-cell-label">到達站</div><div class="trip-cell-val">{{ trip.destination }}</div></div>
                                <div class="trip-cell"><div class="trip-cell-label">起程時間</div><div class="trip-cell-val font-mono">{{ trip.depTime }}</div></div>
                                <div class="trip-cell"><div class="trip-cell-label">到達時間</div><div class="trip-cell-val font-mono">{{ trip.arrTime }}</div></div>
                            </div>

                            <!-- Ticket Info Row -->
                            <div class="trip-info-grid" style="grid-template-columns: 2fr 4fr 1fr 2fr;">
                                <div class="trip-cell"><div class="trip-cell-label">車廂</div><div class="trip-cell-val">{{ trip.carType }}</div></div>
                                <div class="trip-cell" style="text-align: left; padding-left: 10px;">
                                    <div class="trip-cell-label">票種明細</div>
                                    <div class="text-xs">
                                        <span v-for="t in trip.tickets" v-if="t.count > 0" class="mr-2">
                                            {{ t.type }} x{{ t.count }}
                                        </span>
                                    </div>
                                </div>
                                <div class="trip-cell"><div class="trip-cell-label">張數</div><div class="trip-cell-val">{{ getTotalCount(trip.tickets) }}</div></div>
                                <div class="trip-cell"><div class="trip-cell-label">個別金額</div><div class="trip-cell-val font-mono">${{ formatPrice(getTripSubtotal(trip)) }}</div></div>
                            </div>

                            <!-- Passenger List -->
                            <div class="passenger-list">
                                <div class="text-xs text-gray-400 mb-1 font-bold">{{ trip.direction }}旅客資料</div>
                                <div v-for="(p, pIdx) in trip.passengers" :key="pIdx" class="passenger-row">
                                    <span style="width: 20%; font-weight: 500;">{{ p.name }}</span>
                                    <span style="width: 25%; font-family: monospace;">{{ maskID(p.id) }}</span>
                                    <span style="width: 25%; font-family: monospace;">{{ formatDate(p.birthDate) }}</span>
                                    <span style="width: 30%; font-family: monospace;">{{ p.passport || '-' }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Price Summary -->
                        <div class="price-summary">
                            總金額 Total Amount: TWD ${{ formatPrice(totalPrice) }}
                        </div>

                        <!-- Footer -->
                        <div class="footer-note">
                             <div class="bg-red-50 border border-red-200 rounded p-2 text-center mb-4">
                                <p class="text-red-700 font-bold text-xs">
                                    請業務們務必再次核對 票種/張數/金額 是否正確，如有錯誤 請於「出票前」告知，<br>
                                    出票後告知請自行負責，高鐵訂票服務窗口感謝您的配合。
                                </p>
                            </div>

                            <p class="text-center font-bold mb-2">【 請務必於D/L前告知可開票 與 取票方式  紙本 / 電子票(搭配APP使用) 】</p>
                            <p class="text-center text-xs mb-4">掛帳全票會先掛85折的價格，優待票(孩童、敬老、愛心)都是半價，如果售價有調整需要更改再請通知唷 謝謝</p>
                            
                            <h5 class="font-bold border-b pb-1 mb-1">注意事項與退票說明</h5>
                            <ol class="list-decimal list-inside pl-1">
                                <li>座位皆由電腦自動劃位，恕無法指定座位，亦無法保證同行者可安排相鄰座位。</li>
                                <li>若因逾時未能搭乘，請自行洽詢站務人員是否可改搭當日其他車次之自由座，恕無法辦理退票。</li>
                                <li>高鐵車票須於搭乘當日使用，逾期視同廢票，恕不受理退票。</li>
                                <li>如需辦理退票，請於 4個工作日前 申請，並提供紙本票根或 APP 電子票截圖（天災導致高鐵停駛者不在此限）。</li>
                                <li>退票將酌收手續費 每張新台幣 50 元。</li>
                                <li>辦理退票時，請務必提供 紙本票根或電子票（APP 截圖），未提供者將視同正常搭乘，相關費用須自行負擔。</li>
                                <li>因航班延誤或取消等非高鐵因素致無法搭乘者，車票 恕無法改期或退票，敬請見諒。</li>
                            </ol>
                        </div>
                    </div>

                    <div class="fixed bottom-8 left-0 right-0 flex justify-center pointer-events-none">
                        <button @click="generateImage" class="pointer-events-auto bg-stone-800 hover:bg-stone-900 text-white px-8 py-3 rounded-full shadow-xl flex items-center gap-2 transform transition-all hover:-translate-y-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            下載圖片 (JPG)
                        </button>
                    </div>
                </div>
            </div>
        </transition>
    </div>

    <script>
        new Vue({
            el: '#app',
            data: {
                showModal: false,
                isRecognizing: false,
                stations: ['南港', '台北', '板橋', '桃園', '新竹', '苗栗', '台中', '彰化', '雲林', '嘉義', '台南', '左營'],
                standardFares: {
                    '南港': { '台北': 40, '板橋': 70, '桃園': 200, '新竹': 330, '苗栗': 480, '台中': 750, '彰化': 870, '雲林': 930, '嘉義': 1120, '台南': 1390, '左營': 1530 },
                    '台北': { '板橋': 40, '桃園': 160, '新竹': 290, '苗栗': 430, '台中': 700, '彰化': 820, '雲林': 930, '嘉義': 1080, '台南': 1350, '左營': 1490 },
                    '板橋': { '桃園': 130, '新竹': 260, '苗栗': 400, '台中': 670, '彰化': 790, '雲林': 900, '嘉義': 1050, '台南': 1320, '左營': 1460 },
                    '桃園': { '新竹': 130, '苗栗': 280, '台中': 540, '彰化': 670, '雲林': 780, '嘉義': 920, '台南': 1190, '左營': 1330 },
                    '新竹': { '苗栗': 270, '台中': 390, '彰化': 500, '雲林': 640, '嘉義': 920, '台南': 1060, '左營': 1200 },
                    '苗栗': { '台中': 270, '彰化': 390, '雲林': 500, '嘉義': 640, '台南': 920, '左營': 1060 },
                    '台中': { '彰化': 130, '雲林': 230, '嘉義': 380, '台南': 650, '左營': 790 },
                    '彰化': { '雲林': 110, '嘉義': 250, '台南': 530, '左營': 680 },
                    '雲林': { '嘉義': 150, '台南': 420, '左營': 560 },
                    '嘉義': { '台南': 280, '左營': 410 },
                    '台南': { '左營': 140 }
                },
                businessFares: {
                    '南港': { '台北': 260, '板橋': 310, '桃園': 500, '新竹': 700, '苗栗': 920, '台中': 1330, '彰化': 1510, '雲林': 1660, '嘉義': 1880, '台南': 2290, '左營': 2500 },
                    '台北': { '板橋': 260, '桃園': 440, '新竹': 640, '苗栗': 850, '台中': 1250, '彰化': 1430, '雲林': 1600, '嘉義': 1820, '台南': 2230, '左營': 2440 },
                    '板橋': { '桃園': 400, '新竹': 590, '苗栗': 800, '台中': 1210, '彰化': 1390, '雲林': 1550, '嘉義': 1780, '台南': 2180, '左營': 2390 },
                    '桃園': { '新竹': 400, '苗栗': 620, '台中': 1010, '彰化': 1210, '雲林': 1370, '嘉義': 1580, '台南': 1990, '左營': 2200 },
                    '新竹': { '苗栗': 410, '台中': 820, '彰化': 1010, '雲林': 1160, '嘉義': 1390, '台南': 1790, '左營': 2000 },
                    '苗栗': { '台中': 610, '彰化': 790, '雲林': 950, '嘉義': 1160, '台南': 1580, '左營': 1790 },
                    '台中': { '彰化': 400, '雲林': 550, '嘉義': 770, '台南': 1180, '左營': 1390 },
                    '彰化': { '雲林': 370, '嘉義': 580, '台南': 1000, '左營': 1210 },
                    '雲林': { '嘉義': 430, '台南': 830, '左營': 1040 },
                    '嘉義': { '台南': 620, '左營': 820 },
                    '台南': { '左營': 410 }
                },
                orderId: '',
                groupNumber: '', 
                cowayOrderId: '', 
                booker: '卓芷伶', 
                bookingDate: '', 
                deadlineDate: '', 
                passengers: [], 
                trips: [],
                currentTripInput: {
                    direction: '去程',
                    date: '',
                    trainNumber: '',
                    carType: '標準車廂',
                    origin: '南港',
                    destination: '左營',
                    depTime: '09:00',
                    arrTime: '10:45',
                    pnr: '', 
                    hsrOrderId: '', // New field per trip
                    tickets: [
                        { type: '全票', count: 1, price: 0 } 
                    ]
                }
            },
            computed: {
                totalPrice() {
                    let total = 0;
                    this.trips.forEach(trip => {
                        trip.tickets.forEach(t => {
                            total += (t.count * t.price);
                        });
                    });
                    return total;
                },
                today() {
                    return new Date().toLocaleDateString('zh-TW');
                }
            },
            methods: {
                // Swap stations function
                swapStations() {
                    const temp = this.currentTripInput.origin;
                    this.currentTripInput.origin = this.currentTripInput.destination;
                    this.currentTripInput.destination = temp;
                    this.updateInputPrices();
                },

                // OCR 圖片處理 (Updated to map HSR Order ID to currentTripInput)
                handleFileUpload(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    this.recognizeImage(file);
                },
                handlePaste(e) {
                    const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                    for (let item of items) {
                        if (item.kind === 'file' && item.type.startsWith('image/')) {
                            const blob = item.getAsFile();
                            this.recognizeImage(blob);
                            e.preventDefault(); 
                            break;
                        }
                    }
                },
                handleDrop(e) {
                    const file = e.dataTransfer.files[0];
                    if (file && file.type.startsWith('image/')) {
                        this.recognizeImage(file);
                    }
                },
                recognizeImage(imageBlob) {
                    this.isRecognizing = true;
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.fillStyle = "#FFFFFF";
                        ctx.fillRect(0,0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0);
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const data = imageData.data;
                        for (let i = 0; i < data.length; i += 4) {
                            const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                            const color = avg > 180 ? 255 : 0; 
                            data[i] = color;
                            data[i + 1] = color;
                            data[i + 2] = color;
                        }
                        ctx.putImageData(imageData, 0, 0);
                        canvas.toBlob((blob) => {
                             Tesseract.recognize(blob, 'eng+chi_tra', { logger: m => console.log(m) })
                            .then(({ data: { text } }) => {
                                console.log('Recognized Text:', text);
                                this.parseOCRText(text);
                                this.isRecognizing = false;
                                alert('辨識完成！請檢查並修正欄位資料。');
                            }).catch(err => {
                                console.error(err);
                                this.isRecognizing = false;
                                alert('辨識失敗，請稍後再試或手動輸入。');
                            });
                        });
                    };
                    img.src = URL.createObjectURL(imageBlob);
                },
                parseOCRText(text) {
                    // PNR
                    const pnrMatch = text.match(/\b[A-Z0-9]{8}\b/);
                    if (pnrMatch) this.currentTripInput.pnr = pnrMatch[0];

                    // HSR Order ID (Now specific to trip)
                    const orderIdMatch = text.match(/(?:訂單編號|編號)[\D]*(\d{8,12})/);
                    if (orderIdMatch) {
                        this.currentTripInput.hsrOrderId = orderIdMatch[1];
                    } else {
                        const numMatch = text.match(/\b\d{8,10}\b/);
                        if(numMatch) this.currentTripInput.hsrOrderId = numMatch[0];
                    }

                    // Train Number
                    const labeledTrain = text.match(/(?:車\s*次)[\D]*(\d{3,4})/);
                    if (labeledTrain) {
                        this.currentTripInput.trainNumber = labeledTrain[1];
                    } else {
                        const nums = text.match(/\b\d{3,4}\b/g);
                        if (nums) {
                            const validTrains = nums.filter(n => {
                                const v = parseInt(n);
                                return v > 100 && v < 2000 && v !== 2023 && v !== 2024 && v !== 2025; 
                            });
                            if (validTrains.length > 0) this.currentTripInput.trainNumber = validTrains[0];
                        }
                    }

                    // Stations
                    const stations = ['南港', '台北', '板橋', '桃園', '新竹', '苗栗', '台中', '彰化', '雲林', '嘉義', '台南', '左營'];
                    const foundStations = [];
                    const cleanText = text.replace(/\s/g, '');
                    stations.forEach(s => { if (cleanText.includes(s)) foundStations.push(s); });
                    const uniqueStations = [...new Set(foundStations)];
                    
                    if (uniqueStations.length >= 2) {
                        const s1Index = text.indexOf(uniqueStations[0]);
                        const s2Index = text.indexOf(uniqueStations[1]);
                        if (s1Index < s2Index) {
                            this.currentTripInput.origin = uniqueStations[0];
                            this.currentTripInput.destination = uniqueStations[1];
                        } else {
                            this.currentTripInput.origin = uniqueStations[1];
                            this.currentTripInput.destination = uniqueStations[0];
                        }
                    }

                    // Times
                    const timeMatches = text.match(/([0-2]?\d):([0-5]\d)/g);
                    if (timeMatches && timeMatches.length >= 2) {
                        this.currentTripInput.depTime = timeMatches[0];
                        this.currentTripInput.arrTime = timeMatches[1];
                    }

                    // Car Type
                    if (text.includes("商務")) this.currentTripInput.carType = "商務車廂";
                    else if (text.includes("標準")) this.currentTripInput.carType = "標準車廂";

                    // Passengers
                    const lines = text.split(/\r?\n/);
                    const newPassengers = [];
                    lines.forEach(line => {
                        const cleanLineForID = line.replace(/\s/g, '');
                        const idMatch = cleanLineForID.match(/[A-Z](?:[12]\d{8}|[*]{5}\d{4})/);
                        if (idMatch) {
                            const id = idMatch[0];
                            let name = '';
                            let cleanLine = line.replace(/[A-Z]\s?(?:[12]\s?\d{8}|(?:\*\s?){5}\d{4})/g, '');
                            const keywords = ['全票', '孩童', '敬老', '愛心', '大學生', '票', 'TWD', '$', '早鳥', '商務', '標準', '車廂', '座位'];
                            keywords.forEach(k => cleanLine = cleanLine.replace(new RegExp(k, 'g'), ''));
                            cleanLine = cleanLine.replace(/[0-9:.,]/g, '');
                            const tokens = cleanLine.trim().split(/\s+/);
                            const nameCandidate = tokens.find(t => t.length >= 2 && t.length <= 4);
                            if (nameCandidate) name = nameCandidate;

                            if (!newPassengers.find(p => p.id === id)) {
                                newPassengers.push({ name: name, id: id, passport: '', birthDate: '' });
                            }
                        }
                    });

                    if (newPassengers.length > 0) {
                        if (this.passengers.length === 1 && !this.passengers[0].id) {
                            this.passengers = newPassengers;
                        } else {
                            newPassengers.forEach(np => {
                                if (!this.passengers.find(p => p.id === np.id)) this.passengers.push(np);
                            });
                        }
                    }
                    
                    // Date
                    const dateMatch = text.match(/(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})/);
                    if (dateMatch) {
                        const y = dateMatch[1];
                        const m = dateMatch[2].padStart(2, '0');
                        const d = dateMatch[3].padStart(2, '0');
                        this.currentTripInput.date = `${y}-${m}-${d}`;
                    }
                    
                    // Tickets
                    const types = ['全票', '孩童', '敬老', '愛心', '大學生', '早鳥'];
                    const newTickets = [];
                    types.forEach(type => {
                         if (text.includes(type)) {
                             const regex = new RegExp(`${type}.*?(\\d+)`);
                             const match = text.match(regex);
                             let count = 1;
                             if(match) count = parseInt(match[1]);
                             let mappedType = '全票';
                             if(type === '孩童') mappedType = '孩童';
                             if(type === '敬老') mappedType = '敬老';
                             if(type === '愛心') mappedType = '愛心';
                             const existing = newTickets.find(t => t.type === mappedType);
                             if(existing) existing.count += count;
                             else newTickets.push({ type: mappedType, count: count, price: 0 });
                         }
                    });
                    if (newTickets.length > 0) {
                        this.currentTripInput.tickets = newTickets;
                        this.updateInputPrices(); 
                        this.updatePassengerCount();
                    }
                },

                updatePassengerCount() {
                    const count = this.currentTripInput.tickets.reduce((sum, t) => sum + (t.count || 0), 0);
                    if (count > 10) { alert("每筆行程最多只能有 10 位旅客！"); return; }
                    const currentLen = this.passengers.length;
                    if (count > currentLen) {
                        for (let i = 0; i < count - currentLen; i++) this.passengers.push({ name: '', id: '', passport: '', birthDate: '' });
                    } else if (count < currentLen) {
                        this.passengers.splice(count);
                    }
                },
                addTicketInput() {
                    let currentCount = this.currentTripInput.tickets.reduce((sum, t) => sum + (t.count || 0), 0);
                    if (currentCount >= 10) { alert("已達到 10 位旅客上限！"); return; }
                    this.currentTripInput.tickets.push({ type: '全票', count: 1, price: 0 });
                    this.updateInputPrices(); this.updatePassengerCount();
                },
                removeTicketInput(index) {
                    this.currentTripInput.tickets.splice(index, 1);
                    this.updateInputPrices(); this.updatePassengerCount();
                },
                updateInputPrices() {
                    const { carType, origin, destination, tickets } = this.currentTripInput;
                    if (origin && destination) {
                        tickets.forEach(ticket => {
                            ticket.price = this.calculateSinglePrice(carType, ticket.type, origin, destination);
                        });
                    }
                    this.updatePassengerCount(); 
                },
                addTripToList() {
                    let totalPassengers = this.passengers.length;
                    if (totalPassengers > 10) { alert("每筆行程最多只能有 10 位旅客！請減少票數。"); return; }
                    for(let i=0; i<this.passengers.length; i++) {
                        if(!this.passengers[i].name || !this.passengers[i].id) {
                            alert(`請填寫第 ${i+1} 位旅客的姓名與身分證字號`); return;
                        }
                    }
                    const tripToAdd = JSON.parse(JSON.stringify(this.currentTripInput));
                    tripToAdd.passengers = JSON.parse(JSON.stringify(this.passengers));
                    this.trips.push(tripToAdd);
                    
                    if (this.currentTripInput.direction === '去程') {
                         this.currentTripInput.direction = '回程';
                         let temp = this.currentTripInput.origin;
                         this.currentTripInput.origin = this.currentTripInput.destination;
                         this.currentTripInput.destination = temp;
                         this.currentTripInput.depTime = '18:00';
                         this.currentTripInput.arrTime = '19:45';
                         this.currentTripInput.pnr = ''; 
                         this.currentTripInput.hsrOrderId = ''; // Clear for next input
                    } else {
                        this.currentTripInput.trainNumber = '';
                        this.currentTripInput.pnr = ''; 
                        this.currentTripInput.hsrOrderId = '';
                    }
                    this.updateInputPrices();
                    this.$nextTick(() => {
                        const previewSection = document.querySelector('.preview-section');
                        if(previewSection) previewSection.scrollTop = previewSection.scrollHeight;
                    });
                },
                generateTicket() {
                    if (this.trips.length === 0) { alert("請先加入至少一筆行程！"); return; }
                    this.showModal = true;
                },
                generateImage() {
                    const element = this.$refs.captureArea;
                    if (!element) return;
                    const modalContent = document.querySelector('.modal-content');
                    if (modalContent) modalContent.scrollTo(0,0);
                    html2canvas(element, { scale: 2, useCORS: true, backgroundColor: '#ffffff' }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = `高鐵訂位確認單_${this.cowayOrderId || 'untiltled'}.jpg`;
                        link.href = canvas.toDataURL('image/jpeg', 0.9);
                        link.click();
                    }).catch(err => { console.error(err); alert('生成失敗'); });
                },
                getBaseFare(faresObj, start, end) {
                    if (start === end) return 0;
                    if (faresObj[start] && faresObj[start][end]) return faresObj[start][end];
                    if (faresObj[end] && faresObj[end][start]) return faresObj[end][start];
                    return 0; 
                },
                calculateSinglePrice(carType, ticketType, origin, destination) {
                    let baseFare = 0;
                    let finalPrice = 0;
                    if (carType === '商務車廂') {
                        baseFare = this.getBaseFare(this.businessFares, origin, destination);
                        finalPrice = (ticketType === '全票') ? baseFare * 0.9 : baseFare * 0.5;
                    } else {
                        baseFare = this.getBaseFare(this.standardFares, origin, destination);
                        finalPrice = (ticketType === '全票') ? baseFare * 0.85 : baseFare * 0.5;
                    }
                    return Math.round(finalPrice);
                },
                removeTripFromList(index) {
                    if(confirm('確定要刪除此行程嗎？')) this.trips.splice(index, 1);
                },
                getTripSubtotal(trip) {
                    return trip.tickets.reduce((sum, t) => sum + (t.count * t.price), 0);
                },
                getTotalCount(tickets) {
                    return tickets.reduce((sum, t) => sum + t.count, 0);
                },
                getTicketCount(tickets, type) {
                    return tickets.filter(t => t.type === type).reduce((sum, t) => sum + t.count, 0) || '-';
                },
                formatPrice(value) {
                    if (!value) return '0';
                    return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                },
                formatDate(dateStr) {
                    if (!dateStr) return '-';
                    const date = new Date(dateStr);
                    return `${date.getFullYear()}/${(date.getMonth()+1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
                },
                formatDateShort(dateStr) {
                    if (!dateStr) return '-';
                    const date = new Date(dateStr);
                    return `${(date.getMonth()+1)}/${date.getDate()}`;
                },
                maskID(id) {
                    if (!id) return '';
                    if (id.includes('*')) return id; 
                    if (id.length < 4) return id;
                    return id.substring(0, 3) + '*****' + id.substring(id.length - 2);
                },
                resetForm() {
                    if(confirm('確定要清空所有資料嗎？')) {
                        this.groupNumber = ''; this.cowayOrderId = '';
                        this.trips = []; this.showModal = false;
                        this.passengers = []; 
                        const todayDate = new Date();
                        const todayStr = todayDate.toISOString().split('T')[0];
                        const dlDate = new Date(todayDate);
                        dlDate.setDate(todayDate.getDate() + 2);
                        if (dlDate.getDay() === 6) dlDate.setDate(dlDate.getDate() - 1);
                        else if (dlDate.getDay() === 0) dlDate.setDate(dlDate.getDate() - 2);
                        this.deadlineDate = dlDate.toISOString().split('T')[0];
                        this.currentTripInput = {
                            direction: '去程',
                            date: todayStr,
                            trainNumber: '',
                            carType: '標準車廂',
                            origin: '南港',
                            destination: '左營',
                            depTime: '09:00',
                            arrTime: '10:45',
                            pnr: '',
                            hsrOrderId: '',
                            tickets: [{ type: '全票', count: 1, price: 0 }]
                        };
                        this.updateInputPrices();
                    }
                }
            },
            mounted() {
                const todayDate = new Date();
                const todayStr = todayDate.toISOString().split('T')[0];
                const dlDate = new Date(todayDate);
                dlDate.setDate(todayDate.getDate() + 2);
                if (dlDate.getDay() === 6) dlDate.setDate(dlDate.getDate() - 1);
                else if (dlDate.getDay() === 0) dlDate.setDate(dlDate.getDate() - 2);
                const dlDateStr = dlDate.toISOString().split('T')[0];
                this.currentTripInput.date = todayStr;
                this.bookingDate = todayStr; 
                this.deadlineDate = dlDateStr; 
                this.currentTripInput.pnr = Math.floor(10000000 + Math.random() * 90000000).toString();
                this.currentTripInput.hsrOrderId = '202' + Math.floor(10000000 + Math.random() * 90000000).toString();
                this.updateInputPrices();
            }
        });
    </script>
</body>
</html>
