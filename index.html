<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜éµè¨‚ä½ç¢ºèªå–®ç”Ÿæˆå™¨</title>
    
    <!-- å¼•å…¥å­—é«” Noto Sans TC -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Vue.js 2 (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>

    <!-- html2canvas (ç”¨æ–¼ç”Ÿæˆåœ–ç‰‡) -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <!-- Tesseract.js (ç”¨æ–¼åœ–ç‰‡æ–‡å­—è¾¨è­˜) -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f5f5f4; /* Stone 100 */
        }
        /* è‡ªå®šç¾©æ—¥ç³»è¼¸å…¥æ¡†æ¨£å¼ */
        .input-minimal {
            background-color: transparent;
            border-bottom: 1px solid #d6d3d1; /* Stone 300 */
            padding: 0.5rem 0;
            width: 100%;
            transition: all 0.3s ease;
            color: #44403c; /* Stone 700 */
            outline: none;
        }
        .input-minimal:focus {
            border-color: #0d9488; /* Teal 600 */
            border-bottom-width: 2px;
        }
        .input-label {
            font-size: 0.75rem;
            color: #78716c; /* Stone 500 */
            margin-bottom: 0.25rem;
            display: block;
        }
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-add {
            background-color: #57534e; /* Stone 600 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s;
            width: 100%;
        }
        .btn-add:hover {
            background-color: #44403c;
        }
        .btn-primary {
            background-color: #0d9488; /* Teal 600 */
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 0.5rem;
            font-weight: 500;
            letter-spacing: 0.05em;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            background-color: #0f766e; /* Teal 700 */
            transform: translateY(-1px);
            box-shadow: 0 6px 8px -1px rgba(0, 0, 0, 0.15);
        }
        
        /* å½ˆçª—æ¨£å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            padding: 20px;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: #e5e5e5;
            border-radius: 1rem;
            max-height: 95vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* è®€å–ä¸­é®ç½© */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 60;
            backdrop-filter: blur(2px);
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0d9488;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* é è¦½ç¢ºèªå–®å°ˆç”¨æ¨£å¼ (ç¾åŒ–ç‰ˆ) */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .info-cell {
            background: #fff;
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
        }
        .info-cell-label {
            font-size: 0.65rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 2px;
        }
        .info-cell-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: #334155;
        }
        
        .trip-card {
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 1.5rem;
            background: white;
        }
        .trip-header {
            background-color: #f1f5f9;
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e2e8f0;
        }
        .trip-body {
            padding: 1rem;
        }
        .station-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
        }
        .time-display {
            font-family: monospace;
            font-size: 1.1rem;
            color: #475569;
        }
        
        /* æ—…å®¢è¡¨æ ¼æ¨£å¼ */
        .passenger-table {
            width: 100%;
            font-size: 0.85rem;
            border-collapse: collapse;
        }
        .passenger-table th {
            text-align: left;
            padding: 0.5rem;
            background-color: #f8fafc;
            color: #64748b;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
        }
        .passenger-table td {
            padding: 0.5rem;
            border-bottom: 1px solid #f1f5f9;
            color: #334155;
        }
        .passenger-table tr:last-child td {
            border-bottom: none;
        }

        /* æ»¾å‹•æ¢æ¨£å¼ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d6d3d1; 
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a29e; 
        }
        
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s;
        }
        .fade-enter, .fade-leave-to {
            opacity: 0;
        }
        
        /* å¿…å¡«æ˜Ÿè™Ÿ */
        .required-mark {
            color: #ef4444;
            margin-left: 2px;
        }
    </style>
</head>
<body class="text-stone-700 h-screen overflow-hidden" @paste="handlePaste">

    <div id="app" class="h-full flex flex-col">
        
        <!-- Loading Overlay -->
        <div v-if="isRecognizing" class="loading-overlay">
            <div class="spinner"></div>
            <div class="text-stone-600 font-bold">æ­£åœ¨è¾¨è­˜åœ–ç‰‡ä¸­çš„æ–‡å­—...</div>
            <div class="text-xs text-stone-400 mt-2">è«‹ç¨å€™ï¼Œè¾¨è­˜é€Ÿåº¦å–æ±ºæ–¼åœ–ç‰‡æ¸…æ™°åº¦</div>
        </div>

        <!-- æ¨™é¡Œ (å›ºå®šé ‚éƒ¨) -->
        <header class="py-4 text-center no-print bg-[#f5f5f4] shrink-0 border-b border-stone-200 shadow-sm z-20">
            <h1 class="text-2xl font-light tracking-widest text-stone-800">é«˜éµè¨‚ä½ç¢ºèªå–®ç”Ÿæˆå™¨</h1>
        </header>

        <!-- ä¸»å…§å®¹å€ (é›™æ¬„ä½ˆå±€) -->
        <main class="flex-1 overflow-hidden grid grid-cols-1 lg:grid-cols-12 gap-4 p-4 lg:p-6 bg-[#f5f5f4]">
            
            <!-- å·¦å´ï¼šè¼¸å…¥è¡¨å–®å€ -->
            <section class="lg:col-span-7 bg-white rounded-2xl border border-stone-200 overflow-y-auto custom-scrollbar input-section p-6 md:p-8 shadow-sm z-10">
                
                <!-- æ¨™é¡Œåˆ— + è¨‚ç¥¨äººå“¡/æ—¥æœŸ + D/L -->
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b border-stone-100 pb-4 gap-3">
                    <div class="flex items-center gap-4 flex-wrap">
                        <h2 class="text-lg font-medium text-stone-600 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-teal-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                            è³‡æ–™è¼¸å…¥
                        </h2>
                        
                        <!-- æ•´åˆå€å¡Š -->
                        <div class="flex items-center gap-3 bg-stone-50 px-4 py-2 rounded-lg border border-stone-100 shadow-sm">
                            <div class="flex items-center gap-1 border-r border-stone-200 pr-3">
                                <span class="text-xs text-stone-400">è¨‚ç¥¨äººå“¡</span>
                                <select v-model="booker" class="bg-transparent text-sm font-bold text-stone-700 focus:outline-none cursor-pointer p-0 border-none appearance-none hover:text-teal-600">
                                    <option>å“èŠ·ä¼¶</option>
                                    <option>é™³ä¾‘å›</option>
                                </select>
                            </div>
                            
                            <div class="flex items-center gap-1 border-r border-stone-200 pr-3">
                                <span class="text-xs text-stone-400">è¨‚ç¥¨æ—¥æœŸ</span>
                                <span class="text-sm font-bold text-stone-700">{{ formatDate(bookingDate) }}</span>
                            </div>

                            <div class="flex items-center gap-1">
                                <span class="text-xs text-teal-600 font-bold">D/L</span>
                                <input type="date" v-model="deadlineDate" class="bg-transparent text-sm font-bold text-teal-700 focus:outline-none p-0 border-none w-28 cursor-pointer hover:bg-stone-100 rounded px-1">
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 ml-auto sm:ml-0">
                        <!-- åœ–ç‰‡ä¸Šå‚³æŒ‰éˆ• -->
                        <div class="relative">
                            <input type="file" ref="fileInput" @change="handleFileUpload" accept="image/*" class="hidden">
                            <button @click="$refs.fileInput.click()" class="text-stone-400 hover:text-teal-600 transition-colors p-1 rounded hover:bg-teal-50" title="ä¸Šå‚³æˆªåœ–è‡ªå‹•è¾¨è­˜ (æˆ–ç›´æ¥æŒ‰ Ctrl+V)">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </button>
                        </div>

                        <!-- åƒåœ¾æ¡¶åœ–ç¤º -->
                        <button @click="resetForm" class="text-stone-400 hover:text-red-500 transition-colors p-1 rounded hover:bg-stone-100" title="æ¸…ç©ºæ‰€æœ‰è³‡æ–™">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- 1. å…¨åŸŸè¨­å®š -->
                <div class="grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-4 mb-6 pb-6 border-b border-stone-100 text-sm">
                    <div>
                        <label class="input-label">é«˜éµè¨‚å–®ç·¨è™Ÿ</label>
                        <input type="text" v-model="orderId" class="input-minimal font-mono tracking-wider" placeholder="20230512">
                    </div>
                    <div>
                        <label class="input-label">è¨‚å–®ç·¨è™Ÿ</label>
                        <input type="text" v-model="cowayOrderId" maxlength="8" class="input-minimal tracking-wider" placeholder="12345678">
                    </div>
                    <div>
                        <label class="input-label">åœ˜è™Ÿ</label>
                        <input type="text" v-model="groupNumber" class="input-minimal" placeholder="TPE20230512A001">
                    </div>
                </div>

                <!-- 2. æ–°å¢è¡Œç¨‹ & æ—…å®¢ -->
                <div class="mb-10 p-5 bg-stone-50 rounded-xl border border-stone-100">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="w-1.5 h-5 bg-stone-700 rounded-sm"></span>
                        <h3 class="font-bold text-stone-700 text-sm">æ–°å¢è¡Œç¨‹è¨­å®š</h3>
                        <span class="text-[10px] text-teal-600 bg-teal-50 px-2 py-0.5 rounded ml-2 hidden md:inline-block">ğŸ’¡ æç¤ºï¼šå¯ç›´æ¥è²¼ä¸Šåœ–ç‰‡è‡ªå‹•è¾¨è­˜</span>
                    </div>

                    <!-- è¡Œç¨‹æ–¹å‘ -->
                    <div class="mb-4 flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded border border-stone-200 hover:border-teal-400 transition-colors">
                            <input type="radio" value="å»ç¨‹" v-model="currentTripInput.direction" class="text-teal-600 focus:ring-teal-500">
                            <span :class="currentTripInput.direction === 'å»ç¨‹' ? 'font-bold text-teal-700' : 'text-stone-600'">å»ç¨‹</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded border border-stone-200 hover:border-teal-400 transition-colors">
                            <input type="radio" value="å›ç¨‹" v-model="currentTripInput.direction" class="text-teal-600 focus:ring-teal-500">
                            <span :class="currentTripInput.direction === 'å›ç¨‹' ? 'font-bold text-teal-700' : 'text-stone-600'">å›ç¨‹</span>
                        </label>
                    </div>

                    <!-- è¡Œç¨‹è©³ç´°è³‡æ–™ -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div class="lg:col-span-1">
                            <label class="input-label">è¨‚ä½ä»£è™Ÿ (PNR)</label>
                            <input type="text" v-model="currentTripInput.pnr" maxlength="8" class="input-minimal font-bold uppercase tracking-wider text-teal-700" placeholder="06082412">
                        </div>
                        <div class="lg:col-span-1">
                            <label class="input-label">æ—¥æœŸ</label>
                            <input type="date" v-model="currentTripInput.date" class="input-minimal">
                        </div>
                        <div class="lg:col-span-1">
                            <label class="input-label">è»Šæ¬¡</label>
                            <input type="text" v-model="currentTripInput.trainNumber" class="input-minimal" placeholder="ex: 1205">
                        </div>
                        <div class="lg:col-span-1">
                            <label class="input-label">è»Šå»‚ç¨®é¡</label>
                            <select v-model="currentTripInput.carType" @change="updateInputPrices" class="input-minimal">
                                <option>æ¨™æº–è»Šå»‚</option>
                                <option>å•†å‹™è»Šå»‚</option>
                            </select>
                        </div>
                        
                        <div class="lg:col-span-1">
                            <label class="input-label">èµ·ç¨‹æ™‚é–“</label>
                            <input type="text" v-model="currentTripInput.depTime" class="input-minimal" placeholder="ex: 09:30">
                        </div>
                        <div class="lg:col-span-1">
                            <label class="input-label">åˆ°é”æ™‚é–“</label>
                            <input type="text" v-model="currentTripInput.arrTime" class="input-minimal" placeholder="ex: 11:15">
                        </div>
                        <div class="lg:col-span-1">
                            <label class="input-label">å‡ºç™¼ç«™</label>
                            <select v-model="currentTripInput.origin" @change="updateInputPrices" class="input-minimal">
                                <option v-for="st in stations" :value="st">{{ st }}</option>
                            </select>
                        </div>
                        <div class="lg:col-span-1">
                            <label class="input-label">æŠµé”ç«™</label>
                            <select v-model="currentTripInput.destination" @change="updateInputPrices" class="input-minimal">
                                <option v-for="st in stations" :value="st">{{ st }}</option>
                            </select>
                        </div>
                    </div>

                    <!-- ç¥¨ç¨®è¼¸å…¥ -->
                    <div class="bg-white p-3 rounded-lg border border-stone-200 mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-bold text-stone-500">ç¥¨ç¨®èˆ‡å¼µæ•¸ (ä¸Šé™ 10 ä½)</label>
                            <button @click="addTicketInput" class="text-xs text-teal-600 hover:text-teal-800 font-medium">+ å¢åŠ ç¥¨ç¨®</button>
                        </div>
                        <div v-for="(ticket, idx) in currentTripInput.tickets" :key="'t-'+idx" class="flex gap-2 mb-2 items-end border-b border-stone-100 pb-2 last:border-0 last:pb-0 last:mb-0">
                            <div class="flex-1">
                                <select v-model="ticket.type" @change="updateInputPrices" class="input-minimal text-sm">
                                    <option>å…¨ç¥¨</option>
                                    <option>å­©ç«¥</option>
                                    <option>æ•¬è€</option>
                                    <option>æ„›å¿ƒ</option>
                                </select>
                            </div>
                            <div class="w-16">
                                <input type="number" v-model.number="ticket.count" min="1" max="10" @input="updatePassengerCount" class="input-minimal text-center text-sm" placeholder="å¼µæ•¸">
                            </div>
                            <div class="w-20">
                                <input type="number" v-model.number="ticket.price" class="input-minimal text-right text-sm" placeholder="åƒ¹æ ¼">
                            </div>
                            <button v-if="currentTripInput.tickets.length > 1" @click="removeTicketInput(idx)" class="text-stone-300 hover:text-red-400 px-1">
                                &times;
                            </button>
                        </div>
                    </div>

                    <!-- å‹•æ…‹æ—…å®¢è³‡æ–™è¼¸å…¥ -->
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-3 px-1">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-bold text-stone-700">æ—…å®¢è³‡æ–™è¼¸å…¥</span>
                                <span class="text-xs text-teal-600 bg-teal-50 px-2 py-0.5 rounded-full">å…± {{ passengers.length }} ä½</span>
                            </div>
                        </div>
                        
                        <div v-if="passengers.length === 0" class="text-center py-4 text-stone-400 text-xs bg-stone-100 rounded-lg">
                            è«‹å…ˆåœ¨ä¸Šæ–¹é¸æ“‡ç¥¨ç¨®èˆ‡å¼µæ•¸
                        </div>

                        <div v-for="(p, index) in passengers" :key="'p-'+index" class="mb-3 bg-white p-4 rounded-xl border border-stone-200 shadow-sm">
                            <div class="text-xs text-stone-400 mb-2 font-bold">æ—…å®¢ {{ index + 1 }}</div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <label class="input-label">å§“å <span class="required-mark">*</span></label>
                                    <input type="text" v-model="p.name" class="input-minimal" placeholder="å¿…å¡«">
                                </div>
                                <div>
                                    <label class="input-label">èº«åˆ†è­‰å­—è™Ÿ <span class="required-mark">*</span></label>
                                    <input type="text" v-model="p.id" class="input-minimal uppercase" placeholder="å¿…å¡«">
                                </div>
                                <div>
                                    <label class="input-label">å‡ºç”Ÿå¹´æœˆæ—¥ (é¸å¡«)</label>
                                    <input type="date" v-model="p.birthDate" class="input-minimal text-stone-500">
                                </div>
                                <div>
                                    <label class="input-label">è­·ç…§è™Ÿç¢¼ (é¸å¡«)</label>
                                    <input type="text" v-model="p.passport" class="input-minimal uppercase" placeholder="é¸å¡«">
                                </div>
                            </div>
                        </div>
                    </div>

                    <button @click="addTripToList" class="btn-add flex items-center justify-center gap-2 w-full py-3 shadow-md hover:shadow-lg transform transition-all hover:-translate-y-0.5">
                        <span>åŠ å…¥è¡Œç¨‹æ¸…å–®</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                        </svg>
                    </button>
                </div>

            </section>

            <!-- å³å´ï¼šæ‘˜è¦æ¸…å–®å€ -->
            <section class="lg:col-span-5 bg-[#fdfcfc] rounded-2xl border border-stone-200 overflow-y-auto custom-scrollbar p-6 relative flex flex-col shadow-sm">
                
                <h2 class="text-xl font-bold text-stone-700 mb-6 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-stone-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                    </svg>
                    é è¦½æ‘˜è¦ (Trip Summary)
                </h2>

                <!-- ç©ºç‹€æ…‹ -->
                <div v-if="trips.length === 0" class="flex-1 flex flex-col justify-center items-center text-stone-300 border-2 border-dashed border-stone-200 rounded-xl mb-8 min-h-[200px]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4v16m8-8H4" />
                    </svg>
                    <p class="text-lg">å°šæœªåŠ å…¥ä»»ä½•è¡Œç¨‹</p>
                    <p class="text-sm mt-1">è«‹åœ¨å·¦å´å¡«å¯«ä¸¦åŠ å…¥</p>
                </div>

                <!-- è¡Œç¨‹å¡ç‰‡æ¸…å–® -->
                <div v-else class="space-y-3 mb-8">
                    <div v-for="(trip, idx) in trips" :key="idx" class="bg-white border border-stone-200 rounded-lg p-4 shadow-sm relative group hover:shadow-md transition-shadow">
                        <button @click="removeTripFromList(idx)" class="absolute top-3 right-3 text-stone-300 hover:text-red-500 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>

                        <div class="flex items-center gap-3 mb-2">
                            <span class="px-2 py-0.5 rounded text-xs font-bold tracking-wider" 
                                  :class="trip.direction === 'å»ç¨‹' ? 'bg-teal-100 text-teal-800' : 'bg-stone-200 text-stone-600'">
                                {{ trip.direction }}
                            </span>
                            <span class="text-sm text-stone-500 font-medium">{{ formatDateShort(trip.date) }}</span>
                            <span class="text-xs font-mono text-stone-400 bg-stone-100 px-2 py-0.5 rounded">{{ trip.trainNumber }}è»Šæ¬¡</span>
                        </div>

                        <div class="flex items-baseline gap-2 mb-1">
                            <span class="text-lg font-bold text-stone-800">{{ trip.origin }}</span>
                            <span class="text-stone-300 text-sm">âœ</span>
                            <span class="text-lg font-bold text-stone-800">{{ trip.destination }}</span>
                            <span class="ml-auto font-mono text-base font-bold text-stone-700">TWD ${{ formatPrice(getTripSubtotal(trip)) }}</span>
                        </div>

                        <div class="text-xs text-stone-500 flex gap-3">
                            <span class="font-mono">{{ trip.depTime }} - {{ trip.arrTime }}</span>
                            <span class="text-stone-300">|</span>
                            <span>{{ trip.pnr }}</span>
                            <span class="text-stone-300">|</span>
                            <span>å…± {{ getTotalCount(trip.tickets) }} å¼µ</span>
                        </div>
                    </div>

                    <!-- ç¸½è¨ˆæ‘˜è¦ -->
                    <div class="flex justify-end items-center gap-4 pt-4 border-t border-stone-200 mt-6">
                        <span class="text-stone-500 text-sm">ç¸½é‡‘é¡åˆè¨ˆ</span>
                        <span class="text-2xl font-bold text-teal-700">TWD ${{ formatPrice(totalPrice) }}</span>
                    </div>
                </div>

                <!-- ç”ŸæˆæŒ‰éˆ• -->
                <div class="mt-auto pt-4 text-center">
                    <button 
                        @click="generateTicket" 
                        :disabled="trips.length === 0"
                        :class="trips.length === 0 ? 'bg-stone-300 cursor-not-allowed' : 'bg-stone-800 hover:bg-stone-900 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5'"
                        class="text-white px-8 py-3 rounded-full text-lg font-medium tracking-wide transition-all flex items-center justify-center gap-3 mx-auto w-full max-w-sm">
                        <span>ç”Ÿæˆç¢ºèªå–®</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>

            </section>
        </main>

        <!-- å½ˆå‡ºå¼ç¢ºèªå–® Modal -->
        <transition name="fade">
            <div v-if="showModal" class="modal-overlay" @click.self="showModal = false">
                <div class="modal-content relative p-4 md:p-8">
                    
                    <button @click="showModal = false" class="absolute top-4 right-4 z-50 bg-stone-200 hover:bg-stone-300 rounded-full p-2 text-stone-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>

                    <!-- A4 ç´™å¼µæ¨¡æ“¬å®¹å™¨ -->
                    <div ref="captureArea" class="bg-white shadow-2xl w-full max-w-[210mm] min-h-[297mm] relative box-border mx-auto mb-20 overflow-hidden">
                        
                        <div class="h-3 w-full bg-teal-600"></div>

                        <div class="p-[12mm] md:p-[15mm]">
                            
                            <!-- 1. æ¨™é¡Œå€ -->
                            <div class="flex justify-between items-end mb-8 border-b-2 border-stone-200 pb-4">
                                <div>
                                    <h2 class="text-3xl font-extrabold tracking-wider text-stone-800">è¨‚ä½ç¢ºèªå–®</h2>
                                    <p class="text-xs text-stone-500 uppercase tracking-[0.2em] mt-1">Booking Confirmation</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-bold text-stone-700">é«˜éµè¨‚ç¥¨æœå‹™</div>
                                    <div class="text-xs text-stone-400">{{ formatDate(today) }}</div>
                                </div>
                            </div>
                            
                            <!-- 2. è¨‚å–®è³‡è¨Šæ‘˜è¦ -->
                            <div class="info-grid mb-8">
                                <div class="info-cell">
                                    <div class="info-cell-label">è¨‚ç¥¨äººå“¡</div>
                                    <div class="info-cell-value">{{ booker }}</div>
                                </div>
                                <div class="info-cell">
                                    <div class="info-cell-label">è¨‚ç¥¨æ—¥æœŸ</div>
                                    <div class="info-cell-value">{{ formatDate(bookingDate) }}</div>
                                </div>
                                <div class="info-cell" style="border-color: #99f6e4; background: #f0fdfa;">
                                    <div class="info-cell-label text-teal-700">D/L æœ€å¾Œé–‹ç¥¨æœŸé™</div>
                                    <div class="info-cell-value text-teal-800">{{ formatDate(deadlineDate) }} 18:00å‰</div>
                                </div>
                                <div class="info-cell">
                                    <div class="info-cell-label">é«˜éµè¨‚å–®ç·¨è™Ÿ</div>
                                    <div class="info-cell-value font-mono">{{ orderId }}</div>
                                </div>
                                <div class="info-cell">
                                    <div class="info-cell-label">è¨‚å–®ç·¨è™Ÿ</div>
                                    <div class="info-cell-value">{{ cowayOrderId || '-' }}</div>
                                </div>
                                <div class="info-cell">
                                    <div class="info-cell-label">åœ˜è™Ÿ</div>
                                    <div class="info-cell-value font-mono text-sm break-all">{{ groupNumber || '-' }}</div>
                                </div>
                            </div>

                            <!-- 3. è¡Œç¨‹å€å¡Š -->
                            <div v-for="(trip, idx) in trips" :key="'preview-'+idx" class="trip-card">
                                
                                <div class="trip-header">
                                    <div class="flex items-center gap-3">
                                        <span class="px-3 py-1 rounded text-xs font-bold text-white tracking-wider" 
                                              :class="trip.direction === 'å»ç¨‹' ? 'bg-teal-600' : 'bg-stone-500'">
                                            {{ trip.direction }}
                                        </span>
                                        <span class="font-bold text-stone-700">{{ formatDate(trip.date) }}</span>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <span class="text-sm font-medium text-stone-600 bg-white px-2 py-0.5 rounded border border-stone-200">
                                            {{ trip.carType }}
                                        </span>
                                        <span class="text-lg font-mono font-bold text-stone-800">
                                            {{ trip.trainNumber }} <span class="text-xs text-stone-400 font-normal">è»Šæ¬¡</span>
                                        </span>
                                    </div>
                                </div>

                                <div class="trip-body">
                                    <div class="flex justify-between items-center mb-6 px-2">
                                        <div class="text-center">
                                            <div class="station-name">{{ trip.origin }}</div>
                                            <div class="time-display">{{ trip.depTime }}</div>
                                        </div>
                                        <div class="flex-1 px-4 flex flex-col items-center">
                                            <div class="h-[1px] w-full bg-stone-300 mb-1 relative">
                                                <div class="absolute -right-1 -top-1 w-2 h-2 border-t border-r border-stone-300 transform rotate-45"></div>
                                            </div>
                                            <div class="text-xs text-stone-400 font-mono">PNR: {{ trip.pnr }}</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="station-name">{{ trip.destination }}</div>
                                            <div class="time-display">{{ trip.arrTime }}</div>
                                        </div>
                                    </div>

                                    <div class="mb-4 bg-stone-50 rounded p-2 text-sm flex gap-4 justify-center border border-stone-100">
                                        <div v-if="getTicketCount(trip.tickets, 'å…¨ç¥¨') !== '-'" class="flex gap-1">
                                            <span class="text-stone-500">å…¨ç¥¨:</span>
                                            <span class="font-bold">{{ getTicketCount(trip.tickets, 'å…¨ç¥¨') }}</span>
                                        </div>
                                        <div v-if="getTicketCount(trip.tickets, 'å­©ç«¥') !== '-'" class="flex gap-1">
                                            <span class="text-stone-500">å­©ç«¥:</span>
                                            <span class="font-bold">{{ getTicketCount(trip.tickets, 'å­©ç«¥') }}</span>
                                        </div>
                                        <div v-if="getTicketCount(trip.tickets, 'æ•¬è€') !== '-'" class="flex gap-1">
                                            <span class="text-stone-500">æ•¬è€:</span>
                                            <span class="font-bold">{{ getTicketCount(trip.tickets, 'æ•¬è€') }}</span>
                                        </div>
                                        <div v-if="getTicketCount(trip.tickets, 'æ„›å¿ƒ') !== '-'" class="flex gap-1">
                                            <span class="text-stone-500">æ„›å¿ƒ:</span>
                                            <span class="font-bold">{{ getTicketCount(trip.tickets, 'æ„›å¿ƒ') }}</span>
                                        </div>
                                    </div>

                                    <table class="passenger-table">
                                        <thead>
                                            <tr>
                                                <th width="20%">å§“å</th>
                                                <th width="25%">èº«åˆ†è­‰å­—è™Ÿ</th>
                                                <th width="25%">å‡ºç”Ÿå¹´æœˆæ—¥</th>
                                                <th width="30%">è­·ç…§è™Ÿç¢¼</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="(p, pIdx) in trip.passengers" :key="pIdx">
                                                <td class="font-medium">{{ p.name }}</td>
                                                <td class="font-mono text-stone-500">{{ maskID(p.id) }}</td>
                                                <td class="font-mono text-stone-500">{{ formatDate(p.birthDate) }}</td>
                                                <td class="font-mono text-stone-500">{{ p.passport || '-' }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- 4. ç¸½é‡‘é¡ -->
                            <div class="mt-4 flex justify-end items-end gap-3 mb-8">
                                <span class="text-stone-500 text-sm pb-1">ç¸½é‡‘é¡ Total Amount</span>
                                <span class="text-3xl font-bold text-stone-800 border-b-4 border-teal-500/30 px-2">TWD ${{ formatPrice(totalPrice) }}</span>
                            </div>

                            <!-- 5. é å°¾å‚™è¨» -->
                            <div class="border-t-2 border-stone-100 pt-6 space-y-6">
                                <div class="bg-red-50 border-l-4 border-red-400 rounded-r p-4">
                                    <p class="text-red-700 font-bold text-sm leading-relaxed text-center">
                                        è«‹æ¥­å‹™å€‘å‹™å¿…å†æ¬¡æ ¸å° ç¥¨ç¨®/å¼µæ•¸/é‡‘é¡ æ˜¯å¦æ­£ç¢ºï¼Œå¦‚æœ‰éŒ¯èª¤ è«‹æ–¼ã€Œå‡ºç¥¨å‰ã€å‘ŠçŸ¥ï¼Œ<br>
                                        å‡ºç¥¨å¾Œå‘ŠçŸ¥è«‹è‡ªè¡Œè² è²¬ï¼Œé«˜éµè¨‚ç¥¨æœå‹™çª—å£æ„Ÿè¬æ‚¨çš„é…åˆã€‚
                                    </p>
                                </div>

                                <div class="text-center space-y-2">
                                    <div class="font-bold text-lg text-stone-800">
                                        ã€ è«‹å‹™å¿…æ–¼D/Lå‰å‘ŠçŸ¥å¯é–‹ç¥¨ èˆ‡ å–ç¥¨æ–¹å¼  ç´™æœ¬ / é›»å­ç¥¨(æ­é…APPä½¿ç”¨) ã€‘
                                    </div>
                                    <p class="text-sm text-stone-600">
                                        æ›å¸³å…¨ç¥¨æœƒå…ˆæ›85æŠ˜çš„åƒ¹æ ¼ï¼Œå„ªå¾…ç¥¨(å­©ç«¥ã€æ•¬è€ã€æ„›å¿ƒ)éƒ½æ˜¯åŠåƒ¹<br>
                                        å¦‚æœå”®åƒ¹æœ‰èª¿æ•´éœ€è¦æ›´æ”¹å†è«‹é€šçŸ¥å”· è¬è¬
                                    </p>
                                </div>

                                <div class="text-xs text-stone-500 leading-relaxed bg-white p-4 rounded border border-stone-200">
                                    <h5 class="font-bold text-stone-700 mb-2 border-b border-stone-100 pb-1 inline-block">æ³¨æ„äº‹é …èˆ‡é€€ç¥¨èªªæ˜</h5>
                                    <ol class="list-decimal list-inside space-y-1 pl-1">
                                        <li>åº§ä½çš†ç”±é›»è…¦è‡ªå‹•åŠƒä½ï¼Œæ•ç„¡æ³•æŒ‡å®šåº§ä½ï¼Œäº¦ç„¡æ³•ä¿è­‰åŒè¡Œè€…å¯å®‰æ’ç›¸é„°åº§ä½ã€‚</li>
                                        <li>è‹¥å› é€¾æ™‚æœªèƒ½æ­ä¹˜ï¼Œè«‹è‡ªè¡Œæ´½è©¢ç«™å‹™äººå“¡æ˜¯å¦å¯æ”¹æ­ç•¶æ—¥å…¶ä»–è»Šæ¬¡ä¹‹è‡ªç”±åº§ï¼Œæ•ç„¡æ³•è¾¦ç†é€€ç¥¨ã€‚</li>
                                        <li>é«˜éµè»Šç¥¨é ˆæ–¼æ­ä¹˜ç•¶æ—¥ä½¿ç”¨ï¼Œé€¾æœŸè¦–åŒå»¢ç¥¨ï¼Œæ•ä¸å—ç†é€€ç¥¨ã€‚</li>
                                        <li>å¦‚éœ€è¾¦ç†é€€ç¥¨ï¼Œè«‹æ–¼ 4å€‹å·¥ä½œæ—¥å‰ ç”³è«‹ï¼Œä¸¦æä¾›ç´™æœ¬ç¥¨æ ¹æˆ– APP é›»å­ç¥¨æˆªåœ–ï¼ˆå¤©ç½å°è‡´é«˜éµåœé§›è€…ä¸åœ¨æ­¤é™ï¼‰ã€‚</li>
                                        <li>é€€ç¥¨å°‡é…Œæ”¶æ‰‹çºŒè²» æ¯å¼µæ–°å°å¹£ 50 å…ƒã€‚</li>
                                        <li>è¾¦ç†é€€ç¥¨æ™‚ï¼Œè«‹å‹™å¿…æä¾› ç´™æœ¬ç¥¨æ ¹æˆ–é›»å­ç¥¨ï¼ˆAPP æˆªåœ–ï¼‰ï¼Œæœªæä¾›è€…å°‡è¦–åŒæ­£å¸¸æ­ä¹˜ï¼Œç›¸é—œè²»ç”¨é ˆè‡ªè¡Œè² æ“”ã€‚</li>
                                        <li>å› èˆªç­å»¶èª¤æˆ–å–æ¶ˆç­‰éé«˜éµå› ç´ è‡´ç„¡æ³•æ­ä¹˜è€…ï¼Œè»Šç¥¨ æ•ç„¡æ³•æ”¹æœŸæˆ–é€€ç¥¨ï¼Œæ•¬è«‹è¦‹è«’ã€‚</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="fixed bottom-8 left-0 right-0 flex justify-center pointer-events-none">
                        <button @click="generateImage" class="pointer-events-auto bg-stone-800 hover:bg-stone-900 text-white px-8 py-3 rounded-full shadow-xl flex items-center gap-2 transform transition-all hover:-translate-y-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            ä¸‹è¼‰åœ–ç‰‡ (JPG)
                        </button>
                    </div>
                </div>
            </div>
        </transition>
    </div>

    <script>
        new Vue({
            el: '#app',
            data: {
                showModal: false,
                isRecognizing: false,
                stations: ['å—æ¸¯', 'å°åŒ—', 'æ¿æ©‹', 'æ¡ƒåœ’', 'æ–°ç«¹', 'è‹—æ —', 'å°ä¸­', 'å½°åŒ–', 'é›²æ—', 'å˜‰ç¾©', 'å°å—', 'å·¦ç‡Ÿ'],
                standardFares: {
                    'å—æ¸¯': { 'å°åŒ—': 40, 'æ¿æ©‹': 70, 'æ¡ƒåœ’': 200, 'æ–°ç«¹': 330, 'è‹—æ —': 480, 'å°ä¸­': 750, 'å½°åŒ–': 870, 'é›²æ—': 930, 'å˜‰ç¾©': 1120, 'å°å—': 1390, 'å·¦ç‡Ÿ': 1530 },
                    'å°åŒ—': { 'æ¿æ©‹': 40, 'æ¡ƒåœ’': 160, 'æ–°ç«¹': 290, 'è‹—æ —': 430, 'å°ä¸­': 700, 'å½°åŒ–': 820, 'é›²æ—': 930, 'å˜‰ç¾©': 1080, 'å°å—': 1350, 'å·¦ç‡Ÿ': 1490 },
                    'æ¿æ©‹': { 'æ¡ƒåœ’': 130, 'æ–°ç«¹': 260, 'è‹—æ —': 400, 'å°ä¸­': 670, 'å½°åŒ–': 790, 'é›²æ—': 900, 'å˜‰ç¾©': 1050, 'å°å—': 1320, 'å·¦ç‡Ÿ': 1460 },
                    'æ¡ƒåœ’': { 'æ–°ç«¹': 130, 'è‹—æ —': 280, 'å°ä¸­': 540, 'å½°åŒ–': 670, 'é›²æ—': 780, 'å˜‰ç¾©': 920, 'å°å—': 1190, 'å·¦ç‡Ÿ': 1330 },
                    'æ–°ç«¹': { 'è‹—æ —': 270, 'å°ä¸­': 390, 'å½°åŒ–': 500, 'é›²æ—': 640, 'å˜‰ç¾©': 920, 'å°å—': 1060, 'å·¦ç‡Ÿ': 1200 },
                    'è‹—æ —': { 'å°ä¸­': 270, 'å½°åŒ–': 390, 'é›²æ—': 500, 'å˜‰ç¾©': 640, 'å°å—': 920, 'å·¦ç‡Ÿ': 1060 },
                    'å°ä¸­': { 'å½°åŒ–': 130, 'é›²æ—': 230, 'å˜‰ç¾©': 380, 'å°å—': 650, 'å·¦ç‡Ÿ': 790 },
                    'å½°åŒ–': { 'é›²æ—': 110, 'å˜‰ç¾©': 250, 'å°å—': 530, 'å·¦ç‡Ÿ': 680 },
                    'é›²æ—': { 'å˜‰ç¾©': 150, 'å°å—': 420, 'å·¦ç‡Ÿ': 560 },
                    'å˜‰ç¾©': { 'å°å—': 280, 'å·¦ç‡Ÿ': 410 },
                    'å°å—': { 'å·¦ç‡Ÿ': 140 }
                },
                businessFares: {
                    'å—æ¸¯': { 'å°åŒ—': 260, 'æ¿æ©‹': 310, 'æ¡ƒåœ’': 500, 'æ–°ç«¹': 700, 'è‹—æ —': 920, 'å°ä¸­': 1330, 'å½°åŒ–': 1510, 'é›²æ—': 1660, 'å˜‰ç¾©': 1880, 'å°å—': 2290, 'å·¦ç‡Ÿ': 2500 },
                    'å°åŒ—': { 'æ¿æ©‹': 260, 'æ¡ƒåœ’': 440, 'æ–°ç«¹': 640, 'è‹—æ —': 850, 'å°ä¸­': 1250, 'å½°åŒ–': 1430, 'é›²æ—': 1600, 'å˜‰ç¾©': 1820, 'å°å—': 2230, 'å·¦ç‡Ÿ': 2440 },
                    'æ¿æ©‹': { 'æ¡ƒåœ’': 400, 'æ–°ç«¹': 590, 'è‹—æ —': 800, 'å°ä¸­': 1210, 'å½°åŒ–': 1390, 'é›²æ—': 1550, 'å˜‰ç¾©': 1780, 'å°å—': 2180, 'å·¦ç‡Ÿ': 2390 },
                    'æ¡ƒåœ’': { 'æ–°ç«¹': 400, 'è‹—æ —': 620, 'å°ä¸­': 1010, 'å½°åŒ–': 1210, 'é›²æ—': 1370, 'å˜‰ç¾©': 1580, 'å°å—': 1990, 'å·¦ç‡Ÿ': 2200 },
                    'æ–°ç«¹': { 'è‹—æ —': 410, 'å°ä¸­': 820, 'å½°åŒ–': 1010, 'é›²æ—': 1160, 'å˜‰ç¾©': 1390, 'å°å—': 1790, 'å·¦ç‡Ÿ': 2000 },
                    'è‹—æ —': { 'å°ä¸­': 610, 'å½°åŒ–': 790, 'é›²æ—': 950, 'å˜‰ç¾©': 1160, 'å°å—': 1580, 'å·¦ç‡Ÿ': 1790 },
                    'å°ä¸­': { 'å½°åŒ–': 400, 'é›²æ—': 550, 'å˜‰ç¾©': 770, 'å°å—': 1180, 'å·¦ç‡Ÿ': 1390 },
                    'å½°åŒ–': { 'é›²æ—': 370, 'å˜‰ç¾©': 580, 'å°å—': 1000, 'å·¦ç‡Ÿ': 1210 },
                    'é›²æ—': { 'å˜‰ç¾©': 430, 'å°å—': 830, 'å·¦ç‡Ÿ': 1040 },
                    'å˜‰ç¾©': { 'å°å—': 620, 'å·¦ç‡Ÿ': 820 },
                    'å°å—': { 'å·¦ç‡Ÿ': 410 }
                },
                orderId: '',
                groupNumber: '', 
                cowayOrderId: '', 
                booker: 'å“èŠ·ä¼¶', 
                bookingDate: '', 
                deadlineDate: '', 
                passengers: [], 
                trips: [],
                currentTripInput: {
                    direction: 'å»ç¨‹',
                    date: '',
                    trainNumber: '',
                    carType: 'æ¨™æº–è»Šå»‚',
                    origin: 'å—æ¸¯',
                    destination: 'å·¦ç‡Ÿ',
                    depTime: '09:00',
                    arrTime: '10:45',
                    pnr: '', 
                    tickets: [
                        { type: 'å…¨ç¥¨', count: 1, price: 0 } 
                    ]
                }
            },
            computed: {
                totalPrice() {
                    let total = 0;
                    this.trips.forEach(trip => {
                        trip.tickets.forEach(t => {
                            total += (t.count * t.price);
                        });
                    });
                    return total;
                },
                today() {
                    return new Date().toLocaleDateString('zh-TW');
                }
            },
            methods: {
                // OCR åœ–ç‰‡è™•ç†
                handleFileUpload(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    this.recognizeImage(file);
                },
                handlePaste(e) {
                    const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                    for (let item of items) {
                        if (item.kind === 'file' && item.type.startsWith('image/')) {
                            const blob = item.getAsFile();
                            this.recognizeImage(blob);
                            e.preventDefault(); // é˜²æ­¢é‡è¤‡è²¼ä¸Š
                            break;
                        }
                    }
                },
                recognizeImage(imageBlob) {
                    this.isRecognizing = true;
                    Tesseract.recognize(
                        imageBlob,
                        'eng+chi_tra', 
                        { logger: m => console.log(m) }
                    ).then(({ data: { text } }) => {
                        console.log('Recognized Text:', text);
                        this.parseOCRText(text);
                        this.isRecognizing = false;
                        alert('è¾¨è­˜å®Œæˆï¼è«‹æª¢æŸ¥ä¸¦ä¿®æ­£æ¬„ä½è³‡æ–™ã€‚');
                    }).catch(err => {
                        console.error(err);
                        this.isRecognizing = false;
                        alert('è¾¨è­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–æ‰‹å‹•è¼¸å…¥ã€‚');
                    });
                },
                parseOCRText(text) {
                    // 1. å˜—è©¦æŠ“å– PNR (8ç¢¼è‹±æ•¸)
                    const pnrMatch = text.match(/\b[A-Z0-9]{8}\b/);
                    if (pnrMatch) {
                        this.currentTripInput.pnr = pnrMatch[0];
                    }

                    // 2. å˜—è©¦æŠ“å– è»Šæ¬¡ (3-4ç¢¼æ•¸å­—ï¼Œå¸¸åœ¨ "è»Šæ¬¡" é™„è¿‘)
                    // é€™è£¡ç°¡åŒ–æŠ“å– 3-4 ç¢¼æ•¸å­—ï¼Œæ’é™¤å¯èƒ½æ˜¯æ™‚é–“çš„éƒ¨åˆ†
                    const trainMatches = text.match(/\b[0-9]{3,4}\b/g);
                    if (trainMatches) {
                        // éæ¿¾æ‰æ˜é¡¯åƒå¹´ä»½æˆ–æ™‚é–“çš„
                        const likelyTrain = trainMatches.find(n => {
                            const num = parseInt(n);
                            return num < 2000 && num > 100; 
                        });
                        if (likelyTrain) this.currentTripInput.trainNumber = likelyTrain;
                    }

                    // 3. å˜—è©¦æŠ“å– æ™‚é–“ (HH:mm)
                    const timeMatches = text.match(/([01]?[0-9]|2[0-3]):([0-5][0-9])/g);
                    if (timeMatches && timeMatches.length >= 2) {
                        // å‡è¨­å…ˆå‡ºç¾çš„æ˜¯å‡ºç™¼ï¼Œå¾Œå‡ºç¾çš„æ˜¯æŠµé”
                        this.currentTripInput.depTime = timeMatches[0];
                        this.currentTripInput.arrTime = timeMatches[1];
                    }

                    // 4. å˜—è©¦æŠ“å– æ—¥æœŸ (YYYY/MM/DD æˆ– MM/DD)
                    // Tesseract å°æ–œç·šæœ‰æ™‚æœƒèª¤åˆ¤ï¼Œéœ€å¯¬å®¹è™•ç†
                    const dateMatch = text.match(/(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})/);
                    if (dateMatch) {
                        const y = dateMatch[1];
                        const m = dateMatch[2].padStart(2, '0');
                        const d = dateMatch[3].padStart(2, '0');
                        this.currentTripInput.date = `${y}-${m}-${d}`;
                    }
                },

                updatePassengerCount() {
                    const count = this.currentTripInput.tickets.reduce((sum, t) => sum + (t.count || 0), 0);
                    if (count > 10) {
                        alert("æ¯ç­†è¡Œç¨‹æœ€å¤šåªèƒ½æœ‰ 10 ä½æ—…å®¢ï¼");
                        return;
                    }
                    const currentLen = this.passengers.length;
                    if (count > currentLen) {
                        for (let i = 0; i < count - currentLen; i++) {
                            this.passengers.push({ name: '', id: '', passport: '', birthDate: '' });
                        }
                    } else if (count < currentLen) {
                        this.passengers.splice(count);
                    }
                },
                addTicketInput() {
                    let currentCount = this.currentTripInput.tickets.reduce((sum, t) => sum + (t.count || 0), 0);
                    if (currentCount >= 10) {
                        alert("å·²é”åˆ° 10 ä½æ—…å®¢ä¸Šé™ï¼");
                        return;
                    }
                    this.currentTripInput.tickets.push({ type: 'å…¨ç¥¨', count: 1, price: 0 });
                    this.updateInputPrices(); 
                    this.updatePassengerCount();
                },
                removeTicketInput(index) {
                    this.currentTripInput.tickets.splice(index, 1);
                    this.updateInputPrices();
                    this.updatePassengerCount();
                },
                updateInputPrices() {
                    const { carType, origin, destination, tickets } = this.currentTripInput;
                    if (origin && destination) {
                        tickets.forEach(ticket => {
                            ticket.price = this.calculateSinglePrice(carType, ticket.type, origin, destination);
                        });
                    }
                    this.updatePassengerCount(); 
                },
                addTripToList() {
                    let totalPassengers = this.passengers.length;
                    if (totalPassengers > 10) {
                        alert("æ¯ç­†è¡Œç¨‹æœ€å¤šåªèƒ½æœ‰ 10 ä½æ—…å®¢ï¼è«‹æ¸›å°‘ç¥¨æ•¸ã€‚");
                        return;
                    }
                    for(let i=0; i<this.passengers.length; i++) {
                        if(!this.passengers[i].name || !this.passengers[i].id) {
                            alert(`è«‹å¡«å¯«ç¬¬ ${i+1} ä½æ—…å®¢çš„å§“åèˆ‡èº«åˆ†è­‰å­—è™Ÿ`);
                            return;
                        }
                    }
                    const tripToAdd = JSON.parse(JSON.stringify(this.currentTripInput));
                    tripToAdd.passengers = JSON.parse(JSON.stringify(this.passengers));
                    this.trips.push(tripToAdd);
                    
                    if (this.currentTripInput.direction === 'å»ç¨‹') {
                         this.currentTripInput.direction = 'å›ç¨‹';
                         let temp = this.currentTripInput.origin;
                         this.currentTripInput.origin = this.currentTripInput.destination;
                         this.currentTripInput.destination = temp;
                         this.currentTripInput.depTime = '18:00';
                         this.currentTripInput.arrTime = '19:45';
                         this.currentTripInput.pnr = ''; 
                    } else {
                        this.currentTripInput.trainNumber = '';
                        this.currentTripInput.pnr = ''; 
                    }
                    this.updateInputPrices();
                    
                    this.$nextTick(() => {
                        const previewSection = document.querySelector('.preview-section');
                        if(previewSection) previewSection.scrollTop = previewSection.scrollHeight;
                    });
                },
                
                generateTicket() {
                    if (this.trips.length === 0) {
                        alert("è«‹å…ˆåŠ å…¥è‡³å°‘ä¸€ç­†è¡Œç¨‹ï¼");
                        return;
                    }
                    this.showModal = true;
                },

                generateImage() {
                    const element = this.$refs.captureArea;
                    if (!element) return;
                    const modalContent = document.querySelector('.modal-content');
                    if (modalContent) modalContent.scrollTo(0,0);
                    
                    html2canvas(element, { scale: 2, useCORS: true, backgroundColor: '#ffffff' }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = `é«˜éµè¨‚ä½ç¢ºèªå–®_${this.orderId || 'untiltled'}.jpg`;
                        link.href = canvas.toDataURL('image/jpeg', 0.9);
                        link.click();
                    }).catch(err => { console.error(err); alert('ç”Ÿæˆå¤±æ•—'); });
                },
                getBaseFare(faresObj, start, end) {
                    if (start === end) return 0;
                    if (faresObj[start] && faresObj[start][end]) return faresObj[start][end];
                    if (faresObj[end] && faresObj[end][start]) return faresObj[end][start];
                    return 0; 
                },
                calculateSinglePrice(carType, ticketType, origin, destination) {
                    let baseFare = 0;
                    let finalPrice = 0;
                    if (carType === 'å•†å‹™è»Šå»‚') {
                        baseFare = this.getBaseFare(this.businessFares, origin, destination);
                        finalPrice = (ticketType === 'å…¨ç¥¨') ? baseFare * 0.9 : baseFare * 0.5;
                    } else {
                        baseFare = this.getBaseFare(this.standardFares, origin, destination);
                        finalPrice = (ticketType === 'å…¨ç¥¨') ? baseFare * 0.85 : baseFare * 0.5;
                    }
                    return Math.round(finalPrice);
                },
                removeTripFromList(index) {
                    if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹å—ï¼Ÿ')) this.trips.splice(index, 1);
                },
                getTripSubtotal(trip) {
                    return trip.tickets.reduce((sum, t) => sum + (t.count * t.price), 0);
                },
                getTotalCount(tickets) {
                    return tickets.reduce((sum, t) => sum + t.count, 0);
                },
                getTicketCount(tickets, type) {
                    return tickets.filter(t => t.type === type).reduce((sum, t) => sum + t.count, 0) || '-';
                },
                formatPrice(value) {
                    if (!value) return '0';
                    return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                },
                formatDate(dateStr) {
                    if (!dateStr) return '-';
                    const date = new Date(dateStr);
                    return `${date.getFullYear()}/${(date.getMonth()+1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
                },
                formatDateShort(dateStr) {
                    if (!dateStr) return '-';
                    const date = new Date(dateStr);
                    return `${(date.getMonth()+1)}/${date.getDate()}`;
                },
                maskID(id) {
                    if (!id || id.length < 4) return id;
                    return id.substring(0, 3) + '*****' + id.substring(id.length - 2);
                },
                resetForm() {
                    if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) {
                        this.orderId = ''; this.groupNumber = ''; this.cowayOrderId = '';
                        this.trips = []; this.showModal = false;
                        this.passengers = []; 
                        
                        const todayDate = new Date();
                        const todayStr = todayDate.toISOString().split('T')[0];
                        
                        const dlDate = new Date(todayDate);
                        dlDate.setDate(todayDate.getDate() + 2);
                        
                        if (dlDate.getDay() === 6) { 
                            dlDate.setDate(dlDate.getDate() - 1);
                        } else if (dlDate.getDay() === 0) { 
                            dlDate.setDate(dlDate.getDate() - 2);
                        }
                        
                        this.deadlineDate = dlDate.toISOString().split('T')[0];

                        this.currentTripInput = {
                            direction: 'å»ç¨‹',
                            date: todayStr,
                            trainNumber: '',
                            carType: 'æ¨™æº–è»Šå»‚',
                            origin: 'å—æ¸¯',
                            destination: 'å·¦ç‡Ÿ',
                            depTime: '09:00',
                            arrTime: '10:45',
                            pnr: '',
                            tickets: [{ type: 'å…¨ç¥¨', count: 1, price: 0 }]
                        };
                        this.updateInputPrices();
                    }
                }
            },
            mounted() {
                const todayDate = new Date();
                const todayStr = todayDate.toISOString().split('T')[0];
                
                const dlDate = new Date(todayDate);
                dlDate.setDate(todayDate.getDate() + 2);
                
                if (dlDate.getDay() === 6) { 
                    dlDate.setDate(dlDate.getDate() - 1);
                } else if (dlDate.getDay() === 0) { 
                    dlDate.setDate(dlDate.getDate() - 2);
                }
                
                const dlDateStr = dlDate.toISOString().split('T')[0];

                this.currentTripInput.date = todayStr;
                this.bookingDate = todayStr; 
                this.deadlineDate = dlDateStr; 
                this.orderId = '202' + Math.floor(10000000 + Math.random() * 90000000).toString();
                this.currentTripInput.pnr = Math.floor(10000000 + Math.random() * 90000000).toString();
                
                this.updateInputPrices();
            }
        });
    </script>
</body>
</html>
