<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高鐵訂位確認單生成器 - 專業完整復原版</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Google Fonts: Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f4f4f2; 
            color: #4a4a46;
            letter-spacing: 0.01em;
        }
        .japanese-card {
            background: #ffffff;
            border: 1px solid #a0aec0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(74, 74, 70, 0.05);
        }
        .form-label {
            font-size: 0.75rem;
            color: #8c8c88;
            margin-bottom: 0.25rem;
            font-weight: 600;
        }
        input, select {
            background-color: #ffffff;
            border: 1px solid #a0aec0;
            border-radius: 4px;
            padding: 0.6rem;
            font-size: 0.875rem;
            outline: none;
            width: 100%;
            color: #4a4a46;
            height: 42px;
        }
        input:focus, select:focus {
            border-color: #4a4a46;
            box-shadow: 0 0 0 2px rgba(74, 74, 70, 0.1);
        }
        .btn-primary {
            background-color: #4a4a46;
            color: #f4f4f2;
            font-weight: 600;
            border-radius: 4px;
            transition: opacity 0.2s;
        }
        .btn-primary:hover:not(:disabled) {
            opacity: 0.9;
        }
        .btn-outline {
            border: 1px solid #4a4a46;
            color: #4a4a46;
            background-color: transparent;
            font-weight: 600;
            border-radius: 4px;
        }
        .btn-icon {
            color: #a0aec0;
            transition: color 0.2s;
        }
        .btn-icon:hover {
            color: #4a4a46;
        }
        .btn-danger:hover {
            color: #ef4444;
        }
        .time-input {
            letter-spacing: 0.05em;
            text-align: center;
        }
        .tab-active {
            border-bottom: 3px solid #4a4a46;
            color: #4a4a46;
            font-weight: bold;
        }
        .tab-inactive {
            color: #a0aec0;
        }
        [v-cloak] { display: none; }
        
        #capture-area-container {
            position: absolute;
            left: -9999px;
            top: 0;
            z-index: -1;
        }

        .img-header-line {
            height: 6px;
            background-color: #4a4a46;
        }
        .img-section-title {
            background: #f4f4f2;
            padding: 2px 10px;
            border-radius: 2px;
            font-size: 10px;
            font-weight: bold;
            color: #4a4a46;
            text-transform: uppercase;
        }

        /* 圖檔專用表格樣式 - 行高 1.5 */
        .img-table-container {
            border: 2px solid #4a4a46;
            margin-bottom: 12px;
            overflow: hidden;
            border-radius: 2px;
        }
        .img-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
            text-align: center;
            line-height: 1.5;
        }
        .img-table th {
            padding: 8px 4px;
            border-bottom: 1.5px solid #4a4a46;
            color: #f4f4f2;
            background-color: #4a4a46;
            font-weight: bold;
            border-right: 1px solid #6b6b6b;
            vertical-align: middle !important;
        }
        .img-table td {
            padding: 10px 4px;
            border-bottom: 1px solid #d1d5db;
            color: #4a4a46;
            font-weight: 900;
            border-right: 1px solid #d1d5db;
            vertical-align: middle !important;
        }
        .img-row-summary {
            padding: 8px 12px;
            font-size: 10px;
            font-weight: 500;
            color: #4a4a46;
            border-bottom: 1px solid #d1d5db;
            line-height: 1.5;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #ffffff;
        }
        .img-row-breakdown {
            padding: 8px 12px;
            font-size: 10px;
            color: #6b7280;
            border-bottom: 1px dashed #d1d5db;
            background-color: #ffffff;
            text-align: left;
            line-height: 1.5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* 旅客表格樣式 - 水平置中 */
        .pax-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
            text-align: center; 
            line-height: 1.5;
        }
        .pax-table th {
            padding: 8px 8px;
            border-bottom: 1px solid #4a4a46;
            color: #4a4a46;
            background-color: #e2e8f0;
            font-weight: bold;
            border-right: 1px solid #cbd5e1;
        }
        .pax-table td {
            padding: 8px 8px;
            border-bottom: 1px solid #f0f0f0;
            color: #4a4a46;
            font-weight: bold;
            border-right: 1px solid #f0f0f0;
        }
        .pax-table tr td:last-child, .pax-table tr th:last-child { border-right: none; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app" v-cloak class="max-w-6xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-[#4a4a46] tracking-tight">高鐵訂位確認單生成系統</h1>
            <p class="text-[#8c8c88] mt-2 tracking-widest uppercase">Professional Slip Management</p>
        </header>

        <div v-if="toastMsg" class="fixed top-6 left-1/2 -translate-x-1/2 z-[100] bg-[#4a4a46] text-[#f4f4f2] px-6 py-3 rounded shadow-2xl text-sm flex items-center gap-3">
            <span class="font-medium">{{ toastMsg }}</span>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            
            <!-- 左側：輸入表單 -->
            <div class="lg:col-span-8 space-y-6">
                <!-- 基本資料 -->
                <div class="japanese-card p-6 md:p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-bold border-l-4 border-[#4a4a46] pl-3">基本資料管理</h2>
                        <div class="flex gap-4">
                            <button @click="focusInput('staff')" class="btn-icon" title="編輯人員"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></button>
                            <button @click="clearBasicInfo" class="btn-icon btn-danger" title="清除基本資料"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                        <div class="flex flex-col"><label class="form-label">訂票人員</label><input ref="staffInput" type="text" v-model="baseInfo.staff"></div>
                        <div class="flex flex-col"><label class="form-label">訂票日期</label><input type="date" v-model="baseInfo.bookingDate"></div>
                        <div class="flex flex-col text-red-600">
                            <label class="form-label text-red-600 font-bold">開票期限 (DL)</label>
                            <div class="flex gap-2">
                                <input type="date" v-model="baseInfo.deadlineDate" class="flex-[2] border-red-200">
                                <input type="text" v-model="baseInfo.deadlineTime" class="flex-1 time-input border-red-200" maxlength="5">
                            </div>
                        </div>
                        <div class="flex flex-col"><label class="form-label">業務姓名</label><input type="text" v-model="baseInfo.sales"></div>
                        <div class="flex flex-col"><label class="form-label">訂單編號</label><input type="text" v-model="baseInfo.orderId"></div>
                        <div class="flex flex-col"><label class="form-label">團體代號</label><input type="text" v-model="baseInfo.groupId"></div>
                    </div>
                </div>

                <!-- 行程詳細設定 -->
                <div class="japanese-card p-6 md:p-8 relative">
                    <div v-if="editingIndex !== null" class="absolute top-4 right-24 bg-[#4a4a46] text-[#f4f4f2] px-3 py-1 text-xs font-bold rounded">編輯模式中</div>
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-lg font-bold border-l-4 border-[#4a4a46] pl-3">行程詳細設定</h2>
                        <div class="flex items-center gap-4">
                            <button @click="focusInput('hsrId')" class="btn-icon" title="開始輸入行程"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></button>
                            <button @click="clearTripForm" class="btn-icon btn-danger" title="重置輸入表單"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg></button>
                            <div class="flex bg-[#f4f4f2] p-1 rounded ml-2">
                                <button @click="tripMode = 'one-way'" :class="tripMode === 'one-way' ? 'bg-[#4a4a46] text-[#f4f4f2]' : 'text-[#8c8c88]'" class="px-4 py-1 text-sm font-bold transition-all rounded">單程</button>
                                <button @click="tripMode = 'round-trip'" :class="tripMode === 'round-trip' ? 'bg-[#4a4a46] text-[#f4f4f2]' : 'text-[#8c8c88]'" class="px-4 py-1 text-sm font-bold transition-all rounded">來回</button>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-10">
                        <!-- 去程 -->
                        <div>
                            <span class="text-[10px] bg-[#4a4a46] text-white px-2 py-0.5 rounded font-bold uppercase mb-4 inline-block tracking-widest">去程設定</span>
                            <div class="grid grid-cols-1 md:grid-cols-12 gap-5">
                                <div class="md:col-span-6"><label class="form-label">高鐵訂位編號 (ID)</label><input ref="hsrIdInput" type="text" v-model="outbound.hsrOrderId" @input="handleHsrIdInput" class="font-bold tracking-widest" placeholder="請輸入 8 碼訂位編號"></div>
                                <div class="md:col-span-6"><label class="form-label">PNR 代碼</label><input type="text" v-model="outbound.pnr" class="uppercase font-bold tracking-widest"></div>
                                <div class="md:col-span-4"><label class="form-label">乘車日期</label><input type="date" v-model="outbound.date"></div>
                                <div class="md:col-span-4"><label class="form-label">艙等</label><select v-model="outbound.carClass"><option value="標準車廂">標準車廂</option><option value="商務車廂">商務車廂</option></select></div>
                                <div class="md:col-span-4"><label class="form-label">車次</label><input type="text" v-model="outbound.trainNo"></div>
                                <div class="md:col-span-6">
                                    <label class="form-label">起訖站點</label>
                                    <div class="flex items-center gap-2">
                                        <select v-model="outbound.from" class="flex-1"><option v-for="s in stations" :value="s">{{s}}</option></select>
                                        <button @click="swapStations(outbound)" class="text-[#a0aec0] hover:text-[#4a4a46] transition-colors px-2" title="交換站點">⇆</button>
                                        <select v-model="outbound.to" class="flex-1"><option v-for="s in stations" :value="s">{{s}}</option></select>
                                    </div>
                                </div>
                                <div class="md:col-span-6"><label class="form-label">時間 (24H)</label><div class="flex gap-1"><input type="text" v-model="outbound.depTime" class="time-input text-xs" placeholder="09:00"><input type="text" v-model="outbound.arrTime" class="time-input text-xs" placeholder="10:30"></div></div>
                            </div>
                        </div>

                        <!-- 回程 -->
                        <div v-if="tripMode === 'round-trip'" class="pt-8 border-t border-[#a0aec0]/30">
                            <span class="text-[10px] bg-gray-400 text-white px-2 py-0.5 rounded font-bold uppercase mb-4 inline-block tracking-widest">Return / 回程設定</span>
                            <div class="grid grid-cols-1 md:grid-cols-12 gap-5">
                                <div class="md:col-span-6"><label class="form-label">高鐵訂位編號 (ID)</label><input type="text" v-model="returnTrip.hsrOrderId" class="font-bold tracking-widest"></div>
                                <div class="md:col-span-6"><label class="form-label">PNR 代碼</label><input type="text" v-model="returnTrip.pnr" class="uppercase font-bold tracking-widest"></div>
                                <div class="md:col-span-4"><label class="form-label">乘車日期</label><input type="date" v-model="returnTrip.date"></div>
                                <div class="md:col-span-4"><label class="form-label">艙等</label><select v-model="returnTrip.carClass"><option value="標準車廂">標準車廂</option><option value="商務車廂">商務車廂</option></select></div>
                                <div class="md:col-span-4"><label class="form-label">車次</label><input type="text" v-model="returnTrip.trainNo"></div>
                                <div class="md:col-span-6">
                                    <label class="form-label">起訖站點</label>
                                    <div class="flex items-center gap-2">
                                        <select v-model="returnTrip.from" class="flex-1"><option v-for="s in stations" :value="s">{{s}}</option></select>
                                        <button @click="swapStations(returnTrip)" class="text-[#a0aec0] hover:text-[#4a4a46] transition-colors px-2" title="交換站點">⇆</button>
                                        <select v-model="returnTrip.to" class="flex-1"><option v-for="s in stations" :value="s">{{s}}</option></select>
                                    </div>
                                </div>
                                <div class="md:col-span-6"><label class="form-label">時間 (24H)</label><div class="flex gap-1"><input type="text" v-model="returnTrip.depTime" class="time-input text-xs" placeholder="18:00"><input type="text" v-model="returnTrip.arrTime" class="time-input text-xs" placeholder="19:30"></div></div>
                            </div>
                        </div>

                        <!-- 票數統計區域 -->
                        <div class="bg-[#f4f4f2] p-6 border border-[#a0aec0] rounded">
                            <div class="mb-4">
                                <p class="text-[11px] font-bold mb-2 text-[#4a4a46]">去程票種數量設定</p>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div><label class="form-label">全票</label><input type="number" v-model.number="ticketsOut.adult" min="0"></div>
                                    <div><label class="form-label">孩童</label><input type="number" v-model.number="ticketsOut.child" min="0"></div>
                                    <div><label class="form-label">敬老</label><input type="number" v-model.number="ticketsOut.senior" min="0"></div>
                                    <div><label class="form-label">愛心</label><input type="number" v-model.number="ticketsOut.disability" min="0"></div>
                                </div>
                            </div>
                            <div v-if="tripMode === 'round-trip'" class="pt-4 border-t border-gray-300">
                                <div class="flex justify-between items-center mb-2"><p class="text-[11px] font-bold text-[#4a4a46]">回程票種數量設定</p><button @click="copyOutboundTickets" class="text-[10px] underline">同去程票數</button></div>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div><label class="form-label">全票</label><input type="number" v-model.number="ticketsRet.adult" min="0"></div>
                                    <div><label class="form-label">孩童</label><input type="number" v-model.number="ticketsRet.child" min="0"></div>
                                    <div><label class="form-label">敬老</label><input type="number" v-model.number="ticketsRet.senior" min="0"></div>
                                    <div><label class="form-label">愛心</label><input type="number" v-model.number="ticketsRet.disability" min="0"></div>
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mt-8 pt-4 border-t border-gray-300/50">
                                <div class="text-sm font-medium text-[#8c8c88]">
                                    <span v-if="isOverLimit" class="text-red-600 font-bold block mb-1">⚠️ 單程人數限制 10 位</span>
                                    <span>去程：{{ countOut }} 位 / 回程：{{ tripMode === 'round-trip' ? countRet : '-' }} 位</span>
                                </div>
                                <div class="flex gap-2">
                                    <button @click="openPassengerModal" :disabled="countOut === 0" class="btn-outline px-6 py-2 text-sm">編輯旅客名單</button>
                                    <button v-if="editingIndex === null" @click="addTripToList" :disabled="isOverLimit || countOut === 0" class="btn-primary px-10 py-2 text-sm">新增紀錄</button>
                                    <button v-else @click="updateTripInList" :disabled="isOverLimit || countOut === 0" class="bg-blue-600 text-white px-10 py-2 text-sm rounded">儲存更新</button>
                                    <button v-if="editingIndex !== null" @click="cancelEdit" class="text-sm px-4">取消</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右側：摘要清單 -->
            <div class="lg:col-span-4 space-y-6">
                <div class="japanese-card p-6 sticky top-8 flex flex-col h-[85vh]">
                    <h2 class="text-lg font-bold mb-4 border-b border-gray-200 pb-2">已登錄行程摘要</h2>
                    <div class="flex-1 overflow-y-auto space-y-4 pr-1">
                        <div v-if="addedTrips.length === 0" class="h-full flex items-center justify-center text-gray-400 italic text-sm">尚未加入紀錄</div>
                        <div v-for="(trip, idx) in addedTrips" :key="idx" class="p-4 bg-gray-50 border border-gray-200 rounded relative">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-[10px] bg-black text-white px-2 font-mono font-bold">#{{ idx + 1 }}</span>
                                <div class="flex gap-3">
                                    <button @click="startEdit(idx)" class="text-blue-500 text-xs font-bold">編輯</button>
                                    <button @click="removeTrip(idx)" class="text-red-400 text-xs font-bold">刪除</button>
                                </div>
                            </div>
                            <p class="text-sm font-bold text-[#4a4a46]">HSR ID: {{ trip.outbound.hsrOrderId || 'N/A' }}</p>
                            <p class="text-sm font-bold text-gray-500">PNR: {{ trip.outbound.pnr }}</p>
                            <p class="text-[11px] text-gray-400 font-mono mt-1">{{ trip.outbound.date }} | NT$ {{ trip.totalAmount.toLocaleString() }}</p>
                        </div>
                    </div>
                    <div class="pt-4 border-t border-gray-300 mt-4">
                        <div class="flex justify-between items-end mb-4">
                            <span class="text-xs font-bold text-gray-400">Total Payable</span>
                            <span class="text-2xl font-black">NT$ {{ totalOrderAmount.toLocaleString() }}</span>
                        </div>
                        <button @click="downloadImage" :disabled="addedTrips.length === 0" class="w-full btn-primary py-3 mb-2 shadow-lg transition-transform active:scale-95">下載確認圖片檔</button>
                        <div class="grid grid-cols-2 gap-2">
                            <button @click="downloadSummaryText" :disabled="addedTrips.length === 0" class="btn-outline py-2 text-[10px]">下載文字檔</button>
                            <button @click="copySummaryTextToClipboard" :disabled="addedTrips.length === 0" class="btn-outline py-2 text-[10px]">複製文字版</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 旅客名單 Modal -->
        <transition name="fade">
            <div v-if="showPassengerModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
                <div class="bg-white w-full max-w-5xl max-h-[90vh] rounded shadow-2xl flex flex-col overflow-hidden">
                    <div class="px-8 py-4 border-b flex justify-between items-center bg-[#f4f4f2]">
                        <div class="flex gap-6">
                            <button @click="paxTab = 'out'" :class="paxTab === 'out' ? 'tab-active' : 'tab-inactive'" class="text-sm font-bold pb-1 uppercase tracking-widest">去程旅客名單</button>
                            <button v-if="tripMode === 'round-trip'" @click="paxTab = 'ret'" :class="paxTab === 'ret' ? 'tab-active' : 'tab-inactive'" class="text-sm font-bold pb-1 uppercase tracking-widest">回程旅客名單</button>
                        </div>
                        <button @click="showPassengerModal = false" class="text-gray-400 hover:text-black">✕</button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-8 space-y-4 bg-gray-50">
                        <div v-for="(p, i) in (paxTab === 'out' ? passengersOut : passengersRet)" :key="i" class="p-5 border rounded-lg bg-white grid grid-cols-1 md:grid-cols-5 gap-4 items-end relative shadow-sm">
                            <div class="absolute top-1 left-2 text-[9px] font-mono text-gray-300 uppercase">Passenger Segment #{{i+1}}</div>
                            <div><label class="form-label">票種</label><div class="bg-gray-100 p-2 text-xs rounded border font-bold text-gray-500">{{p.type}}</div></div>
                            <div><label class="form-label">旅客姓名</label><input type="text" v-model="p.name" @input="syncPassengerData(i, 'name')"></div>
                            <div><label class="form-label">身分證/居留證</label><input type="text" v-model="p.idNumber" @input="syncPassengerData(i, 'idNumber')" class="uppercase"></div>
                            <div><label class="form-label">護照號碼</label><input type="text" v-model="p.passportNo" @input="syncPassengerData(i, 'passportNo')" class="uppercase"></div>
                            <div><label class="form-label">出生日期</label><input type="date" v-model="p.birthday" @input="syncPassengerData(i, 'birthday')"></div>
                        </div>
                    </div>
                    <div class="px-8 py-4 border-t bg-white text-right"><button @click="showPassengerModal = false" class="btn-primary px-12 py-2 text-sm tracking-widest">完成旅客名單設定</button></div>
                </div>
            </div>
        </transition>

        <!-- 圖檔導出渲染區 -->
        <div id="capture-area-container">
            <div id="image-node" class="w-[850px] bg-white p-6 relative overflow-hidden text-[#4a4a46]">
                <div class="img-header-line"></div>
                <div class="p-4">
                    <div class="flex justify-between items-start mb-5">
                        <div>
                            <h1 class="text-2xl font-black tracking-[0.2em] mb-1">高鐵訂位確認單</h1>
                            <p class="text-[9px] text-gray-400 font-bold tracking-widest uppercase">HSR Booking Confirmation Slip</p>
                        </div>
                        <div class="text-right"><p class="text-[9px] text-gray-400 font-bold uppercase tracking-widest">Slip Timestamp</p><p class="text-[11px] font-bold font-mono">{{ nowTimestamp }}</p></div>
                    </div>

                    <div class="grid grid-cols-6 border-y-2 border-[#a0aec0] py-2 mb-6 text-center items-center">
                        <div><p class="text-[9px] text-gray-400 font-bold">訂單編號</p><p class="text-[12px] font-black font-mono">{{baseInfo.orderId || 'N/A'}}</p></div>
                        <div class="border-l border-gray-300"><p class="text-[9px] text-gray-400 font-bold">團體代號</p><p class="text-[12px] font-black font-mono">{{baseInfo.groupId || 'N/A'}}</p></div>
                        <div class="border-l border-gray-300"><p class="text-[9px] text-gray-400 font-bold">訂票日期</p><p class="text-[12px] font-black font-mono">{{baseInfo.bookingDate.replace(/-/g, '/')}}</p></div>
                        <div class="border-l border-gray-300"><p class="text-[9px] text-gray-400 font-bold">業務人員</p><p class="text-[12px] font-black">{{baseInfo.sales || 'N/A'}}</p></div>
                        <div class="border-l border-gray-300"><p class="text-[9px] text-gray-400 font-bold">開票人員</p><p class="text-[12px] font-black">{{baseInfo.staff}}</p></div>
                        <div class="border-l border-gray-300 text-red-600 font-bold"><p class="text-[9px] font-bold">開票期限 (DL)</p><p class="text-[12px] font-black font-mono">{{formattedDeadline}}</p></div>
                    </div>

                    <div class="bg-orange-50 border-l-4 border-orange-400 p-4 mb-6 rounded-r">
                        <p class="text-xs font-black text-red-600 mb-1">開票注意事項：</p>
                        <div class="text-[10px] text-orange-800 font-bold space-y-1 leading-relaxed">
                            <p>請於D/L前通知 可開票 與 取票方式；逾期 系統將自動取消 需重新訂票，不保證有位。</p>
                            <p>每筆訂位代碼，統一取票方式。</p>
                        </div>
                    </div>

                    <div v-for="(trip, tIdx) in addedTrips" :key="tIdx" class="mb-8">
                        <div class="img-table-container">
                            <table class="img-table">
                                <thead><tr><th>行程</th><th>高鐵訂位編號</th><th>PNR</th><th>搭乘日期</th><th>車次</th><th>起訖站點</th><th>時間</th></tr></thead>
                                <tbody>
                                    <tr style="background-color: #f1f4f6;">
                                        <td class="font-bold">去程</td><td class="font-black font-mono text-blue-800">{{ trip.outbound.hsrOrderId || 'N/A' }}</td><td class="font-black font-mono">{{ trip.outbound.pnr }}</td><td>{{ trip.outbound.date.replace(/-/g, '/') }}</td><td>{{ trip.outbound.trainNo }}</td><td>{{ trip.outbound.from }} / {{ trip.outbound.to }}</td><td>{{ trip.outbound.depTime }} - {{ trip.outbound.arrTime }}</td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="img-row-summary">
                                <span>車廂艙等：{{ trip.outbound.carClass }}</span>
                                <span class="font-black">票數：{{ trip.outBreakdownFormatted }}</span>
                            </div>
                            <table class="pax-table">
                                <thead><tr><th>票種</th><th>旅客姓名</th><th>身分證/居留證</th><th>護照號碼</th></tr></thead>
                                <tbody>
                                    <tr v-for="p in trip.passengersOut"><td class="text-gray-400">{{ p.type }}</td><td class="font-black">{{ p.name }}</td><td class="font-mono">{{ maskId(p.idNumber) }}</td><td class="font-mono">{{ p.passportNo || '-' }}</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div v-if="trip.mode === 'round-trip'" class="img-table-container">
                            <table class="img-table">
                                <thead><tr><th>行程</th><th>高鐵訂位編號</th><th>PNR</th><th>搭乘日期</th><th>車次</th><th>起訖站點</th><th>時間</th></tr></thead>
                                <tbody>
                                    <tr style="background-color: #f6f4f1;">
                                        <td class="font-bold">回程</td><td class="font-black font-mono text-blue-800">{{ trip.returnTrip.hsrOrderId || 'N/A' }}</td><td class="font-black font-mono">{{ trip.returnTrip.pnr }}</td><td>{{ trip.returnTrip.date.replace(/-/g, '/') }}</td><td>{{ trip.returnTrip.trainNo }}</td><td>{{ trip.returnTrip.from }} / {{ trip.returnTrip.to }}</td><td>{{ trip.returnTrip.depTime }} - {{ trip.returnTrip.arrTime }}</td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="img-row-summary">
                                <span>車廂艙等：{{ trip.returnTrip.carClass }}</span>
                                <span class="font-black">票數：{{ trip.retBreakdownFormatted }}</span>
                            </div>
                            <table class="pax-table">
                                <thead><tr><th>票種</th><th>旅客姓名</th><th>身分證/居留證</th><th>護照號碼</th></tr></thead>
                                <tbody>
                                    <tr v-for="p in trip.passengersRet"><td class="text-gray-400">{{ p.type }}</td><td class="font-black">{{ p.name }}</td><td class="font-mono">{{ maskId(p.idNumber) }}</td><td class="font-mono">{{ p.passportNo || '-' }}</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="border-t-2 border-[#4a4a46] pt-4">
                        <p class="text-[10px] font-black text-gray-700 mb-2">【 掛帳說明 】</p>
                        <p class="text-[10px] font-medium text-gray-600 mb-4 leading-relaxed">掛帳全票會先掛85折的價格,優待票(孩童、敬老、愛心)都是半價。如果售價有調整需要更改再請通知唷 謝謝。</p>
                        
                        <div class="bg-gray-50 p-4 rounded border border-gray-200">
                            <p class="text-[10px] font-black mb-2 tracking-widest text-[#4a4a46]">---注意事項與改/退票說明---</p>
                            <ul class="text-[9px] text-gray-500 space-y-1.5 leading-relaxed font-medium">
                                <li>1. 座位皆由電腦自動劃位,恕無法指定座位,亦無法保證同行者為相鄰座位。</li>
                                <li>2. 若因逾時未能搭乘,請自行洽詢站務人員是否可改搭當日其他車次之自由座,恕無法辦理退票。</li>
                                <li>3. 高鐵車票須於搭乘當日使用,逾期視同廢票,恕不受理退票。</li>
                                <li>4. 如需辦理改票/退票,請於 4個工作日前 申請,並提供紙本票根或 APP 電子票截圖(天災導致高鐵停駛者不在此限)。</li>
                                <li>5. 退票將酌收手續費 每張新台幣 50 元。</li>
                                <li>6. 辦理改票/退票時,請務必提供 紙本票根或電子票(APP 截圖),未提供者將視同正常搭乘,相關費用須自行負擔。</li>
                                <li>7. 因航班延誤或取消等非高鐵因素致無法搭乘者,車票 恕無法改期或退票,敬請見諒。</li>
                            </ul>
                        </div>
                    </div>
                    <div class="flex justify-between items-end mt-6">
                        <p class="text-[8px] text-gray-300 font-bold uppercase">Total Grand Receivable</p>
                        <p class="text-4xl font-black tracking-tighter">NT$ {{ totalOrderAmount.toLocaleString() }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, computed, watch, onMounted } = Vue;

        createApp({
            setup() {
                const stations = ['南港', '台北', '板橋', '桃園', '新竹', '苗栗', '台中', '彰化', '雲林', '嘉義', '台南', '左營'];
                const tripMode = ref('one-way');
                const paxTab = ref('out');
                const showPassengerModal = ref(false);
                const toastMsg = ref('');
                const addedTrips = ref([]);
                const editingIndex = ref(null);
                const staffInput = ref(null);
                const hsrIdInput = ref(null);

                const fareRules = {
                    standard: {
                        '南港': { '台北': 40, '板橋': 70, '桃園': 200, '新竹': 330, '苗栗': 470, '台中': 740, '彰化': 860, '雲林': 970, '嘉義': 1120, '台南': 1390, '左營': 1530 },
                        '台北': { '板橋': 40, '桃園': 160, '新竹': 290, '苗栗': 430, '台中': 700, '彰化': 820, '雲林': 930, '嘉義': 1080, '台南': 1350, '左營': 1490 },
                        '板橋': { '桃園': 130, '新竹': 260, '苗栗': 400, '台中': 670, '彰化': 790, '雲林': 900, '嘉義': 1050, '台南': 1320, '左營': 1460 },
                        '桃園': { '新竹': 130, '苗栗': 280, '台中': 540, '彰化': 670, '雲林': 780, '嘉義': 920, '台南': 1190, '左營': 1330 },
                        '新竹': { '苗栗': 140, '台中': 410, '彰化': 540, '雲林': 640, '嘉義': 790, '台南': 1060, '左營': 1200 },
                        '苗栗': { '台中': 270, '彰化': 390, '雲林': 500, '嘉義': 640, '台南': 920, '左營': 1060 },
                        '台中': { '彰化': 130, '雲林': 230, '嘉義': 380, '台南': 650, '左營': 790 },
                        '彰化': { '雲林': 110, '嘉義': 250, '台南': 530, '左營': 670 },
                        '雲林': { '嘉義': 150, '台南': 420, '左營': 560 },
                        '嘉義': { '台南': 280, '左營': 410 },
                        '台南': { '左營': 140 }
                    },
                    business: {
                        '南港': { '台北': 260, '板橋': 310, '桃園': 500, '新竹': 700, '苗栗': 920, '台中': 1330, '彰化': 1510, '雲林': 1660, '嘉義': 1880, '台南': 2290, '左營': 2500 },
                        '台北': { '板橋': 260, '桃園': 440, '新竹': 640, '苗栗': 850, '台中': 1250, '彰化': 1430, '雲林': 1600, '嘉義': 1820, '台南': 2230, '左營': 2440 },
                        '板橋': { '桃園': 400, '新竹': 590, '苗栗': 800, '台中': 1210, '彰化': 1390, '雲林': 1550, '嘉義': 1780, '台南': 2180, '左營': 2390 },
                        '桃園': { '新竹': 400, '苗栗': 620, '台中': 1010, '彰化': 1210, '雲林': 1370, '嘉義': 1580, '台南': 1990, '左營': 2200 },
                        '新竹': { '苗栗': 410, '台中': 820, '彰化': 1010, '雲林': 1160, '嘉義': 1390, '台南': 1790, '左營': 2000 },
                        '苗栗': { '台中': 610, '彰化': 790, '雲林': 950, '嘉義': 1160, '台南': 1580, '左營': 1790 },
                        '台中': { '彰化': 400, '雲林': 550, '嘉義': 770, '台南': 1180, '左營': 1390 },
                        '彰化': { '雲林': 370, '嘉義': 580, '台南': 1000, '左營': 1210 },
                        '雲林': { '嘉義': 430, '台南': 830, '左營': 1040 },
                        '嘉義': { '台南': 620, '左營': 820 },
                        '台南': { '左營': 410 }
                    }
                };

                const baseInfo = reactive({ staff: '陳侑君', bookingDate: new Date().toISOString().split('T')[0], deadlineDate: '', deadlineTime: '18:00', sales: '', orderId: '', groupId: '' });
                const outbound = reactive({ hsrOrderId: '', pnr: '', date: '', carClass: '標準車廂', from: '台北', to: '左營', trainNo: '', depTime: '09:00', arrTime: '10:34' });
                const returnTrip = reactive({ hsrOrderId: '', pnr: '', date: '', carClass: '標準車廂', from: '左營', to: '台北', trainNo: '', depTime: '18:00', arrTime: '19:34' });
                const ticketsOut = reactive({ adult: 0, child: 0, senior: 0, disability: 0 });
                const ticketsRet = reactive({ adult: 0, child: 0, senior: 0, disability: 0 });
                const passengersOut = ref([]);
                const passengersRet = ref([]);

                const showToast = (msg) => { toastMsg.value = msg; setTimeout(() => { toastMsg.value = ''; }, 3000); };

                const calculateDeadline = () => {
                    if (!baseInfo.bookingDate) return;
                    const bDate = new Date(baseInfo.bookingDate);
                    let dDate = new Date(bDate);
                    dDate.setDate(bDate.getDate() + 2);
                    const dayOfWeek = bDate.getDay(); 
                    const diffToFriday = (dayOfWeek <= 5) ? (5 - dayOfWeek) : (5 + (7 - dayOfWeek));
                    const friday = new Date(bDate);
                    friday.setDate(bDate.getDate() + diffToFriday);
                    const finalDeadline = (dDate > friday) ? friday : dDate;
                    baseInfo.deadlineDate = finalDeadline.toISOString().split('T')[0];
                };

                const handleHsrIdInput = () => {
                    if (tripMode.value === 'round-trip') returnTrip.hsrOrderId = outbound.hsrOrderId;
                };

                const syncPassengerData = (index, field) => {
                    if (paxTab.value === 'out' && tripMode.value === 'round-trip') {
                        if (passengersRet.value[index] && !passengersRet.value[index].isDirty) {
                            passengersRet.value[index][field] = passengersOut.value[index][field];
                        }
                    } else if (paxTab.value === 'ret') {
                        if (passengersRet.value[index]) passengersRet.value[index].isDirty = true;
                    }
                };

                const swapStations = (trip) => {
                    const temp = trip.from;
                    trip.from = trip.to;
                    trip.to = temp;
                };

                const clearBasicInfo = () => {
                    if (confirm("確定要清除業務名稱、訂單編號與團號嗎？")) {
                        baseInfo.sales = ''; baseInfo.orderId = ''; baseInfo.groupId = '';
                        showToast("基本資料已清除");
                    }
                };

                const clearTripForm = () => {
                    if (confirm("確定要重置目前的行程輸入表單嗎？")) {
                        resetInputs();
                        showToast("行程表單已重置");
                    }
                };

                const focusInput = (type) => {
                    if (type === 'staff' && staffInput.value) staffInput.value.focus();
                    if (type === 'hsrId' && hsrIdInput.value) hsrIdInput.value.focus();
                };

                const getBasePrice = (f, t, cls) => {
                    const matrix = cls === '商務車廂' ? fareRules.business : fareRules.standard;
                    return matrix[f]?.[t] || matrix[t]?.[f] || 0;
                };

                const calculateTotal = (trip, tks) => {
                    const base = getBasePrice(trip.from, trip.to, trip.carClass);
                    const disc = trip.carClass === '商務車廂' ? 0.9 : 0.85;
                    const full = Math.round(base * disc);
                    const half = Math.round(base * 0.5);
                    return (tks.adult * full) + ((tks.child + tks.senior + tks.disability) * half);
                };

                const generateBreakdown = (trip, tks) => {
                    const base = getBasePrice(trip.from, trip.to, trip.carClass);
                    const disc = trip.carClass === '商務車廂' ? 0.9 : 0.85;
                    const full = Math.round(base * disc);
                    const half = Math.round(base * 0.5);
                    let res = [];
                    if (tks.adult > 0) res.push(`全票*${tks.adult}($${full})`);
                    if (tks.child > 0) res.push(`孩童*${tks.child}($${half})`);
                    if (tks.senior > 0) res.push(`敬老*${tks.senior}($${half})`);
                    if (tks.disability > 0) res.push(`愛心*${tks.disability}($${half})`);
                    return res.join(' ');
                };

                const maskId = (id) => id ? (id.length > 6 ? id.slice(0, 3) + '****' + id.slice(-3) : id) : '-';

                const resetInputs = () => {
                    outbound.hsrOrderId = ''; outbound.pnr = ''; ticketsOut.adult = 0; ticketsOut.child = 0; ticketsOut.senior = 0; ticketsOut.disability = 0;
                    returnTrip.hsrOrderId = ''; returnTrip.pnr = ''; ticketsRet.adult = 0; ticketsRet.child = 0; ticketsRet.senior = 0; ticketsRet.disability = 0;
                    passengersOut.value = []; passengersRet.value = [];
                };

                const addTripToList = () => {
                    const oAmt = calculateTotal(outbound, ticketsOut);
                    const rAmt = tripMode.value === 'round-trip' ? calculateTotal(returnTrip, ticketsRet) : 0;
                    addedTrips.value.push({
                        mode: tripMode.value, outbound: { ...outbound }, returnTrip: { ...returnTrip },
                        ticketsOut: { ...ticketsOut }, ticketsRet: { ...ticketsRet },
                        passengersOut: JSON.parse(JSON.stringify(passengersOut.value)),
                        passengersRet: JSON.parse(JSON.stringify(passengersRet.value)),
                        outAmount: oAmt, retAmount: rAmt, totalAmount: oAmt + rAmt,
                        outBreakdownFormatted: generateBreakdown(outbound, ticketsOut),
                        retBreakdownFormatted: generateBreakdown(returnTrip, ticketsRet)
                    });
                    resetInputs(); showToast("已儲存行程紀錄");
                };

                const startEdit = (idx) => {
                    editingIndex.value = idx; const t = addedTrips.value[idx];
                    tripMode.value = t.mode; Object.assign(outbound, t.outbound); Object.assign(returnTrip, t.returnTrip);
                    Object.assign(ticketsOut, t.ticketsOut); Object.assign(ticketsRet, t.ticketsRet);
                    passengersOut.value = JSON.parse(JSON.stringify(t.passengersOut));
                    passengersRet.value = JSON.parse(JSON.stringify(t.passengersRet));
                };

                const updateTripInList = () => {
                    const idx = editingIndex.value; const oAmt = calculateTotal(outbound, ticketsOut);
                    const rAmt = tripMode.value === 'round-trip' ? calculateTotal(returnTrip, ticketsRet) : 0;
                    addedTrips.value[idx] = {
                        mode: tripMode.value, outbound: { ...outbound }, returnTrip: { ...returnTrip },
                        ticketsOut: { ...ticketsOut }, ticketsRet: { ...ticketsRet },
                        passengersOut: JSON.parse(JSON.stringify(passengersOut.value)),
                        passengersRet: JSON.parse(JSON.stringify(passengersRet.value)),
                        outAmount: oAmt, retAmount: rAmt, totalAmount: oAmt + rAmt,
                        outBreakdownFormatted: generateBreakdown(outbound, ticketsOut),
                        retBreakdownFormatted: generateBreakdown(returnTrip, ticketsRet)
                    };
                    editingIndex.value = null; resetInputs(); showToast("紀錄已更新");
                };

                const countOut = computed(() => ticketsOut.adult + ticketsOut.child + ticketsOut.senior + ticketsOut.disability);
                const countRet = computed(() => ticketsRet.adult + ticketsRet.child + ticketsRet.senior + ticketsRet.disability);
                const isOverLimit = computed(() => countOut.value > 10 || countRet.value > 10);
                const totalOrderAmount = computed(() => addedTrips.value.reduce((s, t) => s + t.totalAmount, 0));
                const formattedDeadline = computed(() => baseInfo.deadlineDate ? `${baseInfo.deadlineDate.replace(/-/g, '/')} ${baseInfo.deadlineTime}` : '-');

                watch(() => baseInfo.bookingDate, calculateDeadline);
                watch(ticketsOut, (v) => syncPaxList(passengersOut, v, v.adult+v.child+v.senior+v.disability), { deep: true });
                watch(ticketsRet, (v) => syncPaxList(passengersRet, v, v.adult+v.child+v.senior+v.disability), { deep: true });

                const syncPaxList = (list, tks, count) => {
                    if (count > list.value.length) {
                        for (let i = list.value.length; i < count; i++) list.value.push({ type: '', name: '', idNumber: '', passportNo: '', birthday: '', isDirty: false });
                    } else if (count < list.value.length) {
                        list.value.splice(count);
                    }
                    let idx = 0;
                    [{ n: tks.adult, t: '全票' }, { n: tks.child, t: '孩童票' }, { n: tks.senior, t: '敬老票' }, { n: tks.disability, t: '愛心票' }].forEach(type => {
                        for (let k = 0; k < type.n; k++) { if (list.value[idx]) list.value[idx].type = type.t; idx++; }
                    });
                };

                const buildSummaryText = () => {
                    let txt = `【高鐵訂位確認單】\n\n`;
                    txt += `業務姓名：${baseInfo.sales || 'N/A'}\n`;
                    txt += `訂單編號：${baseInfo.orderId || 'N/A'}\n`;
                    txt += `團體代號：${baseInfo.groupId || 'N/A'}\n`;
                    txt += `開票人員：${baseInfo.staff}\n\n`;
                    txt += `開票期限：${formattedDeadline.value}\n\n`;
                    txt += `開票說明：\n請於D/L前通知 可開票 與 取票方式\n逾期將自動取消需重新訂票\n每筆訂位代碼,統一取票方式\n\n`;
                    txt += `掛帳說明：\n掛帳全票會先掛85折的價格,優待票(孩童、敬老、愛心)都是半價。如果售價有調整需要更改再請通知唷 謝謝\n\n`;

                    addedTrips.value.forEach((t, i) => {
                        txt += `[行程紀錄 #${i+1}]\n\n`;
                        txt += `去程｜PNR ${t.outbound.pnr}\n`;
                        txt += `${t.outbound.date.replace(/-/g, '/')}　${t.outbound.from}/${t.outbound.to}　班次${t.outbound.trainNo}　${t.outbound.depTime}-${t.outbound.arrTime}\n`;
                        txt += `票數：${t.outBreakdownFormatted}\n\n`;
                        if(t.mode === 'round-trip') {
                            txt += `回程｜PNR ${t.returnTrip.pnr}\n`;
                            txt += `${t.returnTrip.date.replace(/-/g, '/')}　${t.returnTrip.from}/${t.returnTrip.to}　班次${t.returnTrip.trainNo}　${t.returnTrip.depTime}-${t.returnTrip.arrTime}\n`;
                            txt += `票數：${t.retBreakdownFormatted}\n\n`;
                        }
                    });

                    txt += `\n總計應收金額：NT$ ${totalOrderAmount.value.toLocaleString()}\n\n`;
                    txt += `---注意事項與改/退票說明---\n`;
                    txt += `1. 座位皆由電腦自動劃位,恕無法指定座位,亦無法保證同行者為相鄰座位。\n`;
                    txt += `2. 若因逾時未能搭乘,請自行洽詢站務人員是否可改搭當日其他車次之自由座,恕無法辦理退票。\n`;
                    txt += `3. 高鐵車票須於搭乘當日使用,逾期視同廢票,恕不受理退票。\n`;
                    txt += `4. 如需辦理改票/退票,請於 4個工作日前 申請,並提供紙本票根或 APP 電子票截圖(天災導致高鐵停駛者不在此限)。\n`;
                    txt += `5. 退票將酌收手續費 每張新台幣 50 元。\n`;
                    txt += `6. 辦理改票/退票時,請務必提供 紙本票根或電子票(APP 截圖),未提供者將視同正常搭乘,相關費用須自行負擔。\n`;
                    txt += `7. 因航班延誤或取消等非高鐵因素致無法搭乘者,車票 恕無法改期或退票,敬請見諒。`;
                    return txt;
                };

                const downloadSummaryText = () => {
                    const blob = new Blob([buildSummaryText()], { type: 'text/plain' });
                    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                    a.download = `${baseInfo.orderId || 'HSR'}_確認範本.txt`; a.click();
                };

                const copySummaryTextToClipboard = () => {
                    const el = document.createElement('textarea'); el.value = buildSummaryText();
                    document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
                    showToast("範本文字已複製");
                };

                const downloadImage = () => {
                    const node = document.getElementById('image-node');
                    html2canvas(node, { scale: 2, backgroundColor: '#ffffff' }).then(canvas => {
                        const a = document.createElement('a'); a.href = canvas.toDataURL("image/png");
                        a.download = `${baseInfo.orderId || 'HSR'}_${baseInfo.sales || ''}_高鐵確認單.png`;
                        a.click(); showToast("圖片已下載");
                    });
                };

                onMounted(calculateDeadline);

                return {
                    baseInfo, outbound, returnTrip, ticketsOut, ticketsRet, addedTrips, tripMode, stations, maskId,
                    countOut, countRet, isOverLimit, showPassengerModal, paxTab, passengersOut, passengersRet,
                    totalOrderAmount, formattedDeadline, editingIndex, toastMsg, nowTimestamp: new Date().toLocaleString(),
                    addTripToList, updateTripInList, startEdit, cancelEdit: () => { editingIndex.value = null; resetInputs(); }, 
                    removeTrip: (i) => addedTrips.value.splice(i, 1),
                    openPassengerModal: () => showPassengerModal.value = true, 
                    copyOutboundTickets: () => Object.assign(ticketsRet, ticketsOut), 
                    downloadImage, handleHsrIdInput, syncPassengerData, downloadSummaryText, copySummaryTextToClipboard,
                    swapStations, clearBasicInfo, clearTripForm, focusInput, staffInput, hsrIdInput
                };
            }
        }).mount('#app');
    </script>
</body>
</html>


