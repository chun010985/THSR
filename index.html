<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高鐵訂位確認單生成器</title>
    
    <!-- 引入字體 Noto Sans TC -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Vue.js 2 (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f5f5f4; /* Stone 100 */
        }
        /* 自定義日系輸入框樣式 */
        .input-minimal {
            background-color: transparent;
            border-bottom: 1px solid #d6d3d1; /* Stone 300 */
            padding: 0.5rem 0;
            width: 100%;
            transition: all 0.3s ease;
            color: #44403c; /* Stone 700 */
            outline: none;
        }
        .input-minimal:focus {
            border-color: #5eead4; /* Teal 300 */
            border-bottom-width: 2px;
        }
        .input-label {
            font-size: 0.75rem;
            color: #78716c; /* Stone 500 */
            margin-bottom: 0.25rem;
            display: block;
        }
        /* 按鈕樣式 */
        .btn-primary {
            background-color: #0d9488; /* Teal 600 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            letter-spacing: 0.05em;
            transition: all 0.2s;
            width: 100%;
            text-align: center;
        }
        .btn-primary:hover {
            background-color: #0f766e; /* Teal 700 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn-secondary {
            background-color: white;
            border: 1px solid #d6d3d1;
            color: #57534e;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        .btn-secondary:hover {
            background-color: #fafaf9;
            border-color: #a8a29e;
        }
        .btn-add {
            background-color: #57534e; /* Stone 600 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s;
            width: 100%;
        }
        .btn-add:hover {
            background-color: #44403c;
        }
        
        /* 預覽表格專用樣式 */
        .grid-row-header {
            background-color: #f5f5f4;
            color: #57534e;
            font-size: 0.75rem;
            font-weight: bold;
            padding: 0.5rem;
            text-align: center;
            border-bottom: 1px solid #e7e5e4;
            border-right: 1px solid #e7e5e4;
        }
        .grid-row-data {
            padding: 0.75rem 0.5rem;
            text-align: center;
            font-size: 0.9rem;
            border-bottom: 1px solid #e7e5e4;
            border-right: 1px solid #e7e5e4;
        }
        
        /* Vue Transition 動畫 */
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s;
        }
        .fade-enter, .fade-leave-to {
            opacity: 0;
        }

        /* 列印設定 */
        @media print {
            .no-print {
                display: none !important;
            }
            .print-container {
                box-shadow: none !important;
                border: none !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                max-width: 100% !important;
            }
            body {
                background-color: white;
            }
            -webkit-print-color-adjust: exact;
        }
    </style>
</head>
<body class="text-stone-700">

    <div id="app" class="min-h-screen py-8 px-4 md:px-8 flex flex-col items-center">
        
        <!-- 標題 -->
        <header class="mb-10 text-center no-print">
            <h1 class="text-3xl font-light tracking-widest text-stone-800 mb-2">旅程確認</h1>
            <p class="text-xs text-stone-500 tracking-wider">JOURNEY CONFIRMATION</p>
        </header>

        <main class="w-full max-w-[80rem] mx-auto">
            
            <!-- 頁面 1：輸入表單區 -->
            <transition name="fade" mode="out-in">
                <section v-if="!isGenerated" key="input-form" class="bg-white p-6 md:p-10 rounded-2xl shadow-sm border border-stone-100 no-print transition-all hover:shadow-md">
                    <div class="flex justify-between items-center mb-8 border-b border-stone-100 pb-4">
                        <h2 class="text-xl font-medium text-stone-600">行程資訊輸入</h2>
                        <button @click="resetForm" class="text-xs text-stone-400 hover:text-stone-600 underline">清空重填</button>
                    </div>

                    <!-- 全域設定 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-6 mb-8 pb-8 border-b border-stone-100">
                        <div>
                            <label class="input-label">訂票人員</label>
                            <select v-model="booker" class="input-minimal">
                                <option>卓芷伶</option>
                                <option>陳侑君</option>
                            </select>
                        </div>
                        <div>
                            <label class="input-label">訂票日期</label>
                            <input type="date" v-model="bookingDate" class="input-minimal">
                        </div>
                        <div>
                            <label class="input-label">D/L 日期</label>
                            <input type="date" v-model="deadlineDate" class="input-minimal">
                        </div>
                        <div>
                            <label class="input-label">訂位代號 (PNR)</label>
                            <input type="text" v-model="pnr" class="input-minimal text-lg font-bold tracking-widest uppercase" placeholder="例如：06082412">
                        </div>
                        <div>
                            <label class="input-label">團號 (15字)</label>
                            <input type="text" v-model="groupNumber" class="input-minimal tracking-wider" placeholder="TPE20230512A001">
                        </div>
                        <div>
                            <label class="input-label">高鐵訂單編號</label>
                            <input type="text" v-model="orderId" class="input-minimal text-lg font-mono tracking-wider" placeholder="20230512001">
                        </div>
                    </div>

                    <!-- 核心區塊：左側輸入 & 右側清單 -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        
                        <!-- 左側：單筆行程輸入 (2/3 寬度) -->
                        <div class="lg:col-span-2">
                            <div class="flex items-center gap-2 mb-4">
                                <span class="w-2 h-6 bg-stone-800 rounded-sm"></span>
                                <h3 class="font-bold text-stone-800">新增行程資訊</h3>
                            </div>

                            <div class="bg-stone-50 p-6 rounded-xl border border-stone-100">
                                <!-- 行程方向選擇 -->
                                <div class="mb-4">
                                    <label class="input-label mb-2">行程類別</label>
                                    <div class="flex gap-4">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" value="去程" v-model="currentTripInput.direction" class="text-teal-600 focus:ring-teal-500">
                                            <span :class="currentTripInput.direction === '去程' ? 'font-bold text-teal-700' : 'text-stone-600'">去程</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" value="回程" v-model="currentTripInput.direction" class="text-teal-600 focus:ring-teal-500">
                                            <span :class="currentTripInput.direction === '回程' ? 'font-bold text-teal-700' : 'text-stone-600'">回程</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-4">
                                    <div class="col-span-1">
                                        <label class="input-label">日期</label>
                                        <input type="date" v-model="currentTripInput.date" class="input-minimal">
                                    </div>
                                    <div class="col-span-1">
                                        <label class="input-label">車次</label>
                                        <input type="text" v-model="currentTripInput.trainNumber" class="input-minimal" placeholder="ex: 1205">
                                    </div>
                                    <div class="col-span-1">
                                        <label class="input-label">起程時間</label>
                                        <input type="text" v-model="currentTripInput.depTime" class="input-minimal" placeholder="ex: 09:30">
                                    </div>
                                    <div class="col-span-1">
                                        <label class="input-label">到達時間</label>
                                        <input type="text" v-model="currentTripInput.arrTime" class="input-minimal" placeholder="ex: 11:15">
                                    </div>
                                    <div class="col-span-1">
                                        <label class="input-label">車廂種類</label>
                                        <select v-model="currentTripInput.carType" @change="updateInputPrices" class="input-minimal">
                                            <option>標準車廂</option>
                                            <option>商務車廂</option>
                                        </select>
                                    </div>
                                    <div class="col-span-1">
                                        <label class="input-label">出發站</label>
                                        <select v-model="currentTripInput.origin" @change="updateInputPrices" class="input-minimal">
                                            <option v-for="st in stations" :value="st">{{ st }}</option>
                                        </select>
                                    </div>
                                    <div class="col-span-1">
                                        <label class="input-label">抵達站</label>
                                        <select v-model="currentTripInput.destination" @change="updateInputPrices" class="input-minimal">
                                            <option v-for="st in stations" :value="st">{{ st }}</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- 票種細節 -->
                                <div class="bg-white p-4 rounded-lg border border-stone-200 mb-4">
                                    <div class="flex justify-between items-center mb-3">
                                        <label class="text-sm font-bold text-stone-600">票種與張數</label>
                                        <button @click="addTicketInput" class="text-xs text-teal-600 hover:text-teal-800 font-medium">+ 增加票種</button>
                                    </div>
                                    <div v-for="(ticket, idx) in currentTripInput.tickets" :key="idx" class="flex gap-4 mb-3 items-end border-b border-stone-100 pb-3 last:border-0 last:pb-0 last:mb-0">
                                        <div class="flex-1">
                                            <label class="input-label" v-if="idx===0">票種</label>
                                            <select v-model="ticket.type" @change="updateInputPrices" class="input-minimal">
                                                <option>全票</option>
                                                <option>孩童</option>
                                                <option>敬老</option>
                                                <option>愛心</option>
                                            </select>
                                        </div>
                                        <div class="w-20">
                                            <label class="input-label" v-if="idx===0">張數</label>
                                            <input type="number" v-model.number="ticket.count" min="1" class="input-minimal text-center">
                                        </div>
                                        <div class="w-24">
                                            <label class="input-label" v-if="idx===0">單價</label>
                                            <input type="number" v-model.number="ticket.price" class="input-minimal text-right">
                                        </div>
                                        <button v-if="currentTripInput.tickets.length > 1" @click="removeTicketInput(idx)" class="text-stone-300 hover:text-red-400 pb-1 px-1">
                                            &times;
                                        </button>
                                    </div>
                                    <div class="text-right mt-2 text-xs text-stone-400">
                                        * 價格已自動根據票種計算
                                    </div>
                                </div>

                                <button @click="addTripToList" class="btn-add flex items-center justify-center gap-2">
                                    <span>加入行程清單</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                                    </svg>
                                </button>
                            </div>

                            <!-- 旅客資訊 (全域) -->
                            <div class="mt-8">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="flex items-center gap-2">
                                        <span class="w-2 h-6 bg-teal-600 rounded-sm"></span>
                                        <h3 class="font-bold text-stone-800">旅客資訊</h3>
                                    </div>
                                    <button @click="addPassenger" class="text-xs bg-stone-100 hover:bg-stone-200 px-3 py-1.5 rounded transition font-medium border border-stone-200">+ 增加旅客</button>
                                </div>
                                
                                <div v-for="(p, index) in passengers" :key="index" class="mb-4 bg-stone-50 p-4 rounded-lg relative group border border-stone-100">
                                    <button v-if="passengers.length > 1" @click="removePassenger(index)" class="absolute top-2 right-2 text-stone-300 hover:text-red-400 p-2">
                                        &times;
                                    </button>
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <div>
                                            <label class="input-label">旅客姓名 {{ index + 1 }}</label>
                                            <input type="text" v-model="p.name" class="input-minimal" placeholder="王小明">
                                        </div>
                                        <div>
                                            <label class="input-label">身分證字號</label>
                                            <input type="text" v-model="p.id" class="input-minimal uppercase" placeholder="A123456789">
                                        </div>
                                        <div>
                                            <label class="input-label">出生年月日</label>
                                            <input type="date" v-model="p.birthDate" class="input-minimal">
                                        </div>
                                        <div>
                                            <label class="input-label">護照號碼</label>
                                            <input type="text" v-model="p.passport" class="input-minimal uppercase" placeholder="可留空">
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <!-- 右側：行程摘要清單 (1/3 寬度) -->
                        <div class="lg:col-span-1">
                            <div class="sticky top-4">
                                <div class="bg-white border border-stone-200 rounded-xl shadow-sm p-5 h-full">
                                    <h3 class="font-bold text-stone-700 mb-4 pb-2 border-b border-stone-100 flex justify-between items-center">
                                        <span>行程預覽摘要</span>
                                        <span class="text-xs font-normal text-stone-400">共 {{ trips.length }} 筆行程</span>
                                    </h3>

                                    <div v-if="trips.length === 0" class="text-center py-10 text-stone-400 text-sm bg-stone-50 rounded-lg border-2 border-dashed border-stone-200">
                                        尚未加入任何行程<br>請由左側填寫並加入
                                    </div>

                                    <div v-else class="space-y-4 max-h-[600px] overflow-y-auto pr-2 custom-scrollbar">
                                        <div v-for="(trip, idx) in trips" :key="idx" class="bg-stone-50 rounded-lg p-3 border border-stone-200 relative group transition hover:shadow-md hover:bg-white">
                                            <button @click="removeTripFromList(idx)" class="absolute top-2 right-2 text-stone-300 hover:text-red-400 p-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                                </svg>
                                            </button>
                                            
                                            <div class="flex items-center gap-2 mb-2">
                                                <span class="px-2 py-0.5 rounded text-xs font-bold" 
                                                      :class="trip.direction === '去程' ? 'bg-teal-100 text-teal-700' : 'bg-stone-200 text-stone-600'">
                                                    {{ trip.direction }}
                                                </span>
                                                <span class="text-sm font-mono text-stone-500">{{ formatDateShort(trip.date) }}</span>
                                            </div>
                                            
                                            <div class="flex justify-between items-baseline mb-1">
                                                <div class="font-bold text-stone-800 text-lg">{{ trip.origin }} <span class="text-stone-400 text-sm">➔</span> {{ trip.destination }}</div>
                                                <div class="font-mono font-bold text-stone-600">{{ trip.trainNumber }}</div>
                                            </div>
                                            
                                            <div class="text-xs text-stone-500 mb-2 font-mono">
                                                {{ trip.depTime }} - {{ trip.arrTime }}
                                            </div>
                                            
                                            <div class="border-t border-stone-200 pt-2 mt-2">
                                                <div class="text-xs text-stone-400 mb-1">票數統計: {{ getTotalCount(trip.tickets) }} 張</div>
                                                <div class="flex justify-between items-end">
                                                    <span class="text-xs text-stone-500">{{ trip.carType }}</span>
                                                    <span class="font-mono font-bold text-stone-700">${{ formatPrice(getTripSubtotal(trip)) }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mt-4 pt-4 border-t border-stone-200">
                                        <div class="flex justify-between items-end">
                                            <span class="text-sm text-stone-500">預估總金額</span>
                                            <span class="text-xl font-bold text-stone-800">${{ formatPrice(totalPrice) }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 生成按鈕 -->
                    <div class="mt-12 flex justify-center border-t border-stone-100 pt-8">
                        <button 
                            @click="generateTicket" 
                            :disabled="trips.length === 0"
                            :class="trips.length === 0 ? 'bg-stone-300 cursor-not-allowed' : 'btn-primary hover:shadow-xl transform hover:-translate-y-0.5'"
                            class="text-lg px-12 py-3 rounded-lg text-white font-medium transition-all shadow-lg">
                            生成訂位確認單
                        </button>
                    </div>

                </section>
            </transition>

            <!-- 頁面 2：即時預覽 / 確認表格 -->
            <transition name="fade" mode="out-in">
                <section v-if="isGenerated" key="preview-ticket" class="bg-white p-8 md:p-12 rounded-2xl shadow-lg print-container relative overflow-hidden h-fit">
                    
                    <!-- 頂部功能列 -->
                    <div class="no-print absolute top-6 left-6 z-10">
                        <button @click="editTicket" class="btn-secondary flex items-center gap-2 shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                            </svg>
                            返回修改
                        </button>
                    </div>
                    <div class="no-print absolute top-6 right-6 z-10">
                         <button onclick="window.print()" class="text-stone-400 hover:text-stone-700 p-2 transition-colors flex items-center gap-1" title="列印此頁">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                            </svg>
                            <span class="text-sm">列印 / 存為 PDF</span>
                        </button>
                    </div>

                    <!-- 裝飾背景圓圈 -->
                    <div class="absolute -top-10 -right-10 w-40 h-40 bg-stone-50 rounded-full opacity-50 pointer-events-none"></div>

                    <!-- 預覽區標題 -->
                    <div class="text-center mb-6 border-b border-stone-200 pb-4 mt-8 md:mt-0">
                        <h2 class="text-3xl font-bold tracking-widest text-stone-800 mb-2">訂位確認單</h2>
                        <p class="text-xs text-stone-500 uppercase tracking-[0.2em] mb-4">Booking Confirmation</p>
                        
                        <!-- 訂單資訊摘要區塊 -->
                        <div class="bg-stone-50 rounded-lg p-4 mb-2 border border-stone-200 text-left max-w-5xl mx-auto">
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-sm">
                                <div>
                                    <span class="text-xs text-stone-400 block mb-1">訂票人員</span>
                                    <span class="font-medium text-stone-700">{{ booker }}</span>
                                </div>
                                <div>
                                    <span class="text-xs text-stone-400 block mb-1">訂票日期</span>
                                    <span class="font-medium text-stone-700">{{ formatDate(bookingDate) }}</span>
                                </div>
                                <div class="bg-teal-50 border border-teal-100 rounded px-2 -mx-2">
                                    <span class="text-xs text-teal-600 block mb-1 font-bold">D/L (最後開票期限)</span>
                                    <span class="font-bold text-teal-800">{{ formatDate(deadlineDate) }} 18:00前</span>
                                </div>
                                <div>
                                    <span class="text-xs text-stone-400 block mb-1">團號</span>
                                    <span class="font-medium font-mono text-stone-700 break-all">{{ groupNumber || '-' }}</span>
                                </div>
                                <div>
                                    <span class="text-xs text-stone-400 block mb-1">高鐵訂單編號</span>
                                    <span class="font-medium font-mono text-stone-800">{{ orderId }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 動態行程區塊 -->
                    <div v-for="(trip, idx) in trips" :key="'preview-'+idx" class="mb-10">
                        <h4 class="text-sm font-bold text-stone-800 mb-2 pl-2 border-l-4" 
                            :class="trip.direction === '去程' ? 'border-teal-600' : 'border-stone-500'">
                            搭乘資訊 ({{ trip.direction }})
                        </h4>
                        
                        <div class="w-full border border-stone-300">
                            <!-- 表格內容同前... -->
                            <div class="grid grid-cols-8 text-center text-sm">
                                <div class="grid-row-header">行程</div>
                                <div class="grid-row-header">PNR</div>
                                <div class="grid-row-header">搭乘日期</div>
                                <div class="grid-row-header">車次</div>
                                <div class="grid-row-header">啟程車站</div>
                                <div class="grid-row-header">到達車站</div>
                                <div class="grid-row-header">起程時間</div>
                                <div class="grid-row-header" style="border-right:0;">到達時間</div>

                                <div class="grid-row-data bg-white font-bold">{{ trip.direction }}</div>
                                <div class="grid-row-data bg-white font-mono text-teal-700">{{ pnr }}</div>
                                <div class="grid-row-data bg-white">{{ formatDate(trip.date) }}</div>
                                <div class="grid-row-data bg-white">{{ trip.trainNumber }}</div>
                                <div class="grid-row-data bg-white">{{ trip.origin }}</div>
                                <div class="grid-row-data bg-white">{{ trip.destination }}</div>
                                <div class="grid-row-data bg-white font-mono">{{ trip.depTime }}</div>
                                <div class="grid-row-data bg-white font-mono" style="border-right:0;">{{ trip.arrTime }}</div>
                            </div>

                            <div class="grid grid-cols-6 text-center text-sm border-t border-stone-300">
                                <div class="grid-row-header">車廂</div>
                                <div class="grid-row-header">票種</div>
                                <div class="grid-row-header">全票</div>
                                <div class="grid-row-header">孩童</div>
                                <div class="grid-row-header">敬老</div>
                                <div class="grid-row-header" style="border-right:0;">愛心</div>

                                <div class="grid-row-data bg-white">{{ trip.carType }}</div>
                                <div class="grid-row-data bg-white text-stone-400 text-xs">張數統計</div>
                                <div class="grid-row-data bg-white">{{ getTicketCount(trip.tickets, '全票') }}</div>
                                <div class="grid-row-data bg-white">{{ getTicketCount(trip.tickets, '孩童') }}</div>
                                <div class="grid-row-data bg-white">{{ getTicketCount(trip.tickets, '敬老') }}</div>
                                <div class="grid-row-data bg-white" style="border-right:0;">{{ getTicketCount(trip.tickets, '愛心') }}</div>
                            </div>

                             <div class="grid grid-cols-4 text-center text-sm border-t border-stone-300">
                                <div class="grid-row-header">姓名</div>
                                <div class="grid-row-header">身分證字號</div>
                                <div class="grid-row-header">出生年月日</div>
                                <div class="grid-row-header" style="border-right:0;">護照號碼</div>
                            </div>
                            <div v-for="(p, pIdx) in passengers" :key="pIdx" class="grid grid-cols-4 text-center text-sm">
                                <div class="grid-row-data bg-white" :class="{'border-b-0': pIdx === passengers.length - 1}">{{ p.name }}</div>
                                <div class="grid-row-data bg-white font-mono" :class="{'border-b-0': pIdx === passengers.length - 1}">{{ maskID(p.id) }}</div>
                                <div class="grid-row-data bg-white font-mono" :class="{'border-b-0': pIdx === passengers.length - 1}">{{ formatDate(p.birthDate) }}</div>
                                <div class="grid-row-data bg-white font-mono" :class="{'border-b-0': pIdx === passengers.length - 1}" style="border-right:0;">{{ p.passport || '-' }}</div>
                            </div>
                        </div>
                    </div>

                    <!-- 票務詳情 (總金額) -->
                    <div class="mt-6 bg-stone-50 p-6 rounded-lg border border-stone-100">
                        <div class="border-t border-stone-300 pt-4 flex justify-end items-end gap-3">
                            <span class="text-stone-500 text-sm">總金額 Total Amount</span>
                            <span class="text-2xl font-bold text-stone-800">TWD ${{ formatPrice(totalPrice) }}</span>
                        </div>
                    </div>

                    <!-- 頁尾備註與注意事項 -->
                    <div class="mt-8 border-t border-stone-200 pt-6 space-y-8">
                        
                        <!-- 提醒與計價說明 -->
                        <div class="text-center space-y-2">
                            <div class="font-bold text-lg text-stone-800">
                                【 請務必於D/L前告知可開票 與 取票方式  紙本 / 電子票(搭配APP使用) 】
                            </div>
                            <p class="text-sm text-stone-600">
                                掛帳全票會先掛85折的價格，優待票(孩童、敬老、愛心)都是半價<br>
                                如果售價有調整需要更改再請通知唷 謝謝
                            </p>
                        </div>

                        <!-- 注意事項與退票說明 -->
                        <div class="text-xs text-stone-500 leading-relaxed bg-stone-50 p-4 rounded-lg border border-stone-100">
                            <h5 class="font-bold text-stone-700 mb-2 border-b border-stone-200 pb-1 inline-block">---注意事項與退票說明---</h5>
                            <ol class="list-decimal list-inside space-y-1">
                                <li>座位皆由電腦自動劃位，恕無法指定座位，亦無法保證同行者可安排相鄰座位。</li>
                                <li>若因逾時未能搭乘，請自行洽詢站務人員是否可改搭當日其他車次之自由座，恕無法辦理退票。</li>
                                <li>高鐵車票須於搭乘當日使用，逾期視同廢票，恕不受理退票。</li>
                                <li>如需辦理退票，請於 4個工作日前 申請，並提供紙本票根或 APP 電子票截圖（天災導致高鐵停駛者不在此限）。</li>
                                <li>退票將酌收手續費 每張新台幣 50 元。</li>
                                <li>辦理退票時，請務必提供 紙本票根或電子票（APP 截圖），未提供者將視同正常搭乘，相關費用須自行負擔。</li>
                                <li>因航班延誤或取消等非高鐵因素致無法搭乘者，車票 恕無法改期或退票，敬請見諒。</li>
                            </ol>
                        </div>

                    </div>

                </section>
            </transition>
        </main>
    </div>

    <script>
        new Vue({
            el: '#app',
            data: {
                isGenerated: false,
                stations: ['南港', '台北', '板橋', '桃園', '新竹', '苗栗', '台中', '彰化', '雲林', '嘉義', '台南', '左營'],
                
                // 票價表
                standardFares: {
                    '南港': { '台北': 40, '板橋': 70, '桃園': 200, '新竹': 330, '苗栗': 480, '台中': 750, '彰化': 870, '雲林': 930, '嘉義': 1120, '台南': 1390, '左營': 1530 },
                    '台北': { '板橋': 40, '桃園': 160, '新竹': 290, '苗栗': 430, '台中': 700, '彰化': 820, '雲林': 930, '嘉義': 1080, '台南': 1350, '左營': 1490 },
                    '板橋': { '桃園': 130, '新竹': 260, '苗栗': 400, '台中': 670, '彰化': 790, '雲林': 900, '嘉義': 1050, '台南': 1320, '左營': 1460 },
                    '桃園': { '新竹': 130, '苗栗': 280, '台中': 540, '彰化': 670, '雲林': 780, '嘉義': 920, '台南': 1190, '左營': 1330 },
                    '新竹': { '苗栗': 270, '台中': 390, '彰化': 500, '雲林': 640, '嘉義': 920, '台南': 1060, '左營': 1200 },
                    '苗栗': { '台中': 270, '彰化': 390, '雲林': 500, '嘉義': 640, '台南': 920, '左營': 1060 },
                    '台中': { '彰化': 130, '雲林': 230, '嘉義': 380, '台南': 650, '左營': 790 },
                    '彰化': { '雲林': 110, '嘉義': 250, '台南': 530, '左營': 680 },
                    '雲林': { '嘉義': 150, '台南': 420, '左營': 560 },
                    '嘉義': { '台南': 280, '左營': 410 },
                    '台南': { '左營': 140 }
                },
                businessFares: {
                    '南港': { '台北': 260, '板橋': 310, '桃園': 500, '新竹': 700, '苗栗': 920, '台中': 1330, '彰化': 1510, '雲林': 1660, '嘉義': 1880, '台南': 2290, '左營': 2500 },
                    '台北': { '板橋': 260, '桃園': 440, '新竹': 640, '苗栗': 850, '台中': 1250, '彰化': 1430, '雲林': 1600, '嘉義': 1820, '台南': 2230, '左營': 2440 },
                    '板橋': { '桃園': 400, '新竹': 590, '苗栗': 800, '台中': 1210, '彰化': 1390, '雲林': 1550, '嘉義': 1780, '台南': 2180, '左營': 2390 },
                    '桃園': { '新竹': 400, '苗栗': 620, '台中': 1010, '彰化': 1210, '雲林': 1370, '嘉義': 1580, '台南': 1990, '左營': 2200 },
                    '新竹': { '苗栗': 410, '台中': 820, '彰化': 1010, '雲林': 1160, '嘉義': 1390, '台南': 1790, '左營': 2000 },
                    '苗栗': { '台中': 610, '彰化': 790, '雲林': 950, '嘉義': 1160, '台南': 1580, '左營': 1790 },
                    '台中': { '彰化': 400, '雲林': 550, '嘉義': 770, '台南': 1180, '左營': 1390 },
                    '彰化': { '雲林': 370, '嘉義': 580, '台南': 1000, '左營': 1210 },
                    '雲林': { '嘉義': 430, '台南': 830, '左營': 1040 },
                    '嘉義': { '台南': 620, '左營': 820 },
                    '台南': { '左營': 410 }
                },

                // 全域資料
                pnr: '',
                orderId: '',
                groupNumber: '', 
                booker: '卓芷伶', 
                bookingDate: '', 
                deadlineDate: '', // 新增 D/L 日期
                passengers: [
                    { name: '', id: '', passport: '', birthDate: '' }
                ],

                // 核心資料：已加入的行程清單
                trips: [],

                // 當前正在輸入的單筆行程
                currentTripInput: {
                    direction: '去程',
                    date: '',
                    trainNumber: '',
                    carType: '標準車廂',
                    origin: '南港',
                    destination: '左營',
                    depTime: '09:00',
                    arrTime: '10:45',
                    tickets: [
                        { type: '全票', count: 1, price: 0 } 
                    ]
                }
            },
            computed: {
                totalPrice() {
                    let total = 0;
                    this.trips.forEach(trip => {
                        trip.tickets.forEach(t => {
                            total += (t.count * t.price);
                        });
                    });
                    return total;
                },
                today() {
                    return new Date().toLocaleDateString('zh-TW');
                }
            },
            methods: {
                // 取得基礎票價 (支援雙向)
                getBaseFare(faresObj, start, end) {
                    if (start === end) return 0;
                    if (faresObj[start] && faresObj[start][end]) {
                        return faresObj[start][end];
                    }
                    if (faresObj[end] && faresObj[end][start]) {
                        return faresObj[end][start];
                    }
                    return 0; // 找不到票價
                },
                
                // 計算單張票價
                calculateSinglePrice(carType, ticketType, origin, destination) {
                    let baseFare = 0;
                    let finalPrice = 0;

                    if (carType === '商務車廂') {
                        baseFare = this.getBaseFare(this.businessFares, origin, destination);
                        if (ticketType === '全票') {
                            finalPrice = baseFare * 0.9; // 商務全票9折
                        } else {
                            finalPrice = baseFare * 0.5; // 商務優待票5折
                        }
                    } else {
                        // 標準車廂
                        baseFare = this.getBaseFare(this.standardFares, origin, destination);
                        if (ticketType === '全票') {
                            finalPrice = baseFare * 0.85; // 標準全票85折
                        } else {
                            finalPrice = baseFare * 0.5; // 標準優待票5折
                        }
                    }
                    return Math.round(finalPrice);
                },

                // 更新輸入區的所有票價
                updateInputPrices() {
                    const { carType, origin, destination, tickets } = this.currentTripInput;
                    if (origin && destination) {
                        tickets.forEach(ticket => {
                            ticket.price = this.calculateSinglePrice(carType, ticket.type, origin, destination);
                        });
                    }
                },

                generateTicket() {
                    if (this.trips.length === 0) {
                        alert("請先加入至少一筆行程！");
                        return;
                    }
                    this.isGenerated = true;
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                },
                editTicket() {
                    this.isGenerated = false;
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                },
                // --- 行程清單管理 ---
                addTripToList() {
                    const tripToAdd = JSON.parse(JSON.stringify(this.currentTripInput));
                    this.trips.push(tripToAdd);
                    
                    if (this.currentTripInput.direction === '去程') {
                         this.currentTripInput.direction = '回程';
                         let temp = this.currentTripInput.origin;
                         this.currentTripInput.origin = this.currentTripInput.destination;
                         this.currentTripInput.destination = temp;
                         this.currentTripInput.depTime = '18:00';
                         this.currentTripInput.arrTime = '19:45';
                    } else {
                        this.currentTripInput.trainNumber = '';
                    }
                    // 站點變更後，重新計算價格
                    this.updateInputPrices();
                },
                removeTripFromList(index) {
                    this.trips.splice(index, 1);
                },
                getTripSubtotal(trip) {
                    return trip.tickets.reduce((sum, t) => sum + (t.count * t.price), 0);
                },
                getTotalCount(tickets) {
                    return tickets.reduce((sum, t) => sum + t.count, 0);
                },

                // --- 票種輸入管理 ---
                addTicketInput() {
                    this.currentTripInput.tickets.push({ type: '全票', count: 1, price: 0 });
                    this.updateInputPrices(); // 新增後立即計算價格
                },
                removeTicketInput(index) {
                    this.currentTripInput.tickets.splice(index, 1);
                },

                // --- 旅客管理 ---
                addPassenger() {
                    this.passengers.push({ name: '', id: '', passport: '', birthDate: '' });
                },
                removePassenger(index) {
                    this.passengers.splice(index, 1);
                },

                // --- 工具 ---
                getTicketCount(tickets, type) {
                    return tickets
                        .filter(t => t.type === type)
                        .reduce((sum, t) => sum + t.count, 0) || '-';
                },
                formatPrice(value) {
                    if (!value) return '0';
                    return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                },
                formatDate(dateStr) {
                    if (!dateStr) return '-';
                    const date = new Date(dateStr);
                    return `${date.getFullYear()}/${(date.getMonth()+1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
                },
                formatDateShort(dateStr) {
                    if (!dateStr) return '-';
                    const date = new Date(dateStr);
                    return `${(date.getMonth()+1)}/${date.getDate()}`;
                },
                maskID(id) {
                    if (!id || id.length < 4) return id;
                    return id.substring(0, 3) + '*****' + id.substring(id.length - 2);
                },
                resetForm() {
                    if(confirm('確定要清空所有資料嗎？')) {
                        this.isGenerated = false;
                        this.pnr = '';
                        this.orderId = '';
                        this.groupNumber = '';
                        this.deadlineDate = '';
                        this.trips = [];
                        this.passengers = [{ name: '', id: '', passport: '', birthDate: '' }];
                        this.currentTripInput = {
                            direction: '去程',
                            date: new Date().toISOString().split('T')[0],
                            trainNumber: '',
                            carType: '標準車廂',
                            origin: '南港',
                            destination: '左營',
                            depTime: '09:00',
                            arrTime: '10:45',
                            tickets: [{ type: '全票', count: 1, price: 0 }]
                        };
                        this.updateInputPrices();
                    }
                }
            },
            mounted() {
                const today = new Date().toISOString().split('T')[0];
                this.currentTripInput.date = today;
                this.bookingDate = today; 
                this.pnr = Math.random().toString(36).substring(2, 10).toUpperCase();
                this.orderId = '202' + Math.floor(10000000 + Math.random() * 90000000).toString();
                
                // 初始化計算價格
                this.updateInputPrices();
            }
        });
    </script>
</body>
</html>
