<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜éµè¨‚ä½ç¢ºèªå–®ç”Ÿæˆå™¨ - æœ€çµ‚æ ¡æ­£ç‰ˆ</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* ====================
           UI ä»‹é¢æ¨£å¼
           ==================== */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6; 
            color: #1f2937;
            letter-spacing: 0.02em;
        }
        .japanese-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        .form-label {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 0.3rem;
            font-weight: 700;
        }
        input, select {
            background-color: #fff;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
            width: 100%;
            height: 40px;
            color: #334155;
            transition: all 0.2s;
        }
        input:focus, select:focus {
            border-color: #4a4a46;
            ring: 1px solid #4a4a46;
            outline: none;
        }
        .btn-primary { background-color: #4a4a46; color: #fff; font-weight: 600; border-radius: 6px; transition: opacity 0.2s; }
        .btn-primary:hover:not(:disabled) { background-color: #2d3748; }
        .btn-outline { border: 1px solid #94a3b8; color: #475569; background-color: white; font-weight: 600; border-radius: 6px; }
        .btn-outline:hover { background-color: #f8fafc; }
        .time-input { letter-spacing: 0.1em; text-align: center; }
        [v-cloak] { display: none; }
        
        /* é è¦½å€å®¹å™¨ */
        .preview-wrapper {
            width: 100%;
            background-color: #cbd5e1;
            padding: 40px 20px;
            overflow: auto;
            border-top: 1px solid #94a3b8;
            display: flex;
            justify-content: center;
            margin-top: 40px;
        }
        #capture-area-container { position: relative; }

        /* =========================================
           åœ–æª”è¨­è¨ˆæ¨£å¼ (Professional & Exquisite)
           ========================================= */
        .doc-container {
            width: 850px;
            min-width: 850px;
            background-color: #fff;
            color: #333;
            line-height: 1.5;
            font-family: 'Microsoft JhengHei', 'Microsoft YaHei', Arial, sans-serif;
            position: relative;
            box-sizing: border-box;
            padding: 40px 50px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        /* é ‚éƒ¨è£é£¾æ¢ (å·²ç§»é™¤) */
        .doc-brand-bar {
            display: none;
        }

        /* æ¨™é¡Œå€ */
        .doc-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 20px;
            border-bottom: 2px solid #4a4a46;
            padding-bottom: 10px;
        }
        .doc-title {
            font-family: 'Microsoft JhengHei', sans-serif;
            font-size: 28px;
            font-weight: 900;
            color: #2d3748;
            letter-spacing: 2px;
            margin: 0;
        }
        .doc-subtitle {
            font-size: 10px;
            color: #94a3b8;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-top: 4px;
        }
        .doc-meta { text-align: right; }
        .doc-timestamp { font-size: 10px; color: #a0aec0; font-family: Consolas, monospace; }

        /* åŸºæœ¬è³‡æ–™ (å–®è¡Œè¡¨æ ¼è¨­è¨ˆ) */
        .info-header-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            border: 1px solid #cbd5e1;
            table-layout: fixed;
        }
        .info-header-table td {
            border-right: 1px solid #e2e8f0;
            padding: 8px 2px;
            vertical-align: middle;
            text-align: center;
        }
        .info-header-table td:last-child { border-right: none; }
        
        .info-header-label {
            display: block;
            font-size: 9px;
            color: #64748b;
            font-weight: 700;
            margin-bottom: 4px;
            white-space: nowrap;
        }
        .info-header-value {
            display: block;
            font-size: 11px;
            font-weight: 700;
            color: #1f2937;
            word-break: break-all;
        }
        /* ç›´æ¥åœ¨ HTML ç”¨ style è¦†è“‹ï¼Œä½†ä¿ç•™ class å‚™ç”¨ */
        .text-deadline { color: #dc2626 !important; }

        /* é–‹ç¥¨èªªæ˜ (å­—é«”èª¿æ•´ç‚º 10px) */
        .notice-box {
            border: 1px solid #a0aec0;
            padding: 12px 15px;
            margin-bottom: 25px;
            font-size: 10px; /* çµ±ä¸€ç‚º 10pxï¼Œèˆ‡è¡¨æ ¼å…§å®¹ä¸€è‡´ */
            color: #334155;
            background-color: transparent;
            border-radius: 2px;
            line-height: 1.7;
        }
        .notice-title { 
            font-weight: 900; 
            margin-bottom: 5px; 
            display: block; 
            font-size: 11px; /* æ¨™é¡Œå¾®å¤§ */
            color: #1f2937;
        }
        .checkbox-symbol { 
            font-family: "Segoe UI Symbol", sans-serif; 
            margin-right: 2px; 
            font-size: 12px; 
            vertical-align: text-bottom; 
        }

        /* åˆ†å€æ¨™é¡Œ */
        .doc-section-header {
            font-size: 12px;
            font-weight: 900;
            color: #fff;
            background-color: #4a4a46;
            padding: 4px 12px;
            display: inline-block;
            margin-bottom: 0;
            border-radius: 4px 4px 0 0;
        }

        /* è¡Œç¨‹è¡¨æ ¼ */
        .trip-container {
            margin-bottom: 25px;
            border: 1px solid #cbd5e1;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
            border-radius: 0 4px 4px 4px;
            overflow: hidden;
        }
        
        .trip-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
            text-align: center;
            line-height: 1.5;
            table-layout: fixed;
        }
        .trip-table th {
            background-color: #4a4a46;
            color: #fff;
            font-weight: 600;
            padding: 6px 4px;
            border-right: 1px solid #64748b;
            border-bottom: 1px solid #4a4a46;
            vertical-align: middle !important;
        }
        .trip-table th:last-child { border-right: none; }
        
        .trip-table td {
            background-color: #fff;
            color: #334155;
            padding: 8px 4px;
            border-right: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            vertical-align: middle !important;
        }
        .trip-table td:last-child { border-right: none; }
        
        /* ç¥¨åƒ¹è¨ˆç®—åˆ— */
        .calc-row td {
            background-color: #f9fafb;
            color: #475569;
            font-family: Consolas, monospace;
            text-align: center;
            font-size: 9px;
            padding: 5px;
            border-top: 1px solid #e2e8f0;
            vertical-align: middle !important;
        }
        
        /* æ‘˜è¦åˆ— */
        .summary-bar {
            background-color: #fff;
            padding: 6px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 10px;
            font-weight: 700;
            color: #4a4a46;
            border-top: 1px solid #cbd5e1;
            border-bottom: 1px solid #cbd5e1;
        }

        /* æ—…å®¢è¡¨æ ¼ */
        .pax-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px !important;
            text-align: center;
            line-height: 1.5;
        }
        .pax-table th {
            background-color: #f1f5f9;
            color: #64748b;
            font-weight: 700;
            padding: 5px;
            border-bottom: 1px solid #e2e8f0;
            border-right: 1px solid #e2e8f0;
            vertical-align: middle !important;
        }
        .pax-table td {
            padding: 6px;
            color: #334155;
            border-bottom: 1px solid #f1f5f9;
            border-right: 1px solid #f1f5f9;
            vertical-align: middle !important;
        }
        .pax-table tr:last-child td { border-bottom: none; }

        /* ç¸½è¨ˆèˆ‡èªªæ˜ */
        .grand-total {
            text-align: right;
            margin-top: 20px;
            padding-top: 10px;
            border-top: 2px solid #4a4a46;
        }
        .total-label { font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; margin-right: 10px; }
        .total-value { font-size: 26px; font-weight: 900; color: #2d3748; font-family: 'Arial', sans-serif; }

        .account-note {
            margin-top: 15px;
            font-size: 10px;
            color: #064e3b;
            background-color: #ecfdf5;
            padding: 10px 15px;
            border: 1px solid #bbf7d0;
            border-radius: 4px;
            line-height: 1.6;
        }
        .warning-text {
            color: #991b1b; /* æ·±ç´…è‰²æ–‡å­— */
            background-color: #fef2f2; /* æ·¡ç´…è‰²èƒŒæ™¯ */
            border: 2px solid #fca5a5; /* ç´…è‰²é‚Šæ¡† */
            font-weight: 800;
            margin-top: 15px;
            margin-bottom: 5px;
            padding: 12px 15px; /* å¢åŠ å…§è· */
            display: block;
            font-size: 11px; /* ç¨å¾®åŠ å¤§å­—é«” */
            line-height: 1.6;
            text-align: center; /* æ–‡å­—ç½®ä¸­ */
            border-radius: 6px; /* åœ“è§’ */
            box-shadow: 0 2px 4px rgba(220, 38, 38, 0.1); /* è¼•å¾®é™°å½± */
        }
        
        /* é å°¾æ³¨æ„äº‹é … (Flex æ’ç‰ˆ) */
        .footer-terms {
            margin-top: 20px;
            font-size: 9px; /* ç²¾ç·»å°å­— */
            color: #6b7280;
            border-top: 1px dashed #94a3b8;
            padding-top: 15px;
            line-height: 1.6;
        }
        .footer-title { font-weight: 800; color: #374151; display: block; margin-bottom: 5px; font-size: 10px; }
        
        .note-item { display: flex; align-items: flex-start; margin-bottom: 2px; font-size: 9px; }
        .note-num { width: 16px; flex-shrink: 0; font-weight: 700; color: #4a4a46; }
        .note-text { flex: 1; text-align: justify; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app" v-cloak class="max-w-6xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-[#4a4a46] tracking-tight">é«˜éµè¨‚ä½ç¢ºèªå–®ç”Ÿæˆå™¨</h1>
            <p class="text-[#8c8c88] mt-2 tracking-widest uppercase text-sm">Professional Slip Generator</p>
        </header>

        <div v-if="toastMsg" class="fixed top-6 left-1/2 -translate-x-1/2 z-[100] bg-gray-800 text-white px-6 py-3 rounded shadow-lg text-sm flex items-center gap-2 transition-all">
            <span class="w-2 h-2 bg-green-400 rounded-full"></span>{{ toastMsg }}
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            
            <!-- å·¦å´æ“ä½œå€ -->
            <div class="lg:col-span-8 space-y-6">
                <!-- åŸºæœ¬è³‡æ–™ -->
                <div class="japanese-card p-6 md:p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-bold border-l-4 border-[#4a4a46] pl-3">åŸºæœ¬è³‡æ–™ç®¡ç†</h2>
                        <div class="flex gap-3">
                            <button @click="focusInput('staff')" class="text-xs text-blue-600 hover:underline font-bold">âœ ç·¨è¼¯</button>
                            <button @click="clearBasicInfo" class="text-xs text-red-600 hover:underline font-bold">ğŸ—‘ æ¸…é™¤</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                        <div class="flex flex-col"><label class="form-label">è¨‚ç¥¨äººå“¡</label><input ref="staffInput" type="text" v-model="baseInfo.staff"></div>
                        <div class="flex flex-col"><label class="form-label">è¨‚ç¥¨æ—¥æœŸ</label><input type="date" v-model="baseInfo.bookingDate"></div>
                        <div class="flex flex-col text-red-600">
                            <label class="form-label text-red-600 font-bold">é–‹ç¥¨æœŸé™ (DL)</label>
                            <div class="flex gap-2"><input type="date" v-model="baseInfo.deadlineDate"><input type="text" v-model="baseInfo.deadlineTime" class="time-input w-20"></div>
                        </div>
                        <div class="flex flex-col"><label class="form-label">æ¥­å‹™å§“å</label><input type="text" v-model="baseInfo.sales"></div>
                        <div class="flex flex-col"><label class="form-label">è¨‚å–®ç·¨è™Ÿ</label><input type="text" v-model="baseInfo.orderId"></div>
                        <div class="flex flex-col"><label class="form-label">åœ˜é«”ä»£è™Ÿ</label><input type="text" v-model="baseInfo.groupId"></div>
                    </div>
                </div>

                <!-- è¡Œç¨‹è¨­å®š -->
                <div class="japanese-card p-6 md:p-8 relative">
                    <div v-if="editingIndex !== null" class="absolute top-4 right-24 bg-[#4a4a46] text-[#f4f4f2] px-3 py-1 text-xs font-bold rounded">ç·¨è¼¯æ¨¡å¼ä¸­</div>
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-lg font-bold border-l-4 border-[#4a4a46] pl-3">è¡Œç¨‹è©³ç´°è¨­å®š</h2>
                        <div class="flex items-center gap-4">
                            <button @click="focusInput('hsrId')" class="btn-outline px-2 py-1 text-xs border-none text-blue-600 font-bold">âœ ç·¨è¼¯</button>
                            <button @click="clearTripForm" class="btn-outline px-2 py-1 text-xs border-none text-red-600 font-bold">ğŸ—‘ é‡ç½®</button>
                            <div class="flex bg-gray-100 p-1 rounded ml-2">
                                <button @click="tripMode = 'one-way'" :class="tripMode === 'one-way' ? 'bg-[#4a4a46] text-[#f4f4f2]' : 'text-[#8c8c88]'" class="px-4 py-1 text-sm font-bold transition-all rounded">å–®ç¨‹</button>
                                <button @click="tripMode = 'round-trip'" :class="tripMode === 'round-trip' ? 'bg-[#4a4a46] text-[#f4f4f2]' : 'text-[#8c8c88]'" class="px-4 py-1 text-sm font-bold transition-all rounded">ä¾†å›</button>
                            </div>
                        </div>
                    </div>

                    <!-- å»ç¨‹è¡¨å–® -->
                    <div class="space-y-8">
                        <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
                            <span class="text-[10px] bg-[#4a4a46] text-white px-3 py-1 rounded font-bold uppercase mb-4 inline-block tracking-widest">Outbound å»ç¨‹</span>
                            <div class="grid grid-cols-1 md:grid-cols-12 gap-5">
                                <div class="md:col-span-6"><label class="form-label">é«˜éµè¨‚ä½ç·¨è™Ÿ</label><input ref="hsrIdInput" type="text" v-model="outbound.hsrOrderId" @input="syncHsrOrderId" class="font-bold tracking-widest" placeholder="8ç¢¼ç·¨è™Ÿ"></div>
                                <div class="md:col-span-6"><label class="form-label">PNR ä»£ç¢¼</label><input type="text" v-model="outbound.pnr" class="uppercase font-bold tracking-widest"></div>
                                <div class="md:col-span-4"><label class="form-label">æ—¥æœŸ</label><input type="date" v-model="outbound.date"></div>
                                <div class="md:col-span-4"><label class="form-label">è‰™ç­‰</label><select v-model="outbound.carClass"><option>æ¨™æº–è»Šå»‚</option><option>å•†å‹™è»Šå»‚</option></select></div>
                                <div class="md:col-span-4"><label class="form-label">è»Šæ¬¡</label><input type="text" v-model="outbound.trainNo"></div>
                                <div class="md:col-span-6"><label class="form-label">èµ·è¨–ç«™é»</label><div class="flex gap-2 items-center"><select v-model="outbound.from"><option v-for="s in stations">{{s}}</option></select><button @click="swapStations(outbound)" class="text-gray-400 hover:text-gray-600 text-lg">â‡„</button><select v-model="outbound.to"><option v-for="s in stations">{{s}}</option></select></div></div>
                                <div class="md:col-span-6"><label class="form-label">æ™‚é–“ (24H)</label><div class="flex gap-2 items-center"><input type="text" v-model="outbound.depTime" class="time-input" placeholder="09:00"><span class="text-gray-400">-</span><input type="text" v-model="outbound.arrTime" class="time-input" placeholder="10:30"></div></div>
                            </div>
                        </div>

                        <!-- å›ç¨‹è¡¨å–® -->
                        <div v-if="tripMode === 'round-trip'" class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
                            <span class="text-[10px] bg-gray-500 text-white px-3 py-1 rounded font-bold uppercase mb-4 inline-block tracking-widest">Return å›ç¨‹</span>
                            <div class="grid grid-cols-1 md:grid-cols-12 gap-5">
                                <div class="md:col-span-6"><label class="form-label">é«˜éµè¨‚ä½ç·¨è™Ÿ</label><input type="text" v-model="returnTrip.hsrOrderId"></div>
                                <div class="md:col-span-6"><label class="form-label">PNR ä»£ç¢¼</label><input type="text" v-model="returnTrip.pnr" class="uppercase font-bold tracking-widest"></div>
                                <div class="md:col-span-4"><label class="form-label">æ—¥æœŸ</label><input type="date" v-model="returnTrip.date"></div>
                                <div class="md:col-span-4"><label class="form-label">è‰™ç­‰</label><select v-model="returnTrip.carClass"><option>æ¨™æº–è»Šå»‚</option><option>å•†å‹™è»Šå»‚</option></select></div>
                                <div class="md:col-span-4"><label class="form-label">è»Šæ¬¡</label><input type="text" v-model="returnTrip.trainNo"></div>
                                <div class="md:col-span-6"><label class="form-label">èµ·è¨–ç«™é»</label><div class="flex gap-2 items-center"><select v-model="returnTrip.from"><option v-for="s in stations">{{s}}</option></select><button @click="swapStations(returnTrip)" class="text-gray-400 hover:text-gray-600 text-lg">â‡„</button><select v-model="returnTrip.to"><option v-for="s in stations">{{s}}</option></select></div></div>
                                <div class="md:col-span-6"><label class="form-label">æ™‚é–“ (24H)</label><div class="flex gap-2 items-center"><input type="text" v-model="returnTrip.depTime" class="time-input" placeholder="18:00"><span class="text-gray-400">-</span><input type="text" v-model="returnTrip.arrTime" class="time-input" placeholder="19:30"></div></div>
                            </div>
                        </div>

                        <!-- ç¥¨æ•¸çµ±è¨ˆ -->
                        <div class="bg-white p-6 border border-gray-200 rounded-lg shadow-sm">
                            <div class="mb-5">
                                <p class="text-xs font-bold mb-3 text-gray-700 border-b pb-1">å»ç¨‹ç¥¨æ•¸è¨­å®š</p>
                                <div class="grid grid-cols-4 gap-3">
                                    <div><label class="form-label">å…¨ç¥¨</label><input type="number" v-model.number="ticketsOut.adult" min="0"></div>
                                    <div><label class="form-label">å­©ç«¥</label><input type="number" v-model.number="ticketsOut.child" min="0"></div>
                                    <div><label class="form-label">æ•¬è€</label><input type="number" v-model.number="ticketsOut.senior" min="0"></div>
                                    <div><label class="form-label">æ„›å¿ƒ</label><input type="number" v-model.number="ticketsOut.disability" min="0"></div>
                                </div>
                            </div>
                            <div v-if="tripMode === 'round-trip'" class="mb-5 border-t pt-4">
                                <div class="flex justify-between items-center mb-3 border-b pb-1"><p class="text-xs font-bold text-gray-700">å›ç¨‹ç¥¨æ•¸è¨­å®š</p><button @click="copyOutboundTickets" class="text-[11px] text-blue-600 hover:underline font-bold">åŒå»ç¨‹ç¥¨æ•¸</button></div>
                                <div class="grid grid-cols-4 gap-3">
                                    <div><label class="form-label">å…¨ç¥¨</label><input type="number" v-model.number="ticketsRet.adult" min="0"></div>
                                    <div><label class="form-label">å­©ç«¥</label><input type="number" v-model.number="ticketsRet.child" min="0"></div>
                                    <div><label class="form-label">æ•¬è€</label><input type="number" v-model.number="ticketsRet.senior" min="0"></div>
                                    <div><label class="form-label">æ„›å¿ƒ</label><input type="number" v-model.number="ticketsRet.disability" min="0"></div>
                                </div>
                            </div>
                            <div class="flex justify-end gap-2 mt-2">
                                <button @click="openPassengerModal" :disabled="countOut === 0" class="btn-outline px-4 py-2 text-sm">ç·¨è¼¯åå–®</button>
                                <button v-if="editingIndex === null" @click="addTripToList" :disabled="isOverLimit || countOut === 0" class="btn-primary px-8 py-2 text-sm">æ–°å¢</button>
                                <button v-else @click="updateTripInList" class="bg-blue-600 text-white px-8 py-2 text-sm rounded">æ›´æ–°</button>
                                <button v-if="editingIndex !== null" @click="cancelEdit" class="text-gray-500 text-sm px-2 hover:text-gray-700">å–æ¶ˆ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³å´ï¼šæ‘˜è¦æ¸…å–® -->
            <div class="lg:col-span-4 space-y-6">
                <div class="japanese-card p-6 sticky top-8 flex flex-col h-[85vh]">
                    <h2 class="text-lg font-bold mb-4 border-b border-gray-200 pb-2 text-gray-700">å·²ç™»éŒ„è¡Œç¨‹æ‘˜è¦</h2>
                    <div class="flex-1 overflow-y-auto space-y-3">
                        <div v-if="addedTrips.length===0" class="text-center text-gray-400 text-sm py-10">å°šç„¡è³‡æ–™</div>
                        <div v-for="(t, i) in addedTrips" :key="i" class="p-3 bg-gray-50 border rounded-lg relative hover:shadow-md transition group">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-[10px] bg-[#4a4a46] text-white px-2 py-0.5 rounded font-mono font-bold">#{{ i + 1 }}</span>
                                <div class="flex gap-2 opacity-60 group-hover:opacity-100 transition">
                                    <button @click="startEdit(i)" class="text-blue-600 text-xs font-bold hover:underline">ç·¨è¼¯</button>
                                    <button @click="removeTrip(i)" class="text-red-400 text-xs font-bold hover:underline">åˆªé™¤</button>
                                </div>
                            </div>
                            <p class="font-bold text-[#4a4a46] mb-1">ID: {{t.outbound.hsrOrderId}}</p>
                            <div class="flex justify-between text-xs text-gray-500 font-mono">
                                <span>{{t.outbound.date}}</span>
                                <span class="font-bold text-gray-700">NT$ {{t.totalAmount.toLocaleString()}}</span>
                            </div>
                        </div>
                    </div>
                    <div class="pt-4 border-t mt-auto">
                        <div class="flex justify-between font-bold text-lg mb-2"><span>ç¸½è¨ˆ</span><span>${{ totalOrderAmount.toLocaleString() }}</span></div>
                        <button @click="downloadImage" :disabled="addedTrips.length===0" class="w-full btn-primary py-2 mb-2 shadow-lg">ä¸‹è¼‰åœ–ç‰‡</button>
                        <div class="grid grid-cols-2 gap-2">
                            <button @click="downloadTxt" :disabled="addedTrips.length===0" class="btn-outline py-2 text-xs">ä¸‹è¼‰æ–‡å­—</button>
                            <button @click="copyText" :disabled="addedTrips.length===0" class="btn-outline py-2 text-xs">è¤‡è£½æ–‡å­—</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ—…å®¢ Modal -->
        <div v-if="showPassengerModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded w-full max-w-4xl max-h-[80vh] flex flex-col shadow-2xl">
                <div class="p-4 border-b flex justify-between">
                    <h3 class="font-bold text-gray-700">ç·¨è¼¯æ—…å®¢è³‡æ–™</h3>
                    <div class="space-x-4 text-sm">
                        <button @click="paxTab='out'" :class="{'font-bold border-b-2 border-[#4a4a46] text-[#4a4a46]':paxTab==='out', 'text-gray-400':paxTab!=='out'}">å»ç¨‹</button>
                        <button v-if="tripMode==='round-trip'" @click="paxTab='ret'" :class="{'font-bold border-b-2 border-[#4a4a46] text-[#4a4a46]':paxTab==='ret', 'text-gray-400':paxTab!=='ret'}">å›ç¨‹</button>
                    </div>
                    <button @click="showPassengerModal=false" class="text-gray-500 hover:text-black">âœ•</button>
                </div>
                <div class="p-4 overflow-y-auto flex-1 space-y-2">
                    <div v-for="(p, i) in (paxTab==='out'?passengersOut:passengersRet)" :key="i" class="grid grid-cols-5 gap-2 items-end border-b border-dashed pb-2 text-sm">
                        <div class="text-gray-400 font-mono text-xs">#{{i+1}} {{p.type}}</div>
                        <input v-model="p.name" placeholder="å§“å" class="border p-1 rounded w-full text-sm" @input="syncPassengerData(i, 'name')">
                        <input v-model="p.idNumber" placeholder="è­‰è™Ÿ" class="border p-1 rounded w-full text-sm uppercase" @input="syncPassengerData(i, 'idNumber')">
                        <input v-model="p.passportNo" placeholder="è­·ç…§" class="border p-1 rounded w-full text-sm uppercase" @input="syncPassengerData(i, 'passportNo')">
                        <input type="date" v-model="p.birthday" class="border p-1 rounded w-full text-sm" @input="syncPassengerData(i, 'birthday')">
                    </div>
                </div>
                <div class="p-3 border-t text-right"><button @click="showPassengerModal=false" class="btn-primary px-6 py-2 rounded">å®Œæˆ</button></div>
            </div>
        </div>

        <!-- ======================= -->
        <!--   ç²¾ç·»åœ–æª”å°å‡ºå€ (EXQUISITE & ALIGNED)   -->
        <!-- ======================= -->
        <div class="preview-wrapper">
            <div id="image-node" class="doc-container">
                <!-- å·²ç§»é™¤é ‚éƒ¨è£é£¾æ¢ -->
                
                <div class="doc-header">
                    <div>
                        <h1 class="doc-title">é«˜éµè¨‚ä½ç¢ºèªå–®</h1>
                        <div class="doc-subtitle">BOOKING CONFIRMATION</div>
                    </div>
                    <div class="doc-meta">
                        <div class="doc-timestamp">{{ nowTimestamp }}</div>
                    </div>
                </div>

                <!-- é ‚éƒ¨ 6 æ¬„ä½å–®æ’å°é½Š -->
                <table class="info-header-table">
                    <tr>
                        <td><span class="info-header-label">è¨‚å–®ç·¨è™Ÿ</span><span class="info-header-value">{{ baseInfo.orderId || '-' }}</span></td>
                        <td><span class="info-header-label">åœ˜è™Ÿ</span><span class="info-header-value">{{ baseInfo.groupId || 'N/A' }}</span></td>
                        <td><span class="info-header-label">æ¥­å‹™äººå“¡</span><span class="info-header-value">{{ baseInfo.sales || '-' }}</span></td>
                        <td><span class="info-header-label">è¨‚ç¥¨æ—¥æœŸ</span><span class="info-header-value">{{ baseInfo.bookingDate.replace(/-/g, '/') }}</span></td>
                        <td><span class="info-header-label">è¨‚ç¥¨äººå“¡</span><span class="info-header-value">{{ baseInfo.staff }}</span></td>
                        <td><span class="info-header-label text-deadline" style="color: #dc2626;">é–‹ç¥¨æœŸé™(D/L)</span><span class="info-header-value text-deadline" style="color: #dc2626;">{{ formattedDeadline }}</span></td>
                    </tr>
                </table>

                <div class="notice-box">
                    <strong class="notice-title">ã€ é–‹ç¥¨èªªæ˜ ã€‘</strong>
                    <div>è«‹æ–¼ D/L å‰é€šçŸ¥ <strong style="color:#000;">å¯é–‹ç¥¨</strong> ä»¥åŠ <strong style="color:#000;">å–ç¥¨æ–¹å¼</strong>ï¼›é€¾æœŸç³»çµ±å°‡è‡ªå‹•å–æ¶ˆï¼Œéœ€é‡æ–°è¨‚ç¥¨ï¼Œç„¡æ³•ä¿è­‰æ˜¯å¦æœ‰ä½ã€‚</div>
                    <div style="margin-top:2px;">
                        å–ç¥¨æ–¹å¼ï¼š<span class="checkbox-symbol">â–¢</span>ç´™æœ¬ç¥¨ã€€
                        <span class="checkbox-symbol">â–¢</span>é›»å­ç¥¨(è«‹ä½¿ç”¨å°ç£é«˜éµAPPå–ç¥¨åŠåˆ†ç¥¨)ã€€
                        <span class="checkbox-symbol">â–¢</span>è¶…å•†å–ç¥¨(æ‰‹çºŒè²»è‡ªè² )ã€€ã€€â€» æ¯ä¸€ç­†è¨‚ä½ä»£ç¢¼ç‚ºçµ±ä¸€å–ç¥¨æ–¹å¼ã€‚
                    </div>
                </div>

                <div class="doc-section-header">è¨‚ä½æ˜ç´°</div>

                <div v-for="(trip, idx) in addedTrips" :key="idx" class="trip-container">
                    <!-- 10 æ¬„ä½å®Œç¾å°é½Šç³»çµ± -->
                    <table class="trip-table">
                        <thead>
                            <tr>
                                <th style="width:8%;">è¡Œç¨‹</th>
                                <th colspan="2" style="width:20%;">é«˜éµè¨‚ä½ç·¨è™Ÿ</th>
                                <th style="width:10%;">PNR</th>
                                <th style="width:12%;">æ­ä¹˜æ—¥æœŸ</th>
                                <th style="width:10%;">è»Šæ¬¡</th>
                                <th style="width:10%;">èµ·ç¨‹è»Šç«™</th>
                                <th style="width:10%;">åˆ°é”è»Šç«™</th>
                                <th style="width:10%;">å‡ºç™¼æ™‚é–“</th>
                                <th style="width:10%;">æŠµé”æ™‚é–“</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="font-bold">å»ç¨‹</td>
                                <td colspan="2" style="font-family:monospace; font-weight:900; color:#1e3a8a;">{{ trip.outbound.hsrOrderId || '-' }}</td>
                                <td style="font-family:monospace; font-weight:900;">{{ trip.outbound.pnr }}</td>
                                <td>{{ trip.outbound.date.replace(/-/g, '/') }}</td>
                                <td>{{ trip.outbound.trainNo }}</td>
                                <td>{{ trip.outbound.from }}</td>
                                <td>{{ trip.outbound.to }}</td>
                                <td>{{ trip.outbound.depTime }}</td>
                                <td>{{ trip.outbound.arrTime }}</td>
                            </tr>
                        </tbody>
                        
                        <!-- ç¥¨åƒ¹è¨ˆç®—åˆ— (å»ç¨‹ - æ¨£å¼ä¿®æ­£ç‰ˆ) -->
                        <tbody class="fare-header">
                            <tr>
                                <th colspan="2">å…¨ç¥¨</th>
                                <th colspan="2">å­©ç«¥ç¥¨</th>
                                <th colspan="2">æ„›å¿ƒç¥¨</th>
                                <th colspan="2">æ•¬è€ç¥¨</th>
                                <th colspan="2">å°è¨ˆ</th>
                            </tr>
                        </tbody>
                        <tbody class="fare-data">
                            <tr>
                                <td colspan="2">{{ trip.calcDetailsOut.adultStr }}</td>
                                <td colspan="2">{{ trip.calcDetailsOut.childStr }}</td>
                                <td colspan="2">{{ trip.calcDetailsOut.disabilityStr }}</td>
                                <td colspan="2">{{ trip.calcDetailsOut.seniorStr }}</td>
                                <td colspan="2" style="font-weight:900; color:#000;">NT${{ trip.outAmount.toLocaleString() }}</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="summary-bar">
                        <span>è»Šå»‚ï¼š{{ trip.outbound.carClass }}</span>
                        <span>ç¥¨ç¨®ï¼š{{ trip.outBreakdownText }}</span>
                    </div>

                    <table class="pax-table">
                        <thead><tr><th style="width:15%">ç¥¨ç¨®</th><th style="width:25%">å§“å</th><th style="width:35%">èº«åˆ†è­‰å­—è™Ÿ</th><th style="width:25%">è­·ç…§è™Ÿç¢¼</th></tr></thead>
                        <tbody>
                            <tr v-for="p in trip.passengersOut">
                                <td>{{ p.type }}</td><td>{{ p.name }}</td><td>{{ maskId(p.idNumber) }}</td><td>{{ p.passportNo || '' }}</td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- åˆ†éš”ç·š (ä¿®æ­£ï¼šç¸®å°é–“è·è‡³ 0px) -->
                    <div v-if="trip.mode === 'round-trip'" style="border-bottom: 1px solid #9ca3af; margin-top: 0; margin-bottom: 0;"></div>

                    <!-- å›ç¨‹ -->
                    <div v-if="trip.mode === 'round-trip'">
                        <table class="trip-table">
                            <thead>
                                <tr>
                                    <th style="width:8%;">è¡Œç¨‹</th><th colspan="2" style="width:20%;">é«˜éµè¨‚ä½ç·¨è™Ÿ</th><th style="width:10%;">PNR</th><th style="width:12%;">æ­ä¹˜æ—¥æœŸ</th><th style="width:10%;">è»Šæ¬¡</th><th style="width:10%;">èµ·ç¨‹è»Šç«™</th><th style="width:10%;">åˆ°é”è»Šç«™</th><th style="width:10%;">å‡ºç™¼æ™‚é–“</th><th style="width:10%;">æŠµé”æ™‚é–“</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="font-bold">å›ç¨‹</td>
                                    <td colspan="2" style="font-family:monospace; font-weight:900; color:#1e3a8a;">{{ trip.returnTrip.hsrOrderId || '-' }}</td>
                                    <td style="font-family:monospace; font-weight:900;">{{ trip.returnTrip.pnr }}</td>
                                    <td>{{ trip.returnTrip.date.replace(/-/g, '/') }}</td><td>{{ trip.returnTrip.trainNo }}</td>
                                    <td>{{ trip.returnTrip.from }}</td><td>{{ trip.returnTrip.to }}</td>
                                    <td>{{ trip.returnTrip.depTime }}</td><td>{{ trip.returnTrip.arrTime }}</td>
                                </tr>
                            </tbody>
                            
                            <!-- ç¥¨åƒ¹è¨ˆç®—åˆ— (å›ç¨‹ - æ¨£å¼ä¿®æ­£ç‰ˆ) -->
                            <tbody class="fare-header">
                                <tr>
                                    <th colspan="2">å…¨ç¥¨</th>
                                    <th colspan="2">å­©ç«¥ç¥¨</th>
                                    <th colspan="2">æ„›å¿ƒç¥¨</th>
                                    <th colspan="2">æ•¬è€ç¥¨</th>
                                    <th colspan="2">å°è¨ˆ</th>
                                </tr>
                            </tbody>
                            <tbody class="fare-data">
                                <tr>
                                    <td colspan="2">{{ trip.calcDetailsRet.adultStr }}</td>
                                    <td colspan="2">{{ trip.calcDetailsRet.childStr }}</td>
                                    <td colspan="2">{{ trip.calcDetailsRet.disabilityStr }}</td>
                                    <td colspan="2">{{ trip.calcDetailsRet.seniorStr }}</td>
                                    <td colspan="2" style="font-weight:900; color:#000;">NT${{ trip.retAmount.toLocaleString() }}</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div class="summary-bar">
                            <span>è»Šå»‚ï¼š{{ trip.returnTrip.carClass }}</span>
                            <span>ç¥¨ç¨®ï¼š{{ trip.retBreakdownText }}</span>
                        </div>

                        <table class="pax-table">
                            <thead><tr><th style="width:15%">ç¥¨ç¨®</th><th style="width:25%">å§“å</th><th style="width:35%">èº«åˆ†è­‰å­—è™Ÿ</th><th style="width:25%">è­·ç…§è™Ÿç¢¼</th></tr></thead>
                            <tbody>
                                <tr v-for="p in trip.passengersRet">
                                    <td>{{ p.type }}</td><td>{{ p.name }}</td><td>{{ maskId(p.idNumber) }}</td><td>{{ p.passportNo || '' }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="grand-total">
                    <span class="total-label">ç¸½è¨ˆæ‡‰æ”¶é‡‘é¡</span>
                    <span class="total-value">NT$ {{ totalOrderAmount.toLocaleString() }}</span>
                </div>

                <div class="account-note">
                    <strong>ã€ æ›å¸³èªªæ˜ ã€‘</strong><br>
                    æ›å¸³ å…¨ç¥¨æœƒå…ˆæ› 85æŠ˜çš„åƒ¹æ ¼ï¼Œå„ªå¾…ç¥¨ï¼ˆå­©ç«¥ã€æ•¬è€ã€æ„›å¿ƒï¼‰éƒ½æ˜¯åŠåƒ¹ã€‚å¦‚æœå”®åƒ¹æœ‰èª¿æ•´éœ€è¦æ›´æ”¹è«‹å‹™å¿…é€šçŸ¥ï¼Œè¬è¬æ‚¨ã€‚
                </div>
                <!-- ç¨ç«‹è­¦èªå€å¡Š -->
                <strong class="warning-text">
                    è«‹æ¥­å‹™å€‘å‹™å¿…å†æ¬¡æ ¸å° ç¥¨ç¨®/å¼µæ•¸/é‡‘é¡ æ˜¯å¦æ­£ç¢ºï¼Œå¦‚æœ‰éŒ¯èª¤ è«‹æ–¼ã€Œå‡ºç¥¨å‰ã€å‘ŠçŸ¥ï¼Œå‡ºç¥¨å¾Œå‘ŠçŸ¥è«‹è‡ªè¡Œè² è²¬ï¼Œé«˜éµè¨‚ç¥¨æœå‹™çª—å£æ„Ÿè¬æ‚¨çš„é…åˆã€‚
                </strong>

                <div class="footer-terms">
                    <strong class="footer-title">--- æ³¨æ„äº‹é … èˆ‡ æ”¹/é€€ç¥¨èªªæ˜ ---</strong>
                    <div class="note-item"><div class="note-num">1.</div><div class="note-text">åº§ä½çš†ç”±é›»è…¦è‡ªå‹•åŠƒä½ï¼Œæ•ç„¡æ³•æŒ‡å®šåº§ä½ï¼Œäº¦ç„¡æ³•ä¿è­‰åŒè¡Œè€…ç‚ºç›¸é„°åº§ä½ã€‚</div></div>
                    <div class="note-item"><div class="note-num">2.</div><div class="note-text">è‹¥å› é€¾æ™‚æœªèƒ½æ­ä¹˜ï¼Œè«‹è‡ªè¡Œæ´½è©¢ç«™å‹™äººå“¡æ˜¯å¦å¯æ”¹æ­ç•¶æ—¥å…¶ä»–è»Šæ¬¡ä¹‹è‡ªç”±åº§ï¼Œæ•ç„¡æ³•è¾¦ç†é€€ç¥¨ã€‚</div></div>
                    <div class="note-item"><div class="note-num">3.</div><div class="note-text">é«˜éµè»Šç¥¨é ˆæ–¼æ­ä¹˜ç•¶æ—¥ä½¿ç”¨ï¼Œé€¾æœŸè¦–åŒå»¢ç¥¨ï¼Œæ•ä¸å—ç†é€€ç¥¨ã€‚</div></div>
                    <div class="note-item"><div class="note-num">4.</div><div class="note-text">å¦‚éœ€è¾¦ç†æ”¹ç¥¨/é€€ç¥¨ï¼Œè«‹æ–¼ <strong>4å€‹å·¥ä½œæ—¥å‰</strong> ç”³è«‹ï¼Œä¸¦æä¾›ç´™æœ¬ç¥¨æ ¹æˆ– APP é›»å­ç¥¨æˆªåœ–(å¤©ç½å°è‡´é«˜éµåœé§›è€…ä¸åœ¨æ­¤é™)ã€‚</div></div>
                    <div class="note-item"><div class="note-num">5.</div><div class="note-text">é€€ç¥¨å°‡é…Œæ”¶æ‰‹çºŒè²» æ¯å¼µæ–°å°å¹£ 50 å…ƒã€‚</div></div>
                    <div class="note-item"><div class="note-num">6.</div><div class="note-text">è¾¦ç†æ”¹ç¥¨/é€€ç¥¨æ™‚ï¼Œè«‹å‹™å¿…æä¾› ç´™æœ¬ç¥¨æ ¹æˆ–é›»å­ç¥¨(APP æˆªåœ–)ï¼Œæœªæä¾›è€…å°‡è¦–åŒæ­£å¸¸æ­ä¹˜ï¼Œç›¸é—œè²»ç”¨é ˆè‡ªè¡Œè² æ“”ã€‚</div></div>
                    <div class="note-item"><div class="note-num">7.</div><div class="note-text">å› èˆªç­å»¶èª¤æˆ–å–æ¶ˆç­‰éé«˜éµå› ç´ è‡´ç„¡æ³•æ­ä¹˜è€…ï¼Œè»Šç¥¨ æ•ç„¡æ³•æ”¹æœŸæˆ–é€€ç¥¨ï¼Œæ•¬è«‹è¦‹è«’ã€‚</div></div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, reactive, computed, watch, onMounted } = Vue;

        createApp({
            setup() {
                const stations = ['å—æ¸¯', 'å°åŒ—', 'æ¿æ©‹', 'æ¡ƒåœ’', 'æ–°ç«¹', 'è‹—æ —', 'å°ä¸­', 'å½°åŒ–', 'é›²æ—', 'å˜‰ç¾©', 'å°å—', 'å·¦ç‡Ÿ'];
                const tripMode = ref('one-way');
                const paxTab = ref('out');
                const showPassengerModal = ref(false);
                const toastMsg = ref('');
                const addedTrips = ref([]);
                const editingIndex = ref(null);
                
                const staffInput = ref(null);
                const hsrIdInput = ref(null);

                // 2026 å®Œæ•´å®˜æ–¹ç¥¨åƒ¹ (å«å•†å‹™)
                const fareRules = {
                    standard: {
                        'å—æ¸¯': { 'å°åŒ—': 40, 'æ¿æ©‹': 70, 'æ¡ƒåœ’': 200, 'æ–°ç«¹': 330, 'è‹—æ —': 470, 'å°ä¸­': 740, 'å½°åŒ–': 860, 'é›²æ—': 970, 'å˜‰ç¾©': 1120, 'å°å—': 1390, 'å·¦ç‡Ÿ': 1530 },
                        'å°åŒ—': { 'æ¿æ©‹': 40, 'æ¡ƒåœ’': 160, 'æ–°ç«¹': 290, 'è‹—æ —': 430, 'å°ä¸­': 700, 'å½°åŒ–': 820, 'é›²æ—': 930, 'å˜‰ç¾©': 1080, 'å°å—': 1350, 'å·¦ç‡Ÿ': 1490 },
                        'æ¿æ©‹': { 'æ¡ƒåœ’': 130, 'æ–°ç«¹': 260, 'è‹—æ —': 400, 'å°ä¸­': 670, 'å½°åŒ–': 790, 'é›²æ—': 900, 'å˜‰ç¾©': 1050, 'å°å—': 1320, 'å·¦ç‡Ÿ': 1460 },
                        'æ¡ƒåœ’': { 'æ–°ç«¹': 130, 'è‹—æ —': 280, 'å°ä¸­': 540, 'å½°åŒ–': 670, 'é›²æ—': 780, 'å˜‰ç¾©': 920, 'å°å—': 1190, 'å·¦ç‡Ÿ': 1330 },
                        'æ–°ç«¹': { 'è‹—æ —': 140, 'å°ä¸­': 410, 'å½°åŒ–': 540, 'é›²æ—': 640, 'å˜‰ç¾©': 790, 'å°å—': 1060, 'å·¦ç‡Ÿ': 1200 },
                        'è‹—æ —': { 'å°ä¸­': 270, 'å½°åŒ–': 390, 'é›²æ—': 500, 'å˜‰ç¾©': 640, 'å°å—': 920, 'å·¦ç‡Ÿ': 1060 },
                        'å°ä¸­': { 'å½°åŒ–': 130, 'é›²æ—': 230, 'å˜‰ç¾©': 380, 'å°å—': 650, 'å·¦ç‡Ÿ': 790 },
                        'å½°åŒ–': { 'é›²æ—': 110, 'å˜‰ç¾©': 250, 'å°å—': 530, 'å·¦ç‡Ÿ': 670 },
                        'é›²æ—': { 'å˜‰ç¾©': 150, 'å°å—': 420, 'å·¦ç‡Ÿ': 560 },
                        'å˜‰ç¾©': { 'å°å—': 280, 'å·¦ç‡Ÿ': 410 },
                        'å°å—': { 'å·¦ç‡Ÿ': 140 }
                    },
                    business: {
                        'å—æ¸¯': { 'å°åŒ—': 260, 'æ¿æ©‹': 310, 'æ¡ƒåœ’': 500, 'æ–°ç«¹': 700, 'è‹—æ —': 920, 'å°ä¸­': 1330, 'å½°åŒ–': 1510, 'é›²æ—': 1660, 'å˜‰ç¾©': 1880, 'å°å—': 2290, 'å·¦ç‡Ÿ': 2500 },
                        'å°åŒ—': { 'æ¿æ©‹': 260, 'æ¡ƒåœ’': 440, 'æ–°ç«¹': 640, 'è‹—æ —': 850, 'å°ä¸­': 1250, 'å½°åŒ–': 1430, 'é›²æ—': 1600, 'å˜‰ç¾©': 1820, 'å°å—': 2230, 'å·¦ç‡Ÿ': 2440 },
                        'æ¿æ©‹': { 'æ¡ƒåœ’': 400, 'æ–°ç«¹': 590, 'è‹—æ —': 800, 'å°ä¸­': 1210, 'å½°åŒ–': 1390, 'é›²æ—': 1550, 'å˜‰ç¾©': 1780, 'å°å—': 2180, 'å·¦ç‡Ÿ': 2390 },
                        'æ¡ƒåœ’': { 'æ–°ç«¹': 400, 'è‹—æ —': 620, 'å°ä¸­': 1010, 'å½°åŒ–': 1210, 'é›²æ—': 1370, 'å˜‰ç¾©': 1580, 'å°å—': 1990, 'å·¦ç‡Ÿ': 2200 },
                        'æ–°ç«¹': { 'è‹—æ —': 410, 'å°ä¸­': 820, 'å½°åŒ–': 1010, 'é›²æ—': 1160, 'å˜‰ç¾©': 1390, 'å°å—': 1790, 'å·¦ç‡Ÿ': 2000 },
                        'è‹—æ —': { 'å°ä¸­': 610, 'å½°åŒ–': 790, 'é›²æ—': 950, 'å˜‰ç¾©': 1160, 'å°å—': 1580, 'å·¦ç‡Ÿ': 1790 },
                        'å°ä¸­': { 'å½°åŒ–': 400, 'é›²æ—': 550, 'å˜‰ç¾©': 770, 'å°å—': 1180, 'å·¦ç‡Ÿ': 1390 },
                        'å½°åŒ–': { 'é›²æ—': 370, 'å˜‰ç¾©': 580, 'å°å—': 1000, 'å·¦ç‡Ÿ': 1210 },
                        'é›²æ—': { 'å˜‰ç¾©': 430, 'å°å—': 830, 'å·¦ç‡Ÿ': 1040 },
                        'å˜‰ç¾©': { 'å°å—': 620, 'å·¦ç‡Ÿ': 820 },
                        'å°å—': { 'å·¦ç‡Ÿ': 410 }
                    }
                };

                const baseInfo = reactive({ staff: 'é™³ä¾‘å›', bookingDate: new Date().toISOString().split('T')[0], deadlineDate: '', deadlineTime: '18:00', sales: '', orderId: '', groupId: '' });
                const outbound = reactive({ hsrOrderId: '', pnr: '', date: '', carClass: 'æ¨™æº–è»Šå»‚', from: 'å°åŒ—', to: 'å·¦ç‡Ÿ', trainNo: '', depTime: '09:00', arrTime: '10:34' });
                const returnTrip = reactive({ hsrOrderId: '', pnr: '', date: '', carClass: 'æ¨™æº–è»Šå»‚', from: 'å·¦ç‡Ÿ', to: 'å°åŒ—', trainNo: '', depTime: '18:00', arrTime: '19:34' });
                const ticketsOut = reactive({ adult: 0, child: 0, senior: 0, disability: 0 });
                const ticketsRet = reactive({ adult: 0, child: 0, senior: 0, disability: 0 });
                const passengersOut = ref([]);
                const passengersRet = ref([]);

                const showToast = (msg) => { toastMsg.value = msg; setTimeout(() => { toastMsg.value = ''; }, 3000); };
                const focusInput = (name) => {
                     if(name==='staff' && staffInput.value) staffInput.value.focus();
                     if(name==='hsrId' && hsrIdInput.value) hsrIdInput.value.focus();
                };

                const calculateDeadline = () => {
                    if (!baseInfo.bookingDate) return;
                    const bDate = new Date(baseInfo.bookingDate);
                    let dDate = new Date(bDate); dDate.setDate(bDate.getDate() + 2);
                    const day = bDate.getDay(); 
                    const diff = day <= 5 ? 5-day : 5+(7-day);
                    const friday = new Date(bDate); friday.setDate(bDate.getDate() + diff);
                    const final = dDate > friday ? friday : dDate;
                    baseInfo.deadlineDate = final.toISOString().split('T')[0];
                };

                const syncHsrOrderId = () => { if (tripMode.value === 'round-trip') returnTrip.hsrOrderId = outbound.hsrOrderId; };
                const swapStations = (t) => { const tmp = t.from; t.from = t.to; t.to = tmp; };
                const clearBasicInfo = () => { if(confirm('æ¸…é™¤åŸºæœ¬è³‡æ–™?')) { baseInfo.sales=''; baseInfo.orderId=''; baseInfo.groupId=''; } };
                const clearTripForm = () => { if(confirm('é‡ç½®è¡Œç¨‹è¡¨å–®?')) { outbound.pnr=''; ticketsOut.adult=0; passengersOut.value=[]; } };
                const copyOutboundTickets = () => { Object.assign(ticketsRet, JSON.parse(JSON.stringify(ticketsOut))); };

                // ç¥¨åƒ¹è¨ˆç®— (é¡¯ç¤ºç®—å¼)
                const getCalcDetails = (trip, tks) => {
                    const matrix = trip.carClass === 'å•†å‹™è»Šå»‚' ? fareRules.business : fareRules.standard;
                    const base = matrix[trip.from]?.[trip.to] || matrix[trip.to]?.[trip.from] || 0;
                    const disc = trip.carClass === 'å•†å‹™è»Šå»‚' ? 0.9 : 0.85;
                    const full = Math.round(base * disc);
                    const half = Math.round(base * 0.5);
                    return {
                        adultStr: tks.adult > 0 ? `${full}*${tks.adult}` : '',
                        childStr: tks.child > 0 ? `${half}*${tks.child}` : '',
                        seniorStr: tks.senior > 0 ? `${half}*${tks.senior}` : '',
                        disabilityStr: tks.disability > 0 ? `${half}*${tks.disability}` : ''
                    };
                };

                const getFare = (trip) => {
                    const matrix = trip.carClass === 'å•†å‹™è»Šå»‚' ? fareRules.business : fareRules.standard;
                    return matrix[trip.from]?.[trip.to] || matrix[trip.to]?.[trip.from] || 0;
                };

                const calcTotal = (trip, tks) => {
                    const base = getFare(trip);
                    const disc = trip.carClass === 'å•†å‹™è»Šå»‚' ? 0.9 : 0.85;
                    return (tks.adult * Math.round(base*disc)) + ((tks.child + tks.senior + tks.disability) * Math.round(base*0.5));
                };

                const getBreakdownText = (tks) => {
                    let p = [];
                    if(tks.adult) p.push(`å…¨ç¥¨ ${tks.adult} å¼µ`);
                    if(tks.child) p.push(`å­©ç«¥ç¥¨ ${tks.child} å¼µ`);
                    if(tks.senior) p.push(`æ•¬è€ç¥¨ ${tks.senior} å¼µ`);
                    if(tks.disability) p.push(`æ„›å¿ƒç¥¨ ${tks.disability} å¼µ`);
                    return p.join('ï½œ');
                };

                const addTripToList = () => {
                    addedTrips.value.push({
                        mode: tripMode.value,
                        outbound: { ...outbound }, returnTrip: { ...returnTrip },
                        ticketsOut: { ...ticketsOut }, ticketsRet: { ...ticketsRet },
                        passengersOut: JSON.parse(JSON.stringify(passengersOut.value)),
                        passengersRet: JSON.parse(JSON.stringify(passengersRet.value)),
                        outAmount: calcTotal(outbound, ticketsOut),
                        retAmount: tripMode.value === 'round-trip' ? calcTotal(returnTrip, ticketsRet) : 0,
                        totalAmount: calcTotal(outbound, ticketsOut) + (tripMode.value==='round-trip' ? calcTotal(returnTrip, ticketsRet) : 0),
                        calcDetailsOut: getCalcDetails(outbound, ticketsOut),
                        calcDetailsRet: getCalcDetails(returnTrip, ticketsRet),
                        outBreakdownText: getBreakdownText(ticketsOut),
                        retBreakdownText: getBreakdownText(ticketsRet)
                    });
                    showToast("å·²æ–°å¢");
                };

                const updateTripInList = () => {
                    const idx = editingIndex.value;
                    const oAmt = calcTotal(outbound, ticketsOut);
                    const rAmt = tripMode.value === 'round-trip' ? calcTotal(returnTrip, ticketsRet) : 0;
                    addedTrips.value[idx] = {
                        mode: tripMode.value, outbound: {...outbound}, returnTrip: {...returnTrip},
                        ticketsOut: {...ticketsOut}, ticketsRet: {...ticketsRet},
                        passengersOut: JSON.parse(JSON.stringify(passengersOut.value)),
                        passengersRet: JSON.parse(JSON.stringify(passengersRet.value)),
                        outAmount: oAmt, retAmount: rAmt, totalAmount: oAmt + rAmt,
                        calcDetailsOut: getCalcDetails(outbound, ticketsOut),
                        calcDetailsRet: getCalcDetails(returnTrip, ticketsRet),
                        outBreakdownText: getBreakdownText(ticketsOut),
                        retBreakdownText: getBreakdownText(ticketsRet)
                    };
                    editingIndex.value = null; showToast("å·²æ›´æ–°");
                };

                const startEdit = (idx) => {
                    editingIndex.value = idx; const t = addedTrips.value[idx];
                    tripMode.value = t.mode; Object.assign(outbound, t.outbound); Object.assign(returnTrip, t.returnTrip);
                    Object.assign(ticketsOut, t.ticketsOut); Object.assign(ticketsRet, t.ticketsRet);
                    passengersOut.value = JSON.parse(JSON.stringify(t.passengersOut)); passengersRet.value = JSON.parse(JSON.stringify(t.passengersRet));
                };

                const cancelEdit = () => { editingIndex.value = null; };
                const removeTrip = (i) => addedTrips.value.splice(i, 1);
                const openPassengerModal = () => showPassengerModal.value = true;
                const syncPassengerData = (i, f) => { if(paxTab.value==='out' && tripMode.value==='round-trip' && passengersRet.value[i]) passengersRet.value[i][f] = passengersOut.value[i][f]; };

                const countOut = computed(() => ticketsOut.adult + ticketsOut.child + ticketsOut.senior + ticketsOut.disability);
                const countRet = computed(() => ticketsRet.adult + ticketsRet.child + ticketsRet.senior + ticketsRet.disability);
                const isOverLimit = computed(() => countOut.value > 10 || countRet.value > 10);
                const totalOrderAmount = computed(() => addedTrips.value.reduce((s,t) => s + t.totalAmount, 0));
                const formattedDeadline = computed(() => `${baseInfo.deadlineDate.replace(/-/g,'/')} ${baseInfo.deadlineTime}`);
                const nowTimestamp = computed(() => new Date().toLocaleString('zh-TW', { hour12: false }));

                watch(ticketsOut, (v) => syncPaxList(passengersOut, v.adult+v.child+v.senior+v.disability, v), { deep: true });
                watch(ticketsRet, (v) => syncPaxList(passengersRet, v.adult+v.child+v.senior+v.disability, v), { deep: true });
                watch(() => baseInfo.bookingDate, calculateDeadline);
                watch(passengersOut, (val) => {
                    if (tripMode.value === 'round-trip') {
                        val.forEach((p, i) => {
                            if (passengersRet.value[i] && !passengersRet.value[i].isDirty) {
                                Object.assign(passengersRet.value[i], { name: p.name, idNumber: p.idNumber, passportNo: p.passportNo, birthday: p.birthday });
                            }
                        });
                    }
                }, { deep: true });

                const syncPaxList = (list, count, tks) => {
                    if (count > list.value.length) for(let i=list.value.length; i<count; i++) list.value.push({type:'', name:'', idNumber:'', passportNo:'', isDirty: false});
                    else if (count < list.value.length) list.value.splice(count);
                    let idx = 0;
                    [{n: tks.adult, t:'å…¨ç¥¨'}, {n: tks.child, t:'å­©ç«¥ç¥¨'}, {n: tks.senior, t:'æ•¬è€ç¥¨'}, {n: tks.disability, t:'æ„›å¿ƒç¥¨'}].forEach(grp => {
                        for(let k=0; k<grp.n; k++) { if(list.value[idx]) list.value[idx].type = grp.t; idx++; }
                    });
                };

                const maskId = (id) => id ? (id.length > 6 ? id.slice(0,3) + '*****' + id.slice(-4) : id) : '';

                const downloadImage = () => {
                    const node = document.getElementById('image-node');
                    html2canvas(node, { scale: 2, backgroundColor: '#ffffff' }).then(canvas => {
                        const a = document.createElement('a'); a.href = canvas.toDataURL("image/png");
                        a.download = `${baseInfo.orderId}_${baseInfo.sales}_é«˜éµç¢ºèªå–®.png`; a.click();
                        showToast("åœ–ç‰‡ä¸‹è¼‰æˆåŠŸ");
                    });
                };

                const copyText = () => {
                    let txt = `ã€é«˜éµè¨‚ä½ç¢ºèªå–®ã€‘\n\næ¥­å‹™å§“åï¼š${baseInfo.sales}\nè¨‚å–®ç·¨è™Ÿï¼š${baseInfo.orderId}ã€€\nåœ˜é«”ä»£è™Ÿï¼š${baseInfo.groupId}\t\né–‹ç¥¨äººå“¡ï¼š${baseInfo.staff}\n\né–‹ç¥¨æœŸé™ï¼š${formattedDeadline.value}\n\né–‹ç¥¨èªªæ˜ï¼š\nè«‹æ–¼D/Lå‰é€šçŸ¥ å¯é–‹ç¥¨ èˆ‡ å–ç¥¨æ–¹å¼\né€¾æœŸå°‡è‡ªå‹•å–æ¶ˆéœ€é‡æ–°è¨‚ç¥¨\næ¯ç­†è¨‚ä½ä»£ç¢¼,çµ±ä¸€å–ç¥¨æ–¹å¼\n\næ›å¸³èªªæ˜ï¼š\næ›å¸³å…¨ç¥¨æœƒå…ˆæ›85æŠ˜çš„åƒ¹æ ¼,å„ªå¾…ç¥¨(å­©ç«¥ã€æ•¬è€ã€æ„›å¿ƒ)éƒ½æ˜¯åŠåƒ¹ã€‚å¦‚æœå”®åƒ¹æœ‰èª¿æ•´éœ€è¦æ›´æ”¹å†è«‹é€šçŸ¥å”· è¬è¬\n\nè«‹æ¥­å‹™å€‘å‹™å¿…å†æ¬¡æ ¸å° ç¥¨ç¨®/å¼µæ•¸/é‡‘é¡ æ˜¯å¦æ­£ç¢ºï¼Œå¦‚æœ‰éŒ¯èª¤ è«‹æ–¼ã€Œå‡ºç¥¨å‰ã€å‘ŠçŸ¥ï¼Œå‡ºç¥¨å¾Œå‘ŠçŸ¥è«‹è‡ªè¡Œè² è²¬ï¼Œé«˜éµè¨‚ç¥¨æœå‹™çª—å£æ„Ÿè¬æ‚¨çš„é…åˆã€‚\n\n`;
                    addedTrips.value.forEach((t, i) => {
                        txt += `[è¡Œç¨‹ç´€éŒ„ #${i+1}]\n\n`;
                        txt += `å»ç¨‹ï½œPNR ${t.outbound.pnr}\n${t.outbound.date}ã€€${t.outbound.from}/${t.outbound.to}  ç­æ¬¡${t.outbound.trainNo}ã€€${t.outbound.depTime}-${t.outbound.arrTime}\nç¥¨æ•¸ï¼š${t.outBreakdownText} ($${t.outAmount.toLocaleString()})\n\n`;
                        if (t.mode === 'round-trip') {
                            txt += `å›ç¨‹ï½œPNR ${t.returnTrip.pnr}\n${t.returnTrip.date}ã€€${t.returnTrip.from}/${t.returnTrip.to}  ç­æ¬¡${t.returnTrip.trainNo}ã€€${t.returnTrip.depTime}-${t.returnTrip.arrTime}\nç¥¨æ•¸ï¼š${t.retBreakdownText} ($${t.retAmount.toLocaleString()})\n\n`;
                        }
                    });
                    txt += `ç¸½è¨ˆæ‡‰æ”¶é‡‘é¡ï¼šNT$ ${totalOrderAmount.value.toLocaleString()}\n\n---æ³¨æ„äº‹é …èˆ‡æ”¹/é€€ç¥¨èªªæ˜---\n1. åº§ä½çš†ç”±é›»è…¦è‡ªå‹•åŠƒä½,æ•ç„¡æ³•æŒ‡å®šåº§ä½,äº¦ç„¡æ³•ä¿è­‰åŒè¡Œè€…ç‚ºç›¸é„°åº§ä½ã€‚\n2. è‹¥å› é€¾æ™‚æœªèƒ½æ­ä¹˜,è«‹è‡ªè¡Œæ´½è©¢ç«™å‹™äººå“¡æ˜¯å¦å¯æ”¹æ­ç•¶æ—¥å…¶ä»–è»Šæ¬¡ä¹‹è‡ªç”±åº§,æ•ç„¡æ³•è¾¦ç†é€€ç¥¨ã€‚\n3. é«˜éµè»Šç¥¨é ˆæ–¼æ­ä¹˜ç•¶æ—¥ä½¿ç”¨,é€¾æœŸè¦–åŒå»¢ç¥¨,æ•ä¸å—ç†é€€ç¥¨ã€‚\n4. å¦‚éœ€è¾¦ç†æ”¹ç¥¨/é€€ç¥¨,è«‹æ–¼ 4å€‹å·¥ä½œæ—¥å‰ ç”³è«‹,ä¸¦æä¾›ç´™æœ¬ç¥¨æ ¹æˆ– APP é›»å­ç¥¨æˆªåœ–(å¤©ç½å°è‡´é«˜éµåœé§›è€…ä¸åœ¨æ­¤é™)ã€‚\n5. é€€ç¥¨å°‡é…Œæ”¶æ‰‹çºŒè²» æ¯å¼µæ–°å°å¹£ 50 å…ƒã€‚\n6. è¾¦ç†æ”¹ç¥¨/é€€ç¥¨æ™‚,è«‹å‹™å¿…æä¾› ç´™æœ¬ç¥¨æ ¹æˆ–é›»å­ç¥¨(APP æˆªåœ–),æœªæä¾›è€…å°‡è¦–åŒæ­£å¸¸æ­ä¹˜,ç›¸é—œè²»ç”¨é ˆè‡ªè¡Œè² æ“”ã€‚\n7. å› èˆªç­å»¶èª¤æˆ–å–æ¶ˆç­‰éé«˜éµå› ç´ è‡´ç„¡æ³•æ­ä¹˜è€…,è»Šç¥¨ æ•ç„¡æ³•æ”¹æœŸæˆ–é€€ç¥¨,æ•¬è«‹è¦‹è«’ã€‚`;
                    const el = document.createElement('textarea'); el.value = txt; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
                    showToast("æ–‡å­—ç¯„æœ¬å·²è¤‡è£½");
                };
                
                const downloadTxt = () => {
                    const blob = new Blob([document.querySelector('textarea')?.value || 'è«‹å…ˆé»é¸è¤‡è£½æ–‡å­—'], { type: 'text/plain' });
                    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                    a.download = `${baseInfo.orderId}_ç¢ºèªç¯„æœ¬.txt`; a.click();
                };
                
                const resetCurrentTripForm = () => {
                    if(confirm('é‡ç½®è¡Œç¨‹è¡¨å–®?')) { outbound.pnr=''; ticketsOut.adult=0; passengersOut.value=[]; }
                };

                const handleHsrIdInput = () => {
                     if (tripMode.value === 'round-trip') returnTrip.hsrOrderId = outbound.hsrOrderId;
                };

                onMounted(calculateDeadline);

                return {
                    baseInfo, outbound, returnTrip, ticketsOut, ticketsRet, addedTrips, tripMode, stations, maskId,
                    countOut, countRet, isOverLimit, showPassengerModal, paxTab, passengersOut, passengersRet,
                    totalOrderAmount, formattedDeadline, editingIndex, toastMsg, nowTimestamp: new Date().toLocaleString(),
                    addTripToList, updateTripInList, startEdit, cancelEdit, removeTrip,
                    openPassengerModal, copyOutboundTickets, downloadImage, copyText, downloadTxt, clearBasicInfo, 
                    clearTripForm: resetCurrentTripForm, syncHsrOrderId, swapStations, focusInput, staffInput, hsrIdInput, syncPassengerData,
                    resetCurrentTripForm, handleHsrIdInput
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
