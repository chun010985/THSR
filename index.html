<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜éµè¨‚ä½ç¢ºèªå–®ç”Ÿæˆå™¨ - æ—¥ç³»æ¥µç°¡ç‰ˆ</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Google Fonts: Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f4f4f2; 
            color: #333333;
            letter-spacing: 0.02em;
        }
        .japanese-card {
            background: #ffffff;
            border: 1px solid #e5e5e0;
            border-radius: 4px;
        }
        .form-label {
            font-size: 0.75rem;
            color: #8c8c88;
            margin-bottom: 0.3rem;
            font-weight: 500;
        }
        input, select {
            background-color: #fafaf9;
            border: 1px solid #e5e5e0;
            border-radius: 3px;
            padding: 0.5rem;
            font-size: 0.875rem;
            outline: none;
            transition: all 0.2s;
            width: 100%;
        }
        input:focus, select:focus {
            background-color: #ffffff;
            border-color: #a8a8a2;
        }
        .btn-primary {
            background-color: #4a4a46;
            color: #ffffff;
            transition: all 0.3s;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #2a2a26;
        }
        .btn-update {
            background-color: #8c7e6c;
            color: #ffffff;
        }
        .btn-primary:disabled {
            background-color: #d1d1cc;
            cursor: not-allowed;
        }
        .btn-outline {
            border: 1px solid #4a4a46;
            color: #4a4a46;
            background-color: transparent;
            transition: all 0.3s;
        }
        .btn-outline:hover:not(:disabled) {
            background-color: #4a4a46;
            color: #ffffff;
        }
        .time-input {
            letter-spacing: 0.1em;
            text-align: center;
        }
        .tab-active {
            border-bottom: 2px solid #4a4a46;
            color: #333333;
            font-weight: bold;
        }
        .tab-inactive {
            color: #a8a8a2;
        }
        .notes-text {
            font-size: 10px;
            line-height: 1.5;
            color: #718096;
        }
        [v-cloak] { display: none; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d1d1cc; border-radius: 10px; }
        .sync-badge {
            font-size: 9px;
            background: #f0fdf4;
            color: #16a34a;
            padding: 1px 4px;
            border-radius: 2px;
            border: 1px solid #dcfce7;
        }
    </style>
</head>
<body class="p-4 md:p-8 text-sm">
    <div id="app" v-cloak class="max-w-7xl mx-auto">
        
        <!-- æ¨™é ­ -->
        <header class="mb-10 text-center">
            <div class="inline-block px-8 py-1 border-y border-gray-400 mb-2">
                <span class="text-xl font-light tracking-[0.4em]">é«˜éµè¨‚ä½ç¢ºèªå–®ç”Ÿæˆå™¨</span>
            </div>
        </header>

        <!-- è¨Šæ¯é€šçŸ¥ -->
        <div v-if="toastMsg" class="fixed top-6 left-1/2 -translate-x-1/2 z-[100] bg-gray-800/90 backdrop-blur text-white px-6 py-2.5 rounded shadow-xl text-xs flex items-center gap-3 animate-bounce">
            <span>{{ toastMsg }}</span>
            <button @click="toastMsg = ''">âœ•</button>
        </div>

        <!-- ä¸»è¦ä½ˆå±€ -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            
            <!-- å·¦å´è¼¸å…¥ -->
            <div class="lg:col-span-8 space-y-8">
                
                <!-- åŸºæœ¬è³‡æ–™ -->
                <div class="japanese-card p-6 md:p-8 shadow-sm">
                    <div class="flex items-center gap-3 mb-6 font-bold text-stone-600">
                        <span class="w-1 h-5 bg-stone-400"></span>
                        <h2 class="text-md tracking-wider">åŸºæœ¬è³‡æ–™ç™»éŒ„</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="flex flex-col">
                            <label class="form-label">è¨‚ä½äººå“¡</label>
                            <div class="bg-stone-50 p-2 border border-stone-100 text-stone-400 font-medium rounded">{{ baseInfo.staff }}</div>
                        </div>
                        <div class="flex flex-col">
                            <label class="form-label">è¨‚ç¥¨æ—¥æœŸ</label>
                            <div class="bg-stone-50 p-2 border border-stone-100 text-stone-400 font-medium rounded">{{ baseInfo.bookingDate }}</div>
                        </div>
                        <div class="flex flex-col">
                            <label class="form-label text-red-500 font-bold underline">é–‹ç¥¨æœŸé™ (24H)</label>
                            <div class="flex gap-1">
                                <input type="date" v-model="baseInfo.deadlineDate" class="w-2/3">
                                <input type="text" v-model="baseInfo.deadlineTime" class="w-1/3 time-input" maxlength="5">
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <label class="form-label">æ¥­å‹™äººå“¡</label>
                            <input type="text" v-model="baseInfo.sales" placeholder="è¼¸å…¥æ¥­å‹™å§“å">
                        </div>
                        <div class="flex flex-col">
                            <label class="form-label">è¨‚å–®ç·¨è™Ÿ</label>
                            <input type="text" v-model="baseInfo.orderId">
                        </div>
                        <div class="flex flex-col">
                            <label class="form-label">åœ˜è™Ÿ</label>
                            <input type="text" v-model="baseInfo.groupId">
                        </div>
                    </div>
                </div>

                <!-- è¡Œç¨‹è³‡è¨Š -->
                <div class="japanese-card p-6 md:p-8 relative shadow-sm text-sm">
                    <div v-if="editingIndex !== null" class="absolute top-0 right-0 bg-stone-700 text-white px-4 py-1 text-[10px] font-bold rounded-bl tracking-widest">
                        æ­£åœ¨ç·¨è¼¯è¡Œç¨‹ç´€éŒ„
                    </div>

                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-3">
                            <span class="w-1 h-5 bg-stone-400"></span>
                            <h2 class="text-md font-bold text-stone-600 tracking-wider">è¡Œç¨‹è³‡è¨Š</h2>
                        </div>
                        <div class="flex bg-stone-100 p-1 rounded">
                            <button @click="tripMode = 'one-way'" :class="tripMode === 'one-way' ? 'bg-white shadow-sm font-bold text-stone-800' : 'text-stone-400'" class="px-5 py-1.5 text-[11px] transition-all rounded font-medium">å–®ç¨‹</button>
                            <button @click="tripMode = 'round-trip'" :class="tripMode === 'round-trip' ? 'bg-white shadow-sm font-bold text-stone-800' : 'text-stone-400'" class="px-5 py-1.5 text-[11px] transition-all rounded font-medium">ä¾†å›</button>
                        </div>
                    </div>

                    <!-- å»ç¨‹æ®µ -->
                    <div class="mb-8">
                        <p class="text-[9px] font-bold text-stone-400 uppercase tracking-[0.2em] mb-4 border-b border-stone-100 pb-1 flex justify-between items-end">
                            <span>ç¬¬ä¸€æ®µï¼šå»ç¨‹æ®µ</span>
                            <span v-if="outbound.hsrOrderId" class="font-mono text-stone-300">#{{ outbound.hsrOrderId }}</span>
                        </p>
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                            <div class="flex flex-col md:col-span-4">
                                <label class="form-label">é«˜éµè¨‚å–®ç·¨è™Ÿ</label>
                                <input type="text" v-model="outbound.hsrOrderId" @input="syncOrderId">
                            </div>
                            <div class="flex flex-col md:col-span-4">
                                <label class="form-label font-bold text-stone-600">è¨‚ä½ PNR</label>
                                <input type="text" v-model="outbound.pnr" class="font-bold tracking-[0.2em] text-stone-700 uppercase">
                            </div>
                            <div class="flex flex-col md:col-span-4">
                                <label class="form-label">ä¹˜è»Šæ—¥æœŸ</label>
                                <input type="date" v-model="outbound.date">
                            </div>
                            <div class="flex flex-col md:col-span-2">
                                <label class="form-label font-medium text-stone-500">è»Šå»‚è‰™ç­‰</label>
                                <select v-model="outbound.carClass">
                                    <option value="æ¨™æº–è»Šå»‚">æ¨™æº–è»Šå»‚</option>
                                    <option value="å•†å‹™è»Šå»‚">å•†å‹™è»Šå»‚</option>
                                </select>
                            </div>
                            <div class="flex flex-col md:col-span-2">
                                <label class="form-label">è»Šæ¬¡</label>
                                <input type="text" v-model="outbound.trainNo" placeholder="å¦‚ 612">
                            </div>
                            <div class="flex flex-col md:col-span-4">
                                <label class="form-label">èµ·è¿„ç«™é»</label>
                                <div class="flex items-center gap-1">
                                    <select v-model="outbound.from" class="w-full">
                                        <option v-for="s in stations" :key="s" :value="s">{{s}}</option>
                                    </select>
                                    <button @click="swapStations(outbound)" class="p-1 hover:text-stone-400 text-lg">â‡†</button>
                                    <select v-model="outbound.to" class="w-full">
                                        <option v-for="s in stations" :key="s" :value="s">{{s}}</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex flex-col md:col-span-4">
                                <label class="form-label">ä¹˜è»Šæ™‚é–“ (24H)</label>
                                <div class="flex items-center gap-1">
                                    <input type="text" v-model="outbound.depTime" class="w-1/2 time-input font-mono" placeholder="08:00">
                                    <span class="text-stone-300">~</span>
                                    <input type="text" v-model="outbound.arrTime" class="w-1/2 time-input font-mono" placeholder="09:30">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å›ç¨‹æ®µ -->
                    <div v-if="tripMode === 'round-trip'" class="mb-8 pt-4 border-t border-dashed border-stone-100">
                        <p class="text-[9px] font-bold text-stone-400 uppercase tracking-[0.2em] mb-4 border-b border-stone-100 pb-1 font-bold">ç¬¬äºŒæ®µï¼šå›ç¨‹æ®µ</p>
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                            <div class="flex flex-col md:col-span-4">
                                <label class="form-label">é«˜éµè¨‚å–®ç·¨è™Ÿ</label>
                                <input type="text" v-model="returnTrip.hsrOrderId">
                            </div>
                            <div class="flex flex-col md:col-span-4">
                                <label class="form-label font-bold text-stone-600">è¨‚ä½ PNR</label>
                                <input type="text" v-model="returnTrip.pnr" class="font-bold tracking-[0.2em] text-stone-700 uppercase">
                            </div>
                            <div class="flex flex-col md:col-span-4">
                                <label class="form-label">ä¹˜è»Šæ—¥æœŸ</label>
                                <input type="date" v-model="returnTrip.date">
                            </div>
                            <div class="flex flex-col md:col-span-2">
                                <label class="form-label font-medium text-stone-500">è»Šå»‚è‰™ç­‰</label>
                                <select v-model="returnTrip.carClass">
                                    <option value="æ¨™æº–è»Šå»‚">æ¨™æº–è»Šå»‚</option>
                                    <option value="å•†å‹™è»Šå»‚">å•†å‹™è»Šå»‚</option>
                                </select>
                            </div>
                            <div class="flex flex-col md:col-span-2">
                                <label class="form-label">è»Šæ¬¡</label>
                                <input type="text" v-model="returnTrip.trainNo">
                            </div>
                            <div class="flex flex-col md:col-span-4">
                                <label class="form-label">èµ·è¿„ç«™é»</label>
                                <div class="flex items-center gap-1">
                                    <select v-model="returnTrip.from" class="w-full">
                                        <option v-for="s in stations" :key="s" :value="s">{{s}}</option>
                                    </select>
                                    <button @click="swapStations(returnTrip)" class="p-1 hover:text-stone-400 text-lg">â‡†</button>
                                    <select v-model="returnTrip.to" class="w-full">
                                        <option v-for="s in stations" :key="s" :value="s">{{s}}</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex flex-col md:col-span-4">
                                <label class="form-label">ä¹˜è»Šæ™‚é–“ (24H)</label>
                                <div class="flex items-center gap-1">
                                    <input type="text" v-model="returnTrip.depTime" class="w-1/2 time-input font-mono" placeholder="17:00">
                                    <span class="text-stone-300">~</span>
                                    <input type="text" v-model="returnTrip.arrTime" class="w-1/2 time-input font-mono" placeholder="18:30">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ç¥¨æ•¸èˆ‡æ—…å®¢æŒ‰éˆ• -->
                    <div class="p-6 bg-stone-50 rounded border border-stone-100 shadow-sm font-medium">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8 text-stone-600">
                            <div class="flex flex-col text-xs">
                                <label class="form-label font-bold text-stone-600">å…¨ç¥¨</label>
                                <input type="number" v-model.number="tickets.adult" min="0">
                            </div>
                            <div class="flex flex-col text-xs">
                                <label class="form-label font-bold text-stone-600">å­©ç«¥(å„ªå¾…ç¥¨)</label>
                                <input type="number" v-model.number="tickets.child" min="0" class="border-stone-200">
                            </div>
                            <div class="flex flex-col text-xs">
                                <label class="form-label font-bold text-stone-600">æ•¬è€(å„ªå¾…ç¥¨)</label>
                                <input type="number" v-model.number="tickets.senior" min="0" class="border-stone-200">
                            </div>
                            <div class="flex flex-col text-xs">
                                <label class="form-label font-bold text-stone-600">æ„›å¿ƒ(å„ªå¾…ç¥¨)</label>
                                <input type="number" v-model.number="tickets.disability" min="0" class="border-stone-200">
                            </div>
                        </div>
                        
                        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                            <div class="text-[11px] font-medium" :class="isOverLimit ? 'text-red-500 font-bold underline' : 'text-stone-400'">
                                <span v-if="isOverLimit">âš  äººæ•¸ä¸Šé™ 10 ä½ / </span>
                                åˆè¨ˆï¼š{{ totalPersonCount }} ä½æ—…å®¢ (å…±è¨ˆ {{ totalTicketCountInCurrent }} å¼µ)
                            </div>
                            <div class="flex gap-2 w-full md:w-auto font-bold">
                                <button @click="openPassengerModal" :disabled="isOverLimit || totalPersonCount === 0" class="flex-1 md:flex-none btn-outline px-6 py-2.5 rounded text-[11px] shadow-sm uppercase tracking-widest">
                                    ç·¨è¼¯åå–®
                                </button>
                                <button v-if="editingIndex === null" @click="addTripToList" :disabled="isOverLimit || totalPersonCount === 0" class="flex-1 md:flex-none btn-primary px-8 py-2.5 rounded text-[11px] shadow-sm uppercase tracking-widest">
                                    æ–°å¢è¡Œç¨‹
                                </button>
                                <button v-else @click="updateTripInList" :disabled="isOverLimit || totalPersonCount === 0" class="flex-1 md:flex-none btn-update px-8 py-2.5 rounded text-[11px] font-bold shadow-sm uppercase tracking-widest">
                                    æ›´æ–°ç´€éŒ„
                                </button>
                                <button v-if="editingIndex !== null" @click="cancelEdit" class="p-2 text-stone-400 hover:text-stone-600">å–æ¶ˆ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³å´æ‘˜è¦ -->
            <div class="lg:col-span-4 h-full font-medium">
                <div class="japanese-card p-6 flex flex-col h-[calc(100vh-160px)] sticky top-8 shadow-sm text-sm font-sans">
                    <div class="flex justify-between items-end mb-6 pb-2 border-b border-stone-100">
                        <h2 class="text-xs font-bold text-stone-500 tracking-[0.2em]">è¡Œç¨‹æ‘˜è¦ç´€éŒ„</h2>
                        <span v-if="addedTrips.length > 0" @click="clearAllTrips" class="text-[10px] text-stone-300 hover:text-red-400 cursor-pointer transition-colors font-medium">å…¨éƒ¨æ¸…ç©º</span>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto space-y-4 pr-1">
                        <div v-if="addedTrips.length === 0" class="h-full flex flex-col items-center justify-center italic py-20 text-center text-xs opacity-50 font-light text-stone-400">
                            å°šæœªç™»éŒ„è¡Œç¨‹è¨˜éŒ„<br>å®Œæˆè¼¸å…¥å¾Œé»æ“Šã€Œæ–°å¢è¡Œç¨‹ã€
                        </div>
                        
                        <div v-for="(trip, idx) in addedTrips" :key="idx" 
                             :class="editingIndex === idx ? 'border-stone-400 bg-stone-100' : 'border-stone-100 bg-stone-50'"
                             class="p-4 border rounded-sm relative group transition-all hover:border-stone-300 shadow-sm text-xs">
                            
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-[9px] bg-stone-600 text-white px-2 py-0.5 rounded-full font-bold">#{{ idx + 1 }}</span>
                                <div class="flex gap-3">
                                    <button @click="startEdit(idx)" class="text-[10px] text-stone-400 hover:text-stone-700 underline underline-offset-2">ç·¨è¼¯</button>
                                    <button @click="removeTrip(idx)" class="text-[10px] text-stone-300 hover:text-red-400 font-bold">âœ•</button>
                                </div>
                            </div>

                            <div class="flex flex-col gap-1 text-[11px] text-stone-500">
                                <div class="flex justify-between font-bold text-stone-700 uppercase font-mono tracking-tight">
                                    <span>PNR: {{ trip.outbound.pnr }}</span>
                                    <span>NT$ {{ trip.totalAmount.toLocaleString() }}</span>
                                </div>
                                <div class="flex justify-between mt-1 pt-1 border-t border-stone-200/50 font-mono">
                                    <span class="text-[10px] opacity-70">{{ trip.outbound.date }}</span>
                                    <span class="font-sans font-medium text-stone-600">{{ trip.outbound.from }} â†’ {{ trip.outbound.to }} ({{ trip.outbound.carClass.slice(0,2) }})</span>
                                </div>
                                <div v-if="trip.mode === 'round-trip'" class="flex justify-between text-orange-400/80 font-mono">
                                    <span class="text-[10px] opacity-70">{{ trip.returnTrip.date }}</span>
                                    <span class="font-sans font-medium">{{ trip.returnTrip.from }} â†’ {{ trip.returnTrip.to }} ({{ trip.returnTrip.carClass.slice(0,2) }})</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 pt-6 border-t border-stone-100">
                        <div class="flex justify-between items-baseline mb-6 font-bold text-stone-700">
                            <span class="text-[10px] text-stone-400 tracking-widest uppercase">ç¸½è¨ˆé‡‘é¡å°è¨ˆ</span>
                            <div class="text-right">
                                <span class="text-xs text-stone-400 mr-1 font-mono">TWD</span>
                                <span class="text-3xl font-bold tracking-tighter">{{ totalOrderAmount.toLocaleString() }}</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 font-bold">
                            <button @click="downloadTxt" :disabled="addedTrips.length === 0" class="btn-outline py-3 rounded text-[11px] shadow-sm uppercase tracking-widest">ä¸‹è¼‰æ–‡å­—æª”</button>
                            <button @click="downloadImage" :disabled="addedTrips.length === 0" class="btn-primary py-3 rounded text-[11px] shadow-sm uppercase tracking-widest">ä¸‹è¼‰ç¢ºèªåœ–ç‰‡</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ—…å®¢å½ˆçª— -->
        <transition name="modal">
            <div v-if="showPassengerModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-stone-900/60 backdrop-blur-sm text-sm">
                <div class="bg-white w-full max-w-5xl max-h-[90vh] rounded shadow-2xl flex flex-col overflow-hidden border border-stone-200 font-medium">
                    <div class="px-8 py-4 border-b bg-stone-50 flex justify-between items-center text-xs font-bold">
                        <div class="flex gap-6 items-center">
                            <button @click="passengerTab = 'out'" :class="passengerTab === 'out' ? 'tab-active text-stone-800' : 'tab-inactive text-stone-400'" class="text-[11px] tracking-widest pb-1 transition-all uppercase">å»ç¨‹åå–®</button>
                            <button v-if="tripMode === 'round-trip'" @click="passengerTab = 'ret'" :class="passengerTab === 'ret' ? 'tab-active text-stone-800' : 'tab-inactive text-stone-400'" class="text-[11px] tracking-widest pb-1 transition-all uppercase">å›ç¨‹åå–®</button>
                        </div>
                        <button @click="showPassengerModal = false" class="text-stone-300 hover:text-stone-600 text-xl font-light font-mono">âœ•</button>
                    </div>

                    <div class="flex-1 overflow-y-auto p-8 space-y-4">
                        <div v-if="tripMode === 'round-trip' && passengerTab === 'ret'" class="p-3 bg-stone-50 border border-stone-100 rounded text-[10px] text-stone-400 italic font-light">
                            ğŸ’¡ å›ç¨‹è³‡æ–™é è¨­èˆ‡å»ç¨‹åŒæ­¥ã€‚è‹¥åœ¨æ­¤æ‰‹å‹•ä¿®æ”¹ï¼Œå‰‡è©²é …è³‡æ–™å°‡åœæ­¢åŒæ­¥ã€‚
                        </div>

                        <div v-for="(p, index) in (passengerTab === 'out' ? passengersOut : passengersRet)" :key="index" class="p-4 border border-stone-100 rounded bg-stone-50 grid grid-cols-1 md:grid-cols-5 gap-4 items-end relative shadow-sm text-xs font-medium font-sans">
                            <div class="absolute -top-2 left-2 px-1.5 py-0.5 bg-stone-200 text-stone-600 text-[8px] rounded font-bold uppercase flex items-center gap-2">
                                åºè™Ÿ P{{index + 1}}
                                <span v-if="passengerTab === 'ret' && !p.isDirty" class="sync-badge">åŒæ­¥ä¸­</span>
                            </div>
                            <div class="flex flex-col">
                                <label class="form-label">ç¥¨ç¨®</label>
                                <div class="bg-white border p-2 text-xs text-stone-400 rounded">{{ p.type }}</div>
                            </div>
                            <div class="flex flex-col">
                                <label class="form-label font-bold text-stone-600">å§“å</label>
                                <input type="text" v-model="p.name" @input="p.isDirty = (passengerTab === 'ret')" class="text-sm">
                            </div>
                            <div class="flex flex-col">
                                <label class="form-label font-bold text-stone-600">èº«åˆ†è­‰è™Ÿ</label>
                                <input type="text" v-model="p.idNumber" @input="p.isDirty = (passengerTab === 'ret')" class="text-sm uppercase font-mono tracking-tighter">
                            </div>
                            <div class="flex flex-col">
                                <label class="form-label font-bold text-stone-600">è­·ç…§è™Ÿç¢¼</label>
                                <input type="text" v-model="p.passportNo" @input="p.isDirty = (passengerTab === 'ret')" class="text-sm uppercase font-mono tracking-tighter">
                            </div>
                            <div class="flex flex-col">
                                <label class="form-label font-bold text-stone-600">å‡ºç”Ÿå¹´æœˆæ—¥</label>
                                <input type="date" v-model="p.birthday" @input="p.isDirty = (passengerTab === 'ret')" class="text-xs font-mono">
                            </div>
                        </div>
                    </div>

                    <div class="px-8 py-5 border-t bg-stone-50 flex justify-between items-center text-xs font-medium">
                        <p class="text-[10px] text-stone-400 italic font-light font-sans">æé†’ï¼šå»ç¨‹è³‡æ–™æœƒè‡ªå‹•å¸¶å…¥å›ç¨‹ï¼Œæ‚¨å¯å–®ç¨ç·¨è¼¯å›ç¨‹ç´°ç¯€ã€‚</p>
                        <button @click="showPassengerModal = false" class="px-12 py-2.5 bg-stone-700 text-white rounded text-[11px] font-bold uppercase shadow-md tracking-widest">å®Œæˆä¸¦è¿”å›</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- å°å‡ºåœ–ç‰‡é è¦½å€ (éš±è—) -->
        <div id="capture-area" class="fixed -left-[4000px] top-0">
            <div class="w-[900px] bg-white p-12 text-[#2d2d2a]" id="image-node">
                
                <div class="flex justify-between items-start mb-6 border-b-2 border-[#2d2d2a] pb-4 font-bold">
                    <div>
                        <h1 class="text-2xl tracking-[0.3em] mb-1 uppercase font-bold text-stone-800 font-sans">é«˜éµè¨‚ä½ç¢ºèªå–®</h1>
                        <p class="text-[9px] text-gray-400 font-light tracking-[0.4em] uppercase font-sans">æ—…è¡Œç¤¾è¡Œæ”¿ç®¡ç†ä½œæ¥­ç´€éŒ„å–®</p>
                    </div>
                    <div class="text-right">
                        <div class="inline-block bg-[#2d2d2a] text-white px-4 py-1 text-[10px] tracking-widest mb-1 font-mono uppercase font-bold">OFFICIAL COPY</div>
                        <p class="text-[9px] text-gray-400 font-mono tracking-tighter uppercase font-sans">ç³»çµ±æ™‚é–“: {{ manualTimestamp }}</p>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-x-4 gap-y-1 text-[10px] mb-4 bg-stone-50 p-3 rounded border border-stone-100 shadow-sm font-medium font-sans">
                    <div class="flex gap-2"><span class="text-gray-400">è¨‚å–®ç·¨è™Ÿï¼š</span><span class="text-gray-700 font-bold font-mono">{{baseInfo.orderId}}</span></div>
                    <div class="flex gap-2"><span class="text-gray-400">åœ˜è™Ÿï¼š</span><span class="text-gray-700 font-bold font-mono">{{baseInfo.groupId}}</span></div>
                    <div class="flex gap-2"><span class="text-gray-400">è¨‚ç¥¨æ—¥æœŸï¼š</span><span class="text-gray-700 font-medium font-mono text-[11px]">{{baseInfo.bookingDate}}</span></div>
                    <div class="flex gap-2"><span class="text-gray-400">æ¥­å‹™äººå“¡ï¼š</span><span class="text-gray-700 font-bold">{{baseInfo.sales}}</span></div>
                    <div class="flex gap-2"><span class="text-gray-400">è¨‚ä½äººå“¡ï¼š</span><span class="text-gray-700">{{baseInfo.staff}}</span></div>
                </div>

                <div class="mb-4 py-3 px-4 border-l-4 border-red-500 bg-red-50 flex items-center justify-between shadow-sm rounded-r">
                    <div class="flex items-center gap-3 font-bold text-red-700">
                        <span class="text-[12px] tracking-widest uppercase font-bold font-sans">é–‹ç¥¨æœŸé™</span>
                    </div>
                    <span class="text-red-600 font-bold text-xl underline underline-offset-4 decoration-red-300 font-mono tracking-tighter uppercase font-sans">{{ formattedDeadline }}</span>
                </div>

                <!-- åˆä½µå¾Œçš„æé†’äº‹é … -->
                <div class="mb-8 px-4 py-2 text-stone-600 border-stone-100 border-l-2 font-medium font-sans">
                    <ul class="text-[10px] space-y-1 leading-relaxed">
                        <li class="font-bold tracking-tight">ã€ è«‹å‹™å¿…æ–¼D/Lå‰å‘ŠçŸ¥å¯é–‹ç¥¨ èˆ‡ å–ç¥¨æ–¹å¼  ç´™æœ¬ / é›»å­ç¥¨(æ­é…APPä½¿ç”¨) ã€‘</li>
                        <li class="tracking-tight">æ›å¸³å…¨ç¥¨æœƒå…ˆæ›85æŠ˜çš„åƒ¹æ ¼ï¼Œå„ªå¾…ç¥¨(å­©ç«¥ã€æ•¬è€ã€æ„›å¿ƒ)éƒ½æ˜¯åŠåƒ¹ã€‚ <span class="opacity-80 italic text-[9px] font-normal">â€»å¦‚æœå”®åƒ¹æœ‰èª¿æ•´éœ€è¦æ›´æ”¹å†è«‹é€šçŸ¥å”· è¬è¬</span></li>
                    </ul>
                </div>

                <div v-for="(trip, tIdx) in addedTrips" :key="tIdx" class="mb-10 font-medium text-stone-700 font-sans">
                    <div class="flex items-center gap-4 mb-3 text-xs font-bold font-sans">
                        <span class="text-md text-stone-800 tracking-tighter uppercase font-mono uppercase font-bold">è¨‚ç¥¨ç´€éŒ„ #{{ tIdx + 1 }}</span>
                        <div class="h-[1px] flex-1 bg-stone-100 font-sans"></div>
                    </div>

                    <!-- å»ç¨‹æ®µ -->
                    <div class="mb-5 overflow-hidden rounded-sm border border-stone-100 shadow-sm bg-[#fafafa] font-sans">
                        <div class="bg-stone-800 text-white px-3 py-1.5 flex justify-between items-center text-[10px] font-bold tracking-widest uppercase font-sans">
                            <span>å»ç¨‹</span>
                            <div class="flex gap-6 opacity-80 font-mono tracking-tighter uppercase font-bold">
                                <span>é«˜éµè¨‚å–®ï¼š{{ trip.outbound.hsrOrderId }}</span>
                                <span>PNR: {{ trip.outbound.pnr }}</span>
                            </div>
                        </div>
                        <table class="w-full text-[10px] text-left text-stone-700 border-b border-stone-50 font-sans">
                            <tr class="bg-white">
                                <th class="p-2 w-24 text-stone-400 font-light border-r font-sans">æ—¥æœŸ</th>
                                <td class="p-2 border-r font-medium font-mono text-stone-800">{{ trip.outbound.date }}</td>
                                <th class="p-2 w-20 text-stone-400 font-light border-r font-sans">è»Šæ¬¡</th>
                                <td class="p-2 border-r font-bold font-mono text-stone-800">{{ trip.outbound.trainNo }} æ¬¡</td>
                                <th class="p-2 w-24 text-stone-400 font-light border-r font-sans">å€é–“</th>
                                <td class="p-2 border-r font-bold text-stone-800 font-sans">{{ trip.outbound.from }} â†’ {{ trip.outbound.to }}</td>
                                <th class="p-2 w-24 text-stone-400 font-light border-r text-center font-sans">æ™‚é–“ (24H)</th>
                                <td class="p-2 border-r font-bold font-mono text-stone-800 tracking-tighter text-center font-mono">{{ trip.outbound.depTime }} - {{ trip.outbound.arrTime }}</td>
                                <th class="p-2 w-20 text-stone-400 font-light border-r text-center font-sans">è»Šå»‚</th>
                                <td class="p-2 font-bold text-stone-800 text-center font-sans">{{ trip.outbound.carClass }}</td>
                            </tr>
                        </table>
                        <div class="px-3 py-1.5 bg-stone-50/50 border-b border-stone-100 text-[9px] text-stone-500 italic font-medium font-sans">
                            <span class="font-bold mr-2 not-italic font-sans">ç¥¨åƒ¹æ˜ç´°ï¼š</span>{{ trip.outBreakdown }} <span class="float-right not-italic font-bold text-stone-700 font-sans">å°è¨ˆ: NT$ {{ trip.outAmount.toLocaleString() }}</span>
                        </div>
                        <div class="p-3 bg-white font-sans">
                            <table class="w-full text-[10px] leading-tight text-stone-700 font-medium font-sans">
                                <thead class="text-stone-400 border-b border-stone-50 font-sans">
                                    <tr>
                                        <th class="pb-1 text-left w-24 font-normal font-sans">ç¥¨ç¨®</th>
                                        <th class="pb-1 text-left w-24 font-bold text-stone-500 font-sans">æ—…å®¢å§“å</th>
                                        <th class="pb-1 text-left w-36 font-bold text-stone-500 font-sans">èº«åˆ†è­‰å­—è™Ÿ (éš±ç¢¼)</th>
                                        <th class="pb-1 text-left w-32 font-bold text-stone-500 font-sans">è­·ç…§è™Ÿç¢¼</th>
                                    </tr>
                                </thead>
                                <tbody class="font-sans">
                                    <tr v-for="(p, pIdx) in trip.passengersOut" :key="pIdx" class="border-b border-stone-50 last:border-0 text-xs font-sans">
                                        <td class="py-1.5 text-stone-400 text-[9px] font-medium font-sans">{{ p.type }}</td>
                                        <td class="py-1.5 font-bold text-stone-800 font-sans">{{ p.name }}</td>
                                        <td class="py-1.5 font-mono text-stone-500 tracking-tighter font-mono">{{ maskId(p.idNumber) }}</td>
                                        <td class="py-1.5 font-mono text-stone-500 uppercase font-mono">{{ p.passportNo || '' }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- å›ç¨‹æ®µ -->
                    <div v-if="trip.mode === 'round-trip'" class="mb-5 overflow-hidden rounded-sm border border-orange-100 shadow-sm bg-[#fffbf9] font-sans">
                        <div class="bg-orange-400 text-white px-3 py-1.5 flex justify-between items-center text-[10px] font-bold tracking-widest uppercase font-sans">
                            <span>å›ç¨‹</span>
                            <div class="flex gap-6 opacity-90 font-mono font-bold tracking-tighter uppercase font-mono">
                                <span>é«˜éµè¨‚å–®ï¼š{{ trip.returnTrip.hsrOrderId || trip.outbound.hsrOrderId }}</span>
                                <span>PNR: {{ trip.returnTrip.pnr }}</span>
                            </div>
                        </div>
                        <table class="w-full text-[10px] text-left text-stone-700 border-b border-orange-50 font-sans font-sans">
                            <tr class="bg-white">
                                <th class="p-2 w-24 text-stone-400 font-light border-r font-mono font-sans">æ—¥æœŸ</th>
                                <td class="p-2 border-r font-medium font-mono text-stone-800">{{ trip.returnTrip.date }}</td>
                                <th class="p-2 w-20 text-stone-400 font-light border-r font-mono font-sans">è»Šæ¬¡</th>
                                <td class="p-2 border-r font-bold font-mono text-stone-800 font-mono">{{ trip.returnTrip.trainNo }} æ¬¡</td>
                                <th class="p-2 w-24 text-stone-400 font-light border-r font-sans font-sans">å€é–“</th>
                                <td class="p-2 border-r font-bold text-orange-700/80 font-sans">{{ trip.returnTrip.from }} â†’ {{ trip.returnTrip.to }}</td>
                                <th class="p-2 w-24 text-stone-400 font-light border-r text-center text-[9px] font-sans font-sans">æ™‚é–“ (24H)</th>
                                <td class="p-2 border-r font-bold font-mono text-orange-700/80 tracking-tighter text-center font-mono">{{ trip.returnTrip.depTime }} - {{ trip.returnTrip.arrTime }}</td>
                                <th class="p-2 w-20 text-stone-400 font-light border-r text-center font-sans font-sans">è»Šå»‚</th>
                                <td class="p-2 font-bold text-orange-700/80 text-center font-sans">{{ trip.returnTrip.carClass }}</td>
                            </tr>
                        </table>
                        <div class="px-3 py-1.5 bg-orange-50/30 border-b border-orange-50 text-[9px] text-orange-600/70 italic font-medium font-sans font-sans">
                            <span class="font-bold mr-2 not-italic font-sans">ç¥¨åƒ¹æ˜ç´°ï¼š</span>{{ trip.retBreakdown }} <span class="float-right not-italic font-bold text-orange-700/90 font-sans">å°è¨ˆ: NT$ {{ trip.retAmount.toLocaleString() }}</span>
                        </div>
                        <div class="p-3 bg-white text-stone-700 font-medium font-sans">
                            <table class="w-full text-[10px] leading-tight font-sans">
                                <thead class="text-orange-300 border-b border-orange-50 font-bold font-sans">
                                    <tr>
                                        <th class="pb-1 text-left w-24 font-normal font-sans">ç¥¨ç¨®</th>
                                        <th class="pb-1 text-left w-24 font-bold text-orange-400/80 font-sans">æ—…å®¢å§“å</th>
                                        <th class="pb-1 text-left w-36 font-bold text-orange-400/80 font-sans">èº«åˆ†è­‰å­—è™Ÿ</th>
                                        <th class="pb-1 text-left w-32 font-bold text-orange-400/80 font-sans">è­·ç…§è™Ÿç¢¼</th>
                                    </tr>
                                </thead>
                                <tbody class="font-sans">
                                    <tr v-for="(p, pIdx) in trip.passengersRet" :key="pIdx" class="border-b border-orange-50 last:border-0 text-xs font-sans">
                                        <td class="py-1.5 text-stone-400 text-[9px] font-sans font-sans">{{ p.type }}</td>
                                        <td class="py-1.5 font-bold text-orange-700/80 font-sans font-sans">{{ p.name }}</td>
                                        <td class="py-1.5 font-mono text-stone-500 tracking-tighter font-mono font-mono font-mono">{{ maskId(p.idNumber) }}</td>
                                        <td class="py-1.5 font-mono text-stone-500 uppercase font-mono font-mono font-mono">{{ p.passportNo || '' }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- æ³¨æ„äº‹é …èˆ‡é€€ç¥¨èªªæ˜ -->
                <div class="flex justify-between items-end border-t border-stone-200 pt-6 mb-6 text-sm font-medium font-sans font-sans font-sans font-sans">
                    <div class="w-3/5 text-gray-500 font-light font-sans font-sans font-sans font-sans font-sans">
                        <h4 class="font-bold text-[10px] text-stone-800 mb-1.5 underline decoration-stone-200 underline-offset-4 tracking-widest uppercase font-bold font-sans font-sans font-sans">æ³¨æ„äº‹é …èˆ‡é€€ç¥¨èªªæ˜:</h4>
                        <ul class="notes-text grid grid-cols-1 gap-0.5 italic text-stone-400 tracking-tighter font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans">
                            <li>1. åº§ä½çš†ç”±é›»è…¦è‡ªå‹•åŠƒä½ï¼Œæ•ç„¡æ³•æŒ‡å®šåº§ä½ï¼Œäº¦ç„¡æ³•ä¿è­‰åŒè¡Œè€…å¯å®‰æ’ç›¸é„°åº§ä½ã€‚</li>
                            <li>2. è‹¥å› é€¾æ™‚æœªèƒ½æ­ä¹˜ï¼Œè«‹è‡ªè¡Œæ´½è©¢ç«™å‹™äººå“¡æ˜¯å¦å¯æ”¹æ­ç•¶æ—¥å…¶ä»–è»Šæ¬¡ä¹‹è‡ªç”±åº§ï¼Œæ•ç„¡æ³•è¾¦ç†é€€ç¥¨ã€‚</li>
                            <li>3. é«˜éµè»Šç¥¨é™æ­ä¹˜ç•¶æ—¥ä½¿ç”¨ï¼Œé€¾æœŸè¦–åŒå»¢ç¥¨ï¼Œæ•ä¸å—ç†é€€ç¥¨ã€‚</li>
                            <li>4. å¦‚éœ€è¾¦ç†é€€ç¥¨ï¼Œè«‹æ–¼ <b>4å€‹å·¥ä½œæ—¥å‰</b> ç”³è«‹ï¼Œä¸¦æä¾›ç´™æœ¬ç¥¨æ ¹æˆ– APP é›»å­ç¥¨æˆªåœ–ï¼ˆå¤©ç½å°è‡´é«˜éµåœé§›è€…ä¸åœ¨æ­¤é™ï¼‰ã€‚</li>
                            <li>5. é€€ç¥¨å°‡é…Œæ”¶æ‰‹çºŒè²» æ¯å¼µ <b>æ–°å°å¹£ 50 å…ƒ</b>ã€‚</li>
                            <li>6. è¾¦ç†é€€ç¥¨æ™‚ï¼Œè«‹å‹™å¿…æä¾› <b>ç´™æœ¬ç¥¨æ ¹æˆ–é›»å­ç¥¨ï¼ˆAPP æˆªåœ–ï¼‰</b>ï¼Œæœªæä¾›è€…å°‡è¦–åŒæ­£å¸¸æ­ä¹˜ï¼Œç›¸é—œè²»ç”¨é ˆè‡ªè¡Œè² æ“”ã€‚</li>
                            <li>7. å› èˆªç­å»¶èª¤æˆ–å–æ¶ˆç­‰éé«˜éµå› ç´ è‡´ç„¡æ³•æ­ä¹˜è€…ï¼Œè»Šç¥¨ æ•ç„¡æ³•æ”¹æœŸæˆ–é€€ç¥¨ï¼Œæ•¬è«‹è¦‹è«’ã€‚</li>
                        </ul>
                    </div>
                    <div class="text-right border-l border-stone-100 pl-10 font-bold font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans">
                        <p class="text-[9px] text-stone-400 mb-0.5 uppercase tracking-widest tracking-tighter font-mono font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans">Grand Total (TWD)</p>
                        <p class="text-4xl font-bold text-stone-900 tracking-tighter font-mono font-bold font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans"><span class="text-xl font-light font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans">NT$</span> {{totalOrderAmount.toLocaleString()}}</p>
                    </div>
                </div>

                <div class="mt-4 p-4 border-2 border-stone-800 rounded-sm bg-stone-50 shadow-sm font-bold font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans">
                    <p class="text-[11px] font-bold text-stone-900 leading-relaxed text-center tracking-tighter font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans">
                        è«‹æ¥­å‹™å€‘å‹™å¿…å†æ¬¡æ ¸å° ç¥¨ç¨®/å¼µæ•¸/é‡‘é¡ æ˜¯å¦æ­£ç¢ºï¼Œå¦‚æœ‰éŒ¯èª¤ è«‹æ–¼ã€Œå‡ºç¥¨å‰ã€å‘ŠçŸ¥ï¼Œ<br>
                        å‡ºç¥¨å¾Œå‘ŠçŸ¥è«‹è‡ªè¡Œè² è²¬ï¼Œé«˜éµè¨‚ç¥¨æœå‹™çª—å£æ„Ÿè¬æ‚¨çš„é…åˆã€‚
                    </p>
                </div>

                <div class="text-center pt-4 border-t border-dotted border-stone-100 opacity-40 font-mono text-[8px] text-stone-300 font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans">
                    <p class="tracking-[0.2em] uppercase font-light font-bold font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans font-sans">SYSTEM GENERATED V1.3 Â· FOR INTERNAL AUDIT ONLY</p>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, reactive, computed, watch, onMounted } = Vue;

        createApp({
            setup() {
                const today = new Date().toISOString().split('T')[0];
                const tripMode = ref('one-way');
                const showPassengerModal = ref(false);
                const passengerTab = ref('out');
                const toastMsg = ref('');
                const editingIndex = ref(null);
                const stations = ['å—æ¸¯', 'å°åŒ—', 'æ¿æ©‹', 'æ¡ƒåœ’', 'æ–°ç«¹', 'è‹—æ —', 'å°ä¸­', 'å½°åŒ–', 'é›²æ—', 'å˜‰ç¾©', 'å°å—', 'å·¦ç‡Ÿ'];

                const fareRules = {
                    standard: {
                        'å—æ¸¯': { 'å°åŒ—': 40, 'æ¿æ©‹': 70, 'æ¡ƒåœ’': 200, 'æ–°ç«¹': 330, 'è‹—æ —': 480, 'å°ä¸­': 750, 'å½°åŒ–': 870, 'é›²æ—': 930, 'å˜‰ç¾©': 1120, 'å°å—': 1390, 'å·¦ç‡Ÿ': 1530 },
                        'å°åŒ—': { 'æ¿æ©‹': 40, 'æ¡ƒåœ’': 160, 'æ–°ç«¹': 290, 'è‹—æ —': 430, 'å°ä¸­': 700, 'å½°åŒ–': 820, 'é›²æ—': 930, 'å˜‰ç¾©': 1080, 'å°å—': 1350, 'å·¦ç‡Ÿ': 1490 },
                        'æ¿æ©‹': { 'æ¡ƒåœ’': 130, 'æ–°ç«¹': 260, 'è‹—æ —': 400, 'å°ä¸­': 670, 'å½°åŒ–': 790, 'é›²æ—': 900, 'å˜‰ç¾©': 1050, 'å°å—': 1320, 'å·¦ç‡Ÿ': 1460 },
                        'æ¡ƒåœ’': { 'æ–°ç«¹': 130, 'è‹—æ —': 280, 'å°ä¸­': 540, 'å½°åŒ–': 670, 'é›²æ—': 780, 'å˜‰ç¾©': 920, 'å°å—': 1190, 'å·¦ç‡Ÿ': 1330 },
                        'æ–°ç«¹': { 'è‹—æ —': 270, 'å°ä¸­': 390, 'å½°åŒ–': 500, 'é›²æ—': 640, 'å˜‰ç¾©': 920, 'å°å—': 1060, 'å·¦ç‡Ÿ': 1200 },
                        'è‹—æ —': { 'å°ä¸­': 270, 'å½°åŒ–': 390, 'é›²æ—': 500, 'å˜‰ç¾©': 640, 'å°å—': 920, 'å·¦ç‡Ÿ': 1060 },
                        'å°ä¸­': { 'å½°åŒ–': 130, 'é›²æ—': 230, 'å˜‰ç¾©': 380, 'å°å—': 650, 'å·¦ç‡Ÿ': 790 },
                        'å½°åŒ–': { 'é›²æ—': 110, 'å˜‰ç¾©': 250, 'å°å—': 530, 'å·¦ç‡Ÿ': 680 },
                        'é›²æ—': { 'å˜‰ç¾©': 150, 'å°å—': 420, 'å·¦ç‡Ÿ': 560 },
                        'å˜‰ç¾©': { 'å°å—': 280, 'å·¦ç‡Ÿ': 410 },
                        'å°å—': { 'å·¦ç‡Ÿ': 140 }
                    },
                    business: {
                        'å—æ¸¯': { 'å°åŒ—': 260, 'æ¿æ©‹': 310, 'æ¡ƒåœ’': 500, 'æ–°ç«¹': 700, 'è‹—æ —': 920, 'å°ä¸­': 1330, 'å½°åŒ–': 1510, 'é›²æ—': 1660, 'å˜‰ç¾©': 1880, 'å°å—': 2290, 'å·¦ç‡Ÿ': 2500 },
                        'å°åŒ—': { 'æ¿æ©‹': 260, 'æ¡ƒåœ’': 440, 'æ–°ç«¹': 640, 'è‹—æ —': 850, 'å°ä¸­': 1250, 'å½°åŒ–': 1430, 'é›²æ—': 1600, 'å˜‰ç¾©': 1820, 'å°å—': 2230, 'å·¦ç‡Ÿ': 2440 },
                        'æ¿æ©‹': { 'æ¡ƒåœ’': 400, 'æ–°ç«¹': 590, 'è‹—æ —': 800, 'å°ä¸­': 1210, 'å½°åŒ–': 1390, 'é›²æ—': 1550, 'å˜‰ç¾©': 1780, 'å°å—': 2180, 'å·¦ç‡Ÿ': 2390 },
                        'æ¡ƒåœ’': { 'æ–°ç«¹': 400, 'è‹—æ —': 620, 'å°ä¸­': 1010, 'å½°åŒ–': 1210, 'é›²æ—': 1370, 'å˜‰ç¾©': 1580, 'å°å—': 1990, 'å·¦ç‡Ÿ': 2200 },
                        'æ–°ç«¹': { 'è‹—æ —': 410, 'å°ä¸­': 820, 'å½°åŒ–': 1010, 'é›²æ—': 1160, 'å˜‰ç¾©': 1390, 'å°å—': 1790, 'å·¦ç‡Ÿ': 2000 },
                        'è‹—æ —': { 'å°ä¸­': 610, 'å½°åŒ–': 790, 'é›²æ—': 950, 'å˜‰ç¾©': 1160, 'å°å—': 1580, 'å·¦ç‡Ÿ': 1790 },
                        'å°ä¸­': { 'å½°åŒ–': 400, 'é›²æ—': 550, 'å˜‰ç¾©': 770, 'å°å—': 1180, 'å·¦ç‡Ÿ': 1390 },
                        'å½°åŒ–': { 'é›²æ—': 370, 'å˜‰ç¾©': 580, 'å°å—': 1000, 'å·¦ç‡Ÿ': 1210 },
                        'é›²æ—': { 'å˜‰ç¾©': 430, 'å°å—': 830, 'å·¦ç‡Ÿ': 1040 },
                        'å˜‰ç¾©': { 'å°å—': 620, 'å·¦ç‡Ÿ': 820 },
                        'å°å—': { 'å·¦ç‡Ÿ': 140 }
                    }
                };

                const baseInfo = reactive({ staff: 'é™³ä¾‘å›', bookingDate: today, deadlineDate: '', deadlineTime: '18:00', sales: '', orderId: '', groupId: '' });
                const outbound = reactive({ hsrOrderId: '', pnr: '', date: today, trainNo: '', from: 'å·¦ç‡Ÿ', to: 'å°åŒ—', depTime: '08:00', arrTime: '09:30', carClass: 'æ¨™æº–è»Šå»‚' });
                const returnTrip = reactive({ hsrOrderId: '', pnr: '', date: today, trainNo: '', from: 'å°åŒ—', to: 'å·¦ç‡Ÿ', depTime: '17:00', arrTime: '18:30', carClass: 'æ¨™æº–è»Šå»‚' });
                const tickets = reactive({ adult: 1, child: 0, senior: 0, disability: 0 });
                const passengersOut = ref([]);
                const passengersRet = ref([]);
                const addedTrips = ref([]);

                const getSingleFare = (f, t, carClass) => {
                    const matrix = carClass === 'å•†å‹™è»Šå»‚' ? fareRules.business : fareRules.standard;
                    return matrix[f]?.[t] || matrix[t]?.[f] || 0;
                };
                
                const getBreakdown = (tripObj, tks) => {
                    const unit = getSingleFare(tripObj.from, tripObj.to, tripObj.carClass);
                    const discount = tripObj.carClass === 'æ¨™æº–è»Šå»‚' ? 0.85 : 0.9;
                    const adultPrice = Math.round(unit * discount); // å››æ¨äº”å…¥
                    const concessionPrice = Math.round(unit * 0.5); // å››æ¨äº”å…¥
                    
                    const res = [];
                    if (tks.adult > 0) res.push(`å…¨ç¥¨ ${tks.adult}å¼µ ($${adultPrice})`);
                    if (tks.child > 0) res.push(`å­©ç«¥ ${tks.child}å¼µ ($${concessionPrice})`);
                    if (tks.senior > 0) res.push(`æ•¬è€ ${tks.senior}å¼µ ($${concessionPrice})`);
                    if (tks.disability > 0) res.push(`æ„›å¿ƒ ${tks.disability}å¼µ ($${concessionPrice})`);
                    return res.join(' + ');
                };

                const calcAmount = (tripObj) => {
                    const unit = getSingleFare(tripObj.from, tripObj.to, tripObj.carClass);
                    const discount = tripObj.carClass === 'æ¨™æº–è»Šå»‚' ? 0.85 : 0.9;
                    
                    // å–®å¼µç¥¨åƒ¹å…ˆå››æ¨äº”å…¥å†ä¹˜å¼µæ•¸
                    const adultPrice = Math.round(unit * discount);
                    const concessionPrice = Math.round(unit * 0.5);
                    
                    const adultAmount = tickets.adult * adultPrice;
                    const concessionAmount = (tickets.child + tickets.senior + tickets.disability) * concessionPrice;
                    
                    return adultAmount + concessionAmount;
                };

                const maskId = (id) => {
                    if (!id) return '';
                    const s = id.toString();
                    if (s.length < 3) return s.toUpperCase();
                    return `${s.charAt(0).toUpperCase()}${s.charAt(1)}*****${s.slice(7)}`;
                };

                const showToast = (msg) => {
                    toastMsg.value = msg;
                    setTimeout(() => { if(toastMsg.value === msg) toastMsg.value = ''; }, 3000);
                };

                const swapStations = (trip) => { [trip.from, trip.to] = [trip.to, trip.from]; };

                const addTripToList = () => {
                    if (!outbound.pnr) { showToast("è«‹è¼¸å…¥ PNR ä»£ç¢¼ï¼"); return; }
                    const outAmount = calcAmount(outbound);
                    const retAmount = tripMode.value === 'round-trip' ? calcAmount(returnTrip) : 0;
                    
                    addedTrips.value.push({
                        mode: tripMode.value,
                        outbound: { ...outbound },
                        returnTrip: { ...returnTrip },
                        tickets: { ...tickets },
                        passengersOut: JSON.parse(JSON.stringify(passengersOut.value)),
                        passengersRet: tripMode.value === 'round-trip' ? JSON.parse(JSON.stringify(passengersRet.value)) : [],
                        totalAmount: outAmount + retAmount,
                        outAmount, retAmount,
                        outBreakdown: getBreakdown(outbound, tickets),
                        retBreakdown: tripMode.value === 'round-trip' ? getBreakdown(returnTrip, tickets) : ''
                    });
                    resetForm();
                    showToast("è¡Œç¨‹ç´€éŒ„å·²å­˜å…¥æ‘˜è¦æ¸…å–®");
                };

                const startEdit = (idx) => {
                    const target = addedTrips.value[idx];
                    editingIndex.value = idx;
                    tripMode.value = target.mode;
                    Object.assign(outbound, target.outbound);
                    Object.assign(returnTrip, target.returnTrip);
                    Object.assign(tickets, target.tickets);
                    setTimeout(() => {
                        passengersOut.value = JSON.parse(JSON.stringify(target.passengersOut));
                        if (target.mode === 'round-trip') passengersRet.value = JSON.parse(JSON.stringify(target.passengersRet));
                    }, 0);
                    showToast("è¼‰å…¥è³‡æ–™ï¼Œé€²å…¥ç·¨è¼¯æ¨¡å¼");
                };

                const updateTripInList = () => {
                    const idx = editingIndex.value;
                    const outAmount = calcAmount(outbound);
                    const retAmount = tripMode.value === 'round-trip' ? calcAmount(returnTrip) : 0;
                    addedTrips.value[idx] = {
                        mode: tripMode.value,
                        outbound: { ...outbound },
                        returnTrip: { ...returnTrip },
                        tickets: { ...tickets },
                        passengersOut: JSON.parse(JSON.stringify(passengersOut.value)),
                        passengersRet: tripMode.value === 'round-trip' ? JSON.parse(JSON.stringify(passengersRet.value)) : [],
                        totalAmount: outAmount + retAmount,
                        outAmount, retAmount,
                        outBreakdown: getBreakdown(outbound, tickets),
                        retBreakdown: tripMode.value === 'round-trip' ? getBreakdown(returnTrip, tickets) : ''
                    };
                    resetForm();
                    editingIndex.value = null;
                    showToast("ç´€éŒ„æ›´æ–°å®Œæˆ");
                };

                const cancelEdit = () => { resetForm(); editingIndex.value = null; showToast("ç·¨è¼¯å·²å–æ¶ˆ"); };
                const resetForm = () => { outbound.pnr = ''; outbound.hsrOrderId = ''; returnTrip.pnr = ''; returnTrip.hsrOrderId = ''; };
                const removeTrip = (index) => addedTrips.value.splice(index, 1);
                const clearAllTrips = () => { if(confirm("ç¢ºå®šè¦é‡è¨­æ¸…ç©ºæ‘˜è¦æ¸…å–®ï¼Ÿ")) addedTrips.value = []; };
                const openPassengerModal = () => { showPassengerModal.value = true; };

                const totalPersonCount = computed(() => (tickets.adult || 0) + (tickets.child || 0) + (tickets.senior || 0) + (tickets.disability || 0));
                const totalTicketCountInCurrent = computed(() => tripMode.value === 'one-way' ? totalPersonCount.value : totalPersonCount.value * 2);
                const isOverLimit = computed(() => totalPersonCount.value > 10);
                const totalOrderAmount = computed(() => addedTrips.value.reduce((sum, t) => sum + t.totalAmount, 0));
                const formattedDeadline = computed(() => baseInfo.deadlineDate ? `${baseInfo.deadlineDate.replace(/-/g, '/')} ${baseInfo.deadlineTime}` : '');
                
                const manualTimestamp = computed(() => {
                    const now = new Date();
                    return `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                });

                const syncOutboundToReturn = (outList, retList) => {
                    if (tripMode.value !== 'round-trip') return;
                    outList.forEach((pax, i) => {
                        const target = retList[i];
                        if (target && !target.isDirty) {
                            target.name = pax.name; target.idNumber = pax.idNumber; target.passportNo = pax.passportNo; target.birthday = pax.birthday;
                        }
                    });
                };

                watch(tickets, (newVal) => {
                    const types = [{count: newVal.adult, type:'å…¨ç¥¨'}, {count: newVal.child, type:'å­©ç«¥(å„ªå¾…ç¥¨)'}, {count: newVal.senior, type:'æ•¬è€(å„ªå¾…ç¥¨)'}, {count: newVal.disability, type:'æ„›å¿ƒ(å„ªå¾…ç¥¨)'}];
                    const sync = (list) => {
                        const newList = [];
                        types.forEach(t => { for(let i=0; i<t.count; i++) newList.push({type:t.type, name:'', idNumber:'', passportNo:'', birthday:'', isDirty: false}) });
                        newList.forEach((p, i) => { if(list.value[i]) Object.assign(p, list.value[i]) });
                        list.value = newList.slice(0, 10);
                    };
                    sync(passengersOut); sync(passengersRet);
                }, { deep: true });

                watch(passengersOut, (newVal) => { syncOutboundToReturn(newVal, passengersRet.value); }, { deep: true });

                const syncOrderId = () => { if(tripMode.value === 'round-trip') returnTrip.hsrOrderId = outbound.hsrOrderId; };

                onMounted(() => {
                    let d = new Date(today);
                    d.setDate(d.getDate() + 2);
                    if(d.getDay() === 6) d.setDate(d.getDate()-1);
                    else if(d.getDay() === 0) d.setDate(d.getDate()-2);
                    baseInfo.deadlineDate = d.toISOString().split('T')[0];
                });

                const getCustomFilename = (ext) => {
                    const d = baseInfo.bookingDate.replace(/-/g, '').slice(2);
                    const p = addedTrips.value.length > 0 ? addedTrips.value[0].outbound.pnr : 'HSR';
                    const s = baseInfo.sales || baseInfo.staff;
                    return `${d}${p}${s}.${ext}`;
                };

                const downloadTxt = () => {
                    let text = `ã€é«˜éµè¨‚ç¥¨ç´€éŒ„å–®ã€‘\r\nè¨‚å–®ï¼š${baseInfo.orderId}\r\nè¨‚ç¥¨æ—¥æœŸï¼š${baseInfo.bookingDate}\r\næ¥­å‹™ï¼š${baseInfo.sales}\r\nâ˜…é–‹ç¥¨æœŸé™ï¼š${formattedDeadline.value}\r\n\r\n`;
                    text += `ã€æé†’äº‹é …ã€‘\r\n1. è«‹å‹™å¿…æ–¼æœŸé™å‰å‘ŠçŸ¥å¯é–‹ç¥¨èˆ‡å–ç¥¨æ–¹å¼(ç´™æœ¬/é›»å­)ã€‚\r\n2. æ›å¸³å…¨ç¥¨æœƒå…ˆæ›85æŠ˜çš„åƒ¹æ ¼ï¼Œå„ªå¾…ç¥¨(å­©ç«¥ã€æ•¬è€ã€æ„›å¿ƒ)å‡ç‚ºåŠåƒ¹è¨ˆã€‚ â€»å¦‚æœå”®åƒ¹æœ‰èª¿æ•´éœ€è¦æ›´æ”¹å†è«‹é€šçŸ¥å”· è¬è¬\r\n\r\n`;
                    addedTrips.value.forEach((t, i) => {
                        text += `[ç´€éŒ„ #${i+1}] PNR: ${t.outbound.pnr}\r\nã€å»ç¨‹ ${t.outbound.carClass}ã€‘` + t.passengersOut.map(p => p.name).join(', ') + '\r\n';
                        text += `å»ç¨‹æ˜ç´°ï¼š${t.outBreakdown} = NT$ ${t.outAmount}\r\n`;
                        if(t.mode==='round-trip') {
                            text += `ã€å›ç¨‹ ${t.returnTrip.carClass}ã€‘` + t.passengersRet.map(p => p.name).join(', ') + '\r\n';
                            text += `å›ç¨‹æ˜ç´°ï¼š${t.retBreakdown} = NT$ ${t.retAmount}\r\n`;
                        }
                        text += `----------------\r\n`;
                    });
                    text += `\r\næ³¨æ„äº‹é …èˆ‡é€€ç¥¨èªªæ˜ï¼š\r\n1. åº§ä½çš†ç”±é›»è…¦è‡ªå‹•åŠƒä½ï¼Œæ•ç„¡æ³•æŒ‡å®šåº§ä½ï¼Œäº¦ç„¡æ³•ä¿è­‰åŒè¡Œè€…å¯å®‰æ’ç›¸é„°åº§ä½ã€‚\r\n2. è‹¥å› é€¾æ™‚æœªèƒ½æ­ä¹˜ï¼Œè«‹è‡ªè¡Œæ´½è©¢ç«™å‹™äººå“¡æ˜¯å¦å¯æ”¹æ­ç•¶æ—¥å…¶ä»–è»Šæ¬¡ä¹‹è‡ªç”±åº§ï¼Œæ•ç„¡æ³•è¾¦ç†é€€ç¥¨ã€‚\r\n3. é«˜éµè»Šç¥¨é ˆæ–¼æ­ä¹˜ç•¶æ—¥ä½¿ç”¨ï¼Œé€¾æœŸè¦–åŒå»¢ç¥¨ï¼Œæ•ä¸å—ç†é€€ç¥¨ã€‚\r\n4. å¦‚éœ€è¾¦ç†é€€ç¥¨ï¼Œè«‹æ–¼ 4å€‹å·¥ä½œæ—¥å‰ ç”³è«‹ï¼Œä¸¦æä¾›ç´™æœ¬ç¥¨æ ¹æˆ– APP é›»å­ç¥¨æˆªåœ–ï¼ˆå¤©ç½å°è‡´é«˜éµåœé§›è€…ä¸åœ¨æ­¤é™ï¼‰ã€‚\r\n5. é€€ç¥¨å°‡é…Œæ”¶æ‰‹çºŒè²» æ¯å¼µæ–°å°å¹£ 50 å…ƒã€‚\r\n6. è¾¦ç†é€€ç¥¨æ™‚ï¼Œè«‹å‹™å¿…æä¾› ç´™æœ¬ç¥¨æ ¹æˆ–é›»å­ç¥¨ï¼ˆAPP æˆªåœ–ï¼‰ï¼Œæœªæä¾›è€…å°‡è¦–åŒæ­£å¸¸æ­ä¹˜ï¼Œç›¸é—œè²»ç”¨é ˆè‡ªè¡Œè² æ“”ã€‚\r\n7. å› èˆªç­å»¶èª¤æˆ–å–æ¶ˆç­‰éé«˜éµå› ç´ è‡´ç„¡æ³•æ­ä¹˜è€…ï¼Œè»Šç¥¨ æ•ç„¡æ³•æ”¹æœŸæˆ–é€€ç¥¨ï¼Œæ•¬è«‹è¦‹è«’ã€‚\r\n\r\nç¸½è¨ˆé‡‘é¡ï¼šTWD ${totalOrderAmount.value}`;
                    const blob = new Blob([text], { type: 'text/plain' });
                    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                    a.download = getCustomFilename('txt'); a.click();
                };

                const downloadImage = () => {
                    html2canvas(document.getElementById('image-node'), { scale: 2, backgroundColor: '#ffffff' }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = getCustomFilename('png');
                        link.href = canvas.toDataURL("image/png"); link.click();
                    });
                };

                return { baseInfo, outbound, returnTrip, tickets, passengersOut, passengersRet, passengerTab, stations, tripMode, showPassengerModal, openPassengerModal, formattedDeadline, totalPersonCount, totalTicketCountInCurrent, isOverLimit, addedTrips, addTripToList, startEdit, updateTripInList, cancelEdit, editingIndex, removeTrip, clearAllTrips, totalOrderAmount, syncOrderId, downloadTxt, downloadImage, swapStations, manualTimestamp, toastMsg, maskId };
            }
        }).mount('#app');
    </script>
</body>
</html>
